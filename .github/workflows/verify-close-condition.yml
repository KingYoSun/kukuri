name: Verify Issue Close Condition

on:
  issues:
    types:
      - closed
  workflow_dispatch:

permissions:
  issues: write

jobs:
  enforce-verified-fixed:
    name: Enforce verified-fixed label
    runs-on: ubuntu-latest
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    steps:
      - name: Reopen issue when verified-fixed label is missing
        id: enforce
        uses: actions/github-script@v7
        with:
          script: |
            core.setOutput('reopened', 'false');
            core.setOutput('issue_number', '');
            core.setOutput('issue_title', '');
            core.setOutput('issue_url', '');

            const issue = context.payload.issue;
            if (!issue) {
              core.info('No issue payload found. Skip.');
              return;
            }

            const labels = (issue.labels || []).map((label) => label.name.toLowerCase());
            const hasBugLabel = labels.includes('bug');
            const hasVerifiedFixed = labels.includes('verified-fixed');
            const hasBugTitlePrefix = /^\s*\[bug\]/i.test(issue.title || '');
            const body = (issue.body || '').toLowerCase();
            const hasBugTemplateMarkers =
              body.includes('## å†ç¾æ‰‹é †') && body.includes('## æœŸå¾…ã•ã‚Œã‚‹å‹•ä½œ');
            const isBugIssue = hasBugLabel || hasBugTitlePrefix || hasBugTemplateMarkers;

            core.info(
              `Issue #${issue.number} labels=${labels.join(',') || '(none)'} title="${issue.title}"`,
            );

            if (!isBugIssue) {
              core.info(`Issue #${issue.number} is not detected as bug issue. Skip check.`);
              return;
            }

            if (hasVerifiedFixed) {
              core.info(`Issue #${issue.number} has verified-fixed label.`);
              return;
            }

            if (!hasBugLabel) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issue.number,
                labels: ['bug'],
              });
            }

            await github.rest.issues.update({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              state: 'open',
            });

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: issue.number,
              body:
                'Close Conditions æœªé”ã®ãŸã‚ Issue ã‚’å†ã‚ªãƒ¼ãƒ—ãƒ³ã—ã¾ã—ãŸã€‚`verified-fixed` ãƒ©ãƒ™ãƒ«ä»˜ä¸ã€CIï¼ˆ`Test` workflowï¼‰æˆåŠŸã€æ¤œè¨¼è¨¼è·¡ã®ç¢ºèªå¾Œã«å†åº¦ close ã—ã¦ãã ã•ã„ã€‚å¿…è¦ã«å¿œã˜ã¦ `bug` ãƒ©ãƒ™ãƒ«ã‚‚å†ç¢ºèªã—ã¦ãã ã•ã„ã€‚',
            });

            core.setOutput('reopened', 'true');
            core.setOutput('issue_number', String(issue.number));
            core.setOutput('issue_title', issue.title || '');
            core.setOutput('issue_url', issue.html_url || '');

            core.setFailed('verified-fixed label is required before closing this issue.');

      - name: Send Discord notification for auto-reopened issue
        if: ${{ always() && steps.enforce.outputs.reopened == 'true' && env.DISCORD_WEBHOOK_URL != '' }}
        env:
          WEBHOOK_URL: ${{ env.DISCORD_WEBHOOK_URL }}
          ISSUE_NUMBER: ${{ steps.enforce.outputs.issue_number }}
          ISSUE_TITLE: ${{ steps.enforce.outputs.issue_title }}
          ISSUE_URL: ${{ steps.enforce.outputs.issue_url }}
          REPO: ${{ github.repository }}
        run: |
          content=$(cat <<EOF
          ğŸ” **[Issue Reopened] #${ISSUE_NUMBER}: ${ISSUE_TITLE}**
          ğŸ“Œ repo: ${REPO}
          ğŸ“ reason: Close Conditions æœªé”ï¼ˆverified-fixed / CI success / æ¤œè¨¼è¨¼è·¡ï¼‰
          ğŸ”— ${ISSUE_URL}
          EOF
          )
          payload=$(jq -n --arg content "$content" '{content: $content, flags: 4}')
          curl -sS -X POST "$WEBHOOK_URL" \
            -H "Content-Type: application/json" \
            -d "$payload"

      - name: Skip Discord notification (webhook not configured)
        if: ${{ always() && steps.enforce.outputs.reopened == 'true' && env.DISCORD_WEBHOOK_URL == '' }}
        run: echo "DISCORD_WEBHOOK_URL is empty; skipping reopen notification."
