name: Validate PR Template

on:
  pull_request:
    types:
      - opened
      - edited
      - reopened
      - synchronize
      - ready_for_review

permissions:
  contents: read

jobs:
  validate-pr-template:
    name: Validate PR body quality gates
    runs-on: ubuntu-latest
    if: github.event.pull_request.draft == false
    steps:
      - name: Checkout code to check changed files
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if this is a meta PR (modifies quality gate files)
        id: check-meta
        run: |
          # Get changed files
          git diff --name-only HEAD^ HEAD > /tmp/changed_files.txt || echo "First commit, checking all files"
          
          # Check if any quality gate related files are modified
          if grep -qE '^\.github/workflows/|^\.github/PULL_REQUEST_TEMPLATE\.md|^\.github/ISSUE_TEMPLATE/' /tmp/changed_files.txt 2>/dev/null; then
            echo "is_meta=true" >> $GITHUB_OUTPUT
            echo "This is a meta PR modifying quality gate files. Skipping body validation."
          else
            echo "is_meta=false" >> $GITHUB_OUTPUT
          fi

      - name: Check required template sections and fields
        if: steps.check-meta.outputs.is_meta != 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const body = context.payload.pull_request.body || '';
            const errors = [];
            const requiredSections = [
              '## 概要',
              '## 関連Issue',
              '## Codexレビュー依頼（必須）',
              '## 検証証跡（必須）',
              '## 検証チェックリスト（必須）',
              '## テスト手順',
            ];

            const missingSections = requiredSections.filter((section) => !body.includes(section));
            if (missingSections.length > 0) {
              errors.push(`必須セクション不足: ${missingSections.join(', ')}`);
            }

            if (/Closes\s*#\s*(?:\n|$)/i.test(body)) {
              errors.push('`Closes #` が未入力です。Issue番号を記入してください。');
            }

            const hasIssueReference = /\b(close[sd]?|fix(?:e[sd])?|resolve[sd]?)\s*#\d+\b/i.test(body);
            if (!hasIssueReference) {
              errors.push('Issue参照（例: `Closes #171`）が見つかりません。');
            }

            const hasCodexReviewCheck = /- \[[xX]\]\s*bocchan bot で Codex レビュー依頼コメントを投稿済み/.test(
              body,
            );
            if (!hasCodexReviewCheck) {
              errors.push(
                '`## Codexレビュー依頼（必須）` のチェックボックスが未チェックです。bocchan bot での依頼後に更新してください。',
              );
            }

            const reviewCommentUrlPattern =
              /レビュー依頼コメントURL:\s*(?:\[[^\]]+\]\()?(https:\/\/github\.com\/[^/\s)]+\/[^/\s)#]+\/pull\/\d+#issuecomment-\d+)(?:\))?/i;
            if (!reviewCommentUrlPattern.test(body)) {
              errors.push(
                '`レビュー依頼コメントURL` が未入力です。bocchan bot が投稿した PR コメント URL を記載してください。',
              );
            }

            if (/\n1\.\s*\n2\.\s*\n3\.\s*(?:\n|$)/m.test(body)) {
              errors.push('`## テスト手順` が未記入です。1-3 の手順を具体化してください。');
            }

            if (errors.length > 0) {
              core.setFailed(
                `PRテンプレート準拠チェックに失敗しました:\n- ${errors.join('\n- ')}`,
              );
              return;
            }

            core.info('PRテンプレート準拠チェックに成功しました。');
