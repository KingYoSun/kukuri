name: GitHub -> Discord Hook
on:
  issues:
    types: [opened, edited, reopened]
  issue_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request_review_comment:
    types: [created]
  workflow_run:
    workflows: ["Test"]
    types: [completed]
concurrency:
  group: >-
    discord-hook-${{ github.workflow }}-${{ github.event_name }}-
    ${{ github.event.issue.node_id || github.event.pull_request.node_id || github.run_id }}-
    ${{ github.event.comment.id || github.event.review.id || github.event.issue.updated_at || github.event.pull_request.updated_at || github.run_attempt }}
  cancel-in-progress: false
jobs:
  notify:
    runs-on: ubuntu-latest
    # PR‰∏ä„ÅÆCodex/connector bot„É¨„Éì„É•„ÉºÈÄöÁü•„ÇÇÊµÅ„Åô„Åü„ÇÅ„ÄÅbotÈÄÅ‰ø°„ÇÇË®±ÂèØ„Åô„Çã
    env:
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
    steps:
      - name: Build message
        id: msg
        uses: actions/github-script@v7
        with:
          script: |
            const event = context.eventName;
            const p = context.payload;
            let title = "";
            let url = "";
            let actor = context.actor;
            let summary = "";

            if (event === "issues") {
              title = `[Issue ${p.action}] #${p.issue.number}: ${p.issue.title}`;
              url = p.issue.html_url;
              summary = (p.issue.body || "").slice(0, 200).replace(/\n/g, " ");
            } else if (event === "issue_comment") {
              title = `[Issue Comment] #${p.issue.number}: ${p.issue.title}`;
              url = p.comment.html_url;
              summary = (p.comment.body || "").slice(0, 200).replace(/\n/g, " ");
            } else if (event === "pull_request_review") {
              title = `[PR Review ${p.review.state}] #${p.pull_request.number}: ${p.pull_request.title}`;
              url = p.review.html_url || p.pull_request.html_url;
              summary = (p.review.body || "(no review body)").slice(0, 200).replace(/\n/g, " ");
            } else if (event === "pull_request_review_comment") {
              title = `[PR Review Comment] #${p.pull_request.number}: ${p.pull_request.title}`;
              url = p.comment.html_url;
              summary = (p.comment.body || "").slice(0, 200).replace(/\n/g, " ");
            } else if (event === "workflow_run") {
              const wr = p.workflow_run;
              const icon = wr.conclusion === "success" ? "‚úÖ" : wr.conclusion === "failure" ? "‚ùå" : wr.conclusion === "cancelled" ? "‚èπÔ∏è" : "‚ÑπÔ∏è";
              title = `${icon} [Workflow ${wr.conclusion || wr.status}] ${wr.name}`;
              url = wr.html_url;
              const branch = wr.head_branch || "unknown";
              const sha = (wr.head_sha || "").slice(0, 7);
              summary = `branch=${branch} sha=${sha} event=${wr.event} run_attempt=${wr.run_attempt}`;
            } else {
              title = `[${event}]`;
              url = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
              summary = "Unhandled event";
            }
            const content =
              `üì£ **${title}**\n` +
              `üë§ by: **${actor}**\n` +
              `üîó ${url}\n` +
              `üìù ${summary}\n\n` +
              `„Åº„Å£„Å°„ÇÉ„Çì: kukuri-dev-director„Çπ„Ç≠„É´„Å´Âæì„Å£„Å¶Ê¨°„ÅÆË°åÂãï„Å´Áßª„Å£„Å¶`;
            core.setOutput("content", content);
      - name: Send to Discord
        if: ${{ env.DISCORD_WEBHOOK_URL != '' }}
        env:
          WEBHOOK_URL: ${{ env.DISCORD_WEBHOOK_URL }}
          CONTENT: ${{ steps.msg.outputs.content }}
        run: |
          payload=$(jq -n --arg content "$CONTENT" '{content: $content, flags: 4}')
          curl -sS -X POST "$WEBHOOK_URL" \
          -H "Content-Type: application/json" \
          -d "$payload"
      - name: Skip Discord POST (webhook not configured)
        if: ${{ env.DISCORD_WEBHOOK_URL == '' }}
        run: echo "DISCORD_WEBHOOK_URL is empty; skipping Discord notification."
