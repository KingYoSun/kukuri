# kukuri テスト環境用 Dockerfile
# Rust と Node.js の両方の環境を含むマルチステージビルド

FROM rust:1.89-bookworm AS test-env

# 基本的なシステムパッケージのインストール
RUN set -eux; \
    if [ -f /etc/apt/sources.list ]; then \
      sed -i 's|http://deb.debian.org|https://deb.debian.org|g' /etc/apt/sources.list; \
    fi; \
    if [ -f /etc/apt/sources.list.d/debian.sources ]; then \
      sed -i 's|http://deb.debian.org|https://deb.debian.org|g' /etc/apt/sources.list.d/debian.sources; \
    fi; \
    for attempt in 1 2 3 4 5; do \
      apt-get update -o Acquire::Retries=3 -o Acquire::http::Timeout=30 -o Acquire::https::Timeout=30 && \
      apt-get install -y --no-install-recommends \
        build-essential \
        pkg-config \
        libssl-dev \
        libsqlite3-dev \
        libwebkit2gtk-4.1-dev \
        webkit2gtk-driver \
        libgtk-3-dev \
        libayatana-appindicator3-dev \
        librsvg2-dev \
        xvfb \
        xauth \
        curl \
        wget \
        file \
        git \
      && break; \
      if [ "$attempt" -eq 5 ]; then \
        exit 1; \
      fi; \
      echo "apt bootstrap failed (attempt ${attempt}), retrying..." >&2; \
      rm -rf /var/lib/apt/lists/*; \
      sleep 15; \
    done; \
    rm -rf /var/lib/apt/lists/*
# Node.js 20.x のインストール
RUN set -eux; \
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -; \
    for attempt in 1 2 3; do \
      apt-get update -o Acquire::Retries=3 -o Acquire::http::Timeout=30 -o Acquire::https::Timeout=30 && \
      apt-get install -y --no-install-recommends nodejs \
      && break; \
      if [ "$attempt" -eq 3 ]; then \
        exit 1; \
      fi; \
      echo "nodejs install failed (attempt ${attempt}), retrying..." >&2; \
      rm -rf /var/lib/apt/lists/*; \
      sleep 10; \
    done; \
    rm -rf /var/lib/apt/lists/*

# pnpm のインストール
RUN npm install -g pnpm@9

# Rust の追加コンポーネント
RUN rustup component add rustfmt clippy

# cargo-tarpaulin を導入（Rustカバレッジ計測用）
RUN cargo install cargo-tarpaulin --locked --version 0.33.0
RUN cargo install tauri-driver --locked

# 作業ディレクトリの設定
WORKDIR /app

# プロジェクトファイルのコピー（キャッシュ効率を考慮）
# package.json と lockfile を先にコピー
COPY kukuri-tauri/package.json kukuri-tauri/pnpm-lock.yaml ./kukuri-tauri/

# Node.js 依存関係のインストール
WORKDIR /app/kukuri-tauri
RUN pnpm install --frozen-lockfile --ignore-workspace

# Cargo.toml と Cargo.lock を先にコピー（Rust依存関係のキャッシュ）
WORKDIR /app
COPY kukuri-tauri/src-tauri/Cargo.toml ./kukuri-tauri/src-tauri/
COPY kukuri-tauri/src-tauri/Cargo.lock ./kukuri-tauri/src-tauri/
COPY kukuri-tauri/src-tauri/build.rs ./kukuri-tauri/src-tauri/
COPY kukuri-tauri/src-tauri/tauri.conf.json ./kukuri-tauri/src-tauri/
COPY kukuri-tauri/src-tauri/migrations ./kukuri-tauri/src-tauri/migrations
# Rust依存関係の解決を事前に行い、ビルドキャッシュを有効活用する
WORKDIR /app/kukuri-tauri/src-tauri
RUN mkdir src \
    && printf 'fn main() {}\n' > src/main.rs \
    && printf 'pub fn dummy() {}\n' > src/lib.rs \
    && cargo fetch --locked \
    && rm -rf src

WORKDIR /app
COPY kukuri-tauri/src-tauri/.sqlx ./kukuri-tauri/src-tauri/.sqlx

# 残りのプロジェクトファイルをコピー（.dockerignoreで除外されたものを除く）
WORKDIR /app
COPY . .

# Windows ホストでも entrypoint の実行権限を維持する
RUN chmod +x scripts/docker/ts-test-entrypoint.sh

# SQLiteテスト用のディレクトリ設定と権限付与
RUN mkdir -p /tmp && chmod 777 /tmp
ENV DOCKER_ENV=1

# テスト実行用のスクリプトを作成
RUN install -Dm755 scripts/docker/run-tests.sh /app/run-tests.sh
RUN install -Dm755 scripts/docker/run-smoke-tests.sh /app/run-smoke-tests.sh
RUN install -Dm755 scripts/docker/run-post-delete-cache.sh /app/run-post-delete-cache.sh
RUN install -Dm755 scripts/docker/run-desktop-e2e.sh /app/run-desktop-e2e.sh

# デフォルトコマンド
CMD ["/app/run-smoke-tests.sh"]
