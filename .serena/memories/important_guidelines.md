# 重要なガイドラインとパターン

## コア設計原則

### 1. オフラインファースト設計
- ローカルファーストデータ管理
- 楽観的UI更新
- 同期と競合解決
- オフライン時のUI/UX考慮

### 2. セキュリティファースト
- 秘密鍵は必ずセキュアストレージに保存
- メモリに秘密鍵を保持しない
- 暗号化通信（AES-256-GCM）
- メッセージ署名検証（secp256k1）

### 3. 分散型アーキテクチャ
- P2P通信（iroh-gossip）
- Nostrプロトコル準拠
- トピックベースのゴシップ配信
- ハイブリッド配信メカニズム

## 実装時の参照先

### 必須参照ドキュメント
1. **zustand**: テスト実装前に公式ドキュメント（https://zustand.docs.pmnd.rs/guides/testing）を参照
2. **zustandテスト**: `docs/03_implementation/zustand_testing_best_practices.md`を必ず参照
3. **iroh-gossip**: 実装前に公式ドキュメント（https://docs.rs/iroh-gossip/latest/iroh_gossip/）を参照
4. **iroh**: 実装前に公式ドキュメント（https://docs.rs/iroh/latest/iroh/）を参照

### Nostr互換性
- **NIP準拠**: 実装前に`docs/nips/`内の該当NIPを確認
- **標準仕様**: 新機能実装前に関連NIPの存在を確認
- **互換性**: 実装がNIP仕様に準拠しているか検証
- **拡張**: 独自拡張時は標準との違いを文書化

## 特別な注意事項

### Windows環境での開発
- keyringライブラリには`windows-native`フィーチャーを有効化
- パス区切りはバックスラッシュ（\）
- PowerShellまたはコマンドプロンプトを使用
- WSL環境では一部機能に制限あり

### エラーハンドリング規約
- フロントエンド: `console.error`は使用禁止
- 必ず`errorHandler`を使用
- エラーコンテキストを明確に記載
- ユーザーへの適切なフィードバック

### テスト戦略
- 新機能には必ずテストを追加
- 単体テスト + 統合テスト
- モック実装時は公式ドキュメントを参照
- フロントエンド: 517件以上のテスト維持
- バックエンド: 156件以上のテスト維持

## 現在のフォーカスエリア

### Phase 3.3（進行中）
- ブースト機能（リポスト）
- ブックマーク機能
- カスタムリアクション絵文字

### Phase 4（計画済み）
- ローカルファーストデータ管理
- DBスキーマ拡張
- オフラインストレージAPI
- 楽観的UI更新
- 同期と競合解決
- Service Worker実装

### MVP後の改善項目
- ローカルファーストDB実装
- 予約投稿のバックエンド
- 検索機能の拡張
- パフォーマンステスト実装

## コマンド実行優先順位
1. 型チェック: `pnpm type-check`
2. リント: `pnpm lint`, `cargo clippy`
3. テスト: `pnpm test`, `cargo test`
4. フォーマット: `pnpm format`, `cargo fmt`

これらを必ず実行してからタスクを完了とする。