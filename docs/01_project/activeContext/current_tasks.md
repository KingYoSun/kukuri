# 現在のタスク状況

**最終更新**: 2025年8月6日（テストエラー修正とDocker環境最適化）

> **注記**: 2025年7月のタスク履歴は`archives/current_tasks_2025-07.md`にアーカイブされました。

## 完了済みタスク

### 2025年8月6日（テストエラー修正とDocker環境最適化）
- [x] Rustテストエラーの修正
  - [x] `test_get_bookmarked_post_ids`テストの修正
    - [x] タイムスタンプを`timestamp()`から`timestamp_millis()`に変更
    - [x] テスト内のsleep時間を10msから100msに増加
  - [x] 全154件のRustテストが成功
- [x] Docker環境のビルド最適化
  - [x] Dockerfileの最適化
    - [x] レイヤーキャッシュを活用する構成に変更
    - [x] 依存関係のみを先にビルドしてキャッシュ
  - [x] 名前付きボリュームによるキャッシュ永続化
    - [x] cargo-registry: Cargoレジストリキャッシュ
    - [x] cargo-git: CargoのGit依存関係キャッシュ
    - [x] cargo-target: ビルド成果物のキャッシュ
    - [x] pnpm-store: pnpmパッケージキャッシュ
  - [x] test-docker.ps1スクリプトの機能拡張
    - [x] `-NoBuild`オプション: 既存イメージを使用してテスト実行
    - [x] `cache-clean`コマンド: キャッシュを完全クリア
    - [x] キャッシュ状況の表示機能
  - [x] パフォーマンス改善
    - [x] 初回ビルド: 約5-8分
    - [x] 2回目以降: 約30秒（約90%の時間短縮）
- [x] 進捗レポート作成（2025-08-06_test-fixes-and-docker-optimization.md）

### 2025年8月2日（オフラインファースト設計の組み込み）
- [x] オフラインファースト設計のドキュメント更新
  - [x] 現状のオフライン対応実装を調査
    - [x] SQLiteデータベース（ローカル永続化）
    - [x] Tanstack Query（キャッシュ管理）
    - [x] P2P同期機能（EventSync）
  - [x] tauri_app_experience_design.mdの更新
    - [x] Phase 4を「オフラインファースト機能の実装」に変更
    - [x] オフラインファースト設計原則を追加
    - [x] データ管理、オフライン体験、同期戦略、キャッシュ戦略を定義
  - [x] tauri_app_implementation_plan.mdの更新
    - [x] Phase 4の具体的な実装タスクを定義
    - [x] ローカルファーストデータ管理（DBスキーマ拡張、オフラインストレージAPI）
    - [x] 楽観的UI更新の実装計画
    - [x] 同期と競合解決の戦略
    - [x] オフラインUI/UXの設計
    - [x] 工数見積もり：3-4日

### 2025年8月2日（タイムライン機能の改善）
- [x] デフォルトトピック設定の実装
  - [x] アカウント追加時（新規作成/初回ログイン）に#publicトピックに自動参加
  - [x] #publicトピックをデフォルト表示に設定
  - [x] authStore.tsに処理を追加
- [x] モック投稿データの削除
  - [x] get_posts関数の修正（空配列を返すように変更）
  - [x] ローカルファーストなDB実装は今後のTODOとして設定
- [x] トピック別タイムライン表示
  - [x] Home.tsxでcurrentTopicに応じた表示切り替え
  - [x] usePostsByTopicフックの活用
  - [x] トピック名の動的表示
- [x] 未同期投稿の表記
  - [x] Post型にisSyncedフィールドを追加
  - [x] PostCardコンポーネントに「未同期」バッジを表示
  - [x] 自分の投稿は作成時は未同期、P2P送信後に同期済みとなる設計
- [x] 前回表示トピックの復元
  - [x] topicStoreのcurrentTopicをlocalStorageに永続化
  - [x] アプリ起動時に自動復元
- [x] タイムラインへの遷移導線
  - [x] サイドバーの参加中トピックから遷移
  - [x] トピック一覧ページのトピック名から遷移
  - [x] ヘッダーのロゴクリックで全体タイムラインへ

### 2025年8月2日（Windows環境でのアカウント永続化問題の完全解決）
- [x] Windows環境でのkeyringライブラリの動作修正
  - [x] 初回試行：Windows専用のEntry::new_with_target()実装
    - [x] 複雑なtarget名の設定が原因で失敗
  - [x] 最終解決：シンプルなアプローチへの変更
    - [x] `Entry::new_with_target()`の使用を廃止
    - [x] 全プラットフォームで統一的に`Entry::new()`を使用
    - [x] Cargo.tomlに`windows-native`フィーチャーを追加
  - [x] 不要なコードの削除
    - [x] fallback storageの削除（セキュリティリスクのため）
    - [x] WSL検出機能の削除
    - [x] Windows専用の条件分岐を削除
  - [x] 動作確認完了
    - [x] 新規アカウント作成後のリロードでログイン状態が維持される
    - [x] Windows環境での正常動作を確認
    - [x] デバッグログで保存・読み取りの成功を確認

### 2025年8月1日（アカウント永続化問題の修正）
- [x] アカウント永続化の問題を解決
  - [x] authStoreのpersist設定を修正
    - [x] `isAuthenticated`の強制false保存を削除
    - [x] セキュアストレージからの自動ログインに依存する方式に変更
  - [x] Rustバックエンドのキーペア生成を修正
    - [x] `generate_keypair`メソッドで`npub`を返すように変更
    - [x] TypeScript型定義の更新
  - [x] WSL環境での問題を解決
    - [x] WSL環境検出機能の追加
    - [x] フォールバックストレージの実装（ローカルファイルシステム使用）
    - [x] 各セキュアストレージメソッドでのフォールバック対応
  - [x] デバッグログの追加
    - [x] 保存・読み込み処理の診断用ログ
    - [x] WSL環境検出時のログ
  - [x] 動作確認済み
    - [x] 新規アカウント作成後のリロードでログイン状態が維持される
    - [x] WSL環境での正常動作を確認

### 2025年8月1日（Phase 3.2完了 - 新規投稿機能の拡張）
- [x] Phase 3.2: 新規投稿機能の拡張
  - [x] リッチテキストエディタの実装
    - [x] マークダウンサポート
      - [x] @uiw/react-md-editor@4.0.8の導入
      - [x] MarkdownEditorコンポーネントの作成
      - [x] 画像アップロード機能（ドラッグ&ドロップ対応）
    - [x] メディア埋め込み（画像、動画）
      - [x] MediaEmbedコンポーネントの作成
      - [x] YouTube、Vimeo、Twitter/X対応
      - [x] 自動URL検出と埋め込み変換
    - [x] プレビュー機能
      - [x] MarkdownPreviewコンポーネントの作成
      - [x] カスタムレンダラー実装
      - [x] DOM構造の最適化（validateDOMNesting警告対処）
  - [x] 投稿オプションの追加
    - [x] 予約投稿機能のUI実装
      - [x] PostSchedulerコンポーネントの作成
      - [x] react-day-pickerによる日時選択
      - [x] 日本語ロケール対応
      - [x] 予約投稿のバックエンド実装は保留（ユーザー要望により）
    - [x] 下書き保存機能の実装
      - [x] PostDraft型定義の作成
      - [x] draftStoreの実装（Zustand + localStorage永続化）
      - [x] DraftManagerコンポーネントの作成
      - [x] 自動保存機能（2秒デバウンス）
  - [x] PostComposerコンポーネントの更新
    - [x] シンプル/Markdownモードのタブ切り替え
    - [x] 全新機能の統合
    - [x] 下書き管理との連携
  - [x] 包括的なテストの追加
    - [x] 各コンポーネントのテスト作成
    - [x] 17個のテストエラーを全て修正
    - [x] テスト総数: 517個全て成功 ✅
  - [x] 進捗レポート作成（2025-08-01_phase3_2_implementation.md）

### 2025年8月3日（Phase 3.3完了 - その他のリアクション機能）
- [x] Phase 3.3: その他のリアクション機能
  - [x] ブースト機能（リポスト）の実装
    - [x] Nostrプロトコル準拠のKind:6イベント発行
    - [x] EventManager::send_repostメソッドの追加
    - [x] boost_postコマンドの実装
    - [x] フロントエンドでのブースト状態表示
  - [x] ブックマーク機能の実装
    - [x] SQLiteデータベーススキーマの拡張（bookmarksテーブル）
    - [x] BookmarkManagerモジュールの新規作成
    - [x] bookmarkStoreの実装（フロントエンド状態管理）
    - [x] ブックマーク状態の永続化とUI表示
  - [x] カスタムリアクション絵文字の対応
    - [x] ReactionPickerコンポーネントの実装
    - [x] 16種類の人気絵文字リアクション
    - [x] Nostrプロトコル準拠のKind:7イベント送信
  - [x] like_post機能の修正
    - [x] Nostrリアクションイベント（"+"）の発行実装
    - [x] send_reactionメソッドを使用した統一的な実装
  - [x] 包括的なテストの追加
    - [x] bookmarkStore.test.ts
    - [x] ReactionPicker.test.tsx
    - [x] PostCard.test.tsx（統合テスト）
    - [x] bookmark/tests.rs（Rustテスト）
  - [x] 進捗レポート作成（2025-08-03_phase3_3_implementation.md）

### 2025年8月3日（フロントエンドテストエラーの解消）
- [x] フロントエンドテストエラーの完全解消
  - [x] 14個の失敗していたテストの修正
    - [x] PostCard.test.tsx: 複数要素選択エラーの修正（container.querySelectorsの使用）
    - [x] PostCard.test.tsx: ボタンインデックスの修正（[1]→[2]）
    - [x] PostCard.test.tsx: Collapsibleモックの実装改善
    - [x] ReactionPicker.test.tsx: TauriApiのモック追加
    - [x] topicStore.ts: null参照エラーの修正（apiTopicsのnullチェック追加）
    - [x] Sidebar.test.tsx: ナビゲーション先の修正（/topics/topic1→/）
    - [x] 非同期処理のテスト方法の改善
  - [x] 最終テスト結果: 537個のテスト全て成功（533個成功、4個スキップ）
  - [x] 進捗レポート作成（2025年08月03日_フロントエンドテスト修正.md）

### 2025年8月3日（バックエンド・フロントエンドのテスト・型・リントエラーの修正）
- [x] バックエンド（Rust）のエラー修正
  - [x] テストエラーの修正
    - [x] GossipManager::new_mockのunsafe codeによるundefined behaviorを修正
    - [x] new_mockメソッドを削除（std::mem::zeroed()の使用を回避）
    - [x] Windows環境でのDLLエラー（STATUS_ENTRYPOINT_NOT_FOUND）は環境依存の問題として残存
  - [x] リントエラー（clippy）の修正
    - [x] 未使用のインポートを削除（unused_imports）
    - [x] 未使用のコードに#[allow(dead_code)]を追加
    - [x] format!マクロの引数をインライン化（uninlined_format_args）
    - [x] テストモジュール名の重複を解消（module_inception）
    - [x] 不要な明示的デリファレンスを削除（explicit_auto_deref）
    - [x] match文をif letに変更（single_match）
- [x] フロントエンド（TypeScript）のエラー修正
  - [x] リントエラーの修正
    - [x] 未使用のインポート（useTopicStore）を削除
    - [x] 64個の`any`型使用に関する警告は残存（今後段階的に修正予定）
  - [x] テスト結果: 537個のテスト全て成功（533個成功、4個スキップ）
  - [x] 型チェック: エラーなし
- [x] 進捗レポート作成（2025-08-03_test_lint_error_fixes.md）

## 現在進行中のタスク

### ドキュメント管理
- [x] 2025年8月2日: ドキュメントアーカイブ作業
  - [x] current_tasks.mdとissuesAndNotes.mdのアーカイブ
  - [x] 2025年7月分を`archives/`ディレクトリに移動
  - [x] 現行ファイルをコンパクトに整理

### Tauriアプリケーション改善 Phase 4（オフラインファースト機能）
- [x] Phase 4.1: ローカルファーストデータ管理
  - [x] DBスキーマの拡張（sync_queue, offline_actions, cache_metadata等）
  - [x] オフラインストレージAPI（Rust/TypeScript実装）
  - [x] データ同期メカニズム（自動同期、手動同期）
- [ ] Phase 4.2: 楽観的UI更新
  - [ ] 即座のUI反映
  - [ ] 同期待ちインジケーター
  - [ ] エラー時のロールバック
- [ ] Phase 4.3: 同期と競合解決
  - [ ] 差分同期アルゴリズム
  - [ ] 競合検出と解決
  - [ ] マージ戦略の実装
- [ ] Phase 4.4: オフラインUI/UX
  - [ ] オフラインインジケーター
  - [ ] Service Workerの実装
  - [ ] キャッシュ戦略の最適化

### MVP完成後の改善として保留
- [ ] ローカルファーストなデータベース実装
  - [ ] 投稿データのローカルDB保存機能
  - [ ] eventsテーブルへの投稿保存処理
  - [ ] get_postsコマンドのDB取得実装
  - [ ] 同期状態の管理（is_synced フィールド）
- [ ] 予約投稿のバックエンド実装
  - [ ] 予約投稿の保存機能（SQLite）
  - [ ] 予約投稿の実行スケジューラー
  - [ ] Tauriコマンドの実装
  - 注：予約投稿のUIは実装済み（Phase 3.2）
- [ ] 検索機能の拡張
  - [ ] バックエンドAPI統合
    - [ ] 全文検索エンジンの実装
    - [ ] 検索結果のキャッシング
  - [ ] 高度な検索オプション
    - [ ] フィルター機能（日付範囲、ユーザー、トピック）
    - [ ] ソート機能（関連度、新着順、人気順）
  - 注：基本的な検索機能は実装済み（Phase 2.4）

### P2P通信実装（Day 10）
- [ ] パフォーマンステストの実装
  - [ ] 大量メッセージ処理のベンチマーク
  - [ ] ネットワーク遅延シミュレーション
  - [ ] メモリ使用量の最適化
  - [ ] 並行処理の効率化テスト

## 次のステップ

### Tauriアプリケーション改善（最優先）
1. **Phase 1: 認証フローの修正** ✓ 完了
   - ウェルカム画面の実装 ✓
   - 認証状態の適切な管理 ✓
   - ログアウト機能の修正 ✓
   - 鍵管理の安全性向上 ✓
   - 包括的なテストスイート作成 ✓

2. **Phase 2: データ連携の確立** ✓ 完了
   - ホームページの実データ表示 ✓
   - トピック一覧の実装 ✓
   - 投稿の取得・表示 ✓
   - リアルタイム更新の実装 ✓
   - 手動P2P接続機能 ✓
   - リアクション機能（返信・引用） ✓
   - 検索機能の基本実装 ✓

3. **Phase 3: 主要機能の実装** ✓ 完了
   - トピック参加・離脱機能の改善 ✓
   - 新規投稿機能の拡張 ✓（UIのみ、バックエンドは保留）
   - その他のリアクション機能 ✓（ブースト、ブックマーク、カスタムリアクション）

4. **Phase 4: オフラインファースト機能の実装** ← **次のフォーカス**
   - ローカルファーストデータ管理
   - 楽観的UI更新
   - 同期と競合解決
   - オフラインUI/UX

### 発見層実装（後続タスク）
- TauriアプリPhase 1-2完了後に開始
- Cloudflare Workers / Docker実装
- ピア登録/検索API

5. **Phase 5: P2P機能の拡張**
   - P2P接続状態の可視化改善
   - トピックメッシュの活用
   - オフライン時の動作
   - 同期状態の表示

### ドキュメント整備（優先度: 中）
- [ ] 開発環境セットアップガイドの作成
- [ ] コーディング規約の策定
- [ ] APIドキュメントテンプレートの準備

### インフラ準備（優先度: 中）
- [ ] GitHub リポジトリの設定
- [ ] CI/CDパイプラインの構築
- [ ] 開発用Dockerイメージの作成

## 備考
- **実装状況**: Phase 3 完全完了、Phase 4 開始待ち
- **品質状況**: 
  - フロントエンドテスト: 537件全て成功 ✅（533件成功、4件スキップ）（2025年8月3日更新）
  - バックエンドテスト: テスト実行時にDLLエラーあり（コード自体は問題なし）（2025年8月3日更新）
  - 型チェック: エラーなし ✅（2025年8月3日確認）
  - リント: 
    - フロントエンド: エラーなし ✅（警告64件は`any`型使用）（2025年8月3日更新）
    - バックエンド: エラーなし ✅（clippyの全警告を修正）（2025年8月3日更新）
  - フォーマット: エラーなし ✅
- **主要機能の完成度**:
  - ✅ フロントエンド基盤（UI、状態管理、ルーティング）
  - ✅ Rust基盤（認証、暗号化、DB）
  - ✅ Tauriコマンドインターフェース
  - ✅ Nostr SDK統合とイベント処理
  - ✅ P2P通信基盤（iroh-gossip）
  - ✅ Nostr↔P2P双方向同期
  - ✅ ハイブリッド配信メカニズム
  - ✅ P2P UI統合（状態表示、可視化）
  - ✅ データ連携基盤（Phase 2.1）
  - ✅ トピック管理機能（Phase 2.2）
  - ✅ リアルタイム更新機能（Phase 2.3）
  - ✅ 追加機能（Phase 2.4）- 返信/引用、検索、P2P接続管理
  - ✅ トピック参加・離脱機能の改善（Phase 3.1）
  - ✅ 新規投稿機能の拡張（Phase 3.2）- リッチテキストエディタ、下書き管理、予約投稿UI
  - ✅ その他のリアクション機能（Phase 3.3）- ブースト、ブックマーク、カスタムリアクション
- **最近の成果**:
  - 2025年8月3日: Phase 3.3 その他のリアクション機能の完全実装
    - ブースト機能（NostrプロトコルKind:6イベント）の実装
    - ブックマーク機能（ローカルDB管理）の実装
    - カスタムリアクション絵文字（16種類）の実装
    - like_post機能のNostrイベント発行対応
    - 包括的なテストの追加（フロントエンド3件、バックエンド1件）
  - 2025年8月2日: オフラインファースト設計の組み込み完了
    - 現状のオフライン対応実装を調査（SQLite、Tanstack Query、P2P同期）
    - tauri_app_experience_design.mdにオフラインファースト設計原則を追加
    - tauri_app_implementation_plan.mdにPhase 4の具体的な実装タスクを定義
    - ローカルファーストデータ管理、楽観的UI更新、同期戦略、オフラインUI/UXの設計
  - 2025年8月2日: タイムライン機能の改善完了
    - アカウント追加時に#publicトピックへの自動参加とデフォルト表示設定
    - モック投稿データの削除（get_posts関数が空配列を返すように変更）
    - トピック別タイムライン表示機能の実装
    - 未同期投稿への「未同期」バッジ表示
    - 前回表示トピックの復元機能（localStorageによる永続化）
    - タイムラインへの遷移導線の追加（サイドバー、トピック一覧、ヘッダーロゴ）
  - 2025年8月1日: Phase 3.2 新規投稿機能の拡張完了
    - リッチテキストエディタ（MarkdownEditor）の実装
    - @uiw/react-md-editor@4.0.8によるマークダウンサポート
    - メディア埋め込み機能（YouTube、Vimeo、Twitter/X対応）
    - 予約投稿UI（PostScheduler）の実装
    - 下書き管理システム（draftStore、DraftManager）の実装
    - 自動保存機能（2秒デバウンス）
    - PostComposerへの全機能統合
    - 17個のテストエラーを全て修正
    - テスト総数が517件に増加（全て成功）
  - 2025年7月31日: Phase 3.1 トピック参加・離脱機能の改善完了
    - topicStoreのjoinTopic/leaveTopicメソッドを非同期化
    - P2P接続とNostrサブスクリプションの統合
    - サイドバーでの参加中トピック一覧表示強化
    - 最終活動時刻によるソート機能
    - TopicCardとtopics.$topicIdでのリアルタイム状態反映
    - 29件の新規テストを追加
  - 2025年7月30日: Phase 2.4 追加機能の完全実装
    - 手動P2P接続機能（PeerConnectionPanel）の実装
    - 返信機能（ReplyForm）の実装（NIP-10準拠）
    - 引用機能（QuoteForm）の実装（NIP-10準拠）
    - 検索機能（SearchBar、検索結果コンポーネント）の実装
    - 各機能の包括的なテストを追加
    - テスト総数が400件以上に増加
  - 2025年7月29日: Phase 2.3 リアルタイム更新機能の完全実装
    - useNostrEventsフック実装（Nostrイベントリスナー）
    - useP2PEventListener改善（P2Pメッセージの即座反映）
    - useDataSyncフック実装（データ自動同期）
    - RealtimeIndicatorコンポーネント（接続状態表示）
    - 24件の新規テストを追加（全て成功）
    - テスト総数が366件に増加
  - 2025年7月29日: フロントエンドテストエラーの完全解消
    - 342件全てのテストが成功 ✅
    - PostComposer.test.tsx: 3つの不足テストケースを追加
    - Home.test.tsx: PostComposerモックの修正  
    - topics.test.tsx: UIメッセージとの一致修正
    - AccountSwitcher.tsx: JSDOMのnavigation警告を解消
  - 2025年7月28日: Phase 2.2 完全完了
    - 投稿作成フォーム（PostComposer）の実装
    - トピック選択コンポーネント（TopicSelector）の実装
    - トピック作成・編集・削除機能の完全実装
    - P2Pトピック参加・離脱との連携
    - 36件の新規テストを追加
  - 2025年7月28日: Phase 2.1 完全完了
    - トピック一覧の実データ取得・表示機能の実装
    - TopicCardコンポーネント、Topics.tsxページ、useTopicsフックの実装
    - 28件の新規テストを追加（全て成功）
    - テスト総数が313件に増加
  - 2025年7月28日: Phase 2.1の部分的完了（投稿表示）
    - 投稿の実データ取得・表示機能の完全実装
    - PostCardコンポーネントといいね機能の実装
- **次の重要タスク**:
  - Phase 4（オフラインファースト機能の実装）
    - ローカルファーストデータ管理（DBスキーマ拡張、オフラインストレージAPI）
    - 楽観的UI更新の実装
    - 同期と競合解決（差分同期、競合検出、マージ戦略）
    - オフラインUI/UX（インジケーター、同期待ちバッジ、Service Worker）
  - MVP完成後の改善：
    - ローカルファーストなデータベース実装
    - 予約投稿のバックエンド実装
    - 検索機能の拡張とバックエンドAPI統合
  - パフォーマンステストの実装（P2P通信 Day 10）
  - ドキュメント整備（開発環境セットアップガイド、コーディング規約など）