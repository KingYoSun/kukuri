# Phase 5 CI/ローカルスクリプト パス依存調査
最終更新日: 2025年10月31日

| 対象 | 現状参照パス／コマンド | 影響範囲 | 修正案 |
| --- | --- | --- | --- |
| `scripts/docker/run-smoke-tests.sh` | `cargo test --package kukuri-tauri --test p2p_gossip_smoke -- --nocapture --test-threads=1`<br>`cargo test --package kukuri-tauri --test p2p_mainline_smoke -- --nocapture --test-threads=1` | Docker スモークテストで新テストバイナリを並列実行。 | 2025年10月22日: フォールバックロジックを撤廃し、新バイナリを常に実行する構成へ更新済み。 |
| `scripts/test-docker.sh` | `./scripts/test-docker.sh p2p` / `./scripts/test-docker.sh performance` | ローカル Docker P2P テストに加え、性能ハーネス（ignored テスト）を `performance` サブコマンドで実行。 | 2025年10月22日: フォールバック削除・エイリアス追加を完了し、旧スモークバイナリへの依存を解消。<br>2025年10月31日: `performance` サブコマンドを追加し、計測結果を `test-results/performance/*.json` に保存。 |
| `scripts/test-docker.ps1` | `cargo test --package kukuri-tauri --test p2p_gossip_smoke`<br>`cargo test --package kukuri-tauri --test p2p_mainline_smoke`<br>`cargo test --package kukuri-tauri --test <target>`<br>`./scripts/test-docker.ps1 performance` | Windows 用 Docker テストでスモーク + 個別ターゲット + 性能ハーネスを切替。`performance` 実行時は `cargo test --test performance -- --ignored --nocapture` を呼び、成果物を `test-results/performance` に出力。 | 2025年10月22日: 新バイナリ固定化とログ整備を完了。<br>2025年10月30日: `-Test` オプションを追加し、`event_manager_integration` など個別テストを `./scripts/test-docker.ps1 rust -Test <target>` で実行可能にした。<br>2025年10月31日: `performance` コマンドを追加し、成果物出力先を PowerShell からも制御可能にした。 |
| `scripts/test-docker.{sh,ps1}` coverage コマンド | `./scripts/test-docker.sh coverage` → `docker compose run rust-coverage`（`cargo tarpaulin --locked --all-features --out Json --out Lcov --output-dir /app/test-results/tarpaulin`） | Rust カバレッジ測定を Docker 上で再現し、成果物を `docs/01_project/activeContext/artefacts/metrics/*.json/.lcov` に出力。 | 2025年10月26日: `rust-coverage` サービスを Compose に追加し、tarpaulin の JSON/LCOV を `test-results/tarpaulin` 経由で保存。Shell/PowerShell の両方から同一フローで呼び出せるようにした。 |
| `scripts/metrics/export-p2p.{sh,ps1}` | `cargo run --manifest-path kukuri-tauri/src-tauri/Cargo.toml --bin p2p_metrics_export -- --output <path>` | Gossip/Mainline メトリクスを JSON として保存し、CI から artefacts/metrics に収集する。 | 2025年10月27日: Phase 5 Workstream A/B のメトリクス要件に合わせて追加。`--pretty` を指定すると human readable。 |
| `docker-compose.test.yml` (`test-runner` / `rust-test`) | ボリューム: `./kukuri-tauri/src-tauri/src` / `./kukuri-tauri/src-tauri/tests` を read-only でマウント | Phase 5 で Rust テスト資産を `src-tauri/tests` へ集約しても、ローカル編集が即座に反映される。 | 2025年10月31日: `test-runner` と `rust-test` に加え `rust-coverage` へも `./kukuri-tauri/src-tauri/tests` のマウントを追加し、`docker_test_environment.md` / `windows_test_docker_runbook.md` に反映済み。 |
| GitHub Actions `test.yml`（Docker ジョブ） | `/app/run-tests.sh` → `cargo test --workspace`（`tests/` 配下の新バイナリを網羅実行） | `run-tests.sh` が Phase 5 更新後の `cargo test` を利用できるようにする必要がある。 | `run-tests.sh` 内で個別モジュールパスを指定しないため直接の修正は不要だが、P2P スモークを追加する際は `--test p2p_gossip_smoke` / `--test p2p_mainline_smoke` を明示する。 |
| `cargo clippy`（Rust Lint） | `kukuri-tauri/src-tauri`: `cargo clippy --workspace --all-features -- -D warnings`<br>`kukuri-cli`: `cargo clippy --workspace --all-features -- -D warnings` | Phase 5 のゲート条件として、Tauri アプリと CLI の双方で Clippy 警告ゼロを維持する。CI では共通ルートに `Cargo.toml` が無いため、各ディレクトリで明示的に呼び出す必要がある。 | 2025年10月31日: 両ディレクトリでコマンドを実行し、警告ゼロで完走することを確認。`lint` 系ジョブでは 2 回の `cargo clippy` を順番に呼ぶ手順を記載した。<br>2025年11月01日: 指示どおり `cargo clippy --all-features -- -D warnings` を kukuri-tauri/src-tauri と kukuri-cli の両方で再実行し、警告ゼロ継続を確認。CI lint ジョブにも kukuri-cli 向け Clippy 実行を追加済み。 |
