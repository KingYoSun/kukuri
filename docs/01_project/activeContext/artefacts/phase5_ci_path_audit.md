# Phase 5 CI/ローカルスクリプト パス依存調査
最終更新日: 2025年11月15日

## 2025年11月14日: Tauri API 棚卸しログ
- `add_relay` / `join_topic_by_name` / `delete_events` / `get_nostr_pubkey` を Tauri 側の `invoke_handler` とフロントエンド API から撤去し、`phase5_user_flow_inventory.md` / `phase5_user_flow_summary.md` / `phase5_feature_usage_map.md` で未導線リストを 0 件に更新。  
- `refactoring_plan_2025-08-08_v3.md:436-446` と `tasks/status/in_progress.md` へ棚卸し完了を反映し、今後は新コマンド追加時に同 artefact 群へ即ログを残すルールを明示。  
- `corepack pnpm vitest run src/tests/unit/lib/api/nostr.test.ts src/tests/unit/lib/api/p2p.test.ts` でラッパー更新を検証。Rust 側は `cargo test`（kukuri-tauri: `STATUS_ENTRYPOINT_NOT_FOUND` のため Docker ルートで補完、kukuri-cli: 成功）を実施。
- `scripts/check-tauri-commands.mjs` を追加し、`pnpm run check:tauri-commands | tee tmp/logs/check_tauri_commands_20251114-173522.log` で `#[tauri::command]` と UI 呼び出しの差異を自動検出できるようにした。2025年11月14日時点で 82/82 件が一致し、Add/Remove いずれの UI 作業でも本スクリプトを再実行してログを貼り付けることを義務付けた。  

## 2025年11月14日: Windows テスト実行ルール再定義
- PowerShell セッションで `pnpm test` / `cargo test` を直接叩くケースが散見されたため、Windows では **必ず** `./scripts/test-docker.ps1 <suite>` を介して Docker 内でテストを実行するルールを明文化した。  
- `./scripts/test-docker.ps1 all|rust|ts|lint|integration -Scenario <name>` の実行ログを `tmp/logs/*` に保存し、`STATUS_ENTRYPOINT_NOT_FOUND` / DLL ロードエラーを再発させない。  
- Linux/macOS、WSL2、または Docker コンテナ内部では従来どおり `pnpm test` / `cargo test` を利用できるが、Windows ホストでの直叩きは禁止。明示的なユーザー指示が無い限り例外を設けない。

| 対象 | 現状参照パス／コマンド | 影響範囲 | 修正案 |
| --- | --- | --- | --- |
| `scripts/docker/run-smoke-tests.sh` | `cargo test --package kukuri-tauri --test p2p_gossip_smoke -- --nocapture --test-threads=1`<br>`cargo test --package kukuri-tauri --test p2p_mainline_smoke -- --nocapture --test-threads=1` | Docker スモークテストで新テストバイナリを並列実行。 | 2025年10月22日: フォールバックロジックを撤廃し、新バイナリを常に実行する構成へ更新済み。 |
| `scripts/test-docker.sh` | `./scripts/test-docker.sh p2p` / `./scripts/test-docker.sh performance` | ローカル Docker P2P テストに加え、性能ハーネス（ignored テスト）を `performance` サブコマンドで実行。 | 2025年10月22日: フォールバック削除・エイリアス追加を完了し、旧スモークバイナリへの依存を解消。<br>2025年10月31日: `performance` サブコマンドを追加し、計測結果を `test-results/performance/*.json` に保存。 |
| `scripts/test-docker.ps1` | `cargo test --package kukuri-tauri --test p2p_gossip_smoke`<br>`cargo test --package kukuri-tauri --test p2p_mainline_smoke`<br>`cargo test --package kukuri-tauri --test <target>`<br>`./scripts/test-docker.ps1 performance` | Windows 用 Docker テストでスモーク + 個別ターゲット + 性能ハーネスを切替。`performance` 実行時は `cargo test --test performance -- --ignored --nocapture` を呼び、成果物を `test-results/performance` に出力。 | 2025年10月22日: 新バイナリ固定化とログ整備を完了。<br>2025年10月30日: `-Test` オプションを追加し、`event_manager_integration` など個別テストを `./scripts/test-docker.ps1 rust -Test <target>` で実行可能にした。<br>2025年10月31日: `performance` コマンドを追加し、成果物出力先を PowerShell からも制御可能にした。<br>2025年11月14日: `./scripts/test-docker.ps1 rust` を実行し、`tmp/logs/rust_docker_20251114.log` に 195 件すべて緑のログを保存。Windows 固有の `STATUS_ENTRYPOINT_NOT_FOUND` は Docker 経由で必ず回避するルールを再確認。 |
| `scripts/test-docker.{sh,ps1}` coverage コマンド | `./scripts/test-docker.sh coverage` → `docker compose run rust-coverage`（`cargo tarpaulin --locked --all-features --out Json --out Lcov --output-dir /app/test-results/tarpaulin`） | Rust カバレッジ測定を Docker 上で再現し、成果物を `docs/01_project/activeContext/artefacts/metrics/*.json/.lcov` に出力。 | 2025年10月26日: `rust-coverage` サービスを Compose に追加し、tarpaulin の JSON/LCOV を `test-results/tarpaulin` 経由で保存。Shell/PowerShell の両方から同一フローで呼び出せるようにした。 |
| `scripts/metrics/export-p2p.{sh,ps1}` | `cargo run --manifest-path kukuri-tauri/src-tauri/Cargo.toml --bin p2p_metrics_export -- --job <p2p|trending> --output <path> [--limit N] [--database-url <url>]` | Gossip/Mainline（job=p2p）と `topic_metrics` スナップショット（job=trending）を JSON として保存し、CI から artefacts/metrics / `test-results/trending-feed/metrics` に収集する。 | 2025年10月27日: Phase 5 Workstream A/B のメトリクス要件に合わせて追加。2025年11月10日: `--job trending` で `window_start_ms` / `window_end_ms` / `lag_ms` / `score_weights` / `topics[].score_24h` を含むレポートを生成し、MVP Exit チェックリスト #1（Summary Panel）で参照できるようにした。 |
| CLI ブートストラップ PoC ログ | PowerShell: `Start-Transcript -Path tmp/logs/relay_status_cli_bootstrap_<timestamp>.log`<br>Bash: `script -c \"pnpm tauri dev\" tmp/logs/relay_status_cli_bootstrap_<timestamp>.log` | `kukuri-cli --export-path` → `RelayStatus` → 「最新リストを適用」の PoC を Nightly/Ops で再現した際の証跡を共通フォーマットで保存し、Runbook Chapter10 と照合できる状態にする。 | 2025年11月12日: `tmp/logs/relay_status_cli_bootstrap_20251112-094500.log` を採取し、`docs/03_implementation/p2p_mainline_runbook.md` 10.3/10.4 へ手順を追記。今後は Nightly 成果物から同ログ（`cli_nodes_detected`・`apply_cli_bootstrap_nodes`・`Connected to bootstrap peer` を含む）をダウンロードし、`roadmap.md` Ops 行で共有する。 |
| `docker-compose.test.yml` (`test-runner` / `rust-test`) | ボリューム: `./kukuri-tauri/src-tauri/src` / `./kukuri-tauri/src-tauri/tests` を read-only でマウント | Phase 5 で Rust テスト資産を `src-tauri/tests` へ集約しても、ローカル編集が即座に反映される。 | 2025年10月31日: `test-runner` と `rust-test` に加え `rust-coverage` へも `./kukuri-tauri/src-tauri/tests` のマウントを追加し、`docker_test_environment.md` / `windows_test_docker_runbook.md` に反映済み。 |
| GitHub Actions `test.yml`（Docker ジョブ） | `/app/run-tests.sh` → `cargo test --workspace`（`tests/` 配下の新バイナリを網羅実行） | `run-tests.sh` が Phase 5 更新後の `cargo test` を利用できるようにする必要がある。 | `run-tests.sh` 内で個別モジュールパスを指定しないため直接の修正は不要だが、P2P スモークを追加する際は `--test p2p_gossip_smoke` / `--test p2p_mainline_smoke` を明示する。 |
| GitHub Actions `test.yml`（Native Test/Linux） | `kukuri-tauri/src-tauri`: `cargo test --workspace --all-features` / `cargo clippy --workspace --all-features -- -D warnings -A dead_code -A unused_variables`<br>`kukuri-cli`: `cargo test --workspace --all-features` / `cargo clippy --workspace --all-features -- -D warnings`<br>Cache: `~/.cargo/**`, `kukuri-tauri/src-tauri/target/`, `kukuri-cli/target/` | CLI のユニット/統合テストと Clippy を Linux ジョブで常時実行し、`kukuri-cli/tests/docker_connectivity.rs` など Phase 5 DHT 改修のリグレッションを即座に検知する。 | 2025年11月11日: Native ジョブへ CLI テストを追加し、Rust キャッシュに `kukuri-cli/target/` を含めるようにした。`cargo test --workspace --all-features` で CLI 内の ignored テストも起動され、`scripts/test-docker.ps1 rust` との手順差分を解消。<br>2025年11月13日: `trendingFixture.ts` の catch で未使用の `error` 変数が残り ESLint が `Native Test (Linux)` を落としていたため、`errorHandler.log` で例外を記録するよう修正。Windows では `cargo test` が DLL 依存で失敗するため `./scripts/test-docker.ps1 rust`（`kukuri-tauri/tmp/logs/test_docker_rust_20251113-232319.log`）で Rust テストを完走し、`kukuri-cli/tmp/logs/cargo_test_kukuri_cli_20251113-232450.log` で CLI の `cargo test --workspace --all-features` を取得。`gh act -W .github/workflows/test.yml -j native-test-linux --env CARGO_TEST_THREADS=1 --env RUST_TEST_THREADS=1` の成功ログを `kukuri-tauri/tmp/logs/gh_act_native_test_20251113-232538.log` に保存。 |
| GitHub Actions `test.yml`（Format Check） | `kukuri-tauri/src-tauri`: `cargo fmt -- --check`<br>`kukuri-cli`: `cargo fmt -- --check`<br>`kukuri-tauri`: `pnpm format:check` | これまで CLI 側の整形差分が GitHub Actions 上で検出されず、ローカル Clippy 実行時にのみ気付ける状態だった。 | 2025年11月11日: Format ジョブに `kukuri-cli` ディレクトリでの `cargo fmt -- --check` を追加し、CLI の Rust ファイルも Prettier/ESLint 相当のゲートで統一。<br>2025年11月13日: `DirectMessageDialog.test.tsx` / `profile.$userId.test.tsx` の Prettier 差分で `Format Check` が失敗したため、`corepack pnpm prettier --write` → `corepack pnpm format:check` を再実行し、ログを `kukuri-tauri/tmp/logs/format_check_20251113-230505.log` に保存。`gh act -W .github/workflows/test.yml -j format-check`（`kukuri-tauri/tmp/logs/gh_act_format_check_20251113-231020.log`）でローカル再現。 |
| GitHub Actions `test.yml`（Build Test/Windows） | `kukuri-tauri/src-tauri`: `cargo check --workspace --all-features`<br>`kukuri-cli`: `cargo check --workspace --all-features`<br>`kukuri-tauri`: `pnpm type-check` | Windows 環境固有の MSVC/WinHTTP 周辺で CLI のビルドが壊れても検出できなかった。 | 2025年11月11日: Windows ビルドジョブに CLI の `cargo check --workspace --all-features` を追加し、Tauri と CLI の両方で MSVC Toolchain のコンパイル確認を行うよう統一。 |
| `kukuri-cli` 単体テスト | `cargo test --workspace --all-features`（`parse_node_addr` / `export_bootstrap_list` / `load_bootstrap_peers_from_json` / `resolve_export_path` を検証） | CLI が参照するブートストラップ設定や NodeAddr パース仕様が壊れても CI で即座に検知できる。 | 2025年11月11日: 6 件のユニットテストを追加し、テーブル形式で NodeId/Peers/環境変数が正しく処理されるか確認できるようにした。次は `docker_connectivity_probe` もユニットテスト化し、`tests/docker_connectivity.rs` を `--ignored` ではなくシナリオ別に分割する。 |
| `tests/docker_connectivity.rs` | `cargo test --package kukuri-cli --test docker_connectivity`（`docker_connectivity_direct_no_dht` / `docker_connectivity_with_mdns`） | Docker 上で CLI の `bootstrap` + `connect` コンテナを実行し、DHT 無効・mDNS 有効それぞれのシナリオで接続確立を検証。CI でも常時実行され、失敗時は `docker compose up --abort-on-container-exit node_b` のログが残る。 | 2025年11月11日: 既存の `#[ignore]` テストを 2 シナリオへ分割し、`CONNECT_ARGS` 環境変数で `--no-dht` / `--mdns` / `--timeout` を切り替えられるようにした。`cargo test --workspace --all-features` で Docker シナリオが走ることを確認。 |
| `package.json` `test:unit` スクリプト | `pnpm test:unit` → `vitest run src/tests/unit` | フロントエンドのユニットテスト群を Phase 5 新規テスト（プロフィールアバター導線など）込みで一括実行。CI/ローカル双方で同一コマンドを呼び出せるように共通化。 | 2025年11月03日: `package.json` に `test:unit` を追加し、Nightly Frontend Unit Tests ワークフロー（cron: `0 15 * * *`）から `pnpm test:unit` を実行する構成を追加。`tauri_app_implementation_plan.md` と整合。<br>2025年11月06日: DM 未読バッジ・トレンド/フォロー導線・ユーザー検索のユニットテストを Inventory 5.7-5.10 / Summary 3 の結果と合わせて Nightly ワークフローへ反映し、`DirectMessageDialog` / `TrendingSummaryPanel` / `FollowingSummaryPanel` / `UserSearchResults` のケースを追加。<br>2025年11月08日: `Header.test.tsx`（Inbox/未読バッジ）・`useDirectMessageBadge.test.tsx`・`components/trending/TrendingSummaryPanel.test.tsx`・`components/following/FollowingSummaryPanel.test.tsx` に加え、`directMessages/DirectMessageInbox.test.tsx` を追加し、Nightly Frontend Unit Tests で DM 導線 CTA / 候補検索 / 既読フローの回帰を監視。<br>2025年11月09日: `components/SyncStatusIndicator.test.tsx`・`components/OfflineIndicator.test.tsx`・`components/RelayStatus.test.tsx` を Nightly 監視対象に追加し、`sync_queue` メタデータの表示（要求者/要求時刻/キュー ID）と Offline バナー/Runbook CTA を検証。Rust 側は `cargo test offline_handler::tests::add_to_sync_queue_records_metadata_entry` を `scripts/test-docker.ps1/sh rust` ルートに含め、手動再送キュー登録時の `cache_metadata` 永続化を CI で保証。<br>2025年11月10日: Inventory 5.9/5.10 対応で `TopicSelector.test.tsx` / `PostComposer.test.tsx` / `Sidebar.test.tsx` / `PostCard.test.tsx` を Nightly 対象へ追加。ローカルでは `pnpm` コマンドが存在せず `corepack pnpm` もシバン差異で失敗するため、CI 先行で検証し、実行環境の整備が必要である旨を in_progress.md に記録。 |
| `corepack pnpm` 構築 | `corepack enable pnpm && corepack pnpm --version` | `pnpm` バイナリが無い環境（Windowsホスト）でも `pnpm vitest` / `pnpm test:unit` を再現するための前提コマンド。 | 2025年11月10日: `cmd.exe /c "corepack enable pnpm"` で Windows 側の shim を初期化し、`cmd.exe /c "corepack pnpm --version"` で 10.16.1 を確認。`phase5_user_flow_summary.md` Ops/CI 行と Runbook に再現手順・ログ (`tmp/logs/corepack_setup_20251110013111.log`) を追記予定。 |
| プロフィール設定 + Avatar Stage3 テスト | `pnpm vitest run src/tests/unit/components/settings/ProfileEditDialog.test.tsx src/tests/unit/components/auth/ProfileForm.test.tsx src/tests/unit/components/auth/ProfileSetup.test.tsx` | Stage3（Doc/Blob + privacy 同期）の UI/状態遷移を検証。保存時の直列実行・ロールバック・プレビュー更新が想定どおりかを `ProfileForm` / `ProfileEditDialog` / `ProfileSetup` でカバーし、`phase5_user_flow_inventory.md` 5.1・Sec.6 と `tauri_app_implementation_plan.md` Phase4.4 を裏付ける。 | 2025年11月09日: corepack 有効化後にローカル実行可能になったため、Stage3 実装後は本コマンドを Nightly Frontend Unit Tests と `scripts/test-docker.ps1 ts -Tests ProfileEditDialog` に追加して回帰保証する。 |
| `profile_avatar_sync` Rust 結合テスト | `cargo test --package kukuri-tauri --test profile_avatar_sync`（Linux/macOS）<br>`./scripts/test-docker.ps1 rust -Test profile_avatar_sync`（Windows 迂回） | `ProfileAvatarService` の Upload→Export→Import→Fetch パスと Blob/Doc ticket の整合性に加え、Stage4 の Service Worker 経由で渡された `source/requested_at/retry_count/job_id` メタデータを `cache_metadata`（TTL 30分, `cache_key=doc::profile_avatar::<npub>`）へ記録できることを検証。 | 2025年11月12日: `profile_avatar_sync` コマンドを拡張し、Service Worker 発火分のメタデータを `cache_metadata`（Doc/Blob セクション）へ保存。`useProfileAvatarSync` は Service Worker job 成否を `offlineApi.addToSyncQueue` へ記録し、`ProfileAvatarSyncWorker.test.ts` で再送/バックオフをカバー。Docker/PowerShell の `ts -Scenario profile-avatar-sync --service-worker` で Stage4 ログ（`tmp/logs/profile_avatar_sync_stage4_<timestamp>.log`）と worker テストを取得し、Runbook Chapter4 / Inventory 5.1 に反映。 |
| `npx pnpm vitest run src/tests/unit/components/topics/TopicSelector.test.tsx …` | `npx pnpm vitest run src/tests/unit/components/topics/TopicSelector.test.tsx src/tests/unit/components/posts/PostComposer.test.tsx src/tests/unit/components/layout/Sidebar.test.tsx src/tests/unit/scenarios/topicCreateOffline.test.tsx \| Tee-Object -FilePath ../tmp/logs/topic_create_host_<timestamp>.log` | TopicSelector/PostComposer/Sidebar/`TopicFormModal`（Scenario）でトピック作成ショートカットと `OfflineActionType::CREATE_TOPIC` の UI 復帰を検証。`topicCreateOffline` ではオフライン送信時に `queueTopicCreation` / `watchPendingTopic` / toast が呼ばれることを保証する。 | 2025年11月12日: `tmp/logs/topic_create_host_20251112-231141.log` を採取し、Radix ref 警告を `Input` の `forwardRef` 化で解消。Nightly では同ログと `nightly.topic-create.host` テスト ID をセットで保存。Docker 版は `./scripts/test-docker.{sh,ps1} ts -Scenario topic-create [-NoBuild]` を呼び、`tmp/logs/topic_create_20251112-231334.log` と `test-results/topic-create/20251112-231334-*.json`（4 ファイル）を artefact 化する。 |
| Nightly / `gh act` ログの保存場所 | `tmp/logs/*.log` (`gh_act_native_20251109_postlint.log`, `docker_rust_test_20251109.log` など) | ローカルで実行した `gh act push` / `docker compose` / `scripts/test-docker.ps1` の結果を共有し、CI ブロッカーを可視化。 | 2025年11月09日: `tmp/logs/gh_act_native_20251109_postlint.log`, `tmp/logs/gh_act_format_20251109.log`, `tmp/logs/docker_rust_test_20251109.log` を作成。`tasks/status/in_progress.md` GitHub Actions セクションと `phase5_user_flow_summary.md` Ops/CI 行で参照。 |
| Docker シナリオ `trending-feed` | `./scripts/test-docker.sh ts --scenario trending-feed`<br>`.\scripts\test-docker.ps1 ts -Scenario trending-feed` | `/trending` `/following` ルート専用の Vitest セットを Docker 内で再現し、トレンドメトリクス/API 変更時のリグレッションを検出。Nightly Frontend Unit Tests の後段で実行し、`test-results/trending-feed/reports/*.json`（ユニットテストレポート）と `tmp/logs/trending-feed/latest.log`、`tmp/logs/trending_metrics_job_stage4_<timestamp>.log`（Prometheus 監視スナップショット）、および `test-results/trending-feed/metrics/<timestamp>-trending-metrics.json`（`p2p_metrics_export --job trending` 出力）を生成する。2025年11月12日以降は Prometheus ログを `test-results/trending-feed/prometheus/trending_metrics_job_stage4_<timestamp>.log` に複製し、CI artefact `trending-metrics-prometheus` からも取得可能。 | 2025年11月07日: シナリオ要件を整理（Docker で `pnpm vitest run src/tests/unit/routes/trending.test.tsx src/tests/unit/routes/following.test.tsx src/tests/unit/hooks/useTrendingFeeds.test.tsx` を実行。`VITE_TRENDING_FIXTURE_PATH` でフィクスチャを選択可能にし、既定は `tests/fixtures/trending/default.json`）。`scripts/test-docker.{sh,ps1}` に `--scenario/-Scenario` オプションを追加し、`ts` コマンドからシナリオを切替。Nightly ワークフローに `Trending Feed (Docker)` ジョブを追加し、失敗時は `phase5_ci_path_audit.md` へリンクしたアラートを残す。2025年11月10日: ローカルで `./scripts/test-docker.sh ts --scenario trending-feed --no-build` を実行し、`tmp/logs/trending-feed_20251110020528.log` を保存。2025年11月11日: `prometheus-trending` サービス自動起動と `tmp/logs/trending_metrics_job_stage4_<timestamp>.log` 採取を追加し、監視ログを Nightly artefact に含める。2025年11月12日: `test-results/trending-feed/prometheus/` へ複製・`nightly.yml` で `trending-metrics-prometheus` artefact を公開。2025年11月15日: レポート出力先を `test-results/trending-feed/reports/` に固定し、メトリクス JSON (`test-results/trending-feed/metrics/`) を `trending-metrics-json` artefact として新設。|
| Nightly `user-search-pagination` | テストID: `nightly.user-search-pagination`<br>`./scripts/test-docker.sh ts --scenario user-search-pagination`（PowerShell 版あり） | `/search` (users) タブの cursor/sort/allow_incomplete/429 ハンドリングを Docker で再現し、ログ `tmp/logs/user_search_pagination_<timestamp>.log` を `user-search-pagination-logs` artefact として保存。`test-results/user-search-pagination/*.json` は `user-search-pagination-reports` artefact で共有。 | 2025年11月12日: Nightly へジョブを追加し、`tmp/logs/user_search_pagination_20251112-125208.log` を採取。ローカルでは `npx pnpm vitest run … | tee tmp/logs/user_search_pagination_20251112-125208.log` を実行し、Runbook 6.4 とログ形式を統一。 |
| Nightly `direct-message` | テストID: `nightly.direct-message`<br>`./scripts/test-docker.sh ts --scenario direct-message --no-build`（PowerShell 版: `./scripts/test-docker.ps1 ts -Scenario direct-message -NoBuild`） | `Header` / `DirectMessageInbox` / `DirectMessageDialog` / `useDirectMessageBadge` を Docker 上で再実行し、仮想スクロール・宛先検索・多端末既読共有の UI 回帰を保証。ログ `tmp/logs/vitest_direct_message_<timestamp>.log` を `direct-message-logs` artefact、`test-results/direct-message/*.json` を `direct-message-reports` artefact として保存する。 | 2025年11月15日: シナリオを追加し、`tmp/logs/vitest_direct_message_20251115-074009.log` / `test-results/direct-message/20251115-074009-*.json` を採取。Runbook/Inventory の DM 行から直接参照できるようにした。 |
| `cargo clippy`（Rust Lint） | `kukuri-tauri/src-tauri`: `cargo clippy --workspace --all-features -- -D warnings`<br>`kukuri-cli`: `cargo clippy --workspace --all-features -- -D warnings` | Phase 5 のゲート条件として、Tauri アプリと CLI の双方で Clippy 警告ゼロを維持する。CI では共通ルートに `Cargo.toml` が無いため、各ディレクトリで明示的に呼び出す必要がある。 | 2025年10月31日: 両ディレクトリでコマンドを実行し、警告ゼロで完走することを確認。`lint` 系ジョブでは 2 回の `cargo clippy` を順番に呼ぶ手順を記載した。<br>2025年11月01日: 指示どおり `cargo clippy --all-features -- -D warnings` を kukuri-tauri/src-tauri と kukuri-cli の両方で再実行し、警告ゼロ継続を確認。CI lint ジョブにも kukuri-cli 向け Clippy 実行を追加済み。 |
| トレンド/フォロー中フィード UI テスト | `pnpm vitest run src/tests/unit/routes/trending.test.tsx src/tests/unit/routes/following.test.tsx`<br>`pnpm vitest run src/tests/unit/hooks/useTrendingFeeds.test.tsx` | `/trending`・`/following` ルートのランキング表示、Summary Panel メトリクス、無限スクロール、エラー再試行、DM 未読バッジ連携を検証。 | 2025年11月05日: フック層ユニットテストと `docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from test-runner test-runner` を完走。2025年11月07日: ルートコンポーネントのユニットテストを Nightly Frontend Unit Tests に追加し、手動 QA で `formatDistanceToNow`（ミリ秒入力）・空ページ境界・再試行導線を確認。2025年11月08日: `trending_metrics_job` 常駐化後も `generated_at` と Summary Panel の件数が一致することを Docker/Nightly と Vitest で確認。 |
| Prometheus エクスポート（`trending_metrics_job`） | `curl http://localhost:${KUKURI_METRICS_PROMETHEUS_PORT}/metrics > tmp/logs/trending_metrics_job_<timestamp>.prom` | `runs_total` / `failures_total` / `topics_upserted` / `expired_records` / `duration_seconds_bucket` を定期採取し、ジョブの遅延や連続失敗を検出。Nightly 無人監視が整うまでは手動で `tmp/logs/` に保存したテキストを Runbook とリンクする。 | 2025年11月10日: `MetricsConfig` に `prometheus_port` / `emit_histogram` を追加し、`TrendingMetricsJob` が `tiny_http` サーバー経由で Prometheus 形式のメトリクスを公開。`KUKURI_METRICS_PROMETHEUS_PORT=9898` で `curl http://localhost:9898/metrics | tee tmp/logs/trending_metrics_job_20251110.prom` を取得し、監視手順を `docs/03_implementation/trending_metrics_job.md` と本表へ追記。 |
| ユーザー検索導線テスト | `npx pnpm vitest run src/tests/unit/components/search/UserSearchResults.test.tsx src/tests/unit/hooks/useUserSearchQuery.test.tsx` | `/search` (users) のデバウンス・ページネーション・レート制限ハンドリング。Nightly Frontend Unit Tests に 2025年11月導入予定。 | 2025年11月04日: Inventory 5.8 にテスト観点を追加。Vitest ファイルを作成後、Nightly ワークフローへ追記し、レートリミットケースは `vi.useFakeTimers` で安定化させる。<br>2025年11月10日: `allow_incomplete` フォールバックと SearchBar 警告スタイル実装後に `npx pnpm vitest … | tee tmp/logs/vitest_user_search_allow_incomplete_20251110132951.log` を実行して回帰ログを取得。Docker シナリオ `user-search-pagination` で同テストを Docker 化済み（上表参照）。 |
| グローバルコンポーザー トピック作成テスト | `pnpm vitest run src/tests/unit/components/posts/GlobalComposer.test.tsx src/tests/unit/components/layout/Sidebar.test.tsx` | グローバルコンポーザーとサイドバーのトピック作成ショートカット（`GlobalComposer.topic-create` / `TopicSelector.create-shortcut`）を検証。Nightly Frontend Unit Tests に組み込む。 | 2025年11月06日: Inventory 5.9 に沿ってテストケースを追加し、PowerShell 版 `test-docker.ps1 ts` にも同ケースを連携。 |
| 投稿削除キャッシュ整合性テスト | テストID: `nightly.post-delete-cache`<br>`pnpm vitest run src/tests/unit/hooks/useDeletePost.test.tsx src/tests/unit/components/posts/PostCard.test.tsx src/tests/unit/components/posts/PostCard.deleteOffline.test.tsx`<br>`SCENARIO=post-delete-cache docker compose -f docker-compose.test.yml run --rm test-runner` | React Query キャッシュ無効化と Docker シナリオ `post-delete-cache` を通じて `useDeletePost` / `post_delete_flow` の整合性を監視。Nightly artefact `post-delete-cache-logs` / `post-delete-cache-reports` で `tmp/logs/post_delete_cache_<timestamp>.log`（ホスト）と `tmp/logs/post-delete-cache_docker_<timestamp>.log`（Docker）、`test-results/post-delete-cache/*.json` を共有。 | 2025年11月13日: `pnpm vitest run … | Tee-Object -FilePath tmp/logs/post_delete_cache_20251113-085756.log` を実行し、`test-results/post-delete-cache/20251113-002140.json` を Nightly artefact に登録。続けて `SCENARIO=post-delete-cache docker compose -f docker-compose.test.yml run --rm test-runner` を実行し、`tmp/logs/post-delete-cache_docker_20251113-002140.log` を採取。Runbook Chapter5 と `phase5_user_flow_inventory.md` の Stage4 節に両ログの参照を追記。 |
| `offlineStore` メタデータ同期テスト | `pnpm vitest run src/tests/unit/stores/offlineStore.test.ts` | SyncStatusIndicator で参照するメタデータ更新・同期ステータス更新フローを検証。 | 2025年11月06日: `update_cache_metadata` / `update_sync_status` の配線に合わせてテストを拡張し、未同期件数・エラー数のスナップショットを監視するケースを追加。 |
| SyncStatusIndicator / useSyncManager テスト | テストID: `nightly.sync-status-indicator`。Docker シナリオ: `./scripts/test-docker.sh ts --scenario offline-sync`（PowerShell 版あり）。ローカル/CI Vitest: `npx vitest run src/tests/unit/hooks/useSyncManager.test.tsx src/tests/unit/components/SyncStatusIndicator.test.tsx src/tests/unit/components/OfflineIndicator.test.tsx`. | `SyncStatusIndicator` / `OfflineIndicator` のステータス表示、`get_cache_status` / `add_to_sync_queue` / `list_sync_queue_items` / `update_cache_metadata` / `update_sync_status` の呼び出し整合性、手動再送ボタン・再送履歴（Queue ID フィルタ/ハイライト/エラー表示）とキャッシュ統計表示を検証。Nightly artefact `sync-status-indicator-logs` に `tmp/logs/sync_status_indicator_stage4_<timestamp>.log` を保存する。 | 2025年11月07日: `useSyncManager` に `cacheStatus` / `enqueueSyncRequest` を追加し、Vitest を拡張。2025年11月09日: `list_sync_queue_items` UI とログ記録を追加。2025年11月11日: Stage4（Doc/Blob `cache_metadata` + Service Worker）実装に合わせて `./scripts/test-docker.{sh,ps1} ts --scenario offline-sync --no-build` を Nightly に登録し、`tmp/logs/sync_status_indicator_stage4_<timestamp>.log` を CI/Runbook へリンク。 |

## 関連ドキュメント
- `phase5_user_flow_inventory.md` — UI 導線と Tauri コマンドの棚卸し結果（2025年11月07日更新: 5.6.1/5.6.2 の `/profile/$userId` 導線刷新、5.11「SyncStatusIndicator とオフライン同期導線」の追加、`get_cache_status` / `add_to_sync_queue` 連携とテスト計画を反映）
- `phase5_user_flow_summary.md` — 2025年11月07日更新。Quick View に同期導線・プロフィール導線の優先度とステータス、Summary Panel/Docker シナリオの注記を追加。
- 新導線テスト: `src/tests/unit/stores/composerStore.test.ts` / `src/tests/unit/stores/privacySettingsStore.test.ts` / `src/tests/unit/pages/Home.test.tsx` — グローバルコンポーザーとプライバシー設定のユニットテストを2025年11月02日に追加。Relay/P2P ステータスカードのテスト計画は下記参照。

## テスト更新ログ（2025年11月14日）
- フロントエンド: `pnpm vitest run src/tests/unit/routes/profile.$userId.test.tsx src/tests/unit/components/directMessages/DirectMessageDialog.test.tsx` を実行し、`ProfilePage` のフォロー/フォロー解除（楽観更新・エラーロールバック・未ログイン時の無効化・フォロワー無限スクロール）と `DirectMessageDialog` の送受信/再送/既読同期（未読バッジ更新と offline queue）を検証。CI ログ: `tmp/logs/vitest_profile_dm_20251114.log`。
- Rust: `cargo test`（`kukuri-tauri/src-tauri` / `kukuri-cli`）を完走し、`application::services::user_service::tests` にフォロー一覧カーソル境界テストとプライベートプロフィール時の Unauthorized (403 相当) を追加。`application::services::direct_message_service::tests` へ `send_direct_message` の暗号化失敗/配信 Pending（queued）ケースを追加し、暗号化／署名／配信エラーのハンドリングを網羅。

## テスト更新ログ（2025年11月03日）
- `npx vitest run src/tests/unit/components/RelayStatus.test.tsx src/tests/unit/components/P2PStatus.test.tsx src/tests/unit/stores/authStore.test.ts src/tests/unit/stores/p2pStore.test.ts src/tests/unit/hooks/useP2P.test.tsx src/tests/unit/lib/api/p2p.test.ts` を実行し、バックオフ実装・手動リトライ・新フィールド反映を検証済み。
- Rust 側では `cargo test`（`kukuri-tauri/src-tauri` / `kukuri-cli`）を実行し、`application::services::p2p_service::tests` の `connection_status` / `peers` 追加に伴うフォールバック挙動を確認。
- `src/tests/integration/profileAvatarSync.test.ts`（2025年11月02日実装）: `upload_profile_avatar` / `fetch_profile_avatar` をモックし、Doc レプリケーションと Blob 復号フローを検証。Vitest 統合テストに組み込み済みで、Rust 側の `tests/profile_avatar_sync.rs` ではマルチノード同期と `StreamEncryptor` 復号パスをカバー。

## 追加予定のテスト
- 2025年11月07日: `TrendingRoute` / `FollowingRoute` のユニットテスト（ランキング表示・エラー再試行・未読境界）を Nightly Frontend Unit Tests へ追加。2025年11月08日: `list_trending_topics` / `list_trending_posts` が `topic_metrics` の最新ウィンドウを反映することを Docker `trending-feed` で検証し、Nightly に合流。
- Docker シナリオ `trending-feed` を `scripts/test-docker.{sh,ps1}` に実装し、`docker-compose.test.yml` の `test-runner` エントリポイントを `pnpm vitest run ...` のシナリオ引数対応へ拡張済み。Nightly 用の `nightly.yml` へ「Trending Feed (Docker)」ジョブを追加し、`needs: unit-tests` で連結。失敗時には `tmp/logs/trending-feed/latest.log` を artefact として保存し、Runbook のトリアージ手順へリンクする。
- `UserSearchResults` / `useUserSearchQuery` の新テストで 2 文字未満クエリ・レート制限・カーソルページネーションを検証し、Docker シナリオ `user-search-pagination` と連携済み。2025年11月12日に `nightly.yml` へ `nightly.user-search-pagination` ジョブを追加し、`tmp/logs/user_search_pagination_<timestamp>.log`（`user-search-pagination-logs`）と `test-results/user-search-pagination/*.json`（`user-search-pagination-reports`）を artefact 化する運用を確立。Runbook 6.4 / phase5_user_flow_summary.md に同ログパスを紐づけ、Nightly 失敗時は本表を参照して artefact から JSON/ログを取得する。
- `Header` / `DirectMessageInbox` / `DirectMessageDialog` / `useDirectMessageBadge` を対象にした `direct-message` シナリオを 2025年11月15日に追加し、`./scripts/test-docker.{sh,ps1} ts --scenario direct-message --no-build` で `tmp/logs/vitest_direct_message_20251115-074009.log` と `test-results/direct-message/20251115-074009-*.json` を採取。Rust 側は `./scripts/test-docker.ps1 rust -NoBuild | Tee-Object tmp/logs/rust_docker_20251115-074043.log` で `tests/contract/direct_messages.rs` を再実行し、多端末既読共有 contract を Nightly artefact から参照できるようにした。

## 関連資料（ユーザー導線）
-  - `docs/01_project/activeContext/artefacts/phase5_user_flow_inventory.md` — 2025年11月07日更新。導線別の API/テスト計画と CI 連携ポイントを整理。
  - `docs/01_project/activeContext/artefacts/phase5_user_flow_summary.md` — 2025年11月07日更新。導線ステータスと Quick View の優先度を把握するサマリー。
  - `docs/03_implementation/docker_test_environment.md` — 2025年11月07日更新。Docker テスト共通フローと OS 別 Runbook（`windows_test_docker_runbook.md`）の参照元。
- `docs/03_implementation/trending_metrics_job.md` — 2025年11月08日更新。トレンドメトリクス集計ジョブの実装方針・監視指針・CI 連携・AppConfig 連動を確定版として記録。
- `docs/01_project/refactoring_plan_2025-08-08_v3.md` — ユーザー導線指標と Phase 5 backlog の整合を確認する指標一覧。
| corepack pnpm セットアップ | corepack enable pnpm && pnpm install --frozen-lockfile | Windows ホストに pnpm バイナリが存在しない問題を解消し、Vitest / Nightly と同一コマンドをローカルでも実行できるようにする前提手順。 | 2025年11月10日: shebang 問題を `cmd.exe /c "corepack enable pnpm"` で回避し、続けて `cmd.exe /c "cd /d C:\Users\kgm11\kukuri\kukuri-tauri && pnpm install --frozen-lockfile"` を完走。以降の Vitest 実行ログ（例: `tmp/logs/vitest_topic_create_20251110020423.log`）でホスト環境の再現性を確認。 |
| Nightly `profile-avatar-sync` | テストID: `nightly.profile-avatar-sync`<br>`./scripts/test-docker.sh ts --scenario profile-avatar-sync --service-worker`（PowerShell: `.\scripts\test-docker.ps1 ts -Scenario profile-avatar-sync -ServiceWorker -NoBuild`） | プロフィール Stage3/Stage4（Doc/Blob + Service Worker 再送 + cache_metadata 更新）を Docker で再現し、`tmp/logs/profile_avatar_sync_stage4_<timestamp>.log` を Nightly artefact `profile-avatar-sync-logs` として保存。`ProfileAvatarSyncWorker.test.ts` を同ジョブに含め、BroadcastChannel リトライと `offlineApi.addToSyncQueue` ログを CI でも検証する。 | 2025年11月12日: `--service-worker` フラグと Stage4 ログを scripts/test-docker.{sh,ps1}` に追加し、Nightly artefact を Stage3 版から Stage4 版へ移行。Runbook Chapter4 / phase5_user_flow_inventory.md 5.1 / dependency template に新ログパスとテスト ID を反映。 |
| Nightly `trending-feed` | テストID: `nightly.trending-feed`<br>`./scripts/test-docker.sh ts --scenario trending-feed --no-build`（PowerShell 版あり） | `/trending` `/following` の Vitest セットと Prometheus 監視を Docker で再実行し、`test-results/trending-feed/reports/*.json`（artefact: `trending-feed-reports`）と `tmp/logs/trending-feed_<timestamp>.log`、`tmp/logs/trending_metrics_job_stage4_<timestamp>.log`（artefact: `trending-metrics-logs`）を同時生成。`test-results/trending-feed/prometheus/*` は `trending-metrics-prometheus`、`test-results/trending-feed/metrics/*` は `trending-metrics-json` として公開する。 | 2025年11月10日: ローカルで `tmp/logs/trending-feed_20251110020528.log` と JSON を更新。2025年11月11日: `prometheus-trending` サービスと `curl http://127.0.0.1:9898/metrics` のスナップショットを自動取得し、Runbook 6.4 と artefact 命名規則を同期。2025年11月15日: JSON レポート出力を `reports/` 配下に統一し、Nightly artefact に `trending-metrics-json` を追加。 |
| pnpm vitest TopicSelector/PostCard/TrendingSummaryPanel | pnpm vitest run src/tests/unit/components/topics/TopicSelector.test.tsx src/tests/unit/components/posts/PostCard.test.tsx src/tests/unit/routes/trending.test.tsx src/tests/unit/routes/following.test.tsx | グローバルコンポーザーのトピック作成／投稿削除キャッシュ／Summary Panel（トレンド/フォロー）のユニットテストを網羅し、tmp/logs/vitest_trending_topics_<timestamp>.log を保存。 | 2025年11月10日: corepack セットアップ後に `pnpm vitest run …` を再実行し、トレンド/フォロー UI とポスト系テストをまとめて完走。ログ: `tmp/logs/vitest_trending_topics_20251110020449.log`。 |
