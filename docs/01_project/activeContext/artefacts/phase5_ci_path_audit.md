# Phase 5 CI/ローカルスクリプト パス依存調査
最終更新日: 2025年11月07日

| 対象 | 現状参照パス／コマンド | 影響範囲 | 修正案 |
| --- | --- | --- | --- |
| `scripts/docker/run-smoke-tests.sh` | `cargo test --package kukuri-tauri --test p2p_gossip_smoke -- --nocapture --test-threads=1`<br>`cargo test --package kukuri-tauri --test p2p_mainline_smoke -- --nocapture --test-threads=1` | Docker スモークテストで新テストバイナリを並列実行。 | 2025年10月22日: フォールバックロジックを撤廃し、新バイナリを常に実行する構成へ更新済み。 |
| `scripts/test-docker.sh` | `./scripts/test-docker.sh p2p` / `./scripts/test-docker.sh performance` | ローカル Docker P2P テストに加え、性能ハーネス（ignored テスト）を `performance` サブコマンドで実行。 | 2025年10月22日: フォールバック削除・エイリアス追加を完了し、旧スモークバイナリへの依存を解消。<br>2025年10月31日: `performance` サブコマンドを追加し、計測結果を `test-results/performance/*.json` に保存。 |
| `scripts/test-docker.ps1` | `cargo test --package kukuri-tauri --test p2p_gossip_smoke`<br>`cargo test --package kukuri-tauri --test p2p_mainline_smoke`<br>`cargo test --package kukuri-tauri --test <target>`<br>`./scripts/test-docker.ps1 performance` | Windows 用 Docker テストでスモーク + 個別ターゲット + 性能ハーネスを切替。`performance` 実行時は `cargo test --test performance -- --ignored --nocapture` を呼び、成果物を `test-results/performance` に出力。 | 2025年10月22日: 新バイナリ固定化とログ整備を完了。<br>2025年10月30日: `-Test` オプションを追加し、`event_manager_integration` など個別テストを `./scripts/test-docker.ps1 rust -Test <target>` で実行可能にした。<br>2025年10月31日: `performance` コマンドを追加し、成果物出力先を PowerShell からも制御可能にした。 |
| `scripts/test-docker.{sh,ps1}` coverage コマンド | `./scripts/test-docker.sh coverage` → `docker compose run rust-coverage`（`cargo tarpaulin --locked --all-features --out Json --out Lcov --output-dir /app/test-results/tarpaulin`） | Rust カバレッジ測定を Docker 上で再現し、成果物を `docs/01_project/activeContext/artefacts/metrics/*.json/.lcov` に出力。 | 2025年10月26日: `rust-coverage` サービスを Compose に追加し、tarpaulin の JSON/LCOV を `test-results/tarpaulin` 経由で保存。Shell/PowerShell の両方から同一フローで呼び出せるようにした。 |
| `scripts/metrics/export-p2p.{sh,ps1}` | `cargo run --manifest-path kukuri-tauri/src-tauri/Cargo.toml --bin p2p_metrics_export -- --output <path>` | Gossip/Mainline メトリクスを JSON として保存し、CI から artefacts/metrics に収集する。 | 2025年10月27日: Phase 5 Workstream A/B のメトリクス要件に合わせて追加。`--pretty` を指定すると human readable。 |
| `docker-compose.test.yml` (`test-runner` / `rust-test`) | ボリューム: `./kukuri-tauri/src-tauri/src` / `./kukuri-tauri/src-tauri/tests` を read-only でマウント | Phase 5 で Rust テスト資産を `src-tauri/tests` へ集約しても、ローカル編集が即座に反映される。 | 2025年10月31日: `test-runner` と `rust-test` に加え `rust-coverage` へも `./kukuri-tauri/src-tauri/tests` のマウントを追加し、`docker_test_environment.md` / `windows_test_docker_runbook.md` に反映済み。 |
| GitHub Actions `test.yml`（Docker ジョブ） | `/app/run-tests.sh` → `cargo test --workspace`（`tests/` 配下の新バイナリを網羅実行） | `run-tests.sh` が Phase 5 更新後の `cargo test` を利用できるようにする必要がある。 | `run-tests.sh` 内で個別モジュールパスを指定しないため直接の修正は不要だが、P2P スモークを追加する際は `--test p2p_gossip_smoke` / `--test p2p_mainline_smoke` を明示する。 |
| `package.json` `test:unit` スクリプト | `pnpm test:unit` → `vitest run src/tests/unit` | フロントエンドのユニットテスト群を Phase 5 新規テスト（プロフィールアバター導線など）込みで一括実行。CI/ローカル双方で同一コマンドを呼び出せるように共通化。 | 2025年11月03日: `package.json` に `test:unit` を追加し、Nightly Frontend Unit Tests ワークフロー（cron: `0 15 * * *`）から `pnpm test:unit` を実行する構成を追加。`tauri_app_implementation_plan.md` と整合。<br>2025年11月06日: DM 未読バッジ・トレンド/フォロー導線・ユーザー検索のユニットテストを Inventory 5.7-5.10 / Summary 3 の結果と合わせて Nightly ワークフローへ反映し、`DirectMessageDialog` / `TrendingSummaryPanel` / `FollowingSummaryPanel` / `UserSearchResults` のケースを追加。 |
| Docker シナリオ `trending-feed` | `./scripts/test-docker.sh ts --scenario trending-feed`<br>`.\scripts\test-docker.ps1 ts -Scenario trending-feed` | `/trending` `/following` ルート専用の Vitest セットを Docker 内で再現し、トレンドメトリクス/API 変更時のリグレッションを検出。Nightly Frontend Unit Tests の後段で実行し、`test-results/trending-feed/*.json` を生成して確認ログを保存する。 | 2025年11月07日: シナリオ要件を整理（Docker で `pnpm vitest run src/tests/unit/routes/trending.test.tsx src/tests/unit/routes/following.test.tsx src/tests/unit/hooks/useTrendingFeeds.test.tsx` を実行。`VITE_TRENDING_FIXTURE_PATH` でフィクスチャを選択可能にし、既定は `tests/fixtures/trending/default.json`）。`scripts/test-docker.{sh,ps1}` に `--scenario/-Scenario` オプションを追加し、`ts` コマンドからシナリオを切替。Nightly ワークフローに `Trending Feed (Docker)` ジョブを追加し、失敗時は `phase5_ci_path_audit.md` へリンクしたアラートを残す。 |
| `cargo clippy`（Rust Lint） | `kukuri-tauri/src-tauri`: `cargo clippy --workspace --all-features -- -D warnings`<br>`kukuri-cli`: `cargo clippy --workspace --all-features -- -D warnings` | Phase 5 のゲート条件として、Tauri アプリと CLI の双方で Clippy 警告ゼロを維持する。CI では共通ルートに `Cargo.toml` が無いため、各ディレクトリで明示的に呼び出す必要がある。 | 2025年10月31日: 両ディレクトリでコマンドを実行し、警告ゼロで完走することを確認。`lint` 系ジョブでは 2 回の `cargo clippy` を順番に呼ぶ手順を記載した。<br>2025年11月01日: 指示どおり `cargo clippy --all-features -- -D warnings` を kukuri-tauri/src-tauri と kukuri-cli の両方で再実行し、警告ゼロ継続を確認。CI lint ジョブにも kukuri-cli 向け Clippy 実行を追加済み。 |
| トレンド/フォロー中フィード UI テスト | `pnpm vitest run src/tests/unit/routes/trending.test.tsx src/tests/unit/routes/following.test.tsx`<br>`pnpm vitest run src/tests/unit/hooks/useTrendingFeeds.test.tsx` | `/trending`・`/following` ルートのランキング表示、Summary Panel メトリクス、無限スクロール、エラー再試行、DM 未読バッジ連携を検証。 | 2025年11月05日: フック層ユニットテストと `docker compose -f docker-compose.test.yml up --build --abort-on-container-exit --exit-code-from test-runner test-runner` を完走。2025年11月07日: ルートコンポーネントのユニットテストを Nightly Frontend Unit Tests に追加し、手動 QA で `formatDistanceToNow`（ミリ秒入力）・空ページ境界・再試行導線を確認。Docker シナリオ `trending-feed` 作成と `trending_metrics_job` の導入が継続課題。 |
| ユーザー検索導線テスト | `pnpm vitest run src/tests/unit/components/search/UserSearchResults.test.tsx src/tests/unit/hooks/useUserSearchQuery.test.ts`（新設予定） | `/search` (users) のデバウンス・ページネーション・レート制限ハンドリング。Nightly Frontend Unit Tests に 2025年11月導入予定。 | 2025年11月04日: Inventory 5.8 にテスト観点を追加。Vitest ファイルを作成後、Nightly ワークフローへ追記し、レートリミットケースは `vi.useFakeTimers` で安定化させる。Docker シナリオ `user-search-pagination` を PowerShell スクリプトに追加予定。 |
| グローバルコンポーザー トピック作成テスト | `pnpm vitest run src/tests/unit/components/posts/GlobalComposer.test.tsx src/tests/unit/components/layout/Sidebar.test.tsx` | グローバルコンポーザーとサイドバーのトピック作成ショートカット（`GlobalComposer.topic-create` / `TopicSelector.create-shortcut`）を検証。Nightly Frontend Unit Tests に組み込む。 | 2025年11月06日: Inventory 5.9 に沿ってテストケースを追加し、PowerShell 版 `test-docker.ps1 ts` にも同ケースを連携。 |
| 投稿削除キャッシュ整合性テスト | `pnpm vitest run src/tests/unit/hooks/useDeletePost.test.ts src/tests/unit/components/posts/PostCard.test.tsx`<br>`docker compose -f docker-compose.test.yml run --rm test-runner pnpm vitest run --runInBand post-delete-cache` | React Query キャッシュ無効化と Docker シナリオ `post-delete-cache` を通じて `useDeletePost` / `post_delete_flow` の整合性を監視。 | 2025年11月06日: Inventory 5.10 に基づきテスト ID を登録し、Nightly Frontend Unit Tests と Docker ワークフローに含める計画を追加。PowerShell 版 `test-docker.ps1 ts -Scenario post-delete-cache` を新設予定。 |
| `offlineStore` メタデータ同期テスト | `pnpm vitest run src/tests/unit/stores/offlineStore.test.ts` | SyncStatusIndicator で参照するメタデータ更新・同期ステータス更新フローを検証。 | 2025年11月06日: `update_cache_metadata` / `update_sync_status` の配線に合わせてテストを拡張し、未同期件数・エラー数のスナップショットを監視するケースを追加。 |
| SyncStatusIndicator / useSyncManager テスト | `pnpm vitest run src/tests/unit/hooks/useSyncManager.test.tsx src/tests/unit/components/SyncStatusIndicator.test.tsx` | `SyncStatusIndicator` / `OfflineIndicator` のステータス表示、`get_cache_status` / `add_to_sync_queue` / `update_cache_metadata` / `update_sync_status` の呼び出し整合性、手動再送ボタンとキャッシュ統計表示を検証。 | 2025年11月07日: `useSyncManager` に `cacheStatus` ステートと `enqueueSyncRequest` を追加し、Vitest でキャッシュ統計・エラー再送 UI をカバー。Inventory 5.11 / Summary Quick View / Refactoring Plan のユーザー導線指標とリンク。Nightly Frontend Unit Tests（Run ID `19172338059` / Job `Frontend Unit Tests`）のログで `src/tests/unit/hooks/useSyncManager.test.tsx`・`src/tests/unit/components/SyncStatusIndicator.test.tsx` の完走を確認。 |

## 関連ドキュメント
- `phase5_user_flow_inventory.md` — UI 導線と Tauri コマンドの棚卸し結果（2025年11月07日更新: 5.6.1/5.6.2 の `/profile/$userId` 導線刷新、5.11「SyncStatusIndicator とオフライン同期導線」の追加、`get_cache_status` / `add_to_sync_queue` 連携とテスト計画を反映）
- `phase5_user_flow_summary.md` — 2025年11月07日更新。Quick View に同期導線・プロフィール導線の優先度とステータス、Summary Panel/Docker シナリオの注記を追加。
- 新導線テスト: `src/tests/unit/stores/composerStore.test.ts` / `src/tests/unit/stores/privacySettingsStore.test.ts` / `src/tests/unit/pages/Home.test.tsx` — グローバルコンポーザーとプライバシー設定のユニットテストを2025年11月02日に追加。Relay/P2P ステータスカードのテスト計画は下記参照。

## テスト更新ログ（2025年11月03日）
- `npx vitest run src/tests/unit/components/RelayStatus.test.tsx src/tests/unit/components/P2PStatus.test.tsx src/tests/unit/stores/authStore.test.ts src/tests/unit/stores/p2pStore.test.ts src/tests/unit/hooks/useP2P.test.tsx src/tests/unit/lib/api/p2p.test.ts` を実行し、バックオフ実装・手動リトライ・新フィールド反映を検証済み。
- Rust 側では `cargo test`（`kukuri-tauri/src-tauri` / `kukuri-cli`）を実行し、`application::services::p2p_service::tests` の `connection_status` / `peers` 追加に伴うフォールバック挙動を確認。
- `src/tests/integration/profileAvatarSync.test.ts`（2025年11月02日実装）: `upload_profile_avatar` / `fetch_profile_avatar` をモックし、Doc レプリケーションと Blob 復号フローを検証。Vitest 統合テストに組み込み済みで、Rust 側の `tests/profile_avatar_sync.rs` ではマルチノード同期と `StreamEncryptor` 復号パスをカバー。

## 追加予定のテスト
- `ProfilePage` 向けにフォロー/フォロー解除ハンドリングのユニットテストを追加し、`follow_user` / `unfollow_user` 成功・失敗・未ログイン時の各パスで React Query キャッシュとボタン状態、トースト通知が期待どおりに遷移することを検証する（楽観更新→ロールバックを含む）。
- `DirectMessageDialog`（新規）で kind 4 DM の送受信フローをモックし、未読バッジ更新・オフライン再送キュー登録・`send_direct_message` 失敗時のリトライ UI をテストする。Rust 側では `send_direct_message` コマンドの暗号化/署名/配信エラーをユニットテストでカバーする。
- フォロワー/フォロー中リストの無限スクロールとソート切り替えを `useInfiniteQuery` のテストで再現し、カーソル・ソート条件が API パラメーターへ正しく引き継がれること、`total_count` を利用した進捗表示が更新されることを確認する。Rust 側はカーソル境界（先頭/末尾）とプライベートアカウント時の 403 応答を含む結合テストを追加する。
- 2025年11月07日: `TrendingRoute` / `FollowingRoute` のユニットテスト（ランキング表示・エラー再試行・未読境界）を Nightly Frontend Unit Tests へ追加済み。次は `list_trending_topics` / `list_following_feed` の統合テストと Docker シナリオ `trending-feed` を整備する。
- Docker シナリオ `trending-feed` を `scripts/test-docker.{sh,ps1}` に実装し、`docker-compose.test.yml` の `test-runner` エントリポイントを `pnpm vitest run ...` のシナリオ引数対応へ拡張する。Nightly 用の `nightly.yml` へ「Trending Feed (Docker)」ジョブを追加し、`needs: unit-tests` で連結。失敗時に `test-results/trending-feed/latest.log` を artefact として保存し、Runbook のトリアージ手順へリンクする。
- `UserSearchResults` / `useUserSearchQuery` の新テストで 2 文字未満クエリ・レート制限・カーソルページネーションを検証し、Docker シナリオ `user-search-pagination` と連携させる。

## 関連資料（ユーザー導線）
-  - `docs/01_project/activeContext/artefacts/phase5_user_flow_inventory.md` — 2025年11月07日更新。導線別の API/テスト計画と CI 連携ポイントを整理。
  - `docs/01_project/activeContext/artefacts/phase5_user_flow_summary.md` — 2025年11月07日更新。導線ステータスと Quick View の優先度を把握するサマリー。
  - `docs/03_implementation/docker_test_environment.md` — 2025年11月07日更新。Docker テスト共通フローと OS 別 Runbook（`windows_test_docker_runbook.md`）の参照元。
  - `docs/03_implementation/trending_metrics_job.md` — 2025年11月07日ドラフト。トレンドメトリクス集計ジョブの設計背景・監視指針・CI 連携を整理。
- `docs/01_project/refactoring_plan_2025-08-08_v3.md` — ユーザー導線指標と Phase 5 backlog の整合を確認する指標一覧。
