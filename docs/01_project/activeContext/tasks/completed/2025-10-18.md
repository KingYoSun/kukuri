# 2025年10月18日 完了タスク

## EventService DHT購読ステートマシンの永続化
- `kukuri-tauri/src-tauri/migrations/20251018090000_add_nostr_subscriptions_table.{up,down}.sql` で `nostr_subscriptions` テーブルと状態インデックスを追加し、購読対象ごとの状態・再同期情報・失敗回数を保存可能にした。
- `kukuri-tauri/src-tauri/src/application/services/subscription_state.rs` に `SubscriptionStateMachine` を実装し、購読要求・成功・失敗・再同期要求を一元管理。`mark_failure` で `needs_resync` へ遷移し、`list_for_restore` で未復元項目を再取得できるようにした。
- 同モジュールに対して `record_request_inserts_and_updates` などのユニットテストを追加し、状態遷移・再同期判定・失敗回数更新が期待通りであることを検証。

## 再接続時の購読復元フロー整備
- `kukuri-tauri/src-tauri/src/application/services/event_service.rs` を再構築し、`SubscriptionStateStore` を注入。購読開始時にステートマシンへ記録し、成功時は `mark_subscribed`、失敗時は `mark_failure` を呼び出すよう統合した。
- `EventService::handle_network_disconnected/connected` を追加し、切断時に全購読を `needs_resync` へ遷移、再接続時に `restore_subscriptions` で `SubscriptionInvoker`（`EventManager` ラッパー）経由で自動再購読する処理を実装。
- `kukuri-tauri/src-tauri/src/modules/event/manager.rs` の `subscribe_to_topic/user` に `since: Option<Timestamp>` を受け取る拡張を加え、復元時に最終同期時刻から履歴を取り直せるようにした。
- `kukuri-tauri/src-tauri/src/state.rs` で `ConnectionEvent` を監視し、切断時に `handle_network_disconnected`、再接続時に `handle_network_connected` を発火。同時に `EventManagerSubscriptionInvoker` を介して `EventService` に購読権限を注入。
- `event_service.rs` のテスト群を更新し、購読成功・失敗・再接続復元・例外処理がステートマシンへ正しく反映されることを確認 (`test_handle_network_connected_restores_subscriptions` など)。

## UIでの購読ステータス可視化
- `kukuri-tauri/src-tauri/src/presentation/commands/event_commands.rs` に `list_nostr_subscriptions` コマンドを追加し、`presentation/dto/event.rs` で `NostrSubscriptionStateDto` を定義。`EventHandler::list_subscriptions` から購読一覧を JSON として返却するようにした。
- フロントエンド側で `src/lib/api/nostr.ts` に `listNostrSubscriptions` API を追加し、`src/hooks/useNostrSubscriptions.ts` でポーリング可能なフックとして公開。
- `src/components/P2PDebugPanel.tsx` に購読ステータスセクションを追加し、対象種別・ステータス・最終同期/試行時刻・失敗回数・エラーメッセージをバッジ付きで可視化。`useNostrSubscriptions` から手動更新も可能にした。

## 関連テスト・確認
- Rust: `subscription_state` と `event_service` のユニットテストを追加し、購読ステートマシンの状態遷移・復元処理を検証（Windows 既知の DLL 問題は従来通り Docker 経由で回避）。
