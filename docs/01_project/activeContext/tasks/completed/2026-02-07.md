# 2026年02月07日 作業完了タスク

最終更新日: 2026年02月07日

## Community Nodes / friend_plus 実ノードE2E（join.request -> 承認 -> key.envelope -> 復号表示）

- [x] `tests/e2e/specs/community-node.friend-plus.spec.ts` を実装・安定化し、`join.request(friend_plus) -> 承認 -> key.envelope -> 復号表示` の実ノード経路を検証可能にした
- [x] E2E bridge を拡張（`switchAccount` export、`communityNodeListGroupKeys` 追加、fallback アカウント切替時の backend key 同期）
- [x] follow/unfollow の invoke 引数キー不整合（camelCase 必須）を修正し、friend_plus テストセットアップを通るようにした
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了済みに反映
- [x] `./scripts/test-docker.ps1 e2e-community-node` で `community-node.friend-plus.spec.ts` の `PASSED` を確認（ログ: `tmp/logs/community-node-e2e/manual-rerun-20260207.log`）
  - 注記: 同一実行で `profile.privacy-avatar.spec.ts` が `Error: オンライン表示の状態が変わりませんでした` により失敗（本タスク外の既存不安定）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260207-180303.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260207-180422.log`）

## Community Nodes / Admin Console（Privacy/Data・Index・Access Control）

- [x] `kukuri-community-node/apps/admin-console` に `Privacy / Data` ページを追加
- [x] `kukuri-community-node/apps/admin-console` に `Index` ページを追加（`/v1/reindex` 実行 UI を含む）
- [x] `kukuri-community-node/apps/admin-console` に `Access Control` ページを追加（rotate/revoke UI を含む）
- [x] ルーターとサイドバーに新規ページ導線を追加
- [x] Vitest + Testing Library の UI テスト基盤を追加（`vite.config.ts` / `src/test/setup.ts` / `renderWithQueryClient`）
- [x] 新規ページ向け UI テストを追加（`PrivacyDataPage` / `IndexPage` / `AccessControlPage`）
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新

## Community Nodes / Moderation LLM（日次予算・同時実行制御）

- [x] `cn-moderation` に `max_requests_per_day` / `max_cost_per_day` / `max_concurrency` の実行時ガードを実装
- [x] LLM 実行前に日次使用量・実行中リクエストをトランザクションで検査し、上限到達時は分類処理をスキップするように変更
- [x] スキップ時に `cn_admin.audit_logs` へ `moderation.llm.skip`（`skip_reason` 含む）を記録し、監査可能化
- [x] `cn_moderation.llm_daily_usage` / `cn_moderation.llm_inflight` テーブルを migration で追加
- [x] `cn-moderation` に上限到達ケース（requests/cost/concurrency）のテストを追加
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新

## Community Nodes / Compose（llm-local プロファイル）

- [x] `kukuri-community-node/docker-compose.yml` に `llm-local` プロファイル用 `ollama` サービスを追加（`LLM_LOCAL_ENDPOINT=http://ollama:11434` と整合）
- [x] `ollama` 永続化ボリューム（`ollama_data`）を追加
- [x] `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md` の Compose 未実装項目を完了に更新

## Community Nodes / Admin Console（LLM連携設定・Memberships検索）

- [x] `cn-admin-api` に `GET /v1/admin/access-control/memberships`（topic/scope/pubkey/status/limit 検索）を追加し、OpenAPI に反映
- [x] Admin Console `AccessControlPage` に memberships 一覧/検索 UI（`topic + scope + pubkey + status`）を追加
- [x] `cn-core` の moderation config seed を拡張し、`send_scope` / `storage` / `retention` を保持できるように変更
- [x] Admin Console `ModerationPage` に LLM 連携専用 UI（OpenAI/Local、外部送信ON/OFF、送信範囲、保存/保持、予算上限）を追加
- [x] Admin Console の API クライアント/型/OpenAPI 生成コードを更新し、関連 UI テストを追加
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新

## Community Nodes / cn-user-api 契約テスト（bootstrap/search/reports）

- [x] `cn-user-api` の契約テストに `/v1/bootstrap/nodes` と `/v1/bootstrap/topics/{topic_id}/services` の成功系（200）+ shape 検証を追加
- [x] `cn-user-api` の契約テストに `/v1/search` の成功系（200）+ shape 検証を追加（Meilisearch モックをテスト内起動）
- [x] `cn-user-api` の契約テストに `/v1/reports` の成功系（200/201 互換）+ shape 検証を追加
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新

## Community Nodes / cn-admin-api 契約テスト（auth フロー互換）

- [x] `cn-admin-api` の契約テストに `login -> session cookie -> /v1/admin/auth/me -> logout` の成功系フローを追加
- [x] `login` レスポンスの shape（`admin_user_id` / `username` / `expires_at`）と `Set-Cookie`（`cn_admin_session`）を検証
- [x] `session cookie` を使った `/v1/admin/auth/me` 認証成功を検証
- [x] `logout` 後に同一 cookie の `/v1/admin/auth/me` が `401` になることを検証
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新

## Community Nodes / cn-admin-api 契約テスト（services〜trust 拡充）

- [x] `kukuri-community-node/crates/cn-admin-api/src/contract_tests.rs` を拡張し、以下カテゴリの主要エンドポイント成功系 + レスポンス shape 互換を検証する契約テストを追加
  - `services`
  - `policies`
  - `moderation`
  - `subscription-requests`
  - `node-subscriptions`
  - `plans`
  - `subscriptions`
  - `usage`
  - `audit-logs`
  - `trust`
- [x] `services` 契約テストの成功系を安定化するため、`cn-admin-api` の設定更新通知クエリを `NOTIFY ... $1` から `SELECT pg_notify('cn_admin_config', $1)` に修正
- [x] `community_nodes_roadmap.md` の該当未実装項目（2026年02月07日 監査追記）を完了に更新

## Community Nodes / cn-user-api 契約テスト（auth/policies/consents/topic-subscription/personal-data 拡充）

- [x] `kukuri-community-node/crates/cn-user-api/src/subscriptions.rs` の `api_contract_tests` を拡張し、以下エンドポイント群の成功系 + レスポンス shape 互換を検証する契約テストを追加
  - `/v1/auth/challenge` `/v1/auth/verify`
  - `/v1/policies/current` `/v1/policies/{policy_type}/{version}`
  - `/v1/consents/status` `/v1/consents`
  - `/v1/topic-subscription-requests` `/v1/topic-subscriptions` `/v1/topic-subscriptions/{topic_id}`
  - `/v1/personal-data-export-requests*` `/v1/personal-data-deletion-requests*`
- [x] 契約テスト用ヘルパー（公開 POST、DELETE、current policy seed、active subscriber upsert）を追加
- [x] `create_export_request` 契約テストを安定化するため、テスト用 `export_dir` をユニーク作成して `fs::create_dir_all` を実施
- [x] `personal-data-deletion` の `GET` 成功系は削除済みアカウントで 410 になる仕様を踏まえ、別アカウント seed で成功契約を検証
- [x] `community_nodes_roadmap.md` の該当未実装項目（2026年02月07日 監査追記）を完了に更新

## 検証

- [x] `docker run --rm -e CI=true -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node/apps/admin-console node:20-bookworm bash -lc "corepack enable && pnpm typecheck && pnpm test"`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres` + `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "${PWD}/kukuri-community-node:/app" -w /app rust:1.88-bookworm bash -c "cargo test -p cn-admin-api --tests -- --nocapture"`（成功）
- [x] `./scripts/test-docker.ps1 ts`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres` + `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "${PWD}/kukuri-community-node:/app" -w /app rust:1.88-bookworm bash -c "cargo test -p cn-moderation -- --nocapture"`（成功）
- [x] `./scripts/test-docker.ps1 rust -NoBuild`（成功）
- [x] `docker run --rm -v "${PWD}/kukuri-community-node:/app" -w /app rust:1.88-bookworm cargo test -- --nocapture`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260207-003615.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260207-003730.log`）
- [x] `docker compose -f kukuri-community-node/docker-compose.yml config`（成功。`version` 廃止警告と `TRUST_ADDR` 未設定警告は既知）
- [x] `docker compose -f kukuri-community-node/docker-compose.yml --profile moderation --profile llm-local config`（成功。`ollama` サービスが有効化されることを確認）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260207-083952.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260207-084107.log`）
- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260207-094350.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260207-094505.log`）
- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres` + `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -c "source /usr/local/cargo/env && cargo test -p cn-user-api --tests -- --nocapture"`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres` + `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -c "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（成功: 9 passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。`some refs were not updated` / `pnpm approve-builds` は既知警告）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。`some refs were not updated` / `pnpm approve-builds` / `useRouter` 警告は既知）
- [x] `./scripts/test-docker.ps1 rust -NoBuild`（成功）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri\kukuri-community-node:/app -w /app rust:1.88-bookworm bash -c "source /usr/local/cargo/env && cargo test -- --nocapture"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260207-120025.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260207-115219.log`）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres` + `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "${PWD}/kukuri-community-node:/app" -w /app rust:1.88-bookworm bash -c "cargo test -p cn-admin-api --tests -- --nocapture"`（成功: 16 passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260207-222337.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260207-222451.log`）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -c "source /usr/local/cargo/env && cargo test -p cn-user-api --tests -- --nocapture"`（成功: 24 passed）
- [x] `./scripts/test-docker.ps1 rust -NoBuild`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260207-231112.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260207-231231.log`）

## 備考

- `gh act` 実行時に `some refs were not updated` / `pnpm approve-builds` 警告が出るが、いずれも既知でジョブ自体は成功している。
