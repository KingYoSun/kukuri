# 2026年02月23日 完了タスク

最終更新日: 2026年02月23日

## Issue #145: Topic timeline/thread rebuild Phase 5（realtime timeline mode）

- [x] `standard` / `realtime` の timeline 更新モードを `uiStore` に追加し、persist 対象に含めた。
- [x] `TimelineModeToggle` を追加し、Topic 画面ヘッダーからモード切り替えと LIVE 表示を操作できるようにした。
- [x] `timelineRealtimeEvents` と `useRealtimeTimeline` を追加し、Nostr/P2P 差分のバッチ適用（750ms）と必要時の単発 refetch を実装した。
- [x] `useNostrEvents` / `useP2PEventListener` を更新し、`standard` では invalidate、`realtime` では差分 dispatch に分岐するようにした。
- [x] 切断・オフライン時に realtime から standard へ戻すフォールバックを実装した。
- [x] `useRealtimeTimeline.test.tsx` を新規追加し、バッチ適用・refetch・フォールバック挙動を検証した。
- [x] 既存テスト（`topics.$topicId.test.tsx`, `uiStore.test.ts`）を更新し、モードトグル統合を検証した。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-23_issue145_phase5_realtime_timeline_mode.md` を追加。

## 検証（Issue #145）

- [x] `docker compose -f docker-compose.test.yml run --rm --no-deps ts-test pnpm test -- --run --reporter=dot --silent`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #144: Phase4 右ペイン preview + drag 遷移

- [x] `TimelineThreadCard` に親投稿クリック導線を追加し、タイムラインカードから右ペイン preview を開けるようにした。
- [x] `ThreadPreviewPane` を新規実装し、スレッド内容表示・閉じる操作・アクセシビリティ代替ボタン（全画面表示）を提供した。
- [x] 右ペインで左ドラッグ閾値（120px）を超えた際に `/topics/$topicId/threads/$threadUuid` へ遷移する挙動を実装した。
- [x] `topics.$topicId` ルートを更新し、右ペイン 2 カラム表示と full thread ルート遷移を統合した。
- [x] i18n 追加（ja/en/zh-CN）で preview 操作文言・説明文言を反映した。
- [x] 単体テスト・ルート統合テスト（`ThreadPreviewPane` / `TimelineThreadCard` / `topics.$topicId`）を追加した。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-23_issue144_phase4_right_pane_preview_drag_transition.md` を追加。

## 検証（Issue #144）

- [x] `docker compose --project-name kukuri_tests -f docker-compose.test.yml run --rm lint-check`（pass）
- [x] `bash ./scripts/test-docker.sh ts --no-build`（pass）
- [x] `bash ./scripts/test-docker.sh rust --no-build`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #129: プロフィール保存の永続化不具合修正

- [x] `ProfileEditDialog` / `ProfileSetup` の保存処理で、アバター以外のプロフィール項目（`name` / `displayName` / `about` / `nip05`）をローカル保存できるよう `update_user_profile` 呼び出しを追加。
- [x] Tauri 側に `UpdateUserProfileRequest` と `update_user_profile` コマンドを追加し、フロント API 型との不一致とバリデーション不整合を解消。
- [x] `get_user` / `get_user_by_pubkey` の返却型を `UserProfileDto` に統一し、フロントのプロフィール取得型と整合。
- [x] 既存のアバターアップロード・同期フローを維持しつつ、保存処理中の失敗を工程別（avatar/privacy/local/nostr/sync/init）に可視化。
- [x] 保存後に React Query キャッシュを更新・invalidate して、設定画面/プロフィール表示系の画面間反映を即時化。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-23_issue129_profile_save_persistence.md` を追加。

## 検証

- [x] `cd kukuri-tauri/src-tauri && cargo fmt`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `bash ./scripts/test-docker.sh ts --scenario profile-avatar-sync`（pass）
- [x] `bash ./scripts/test-docker.sh lint --no-build`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #143: Phase3 thread UI routes と forum view

- [x] `/topics/$topicId/threads`（スレッド一覧）と `/topics/$topicId/threads/$threadUuid`（スレッド詳細）ルートを追加し、topic 画面からの導線を接続。
- [x] thread 一覧 UI を実装し、`useTopicThreads` で取得したタイムラインカードを再利用して表示。
- [x] forum-style thread detail を実装し、`thread_parent_event_id` を使った階層返信レンダリングとノード単位 expand/collapse を追加。
- [x] `useThreadPosts` / `useTopicThreads` を追加し、P2P/Nostr 受信・投稿更新時の `topicThreads` / `threadPosts` キャッシュ invalidate を反映。
- [x] i18n（ja/en/zh-CN）へ thread/forum 表示文言を追加。
- [x] ルート・hook・コンポーネントの単体テストを追加/更新。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-23_issue143_phase3_thread_ui_routes_forum_view.md` を追加。

## 検証（Issue #143）

- [x] `bash ./scripts/test-docker.sh ts`（pass）
- [x] `bash ./scripts/test-docker.sh lint --no-build`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #140: Topic timeline/thread rebuild Phase 1（Backend thread foundation）

- [x] `CreatePostRequest` / `PostResponse` を thread メタデータ（`threadUuid` / root / parent）対応に拡張し、`create_post` コマンド経路を breaking 変更。
- [x] `event_threads` 永続化モデルを導入（migration 追加、post 作成/イベント受信時に thread 情報を upsert 保存）。
- [x] `get_thread_posts(topic_id, thread_uuid)` の取得経路を実装（DTO/handler/command/repository を追加）。
- [x] 互換 backfill は実装せず、Phase1 要件どおり新規データ経路のみ整備。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-23_issue140_thread_foundation_phase1.md` を追加。

## 検証（Issue #140）

- [x] `cd kukuri-tauri/src-tauri && cargo fmt`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `bash ./scripts/test-docker.sh ts`（pass）
- [x] `bash ./scripts/test-docker.sh lint --no-build`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #142: Phase2 timeline aggregation rebuild

- [x] バックエンドに `get_topic_timeline(topic_id, limit)` 集約 API を実装し、親投稿 + 先頭返信 + 返信数 + 最終アクティビティ時刻を thread 単位で返却する経路（Repository / Service / DTO / Handler / Tauri command）を追加。
- [x] SQL 集約クエリを追加し、`event_threads` + `posts` から `root_event_id` / `first_reply_event_id` / `reply_count` / `last_activity_at` を算出できるようにした。
- [x] フロントエンドに `useTopicTimeline` と `TimelineThreadCard` を追加し、Topic 画面を「投稿一覧」から「thread タイムラインカード表示」へ切り替えた。
- [x] `topicTimeline` 用の React Query invalidate を投稿追加/更新/削除・P2P/Nostr受信フローへ組み込み、表示の即時反映を担保した。
- [x] i18n 文言（ja/en/zh-CN）を追加し、Timeline カードの返信数/先頭返信/最終アクティビティ表示をローカライズした。
- [x] Rust テスト（`post_service`）とフロントテスト（`usePosts` / `TimelineThreadCard`）を追加し、Phase2 仕様を検証した。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-23_issue142_phase2_timeline_aggregation_rebuild.md` を追加。

## 検証（Issue #142）

- [x] `cd kukuri-tauri/src-tauri && cargo fmt`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `bash ./scripts/test-docker.sh ts`（pass）
- [x] `bash ./scripts/test-docker.sh lint --no-build`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）
