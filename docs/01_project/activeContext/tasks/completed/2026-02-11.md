# 2026年02月11日 作業完了タスク

最終更新日: 2026年02月11日

## Community Nodes / `cn-user-api` bootstrap 認証必須時の `401 + WWW-Authenticate` 契約

- [x] `cn-user-api` の認証エラー実装を更新し、`Authorization` 不備で `401` を返す際に `WWW-Authenticate: Bearer realm="cn-user-api"` を付与
- [x] `/v1/bootstrap/nodes` の契約テストで `401` と `WWW-Authenticate` ヘッダ互換を検証
- [x] `/v1/bootstrap/topics/{topic_id}/services` の契約テストで `401` と `WWW-Authenticate` ヘッダ互換を検証
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-11_cn_user_api_bootstrap_401_www_authenticate_contract.md` として作成

## 検証

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（初回は `cargo fmt` 差分で失敗、整形後に再実行で成功）
  - 失敗ログ: `tmp/logs/gh-act-format-check-20260211-115842.log`
  - 成功ログ: `tmp/logs/gh-act-format-check-20260211-120021.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - ログ: `tmp/logs/gh-act-native-test-linux-20260211-120200.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - ログ: `tmp/logs/gh-act-community-node-tests-20260211-120854.log`

## Community Nodes / outbox consumer 必須メトリクス + `/metrics` 契約固定

- [x] `cn-core` に outbox consumer 指標を追加（`outbox_consumer_batches_total` / `outbox_consumer_processing_duration_seconds` / `outbox_consumer_batch_size`）
- [x] `cn-index` / `cn-moderation` / `cn-trust` の outbox consumer へ計測を実装（error rate 用 success/error カウント、処理レイテンシ、batch size）
- [x] 3サービスの `/metrics` 契約テストを拡張し、メトリクス名とラベル互換を固定
- [x] `docs/03_implementation/community_nodes/ops_runbook.md` に実メトリクス名を追記
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-11_cn_outbox_consumer_metrics_contract.md` として作成

## 検証（outbox consumer メトリクス）

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（初回失敗→整形修正後成功）
  - 失敗ログ: `tmp/logs/gh-act-format-check-20260211-122304.log`
  - 成功ログ: `tmp/logs/gh-act-format-check-20260211-122443.log`
  - 最終確認ログ: `tmp/logs/gh-act-format-check-20260211-124219.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - ログ: `tmp/logs/gh-act-native-test-linux-20260211-122600.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（初回失敗→ラベル順修正後成功）
  - 失敗ログ: `tmp/logs/gh-act-community-node-tests-20260211-123255.log`
  - 成功ログ: `tmp/logs/gh-act-community-node-tests-20260211-123647.log`

## Community Nodes / Admin Console 未充足要件（Moderation・Trust・Access Control）実装

- [x] 方針を「スコープ縮退なしで実装」に確定
- [x] `cn-admin-api` に Moderation ルールテスト API / Trust 対象検索 API / Access Control invite.capability 運用 API（発行・一覧・失効）を追加
- [x] `cn-admin-api` 契約テストを拡張し、上記 API の成功系と OpenAPI 収載を検証
- [x] `apps/admin-console` に Moderation ルールテスト実行 UI / Trust パラメータ編集・対象検索 UI / Access Control invite.capability 運用 UI を追加
- [x] `apps/admin-console` の UI テストを拡張し、主要操作の API 呼び出しを検証
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-11_admin_console_unmet_requirements_implementation.md` として作成

## 検証（Admin Console 未充足要件実装）

- [x] `docker run --rm -v \"${PWD}:/app\" -w /app/kukuri-community-node rust:1.88-bookworm ... cargo test --workspace --all-features -- --nocapture`（成功）
- [x] `docker run --rm -v \"${PWD}:/app\" -w /app/kukuri-community-node rust:1.88-bookworm ... cargo clippy --workspace --all-features -- -D warnings`（成功）
- [x] `docker run --rm -v \"${PWD}:/app\" -w /app/kukuri-community-node/apps/admin-console node:20-bookworm ... pnpm test -- src/pages/ModerationPage.test.tsx src/pages/TrustPage.test.tsx src/pages/AccessControlPage.test.tsx`（成功）
- [x] `./scripts/test-docker.ps1 rust -NoBuild`（成功）
- [x] `./scripts/test-docker.ps1 ts -NoBuild`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（初回失敗→`cargo fmt --all` 後に成功）
  - 失敗ログ: `tmp/logs/gh-act-format-check-admin-console-20260211-165735.log`
  - 成功ログ: `tmp/logs/gh-act-format-check-admin-console-20260211-165900.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - ログ: `tmp/logs/gh-act-native-test-linux-admin-console-20260211-170023.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（初回失敗: 既存 `kukuri-postgres-age` 名衝突→再実行で成功）
  - 失敗ログ: `tmp/logs/gh-act-community-node-tests-admin-console-20260211-170716.log`
  - 成功ログ: `tmp/logs/gh-act-community-node-tests-admin-console-20260211-170935.log`
