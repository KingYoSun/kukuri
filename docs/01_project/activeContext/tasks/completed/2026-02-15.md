# Issue #5 次タスク（2026年02月15日 追加監査）

最終更新日: 2026年02月15日

## 未実装/不足事項（2026年02月15日 監査追記）

以下の3タスクが追加されました。1タスク=1PRで実装します。

- [ ] **Task 1**: CI 実装を Runbook 方針へ統一する。
  - **目的**: `docs/03_implementation/community_nodes/ops_runbook.md` は「community-node 回帰確認は全OSでコンテナ経路を既定」としているが、`.github/workflows/test.yml` の `community-node-tests` ジョブはホスト上で `cd kukuri-community-node && cargo test --workspace --all-features` を実行している。
  - **修正**: `test-runner` コンテナ経路（`cargo test --workspace --all-features` + `cargo build --release -p cn-cli`）へ置き換え、CI/Runbook/AGENTS の運用を一致させる。
  - **参照**: `.github/workflows/test.yml` の `community-node-tests` ジョブ。

- [ ] **Task 2**: Admin Console の `ServicesPage` で bootstrap 認証遷移フォームの回帰テストを追加する。
  - **目的**: 現行テストは relay の auth transition を中心に検証しており、bootstrap 側（`auth.mode` / `enforce_at` / `grace_seconds` / `ws_auth_timeout_seconds`）の保存・バリデーション・version 衝突時の更新契約が未固定。
  - **修正**: `ServicesPage.test.tsx` に bootstrap 側フォームの初期表示・保存・バリデーション・version 衝突テストを追加（`feat/issue5-task2-bootstrap-auth-transition-tests` で PR作成予定）。
  - **参照**: `kukuri-community-node/apps/admin-console/src/pages/ServicesPage.test.tsx`。

- [ ] **Task 3**: `kukuri-tauri/src-tauri/src/state.rs` の 39000/39001 受信経路（`refresh_bootstrap_from_hint` + `ingest_bootstrap_event` 呼び出し）の統合テストを追加する。
  - **目的**: `community_node_handler.rs` 単体では hint 再取得を検証済みだが、P2P受信ハンドラ経由の連携（state 層）の回帰検知が不足しているため、gossip受信を含む導線テストで固定する。
  - **修正**: `state.rs` の gossip hint 受信→HTTP再取得→ingest 呼び出し経路をテストする統合テストを追加。
  - **参照**: `kukuri-tauri/src-tauri/src/state.rs` の `refresh_bootstrap_from_hint` / `ingest_bootstrap_event`。

## PR 作成方針

- **1タスク = 1PR** ルールに従い、各タスクを独立したブランチで実装。
- 各PRでテスト結果とエビデンス（実装ファイル/テストファイル/コマンド/結果）を明示。
- 全タスク完了後に再監査し、追加タスクがなければ Issue #5 をクローズ。

## Issue #22 監査完了（2026年02月15日）

- 対象: `docs/03_implementation/community_nodes` と `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md`
- 監査基準: `references/community-nodes-strict-audit-checklist.md` が存在しないため、Issue #5 strict gate コメント（`https://github.com/KingYoSun/kukuri/issues/5#issuecomment-3900483686`）を fallback として適用。
- 結果:
  - strict gate（Gate1-4）は PASS。
  - commit `b865ec92115efffb97768c1ed009292104ce1aeb` 起点の DoS上限タスクは未完であることを確認。
  - roadmap に未完4タスクを再起票し、`in_progress.md` に Issue #22 の次アクションを反映。
- 進捗レポート: `docs/01_project/progressReports/2026-02-15_issue22_community_nodes_reaudit.md`

## Issue #22 Task1 完了（2026年02月15日）

- 対象: `cn-user-api` の申請同時保留数上限（per pubkey）実装 + 拒否契約の反映（Issue #22）
- 実施内容:
  - `create_subscription_request` で pending 件数判定を追加し、上限超過時に `429` を返すよう実装。
  - 拒否契約を `code=PENDING_SUBSCRIPTION_REQUEST_LIMIT_REACHED` + `details(metric/current/limit/scope)` で固定。
  - `cn-user-api` 契約テストへ最小回帰（上限到達時拒否）を追加。
  - OpenAPI と設計ドキュメント（`topic_subscription_design.md` / `user_api.md`）を更新。
- 検証:
  - community-node Docker 経路で `cargo test --workspace --all-features` + `cargo build --release -p cn-cli` を完走。
  - `gh act --job format-check` / `--job native-test-linux` / `--job community-node-tests` を実行（`community-node-tests` は初回 flaky 失敗後の再実行で成功）。
- 進捗レポート: `docs/01_project/progressReports/2026-02-15_issue22_pending_request_limit_cn_user_api.md`

## Issue #22 Task1 フォローアップ完了（PR #23 レビュー修正、2026年02月15日）

- 対象: PR #23 レビューコメント `r2809304474`（`pg_advisory_xact_lock(hashtext($1))` の衝突リスク指摘）
- 実施内容:
  - `cn-user-api` の pending 上限判定で使う advisory lock を `hashtext` 1キー方式から、`blake3` 由来の 2 キー方式（`pg_advisory_xact_lock($1, $2)`）へ置換。
  - 同一 pubkey で鍵が安定すること・異なる pubkey で鍵ペアが変化することをユニットテストで固定。
- 検証:
  - Community Node の Docker 経路で `cargo test --workspace --all-features` と `cargo build --release -p cn-cli` を再実行し成功（1回目 deadlock は flaky として再実行で解消）。
  - セッション完了時に `gh act --job format-check` / `--job native-test-linux` / `--job community-node-tests` を実行。
    - `format-check`: 成功
    - `native-test-linux`: 成功
    - `community-node-tests`: 既知 flaky（`cn-admin-api` 契約テストの `tuple concurrently updated` / `trigger already exists`）で再実行後も失敗
- 進捗レポート: `docs/01_project/progressReports/2026-02-15_issue22_pr23_advisory_lock_collision_fix.md`

## Issue #22 Task2 完了（`cn-user-api` pending limit 契約テスト拡張、2026年02月15日）

- 対象: `cn-user-api` の per-pubkey pending 同時保留数上限に対する契約テスト拡張（Issue #22）
- 実施内容:
  - `under-limit`（上限未満）で申請が受理される契約テストを追加。
  - `at-limit`（上限ちょうど）で `429 + PENDING_SUBSCRIPTION_REQUEST_LIMIT_REACHED` が返る境界契約テストを追加。
  - `approved` / `rejected` に遷移後、再申請が可能になる契約テストを追加。
  - 重複SQLを避けるため、pending申請投入・ステータス更新・pending件数取得のテストヘルパーを追加。
- 検証:
  - `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`
  - `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`
  - `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-user-api topic_subscription_pending_request_limit_contract_ -- --nocapture --test-threads=1"`（成功, 3 passed）
  - `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（既知 flaky 失敗: `cn-admin-api` の `contract_tests::admin_mutations_fail_when_audit_log_write_fails` で `trigger \"test_audit_failures_trigger\" already exists`）
- 進捗レポート: `docs/01_project/progressReports/2026-02-15_issue22_pending_limit_contract_tests.md`

## Issue #22 Task2 フォローアップ完了（PR #24 OpenAPI Artifacts Check 修正、2026年02月15日）

- 対象: PR #24 の `OpenAPI Artifacts Check` 失敗（`user-api.json` の生成物差分）
- 実施内容:
  - `gh` で Actions job `63671295920` のログを取得し、差分が `kukuri-community-node/apps/admin-console/openapi/user-api.json` の末尾改行のみであることを確認。
  - CI と同じ再生成コマンド（`cn openapi export` + `pnpm generate:api`）でローカル再現し、同差分を確認。
  - `user-api.json` を生成結果へ合わせて末尾改行なしへ統一し、OpenAPI アーティファクトの整合を回復。
- 検証:
  - `cd kukuri-community-node/apps/admin-console && CI=true pnpm install --frozen-lockfile`（成功）
  - `cd kukuri-community-node && cargo run --locked -p cn-cli -- openapi export --service user-api --output apps/admin-console/openapi/user-api.json --pretty && cargo run --locked -p cn-cli -- openapi export --service admin-api --output apps/admin-console/openapi/admin-api.json --pretty`（成功）
  - `cd kukuri-community-node/apps/admin-console && pnpm generate:api`（成功）
  - `cd kukuri-community-node && cargo test -p cn-user-api openapi_contract_ -- --nocapture`（成功, 1 passed）
  - `git diff --exit-code -- kukuri-community-node/apps/admin-console/openapi/*.json kukuri-community-node/apps/admin-console/src/generated/admin-api.ts`（HEAD更新後に成功）
- 進捗レポート: `docs/01_project/progressReports/2026-02-15_issue22_pr24_openapi_artifacts_fix.md`

## Issue #22 Task3 完了（node-level 同時取込 topic 数上限の実装、2026年02月15日）

- 対象: `cn-admin-api` + `cn-user-api` + `cn-relay` 境界の承認フローで node-level 同時取込 topic 数上限を強制し、超過時の拒否契約を明示する（Issue #22）。
- 実施内容:
  - `cn-admin-api` の `approve_subscription_request` に node-level 上限チェックを追加し、上限超過時は `429` / `NODE_SUBSCRIPTION_TOPIC_LIMIT_REACHED` / `details(metric=current/limit/scope)` を返すよう実装。
  - 承認時の競合を避けるため、node-level 上限判定に transaction advisory lock（2キー）を導入。
  - 上限設定を `cn_admin.service_configs(service='relay').config_json.node_subscription.max_concurrent_topics` から参照し、未設定時は既定値（`100`）を適用。
  - `cn-relay` 側にも同一設定キーを追加し、enabled topic 読み込みを `max_concurrent_topics` 上限内（`ORDER BY updated_at DESC` + `LIMIT`）へ揃えた。
  - OpenAPI 契約に `POST /v1/admin/subscription-requests/{request_id}/approve` の `429` レスポンスを追加し、生成物（`apps/admin-console/openapi/admin-api.json` / `src/generated/admin-api.ts`）を更新。
  - `cn-admin-api` 契約テストに over-limit 拒否ケースを追加（承認拒否契約と pending 維持を検証）。
- 検証:
  - `cd kukuri-community-node && cargo fmt --all`（成功）
  - `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
  - `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（成功）
  - `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -e RUST_TEST_THREADS=1 -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（成功）
  - `cd kukuri-community-node && cargo run --locked -p cn-cli -- openapi export --service user-api --output apps/admin-console/openapi/user-api.json --pretty && cargo run --locked -p cn-cli -- openapi export --service admin-api --output apps/admin-console/openapi/admin-api.json --pretty`（成功）
  - `cd kukuri-community-node/apps/admin-console && pnpm install --frozen-lockfile && pnpm generate:api`（成功）
  - `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（成功, ログ: `tmp/logs/gh-act-format-check-issue22-node-level-topic-limit.log`）
  - `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功, ログ: `tmp/logs/gh-act-native-test-linux-issue22-node-level-topic-limit.log`）
  - `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功, ログ: `tmp/logs/gh-act-community-node-tests-issue22-node-level-topic-limit.log`）
- 進捗レポート: `docs/01_project/progressReports/2026-02-15_issue22_node_level_topic_ingestion_limit.md`
