# Issue #5 次タスク（2026年02月15日 追加監査）

最終更新日: 2026年02月15日

## 未実装/不足事項（2026年02月15日 監査追記）

以下の3タスクが追加されました。1タスク=1PRで実装します。

- [ ] **Task 1**: CI 実装を Runbook 方針へ統一する。
  - **目的**: `docs/03_implementation/community_nodes/ops_runbook.md` は「community-node 回帰確認は全OSでコンテナ経路を既定」としているが、`.github/workflows/test.yml` の `community-node-tests` ジョブはホスト上で `cd kukuri-community-node && cargo test --workspace --all-features` を実行している。
  - **修正**: `test-runner` コンテナ経路（`cargo test --workspace --all-features` + `cargo build --release -p cn-cli`）へ置き換え、CI/Runbook/AGENTS の運用を一致させる。
  - **参照**: `.github/workflows/test.yml` の `community-node-tests` ジョブ。

- [ ] **Task 2**: Admin Console の `ServicesPage` で bootstrap 認証遷移フォームの回帰テストを追加する。
  - **目的**: 現行テストは relay の auth transition を中心に検証しており、bootstrap 側（`auth.mode` / `enforce_at` / `grace_seconds` / `ws_auth_timeout_seconds`）の保存・バリデーション・version 衝突時の更新契約が未固定。
  - **修正**: `ServicesPage.test.tsx` に bootstrap 側フォームの初期表示・保存・バリデーション・version 衝突テストを追加（`feat/issue5-task2-bootstrap-auth-transition-tests` で PR作成予定）。
  - **参照**: `kukuri-community-node/apps/admin-console/src/pages/ServicesPage.test.tsx`。

- [ ] **Task 3**: `kukuri-tauri/src-tauri/src/state.rs` の 39000/39001 受信経路（`refresh_bootstrap_from_hint` + `ingest_bootstrap_event` 呼び出し）の統合テストを追加する。
  - **目的**: `community_node_handler.rs` 単体では hint 再取得を検証済みだが、P2P受信ハンドラ経由の連携（state 層）の回帰検知が不足しているため、gossip受信を含む導線テストで固定する。
  - **修正**: `state.rs` の gossip hint 受信→HTTP再取得→ingest 呼び出し経路をテストする統合テストを追加。
  - **参照**: `kukuri-tauri/src-tauri/src/state.rs` の `refresh_bootstrap_from_hint` / `ingest_bootstrap_event`。

## PR 作成方針

- **1タスク = 1PR** ルールに従い、各タスクを独立したブランチで実装。
- 各PRでテスト結果とエビデンス（実装ファイル/テストファイル/コマンド/結果）を明示。
- 全タスク完了後に再監査し、追加タスクがなければ Issue #5 をクローズ。

## Issue #22 監査完了（2026年02月15日）

- 対象: `docs/03_implementation/community_nodes` と `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md`
- 監査基準: `references/community-nodes-strict-audit-checklist.md` が存在しないため、Issue #5 strict gate コメント（`https://github.com/KingYoSun/kukuri/issues/5#issuecomment-3900483686`）を fallback として適用。
- 結果:
  - strict gate（Gate1-4）は PASS。
  - commit `b865ec92115efffb97768c1ed009292104ce1aeb` 起点の DoS上限タスクは未完であることを確認。
  - roadmap に未完4タスクを再起票し、`in_progress.md` に Issue #22 の次アクションを反映。
- 進捗レポート: `docs/01_project/progressReports/2026-02-15_issue22_community_nodes_reaudit.md`

## Issue #22 Task1 完了（2026年02月15日）

- 対象: `cn-user-api` の申請同時保留数上限（per pubkey）実装 + 拒否契約の反映（Issue #22）
- 実施内容:
  - `create_subscription_request` で pending 件数判定を追加し、上限超過時に `429` を返すよう実装。
  - 拒否契約を `code=PENDING_SUBSCRIPTION_REQUEST_LIMIT_REACHED` + `details(metric/current/limit/scope)` で固定。
  - `cn-user-api` 契約テストへ最小回帰（上限到達時拒否）を追加。
  - OpenAPI と設計ドキュメント（`topic_subscription_design.md` / `user_api.md`）を更新。
- 検証:
  - community-node Docker 経路で `cargo test --workspace --all-features` + `cargo build --release -p cn-cli` を完走。
  - `gh act --job format-check` / `--job native-test-linux` / `--job community-node-tests` を実行（`community-node-tests` は初回 flaky 失敗後の再実行で成功）。
- 進捗レポート: `docs/01_project/progressReports/2026-02-15_issue22_pending_request_limit_cn_user_api.md`
