# 2026年02月13日 完了タスク

## Community Nodes / `cn-relay` `/healthz` ready 依存判定拡張

- [x] `cn-relay` `/healthz` を DB到達性のみの判定から拡張し、relay 依存（gossip 参加状態・topic購読同期状態）の劣化を `degraded` / `unavailable` で返すように実装
- [x] `cn-relay` `/healthz` 契約テストを拡張し、`gossip未参加 -> unavailable` と `topic同期ドリフト -> degraded` を固定
- [x] `community_nodes_roadmap.md` の該当未実装項目を `[x]` に更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-13_cn_relay_healthz_ready_dependency_status.md` を作成

## 検証

- [x] `./scripts/test-docker.ps1 rust`
  - ログ: `tmp/logs/test-docker-rust-relay-healthz-20260213-050522.log`
- [x] `docker run --rm --network host -v ${PWD}:/workspace ... kukuri-test-runner bash -lc "source /usr/local/cargo/env && cd /workspace/kukuri-community-node && cargo test -p cn-relay --all-features -- --nocapture"`（成功）
  - ログ: `tmp/logs/cn-relay-healthz-contract-mounted-20260213-051222.log`
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功）
  - ログ: `tmp/logs/gh-act-format-check-relay-healthz-20260213-051312.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功）
  - ログ: `tmp/logs/gh-act-native-test-linux-relay-healthz-20260213-051312.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功）
  - ログ: `tmp/logs/gh-act-community-node-tests-relay-healthz-20260213-051312.log`

## Community Nodes / `cn-relay` REQ 制約（`#t` 必須・filter上限・limit上限）テスト互換固定

- [x] `cn-relay` `filters.rs` に REQ 制約の単体テストを追加し、拒否理由 `missing #t filter` / `too many filters` / `too many filter values` の互換を固定
- [x] `limit` 上限（`MAX_LIMIT`）のクランプ挙動を単体テストで固定
- [x] `community_nodes_roadmap.md` の該当未実装項目を `[x]` に更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-13_cn_relay_req_filter_constraints_tests.md` を作成

## 検証（REQ 制約テスト互換固定）

- [x] `./scripts/test-docker.ps1 rust`
  - ログ: `tmp/logs/test-docker-rust-cn-relay-filters-20260213-060257.log`
- [x] `docker run --rm --network kukuri_community-node-network -v ${PWD}:/workspace ... kukuri-test-runner bash -lc "source /usr/local/cargo/env && cd /workspace/kukuri-community-node && cargo test --workspace --all-features && cargo build --release -p cn-cli"`（成功）
  - 備考: 初回は DB 未接続で `PoolTimedOut`。`community-node-postgres` / `community-node-meilisearch` を起動後に再実行して成功
- [x] `docker run --rm -v ${PWD}:/workspace ... kukuri-test-runner bash -lc "source /usr/local/cargo/env && cd /workspace/kukuri-community-node && cargo test -p cn-relay filters::tests -- --nocapture"`（成功）
  - ログ: `tmp/logs/cn-relay-filters-unit-20260213-060159.log`
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - ログ: `tmp/logs/gh-act-format-check-cn-relay-filters-20260213-054917.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功、既知の `useRouter` 警告のみ）
  - ログ: `tmp/logs/gh-act-native-test-linux-cn-relay-filters-20260213-055036.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - ログ: `tmp/logs/gh-act-community-node-tests-cn-relay-filters-20260213-055724.log`

## Community Nodes / `cn-user-api` 429 契約（`RATE_LIMITED` + `Retry-After`）回帰テスト補完

- [x] `cn-user-api` 契約テストに `/v1/auth/challenge` `/v1/auth/verify` の境界テストを追加し、429応答の `code=RATE_LIMITED` と `Retry-After` ヘッダを固定
- [x] `/v1/bootstrap/nodes` `/v1/bootstrap/topics/{topic_id}/services` の境界テストを追加し、`/v1/bootstrap/*` の public rate limit 境界を固定
- [x] protected API（`/v1/search` `/v1/trending`）の境界テストを追加し、429契約（`RATE_LIMITED` + `Retry-After`）を固定
- [x] `community_nodes_roadmap.md` の該当未実装項目を `[x]` に更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-13_cn_user_api_rate_limit_boundary_contract_tests.md` を作成

## 検証（`cn-user-api` 429 契約回帰）

- [x] `./scripts/test-docker.ps1 rust`（成功）
  - ログ: `tmp/logs/test-docker-rust-cn-user-api-rate-limit-20260213-100902.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - ログ: `tmp/logs/gh-act-format-check-cn-user-api-rate-limit-20260213-100933.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功、既知の `useRouter` 警告のみ）
  - ログ: `tmp/logs/gh-act-native-test-linux-cn-user-api-rate-limit-20260213-101052.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - ログ: `tmp/logs/gh-act-community-node-tests-cn-user-api-rate-limit-20260213-101726.log`

## Community Nodes / OpenAPI 生成物の CI 差分検知ジョブ追加

- [x] `test.yml` に `openapi-artifacts-check` ジョブを追加し、`cn-cli openapi export` + `pnpm generate:api` + `git diff --exit-code` で `apps/admin-console/openapi/*.json` と `src/generated/admin-api.ts` の更新漏れを検知するようにした
- [x] `pr-required-checks` に `openapi-artifacts-check` を組み込み、PR 必須チェックに反映した（`docs_only` の skip を許容）
- [x] 既存実装との差分を埋めるため `kukuri-community-node/apps/admin-console/openapi/admin-api.json` と `kukuri-community-node/apps/admin-console/src/generated/admin-api.ts` を再生成した
- [x] `community_nodes_roadmap.md` の該当未実装項目を `[x]` に更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-13_openapi_generated_artifacts_ci_diff_detection.md` を作成

## 検証（OpenAPI CI 差分検知）

- [x] `gh act --workflows .github/workflows/test.yml --job openapi-artifacts-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（失敗、意図どおり）
  - ログ: `tmp/logs/gh-act-openapi-artifacts-check-20260213-104423.log`
  - ログ: `tmp/logs/gh-act-openapi-artifacts-check-20260213-104939.log`
  - 備考: `act` の `actions/checkout` は未コミット差分を取り込まないため、HEAD 基準で「更新漏れあり」となって失敗
- [x] 生成再実行の再現性確認（`admin-api.json` / `admin-api.ts` の SHA-256 一致）
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - ログ: `tmp/logs/gh-act-format-check-openapi-ci-20260213-105407.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功、既知の `useRouter` 警告のみ）
  - ログ: `tmp/logs/gh-act-native-test-linux-openapi-ci-20260213-105531.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - ログ: `tmp/logs/gh-act-community-node-tests-openapi-ci-20260213-110222.log`

## Community Nodes / `cn-user-api` `billing::consume_quota` commit 失敗伝播の厳密化

- [x] `cn-user-api` の `billing::consume_quota` で `tx.commit().await.ok()` を廃止し、commit 失敗を `5xx (DB_ERROR)` として返すように修正
- [x] 成功系/超過系の双方で commit 失敗時に `200`/`402` を誤返却しないよう、`search` 経由の契約回帰テストを追加
- [x] commit 失敗時に `usage_events` / `usage_counters_daily` の副作用が残らないことをテストで固定
- [x] `community_nodes_roadmap.md` の該当未実装項目を `[x]` に更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-13_cn_user_api_billing_consume_quota_commit_db_error.md` を作成

## 検証（`consume_quota` commit 失敗伝播）

- [x] `./scripts/test-docker.ps1 rust`（ログ上成功、終了コード `-1` は既知）
  - ログ: `tmp/logs/test-docker-rust-cn-user-api-billing-20260213-120259.log`
- [x] `docker run --rm --network kukuri_community-node-network -v ${PWD}:/workspace ... cargo test -p cn-user-api search_quota_commit_failure_on_* -- --nocapture --test-threads=1`（成功）
  - ログ: `tmp/logs/cn-user-api-commit-failure-tests-20260213-120342.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - ログ: `tmp/logs/gh-act-format-check-cn-user-api-billing-20260213-120136.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - ログ: `tmp/logs/gh-act-native-test-linux-cn-user-api-billing-20260213-115127.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - ログ: `tmp/logs/gh-act-community-node-tests-cn-user-api-billing-20260213-115757.log`

## Community Nodes / `cn-user-api` `delete_topic_subscription` commit 失敗伝播の厳密化

- [x] `cn-user-api` の `delete_topic_subscription` で `tx.commit().await.ok()` を廃止し、commit 失敗時に `5xx (DB_ERROR)` を返すように修正
- [x] commit 失敗を再現する契約テスト（`topic_subscription_delete_commit_failure_returns_db_error_and_rolls_back`）を追加し、`status=ended` を返さないことを固定
- [x] commit 失敗時に `topic_subscriptions` / `node_subscriptions` の副作用が残らないことをテストで固定
- [x] `community_nodes_roadmap.md` の該当未実装項目（`delete_topic_subscription` と異常系回帰テスト）を `[x]` に更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-13_cn_user_api_delete_topic_subscription_commit_db_error.md` を作成

## 検証（`delete_topic_subscription` commit 失敗伝播）

- [x] `./scripts/test-docker.ps1 rust`（ログ上成功、終了コード `-1` は既知）
  - ログ: `tmp/logs/test-docker-rust-cn-user-api-delete-20260213-122925.log`
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v ${PWD}:/workspace kukuri-test-runner bash -lc "source /usr/local/cargo/env && cd /workspace/kukuri-community-node && cargo test -p cn-user-api topic_subscription_delete_commit_failure_returns_db_error_and_rolls_back -- --nocapture --test-threads=1"`（成功）
  - ログ: `tmp/logs/cn-user-api-topic-subscription-commit-failure-20260213-123537.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job format-check`（初回は rustfmt 差分で失敗後、`cargo fmt` 実行で再実行成功）
  - 失敗ログ: `tmp/logs/gh-act-format-check-cn-user-api-delete-20260213-123411.log`
  - 成功ログ: `tmp/logs/gh-act-format-check-cn-user-api-delete-20260213-123729.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功、既知の `useRouter` 警告のみ）
  - ログ: `tmp/logs/gh-act-native-test-linux-cn-user-api-delete-20260213-123853.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - ログ: `tmp/logs/gh-act-community-node-tests-cn-user-api-delete-20260213-124520.log`

## Community Nodes / `cn-admin-api` `auth::logout` セッション削除失敗の 5xx 契約固定

- [x] `cn-admin-api` `auth::logout` の `DELETE cn_admin.admin_sessions ... .await.ok()` を廃止し、削除失敗を `DB_ERROR (500)` として返すように修正
- [x] OpenAPI（`/v1/admin/auth/logout`）に `500 + ErrorResponse` を追加し、失敗時レスポンス契約を明文化
- [x] 契約テスト `auth_contract_logout_returns_500_when_session_delete_fails` を追加し、`500/DB_ERROR` と副作用なし（セッション残存）を固定
- [x] OpenAPI 契約テストに `.../auth/logout/post/responses/500` の検証を追加
- [x] `apps/admin-console/openapi/admin-api.json` と `src/generated/admin-api.ts` を再生成
- [x] `community_nodes_roadmap.md` の該当未実装項目を `[x]` に更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-13_cn_admin_api_logout_session_delete_db_error_contract.md` を作成

## 検証（`auth::logout` 5xx 契約固定）

- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v ${PWD}:/workspace -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api auth_contract_ -- --nocapture --test-threads=1"`（成功）
  - ログ: `tmp/logs/cn-admin-api-auth-logout-contract-20260213-140818.log`
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v ${PWD}:/workspace -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api openapi_contract_contains_admin_paths -- --nocapture --test-threads=1"`（成功）
  - ログ: `tmp/logs/cn-admin-api-openapi-logout-contract-20260213-140836.log`
- [x] `./scripts/test-docker.ps1 rust -NoBuild`（成功）
  - ログ: `tmp/logs/test-docker-rust-cn-admin-logout-20260213-140743.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - ログ: `tmp/logs/gh-act-format-check-cn-admin-logout-20260213-135317.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功、既知の `useRouter` 警告のみ）
  - ログ: `tmp/logs/gh-act-native-test-linux-cn-admin-logout-20260213-135441.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - ログ: `tmp/logs/gh-act-community-node-tests-cn-admin-logout-20260213-140350.log`
## Community Nodes / `cn-relay` 認証遷移（既存接続の猶予切断）整合

- [x] `cn-relay` の WS 認証遷移を修正し、既存接続の切断条件を `disconnect_unauthenticated_at = enforce_at + grace_seconds` に一致させた
- [x] `ws_auth_timeout_seconds` の責務を新規接続（または猶予なし必須化）向けに分離し、既存接続の猶予中切断に使わないよう実装を明確化した
- [x] `cn-relay` 統合テストを更新し、既存接続は猶予満了後に `auth-required: deadline reached` で切断されることを固定した
- [x] `auth_transition_design.md` / `services_relay.md` に責務分離を追記し、`community_nodes_roadmap.md` の該当未実装項目を `[x]` に更新した
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-13_cn_relay_auth_transition_existing_connection_grace.md` を作成

## 検証（`cn-relay` 認証遷移整合）

- [x] `./scripts/test-docker.ps1 rust`（成功）
  - ログ: `tmp/logs/test-docker-rust-cn-relay-auth-transition-20260213-144235.log`
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v ${PWD}:/workspace -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "source /usr/local/cargo/env && cargo test --workspace --all-features && cargo build --release -p cn-cli"`
  - 初回ログ: `tmp/logs/community-node-rust-workspace-auth-transition-20260213-144302.log`
  - 備考: 既存 DB データ残留により `cn_relay.events` の重複キー衝突（既知）
  - DB 再作成後の再実行ログ: `tmp/logs/community-node-rust-workspace-auth-transition-rerun-20260213-145345.log`（成功）
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - ログ: `tmp/logs/gh-act-format-check-cn-relay-auth-transition-20260213-151015.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功、既知の `useRouter` 警告のみ）
  - ログ: `tmp/logs/gh-act-native-test-linux-cn-relay-auth-transition-20260213-151134.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - ログ: `tmp/logs/gh-act-community-node-tests-cn-relay-auth-transition-20260213-151759.log`
