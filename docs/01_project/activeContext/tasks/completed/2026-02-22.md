# 2026年02月22日 完了タスク

最終更新日: 2026年02月22日

## Issue #124: Admin UI Relay 接続表示/トピック管理 UI

- [x] `cn-admin-api` に node subscription CRUD（`GET/POST/PUT/DELETE`）を追加し、既存の admin 認可・監査ログ・保存挙動を維持。
- [x] `cn_bootstrap.events`（kind `39000`/`39001`）を参照して、topic ごとの `connected_nodes`（`node_id@host:port`）と `connected_node_count` を API 応答へ追加。
- [x] Admin Console の Subscriptions ページに以下を実装。
  - Relay 接続情報（`node_id@host:port`）の topic 単位表示
  - topic ごとの接続ノード数表示
  - 購読 topic CRUD（追加/編集［既存 toggle/policy 保存］/削除）UI
- [x] OpenAPI（`admin-api.json`）と生成型（`src/generated/admin-api.ts`）を更新し、契約を同期。
- [x] `SubscriptionsPage` テストと `cn-admin-api` 契約テストを更新。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-22_issue124_admin_ui_node_subscriptions.md` を追加。

## 検証

- [x] `cargo run --locked -p cn-cli -- openapi export --service admin-api --output apps/admin-console/openapi/admin-api.json --pretty`（pass）
- [x] `docker compose --project-name kukuri -f docker-compose.test.yml up -d --wait community-node-postgres`（pass）
- [x] `docker compose --project-name kukuri -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cd /workspace/kukuri-community-node/apps/admin-console; pnpm install --frozen-lockfile; pnpm generate:api; pnpm test -- src/pages/SubscriptionsPage.test.tsx; cd /workspace/kukuri-community-node; cargo test -p cn-admin-api subscription_requests_and_node_subscriptions_contract_success -- --nocapture"`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-admin-api -- --nocapture"`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `docker run --rm -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-tauri/src-tauri kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #127: Tauri 起動時「初期化中...」表示の短縮

- [x] `authStore.initialize` のクリティカルパスを最小化し、`initializeNostr`・リレー状態更新・トピック bootstrap・アバター取得・`loadAccounts` を遅延実行へ分離。
- [x] 遅延実行タスクは `errorHandler` で失敗を記録し、従来どおり例外を握りつぶさずログを残す挙動を維持。
- [x] `RootRoute` で初期化処理を `try/catch/finally` 化し、失敗時でも初期化表示が解除されるよう改善。
- [x] 起動ゲート時間を `RootRoute.initialize` / `AuthStore.initialize` の情報ログに ms 単位で出力できるようにして、実測可能性を追加。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-22_issue127_tauri_startup_initializing_reduction.md` を追加。

## 検証（Issue #127）

- [x] `bash scripts/test-docker.sh ts`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## PR #133 review discussion `r2838338102`: deferred startup task auth/session guard

- [x] `authStore.initialize` の遅延自動ログイン処理に `isAuthenticated` + `currentUser.npub` 一致ガードを追加し、ログアウト/セッション切替後の `updateRelayStatus`・`bootstrapTopics`・`fetchAndApplyAvatar` 実行を防止。
- [x] `authStore.accounts` テストに、(1) 自動ログイン中ログアウト、(2) 自動ログイン中 `npub` 変更 の2ケースを追加して回帰を固定。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-22_pr133_auth_session_guard.md` を追加。

## 検証（PR #133 review discussion `r2838338102`）

- [x] `docker compose --project-name kukuri_tests -f docker-compose.test.yml run --rm ts-test pnpm vitest run src/tests/unit/stores/authStore.accounts.test.ts src/tests/unit/stores/authStore.test.ts`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #125: Tauri サイドバー幅の自動調整とレスポンシブ対応

- [x] `MainLayout` の固定幅ラッパー制御を削除し、`Sidebar` 側へ幅制御を一元化。
- [x] `Sidebar` に `scrollWidth` + viewport 制約による動的幅算出（`ResizeObserver` 監視）を実装し、固定 `w-64` を撤廃。
- [x] 狭い画面で最大幅を制限し、メイン領域レイアウトの崩れを抑止。
- [x] `Sidebar` テストを更新（閉状態 `width: 0px`）し、開状態の最小幅テスト（`256px`）を追加。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-22_issue125_sidebar_auto_width.md` を追加。

## 検証（Issue #125）

- [x] `docker compose --project-name kukuri_tests -f docker-compose.test.yml run --rm ts-test pnpm vitest run src/tests/unit/components/layout/MainLayout.test.tsx src/tests/unit/components/layout/Sidebar.test.tsx`（pass）
- [x] `bash scripts/test-docker.sh ts --no-build`（pass）
- [x] `bash scripts/test-docker.sh lint --no-build`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #126: Relay/P2P情報をサイドバーからアンテナモーダルへ移設

- [x] `RelayStatus` / `P2PStatus` を `Sidebar` から除去。
- [x] `Header` にアンテナアイコン導線（`AntennaStatusDialog`）を追加し、クリックでモーダル表示できるよう変更。
- [x] モーダル内で `RelayStatus` / `P2PStatus` を同時表示し、既存情報を同等に閲覧できる構成へ移設。
- [x] `Header.test.tsx` / `Sidebar.test.tsx` を更新して、導線と移設結果をテストで固定。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-22_issue126_relay_p2p_antenna_modal.md` を追加。

## 検証（Issue #126）

- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #128: 設定永続化（ダークモード/言語）

- [x] `useUIStore` に `theme` 永続化（`ui-storage`）を追加し、再起動後に復元されるように更新。
- [x] 旧テーマキー（`kukuri-theme` / `theme`）と旧形式（boolean/JSON）の互換復元を追加。
- [x] `i18n` 起動時に `kukuri-locale` を復元し、旧キー `i18nextLng` からの移行保存を追加。
- [x] 設定画面の言語保存を `persistLocale` 経由に統一し、起動時復元と同じキー経路に統合。
- [x] E2E ブリッジの永続化クリア対象へ `persistKeys.ui` / `kukuri-locale` / `i18nextLng` を追加。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-22_issue128_settings_persistence.md` を追加。

## 検証（Issue #128）

- [x] `bash ./scripts/test-docker.sh ts`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config ACT_CACHE_DIR=/tmp/act-cache gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config ACT_CACHE_DIR=/tmp/act-cache gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config ACT_CACHE_DIR=/tmp/act-cache gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）
