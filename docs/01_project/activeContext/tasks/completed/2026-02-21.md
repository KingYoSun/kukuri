# 2026年02月21日 完了タスク

最終更新日: 2026年02月21日

## Issue #111 trust モデルを NIP-85（30382-30385/10040）へ全面置換

- [x] legacy trust kind（39010/39011）を NIP-85 trust assertion / provider list kind（30382-30385/10040）へ移行し、型・定数・バリデーション・生成ロジックを更新。
- [x] Community Node / Tauri 間の trust API・DTO・クライアント・UI の trust provider（NIP-85）経路を更新。
- [x] 旧 trust anchor 保存値の互換移行を残しつつ、実運用経路は NIP-85 に統一。
- [x] trust 関連テスト（Rust/TS/統合）とドキュメントを更新。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-21_issue111_nip85_trust_migration.md` を追加。

## 検証

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `bash ./scripts/test-docker.sh rust`（pass）
- [x] `bash ./scripts/test-docker.sh ts`（pass）
- [x] `docker compose -f docker-compose.test.yml run --rm lint-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## PR #112 Codex review 対応（TrustProviderList validation 強化）

- [x] `kind 10040` の `:rank` タグに対して、tag名prefix kind の妥当性（`30382-30385`）を検証するよう `cn-kip-types` のバリデーションを強化。
- [x] provider pubkey を 64桁hex公開鍵として検証し、無効値を reject するよう更新。
- [x] `invalid kind prefix` / `invalid pubkey` / `valid` のユニットテストを追加・更新。

## 検証（PR #112）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-kip-types"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #111 PR-1: cn-user-api trust subject expansion（event/relay/topic/addressable）

- [x] `cn-user-api` trust endpoint の subject parser/validation を `pubkey` 以外（`event`/`relay`/`topic`/`addressable`）へ拡張。
- [x] trust レスポンス処理を更新し、非 pubkey subject でも attestation fallback から score/assertion を返却可能にした。
- [x] OpenAPI 契約（server annotation / admin-console artifact / contract test）を拡張 subject 仕様へ更新。
- [x] `cn-user-api` の unit/contract test を追加し、event/addressable subject の実レスポンス互換を固定。
- [x] Tauri 側 `community_node_handler` の trust subject 検証を `addressable` 対応し、互換テストを追加。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-21_issue111_pr1_subject_expansion.md` を追加。

## 検証（Issue #111 PR-1）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-user-api -- --nocapture"`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass, log: `tmp/logs/gh-act-format-check-20260221-062943.log`）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass, log: `tmp/logs/gh-act-native-test-linux-20260221-063013.log`）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass, log: `tmp/logs/gh-act-community-node-tests-20260221-063424.log`）

## PR #114 review comment 対応（discussion_r2835917885）

- [x] `cn-user-api` の `load_assertion_by_id` を修正し、参照先 attestation 行が欠損している場合は `Some(event_json: null)` を返さず `None` を返すよう変更。
- [x] 既存の expired 判定（`assertion_exp <= now`）と組み合わせ、`resolve_trust_assertion` が `load_latest_active_assertion` へ確実にフォールバックできる挙動を固定。
- [x] 契約テストを追加し、以下を検証。
  - report-based: 欠損 attestation_id から最新アクティブ assertion へフォールバック
  - communication-density: 欠損 attestation_id から最新アクティブ assertion へフォールバック
  - report-based: 参照 attestation が有効な場合は参照先 assertion を優先（回帰防止）
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-21_pr114_trust_assertion_fallback_fix.md` を追加。

## 検証（PR #114）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-user-api trust_report_based_contract_falls_back_to_latest_assertion_when_attestation_missing -- --nocapture; cargo test -p cn-user-api trust_report_based_contract_keeps_referenced_attestation_when_present -- --nocapture; cargo test -p cn-user-api trust_communication_density_contract_falls_back_to_latest_assertion_when_attestation_missing -- --nocapture"`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-user-api"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #111 PR-2: trust provider key のアルゴリズム分離

- [x] Tauri 側 trust provider 設定を algorithm（`report-based` / `communication-density`）別に分離し、発行・検証・設定・削除 API 経路を更新。
- [x] trust assertion 検証で algorithm ごとの `claim` と provider pubkey を強制し、クロスアルゴリズム key 混線を reject するよう更新。
- [x] 旧単一 provider 保存値（legacy key / legacy trust anchor）を新保存形式へ移行する互換処理を追加。
- [x] フロント（`CommunityNodePanel` / `PostCard`）を algorithm 別 provider 設定・参照に更新。
- [x] Rust/TS テストを追加・更新し、algorithm 分離と cross-algorithm key reject を回帰防止。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-21_issue111_pr2_provider_key_split.md` を追加。

## 検証（Issue #111 PR-2）

- [x] `cargo fmt`（pass）
- [x] `bash ./scripts/test-docker.sh rust`（pass）
- [x] `bash ./scripts/test-docker.sh ts`（pass）
- [x] `docker compose --project-name kukuri_tests -f docker-compose.test.yml run --rm --build lint-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #111 PR-3: NIP-85 trust invalid-case 統合/E2E テスト拡張

- [x] `kukuri-tauri/src-tauri/tests/community_node_trust_invalid_integration.rs` を追加し、以下の invalid-case を統合テストで検証。
  - `invalid subject`
  - `invalid assertion kind`
  - `invalid claim tag`
  - `malformed assertion event_json`
  - `unexpected provider pubkey`
  - `invalid source 混在時に valid source のみ採用（false positive trust score 防止）`
- [x] 並列実行時の secure storage 競合を避けるため、テスト内 `TestSecureStorage` を導入し、`CommunityNodeHandler` のテスト状態分離を強化。
- [x] `cn-user-api` 契約テストを追加し、report-based / communication-density の invalid subject を `400 INVALID_SUBJECT` で reject し、`score/assertion` を返さないことを固定。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-21_issue111_pr3_invalid_cases.md` を追加。

## 検証（Issue #111 PR-3）

- [x] `cd kukuri-tauri/src-tauri && cargo fmt`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo test --test community_node_trust_invalid_integration -- --nocapture`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-user-api trust_report_based_contract_rejects_invalid_subject -- --nocapture; cargo test -p cn-user-api trust_communication_density_contract_rejects_invalid_subject -- --nocapture"`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo fmt --all -- --check"`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo fmt -- --check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass, log: `tmp/logs/gh-act-format-check-20260221-094906.log`）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass, log: `tmp/logs/gh-act-native-test-linux-20260221-095446.log`）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass, log: `tmp/logs/gh-act-community-node-tests-20260221-095820.log`）

## Issue #111 PR-4: 互換レイヤー廃止（legacy trust path deprecation）

- [x] `cn-admin-api` の `POST /v1/attestations` を trust job 作成エイリアスから廃止し、`410 GONE` / `DEPRECATED_PATH` を返す境界へ変更。
- [x] `cn-user-api` の trust 応答で、score row の参照 assertion 欠損時は latest assertion へフォールバックせず `assertion: null` を返すよう変更。
- [x] `community_node_handler` で `community_node_trust_anchor_v1`（39011 系）読み取り互換を削除し、`community_node_trust_provider_v1` 移行のみ維持。
- [x] 実装ドキュメント（`services_trust.md` / `user_api.md`）と進捗レポートを最終仕様へ更新。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-21_issue111_pr4_compat_layer_deprecation.md` を追加。

## 検証（Issue #111 PR-4）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-admin-api legacy_admin_path_aliases_contract_success_and_trust_attestations_deprecated -- --nocapture; cargo test -p cn-user-api trust_report_based_contract_returns_null_when_referenced_attestation_missing -- --nocapture; cargo test -p cn-user-api trust_report_based_contract_prefers_latest_issued_at_when_score_row_is_missing -- --nocapture; cargo test -p cn-user-api trust_report_based_contract_keeps_referenced_attestation_when_present -- --nocapture; cargo test -p cn-user-api trust_communication_density_contract_returns_null_when_referenced_attestation_missing -- --nocapture"`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo test trust_provider_ -- --nocapture`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo fmt --all -- --check"`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo fmt -- --check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass, log: `tmp/logs/gh-act-format-check-20260221-101919.log`）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass, log: `tmp/logs/gh-act-native-test-linux-20260221-101919.log`）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass, log: `tmp/logs/gh-act-community-node-tests-20260221-101919.log`）
