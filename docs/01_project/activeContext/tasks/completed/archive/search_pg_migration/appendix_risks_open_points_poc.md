# 補遺: リスク一覧・未決事項・最小 PoC チェックリスト
最終更新: 2026年02月16日

## リスク一覧
| 分類 | リスク | 影響 | 緩和策 |
|---|---|---|---|
| 技術 | PGroonga 導入のビルド互換性 | 起動不能 | PR-01 で Docker/test 経路を先行検証 |
| 技術 | 正規化仕様の不整合 | 検索漏れ/ノイズ増加 | `normalizer_version` と再バックフィル手順を標準化 |
| 技術 | AGE クエリの高コスト化 | サジェスト遅延悪化 | 候補限定 Cypher + 事前集計 + 短TTLキャッシュ |
| 技術 | index 肥大 | ディスク圧迫/遅延増加 | サイズ監視、REINDEX/VACUUM を定常運用化 |
| 運用 | dual-write の片系失敗 | 整合性ドリフト | 冪等 upsert、再送キュー、失敗率アラート |
| 運用 | backfill 長期化 | cutover 遅延 | checkpoint 再開、チャンク並列度調整 |
| プロダクト | サジェスト順位の急変 | UX 劣化 | shadow-read と段階ロールアウトで重み調整 |
| プロダクト | block/mute 漏れ | 安全性問題 | SQL 最終フィルタ固定 + 回帰テスト必須化 |

## 未決事項
- PGroonga を本番環境でどの配備方式で維持するか（managed/self-host）。
- `communities` 系の正本データソース（topic モデルとの差分含む）。
- `VIEWED_COMMUNITY` シグナルの収集元（API ログかクライアントイベントか）。
- 関係性重みの調整責任者（SRE/検索担当/PM）の確定。
- キャッシュ導入可否（Redis 追加かアプリ内 LRU か）。
- `cn-index` を改修継続するか、`cn-search` として分離するか。

## 最小 PoC チェックリスト
- [ ] 多言語混在投稿（日本語+英語+記号）で期待ヒットが得られる。
- [ ] 検索 P95 が目標内に収まる（目安: 180ms 以内）。
- [ ] サジェスト（1-3 文字）P95 が目標内に収まる（目安: 80ms 以内）。
- [ ] typo ケースの Recall@10 が現行同等以上。
- [ ] block/mute/権限が現行と同じ結果になる。
- [ ] dual-write 障害注入後に再送で整合回復できる。
- [ ] shadow-read overlap@10 が基準以上。
- [ ] backfill の停止再開で最終件数が一致する。
- [ ] 切戻し操作が 5 分以内で完了する。

