# 2025年10月19日 完了タスク

## EventService Phase 2 TODO 解消
- `kukuri-tauri/src-tauri/src/modules/event/manager.rs` に `delete_events` を追加し、削除対象イベントの `EventId` を受け取って削除イベントを発行。EventManager 初期化状態チェック、Nostr への publish、参照トピックの解決と P2P ブロードキャストを統合。
- `kukuri-tauri/src-tauri/src/application/services/event_service.rs` の `delete_events` を EventManager 連携に切り替え、入力検証・EventManager エラー伝播・`EventRepository::delete_event` によるローカル削除フラグの更新を実装。
- 上記の構成変更を検証するため、設定漏れや不正 ID を検知するユニットテスト（`test_delete_events_without_manager_fails`、`test_delete_events_with_invalid_id`、`test_delete_events_event_manager_failure_maps_to_nostr_error`）を追加。

## OfflineService Phase 2 TODO 解消
- `kukuri-tauri/src-tauri/src/application/services/offline_service.rs` にインメモリ SQLite を構築するテストヘルパーを実装し、`offline_actions`／`sync_queue`／`cache_metadata`／`optimistic_updates`／`sync_status` テーブルのスキーマを準備。
- OfflineService 向けに `save_action`・`get_actions`・`sync_actions`・`update_cache_metadata`・`update_sync_status` の振る舞いを検証するユニットテストを追加し、再索引・キュー投入・キャッシュ寿命管理・同期ステータス更新の各処理が期待通りに動作することを確認。

## テスト・整形
- `kukuri-tauri/src-tauri` で `cargo fmt` を実行してコードスタイルを統一。
- `cargo test` をローカルで実行し、追加したテストを含む 187 件のユニットテストが成功することを確認（所要約 8 分弱、既知の `nip10_contract_tests` 警告のみ発生）。

## TopicCommands Phase 2 TODO 解消
- `kukuri-tauri/src-tauri/src/presentation/handlers/topic_handler.rs` を更新し、`join_topic`/`leave_topic`/`get_joined_topics` がユーザーの公開鍵を用いて `TopicService` を呼び出すよう修正。`get_topic_stats` は `TopicService` の統計値からアクティブユーザー数とトレンドスコアを算出。
- `kukuri-tauri/src-tauri/src/application/services/topic_service.rs` と `infrastructure/database/sqlite_repository.rs` を拡張し、`user_topics` テーブルを利用した参加状態の記録・メンバー数集計・トピック削除時のクリーンアップを実装。`MockTopicRepo`／`MockGossipSvc` を用いたユニットテストを追加。
- Tauri コマンド `get_topic_stats` / `delete_topic` / `get_joined_topics` と TypeScript API (`kukuri-tauri/src/lib/api/tauri.ts`) のリクエスト形式を揃え、`useTopics` フックと関連テストを新しいレスポンス構造に追随。

## Phase 3A SqliteRepository 分割（実装完了）
- `kukuri-tauri/src-tauri/src/infrastructure/database/sqlite_repository/` 配下に `mod.rs` / `mapper.rs` / `queries.rs` / `posts.rs` / `topics.rs` / `users.rs` / `events.rs` を新設し、従来 1,099 行だった `sqlite_repository.rs` を責務別モジュールへ分割。`SqliteRepository` 構造体と基底 DI は維持しつつ、トレイト実装を各サブモジュールに移動。
- `mapper.rs` に Post/Topic/User/Event 向けの Row 変換ヘルパーを実装し、タグ抽出や日付変換ロジックを集約。`queries.rs` に SQL 文を定数としてまとめ、`posts.rs` などから再利用することで SQL 差分の可視性を向上。
- `.sqlx/` オフラインデータを `sqlx database create` → `sqlx migrate run` → `cargo sqlx prepare` で再生成。変換直後の `data/kukuri.db` を初期化し、最新スキーマに同期。
- 検証: `cargo fmt` / `cargo clippy -- -D warnings` / `./scripts/test-docker.ps1 rust` を実行し、Windows 環境固有の `STATUS_ENTRYPOINT_NOT_FOUND` を回避しつつ全 Rust テスト 187 件の成功を確認。
