# 2026年02月10日 作業完了タスク

最終更新日: 2026年02月10日

## Community Nodes / Admin API パス設計の不整合解消（`/v1/admin/*` 統一 + 互換エイリアス）

- [x] `cn-admin-api` の正規パスを維持したまま、互換エイリアスを追加
  - `POST /v1/attestations` -> `POST /v1/admin/trust/jobs`
  - `POST /v1/labels` -> `POST /v1/admin/moderation/labels`
  - `/v1/policies*` -> `/v1/admin/policies*`
- [x] `cn-admin-api` 契約テスト `legacy_admin_path_aliases_contract_success` を追加し、旧パス経由でも同一ハンドラで動作することを検証
- [x] `services_trust.md` / `services_moderation.md` / `policy_consent_management.md` を `/v1/admin/*` に統一し、互換エイリアス（非推奨）を明記
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_admin_api_path_alignment.md` として作成

## 検証

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（成功: 22 passed）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --lib legacy_admin_path_aliases_contract_success -- --nocapture"`（成功: 1 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt && cargo fmt --all --check"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-admin-path-alias-20260210-090859.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-admin-path-alias-20260210-091015.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（再実行で成功。ログ: `tmp/logs/gh-act-community-node-tests-admin-path-alias-retry-20260210-092217.log`）

## 備考

- `community-node-tests` 初回は既知の flaky (`cn-relay` の `integration_tests::ingest_outbox_ws_gossip_integration` timeout) で失敗し、再実行で成功。
  - 失敗ログ: `tmp/logs/gh-act-community-node-tests-admin-path-alias-20260210-091824.log`

## Community Nodes / Admin Console Dashboard Runbook 指標対応

- [x] Admin Console `Dashboard` を Runbook 要件に追従
  - `outbox backlog` 指標表示
  - `reject` 急増指標表示
  - DB 逼迫指標表示
- [x] `cn-admin-api` に `GET /v1/admin/dashboard` を追加し、Runbook 指標を集約して返す実装を追加
- [x] `cn-admin-api` OpenAPI / 契約テストを更新し、dashboard path と schema の互換性を固定
- [x] Admin Console `DashboardPage` に Runbook alert 表示と `Refresh` 同時再取得を追加
- [x] `DashboardPage.test.tsx` へ UI テストを追加（指標表示・alert 表示・再取得）
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_admin_dashboard_runbook_signals.md` として作成

## 検証（Dashboard Runbook 指標対応）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（成功: 24 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt && cargo fmt --all --check"`（成功）
- [x] `docker run --rm -e CI=true -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node/apps/admin-console node:20-bookworm bash -lc "set -euo pipefail; corepack enable; pnpm install --frozen-lockfile; pnpm vitest run src/pages/DashboardPage.test.tsx"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-admin-dashboard-20260210-100840.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-admin-dashboard-20260210-100956.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（初回失敗、再実行で成功）
  - 初回失敗ログ: `tmp/logs/gh-act-community-node-tests-admin-dashboard-20260210-101805.log`
  - 再実行成功ログ: `tmp/logs/gh-act-community-node-tests-admin-dashboard-retry-20260210-102155.log`
## Community Nodes / Admin Console Privacy-Data DSAR 運用ビュー追加
- [x] `cn-admin-api` に DSAR 管理 API を追加
  - `GET /v1/admin/personal-data-jobs`（`status` / `request_type` / `requester_pubkey` / `limit`）
  - `POST /v1/admin/personal-data-jobs/{job_type}/{job_id}/retry`
  - `POST /v1/admin/personal-data-jobs/{job_type}/{job_id}/cancel`
  - 監査ログ `dsar.job.retry` / `dsar.job.cancel` を記録
- [x] Admin Console `Privacy / Data` に DSAR Operations カードを追加
  - 削除/エクスポート要求の `queued|running|completed|failed` 一覧
  - 行単位の `Retry` / `Cancel` 操作
  - 監査ログ表示へ DSAR 操作ログを統合
- [x] テスト追加
  - `cn-admin-api`: `dsar_jobs_contract_list_retry_cancel_and_audit_success`
  - Admin Console: `src/pages/PrivacyDataPage.test.tsx` に DSAR 操作検証を追加

## 検証（Privacy/Data DSAR）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（完了）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（25 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt && cargo fmt --all --check"`（pass）
- [x] `docker run --rm -e CI=true -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node/apps/admin-console node:20-bookworm bash -lc "set -euo pipefail; corepack enable; pnpm install --frozen-lockfile; pnpm vitest run src/pages/PrivacyDataPage.test.tsx"`（1 passed）
- [ ] `docker run --rm -e CI=true -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node/apps/admin-console node:20-bookworm bash -lc "set -euo pipefail; corepack enable; pnpm install --frozen-lockfile; pnpm typecheck"`（既存失敗: `AuditPage.test.tsx` / `PoliciesPage.test.tsx` / `SubscriptionsPage.test.tsx` / `TrustPage.test.tsx` の既知型不整合）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-dsar-20260210-110131.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-dsar-20260210-110255.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-community-node-tests-dsar-20260210-111112.log`）

## README 日英翻訳

- [x] README.md を日英併記として翻訳（クイックスタート、構成、CI/設計を両言語に統一）
- [x] README.ja.md を新規追加し、日英併記との重複を整理して運用上の参照先を明確化

## Community Nodes / `cn-admin-api` Axum 0.8 ルーティング形式統一

- [x] `cn-admin-api` のルート定義を Axum 0.8 準拠の `{param}` 形式へ統一
  - `/v1/admin/*/:param` を `/v1/admin/*/{param}` へ置換
  - `/v1/policies/:policy_id*` を `/v1/policies/{policy_id}*` へ置換
- [x] ルータ初期化スモークテスト `router_initializes_with_axum_08_paths` を追加
  - 全ルートを含む `build_router` 初期化時に panic しないことを CI で検知可能にした
- [x] `community_nodes_roadmap.md` の該当未実装項目（2件）を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_cn_admin_api_axum_route_syntax.md` として作成

## 検証（Axum 0.8 ルーティング形式統一）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（成功: 26 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt >/dev/null 2>&1 || true && cargo fmt --all --check"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-cn-admin-axum-20260210-134616.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-cn-admin-axum-20260210-134737.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-community-node-tests-cn-admin-axum-20260210-135547.log`）

## Community Nodes / `cn-relay` 認証必須モードの consent/subscription 強制テスト

- [x] `cn-relay` 統合テスト `auth_required_enforces_consent_and_subscription` を追加
  - AUTH 成功 + 未同意 -> `consent-required`
  - 同意済み未購読 -> `restricted: subscription required`
  - 同意済み購読済み -> 受理（`OK` true）
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_cn_relay_auth_consent_subscription_integration.md` として作成

## 検証（`cn-relay` consent/subscription 強制）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/work -w /work/kukuri-community-node rust:1.88-bookworm bash -lc "export DEBIAN_FRONTEND=noninteractive; apt-get update >/dev/null && apt-get install -y --no-install-recommends build-essential pkg-config libssl-dev >/dev/null; export PATH=/usr/local/cargo/bin:$PATH; cargo test --locked -p cn-relay auth_required_enforces_consent_and_subscription -- --nocapture"`（成功: 1 passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-cn-relay-consent-20260210-150451.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-cn-relay-consent-20260210-150606.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-community-node-tests-cn-relay-consent-20260210-151410.log`）
