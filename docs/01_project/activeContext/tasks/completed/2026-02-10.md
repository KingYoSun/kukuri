# 2026年02月10日 作業完了タスク

最終更新日: 2026年02月10日

## 旧CLI削除移行タスク完了

- [x] 旧CLI専用ディレクトリの削除と参照移行を完了（`cn-cli` 導線へ統一）
- [x] 非 `docs` 配下に旧CLI参照が残っていないことを確認
- [x] `community-node-tests` の非グリーン要因（clippy 連鎖失敗）を解消
  - 対応クレート: `cn-moderation` / `cn-admin-api` / `cn-index` / `cn-user-api` / `cn-trust` / `cn-bootstrap` / `cn-relay` / `cn-cli`
  - いずれも機能変更を伴わない lint 適合中心の修正（format 文字列、条件式簡約、range 判定、引数数 lint 許容など）
- [x] 必須 `gh act` 3ジョブ完走
  - `format-check` 成功（`tmp/logs/gh-act-format-check-cn-cli-removal-20260210-194030.log`）
  - `native-test-linux` 成功（`tmp/logs/gh-act-native-test-linux-cn-cli-removal-20260210-194145.log`）
  - `community-node-tests` 成功（`tmp/logs/gh-act-community-node-tests-cn-cli-removal-20260210-193617.log`）
- [x] 進捗レポート作成
  - `docs/01_project/progressReports/2026-02-10_kukuri_cli_removal_migration_completion.md`

## Community Nodes / Admin API パス設計の不整合解消（`/v1/admin/*` 統一 + 互換エイリアス）

- [x] `cn-admin-api` の正規パスを維持したまま、互換エイリアスを追加
  - `POST /v1/attestations` -> `POST /v1/admin/trust/jobs`
  - `POST /v1/labels` -> `POST /v1/admin/moderation/labels`
  - `/v1/policies*` -> `/v1/admin/policies*`
- [x] `cn-admin-api` 契約テスト `legacy_admin_path_aliases_contract_success` を追加し、旧パス経由でも同一ハンドラで動作することを検証
- [x] `services_trust.md` / `services_moderation.md` / `policy_consent_management.md` を `/v1/admin/*` に統一し、互換エイリアス（非推奨）を明記
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_admin_api_path_alignment.md` として作成

## 検証

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（成功: 22 passed）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --lib legacy_admin_path_aliases_contract_success -- --nocapture"`（成功: 1 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt && cargo fmt --all --check"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-admin-path-alias-20260210-090859.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-admin-path-alias-20260210-091015.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（再実行で成功。ログ: `tmp/logs/gh-act-community-node-tests-admin-path-alias-retry-20260210-092217.log`）

## 備考

- `community-node-tests` 初回は既知の flaky (`cn-relay` の `integration_tests::ingest_outbox_ws_gossip_integration` timeout) で失敗し、再実行で成功。
  - 失敗ログ: `tmp/logs/gh-act-community-node-tests-admin-path-alias-20260210-091824.log`

## Community Nodes / Admin Console Dashboard Runbook 指標対応

- [x] Admin Console `Dashboard` を Runbook 要件に追従
  - `outbox backlog` 指標表示
  - `reject` 急増指標表示
  - DB 逼迫指標表示
- [x] `cn-admin-api` に `GET /v1/admin/dashboard` を追加し、Runbook 指標を集約して返す実装を追加
- [x] `cn-admin-api` OpenAPI / 契約テストを更新し、dashboard path と schema の互換性を固定
- [x] Admin Console `DashboardPage` に Runbook alert 表示と `Refresh` 同時再取得を追加
- [x] `DashboardPage.test.tsx` へ UI テストを追加（指標表示・alert 表示・再取得）
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_admin_dashboard_runbook_signals.md` として作成

## 検証（Dashboard Runbook 指標対応）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（成功: 24 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt && cargo fmt --all --check"`（成功）
- [x] `docker run --rm -e CI=true -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node/apps/admin-console node:20-bookworm bash -lc "set -euo pipefail; corepack enable; pnpm install --frozen-lockfile; pnpm vitest run src/pages/DashboardPage.test.tsx"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-admin-dashboard-20260210-100840.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-admin-dashboard-20260210-100956.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（初回失敗、再実行で成功）
  - 初回失敗ログ: `tmp/logs/gh-act-community-node-tests-admin-dashboard-20260210-101805.log`
  - 再実行成功ログ: `tmp/logs/gh-act-community-node-tests-admin-dashboard-retry-20260210-102155.log`
## Community Nodes / Admin Console Privacy-Data DSAR 運用ビュー追加
- [x] `cn-admin-api` に DSAR 管理 API を追加
  - `GET /v1/admin/personal-data-jobs`（`status` / `request_type` / `requester_pubkey` / `limit`）
  - `POST /v1/admin/personal-data-jobs/{job_type}/{job_id}/retry`
  - `POST /v1/admin/personal-data-jobs/{job_type}/{job_id}/cancel`
  - 監査ログ `dsar.job.retry` / `dsar.job.cancel` を記録
- [x] Admin Console `Privacy / Data` に DSAR Operations カードを追加
  - 削除/エクスポート要求の `queued|running|completed|failed` 一覧
  - 行単位の `Retry` / `Cancel` 操作
  - 監査ログ表示へ DSAR 操作ログを統合
- [x] テスト追加
  - `cn-admin-api`: `dsar_jobs_contract_list_retry_cancel_and_audit_success`
  - Admin Console: `src/pages/PrivacyDataPage.test.tsx` に DSAR 操作検証を追加

## 検証（Privacy/Data DSAR）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（完了）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（25 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt && cargo fmt --all --check"`（pass）
- [x] `docker run --rm -e CI=true -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node/apps/admin-console node:20-bookworm bash -lc "set -euo pipefail; corepack enable; pnpm install --frozen-lockfile; pnpm vitest run src/pages/PrivacyDataPage.test.tsx"`（1 passed）
- [ ] `docker run --rm -e CI=true -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node/apps/admin-console node:20-bookworm bash -lc "set -euo pipefail; corepack enable; pnpm install --frozen-lockfile; pnpm typecheck"`（既存失敗: `AuditPage.test.tsx` / `PoliciesPage.test.tsx` / `SubscriptionsPage.test.tsx` / `TrustPage.test.tsx` の既知型不整合）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-dsar-20260210-110131.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-dsar-20260210-110255.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-community-node-tests-dsar-20260210-111112.log`）

## README 日英翻訳

- [x] README.md を日英併記として翻訳（クイックスタート、構成、CI/設計を両言語に統一）
- [x] README.ja.md を新規追加し、日英併記との重複を整理して運用上の参照先を明確化

## Community Nodes / `cn-admin-api` Axum 0.8 ルーティング形式統一

- [x] `cn-admin-api` のルート定義を Axum 0.8 準拠の `{param}` 形式へ統一
  - `/v1/admin/*/:param` を `/v1/admin/*/{param}` へ置換
  - `/v1/policies/:policy_id*` を `/v1/policies/{policy_id}*` へ置換
- [x] ルータ初期化スモークテスト `router_initializes_with_axum_08_paths` を追加
  - 全ルートを含む `build_router` 初期化時に panic しないことを CI で検知可能にした
- [x] `community_nodes_roadmap.md` の該当未実装項目（2件）を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_cn_admin_api_axum_route_syntax.md` として作成

## 検証（Axum 0.8 ルーティング形式統一）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（成功: 26 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt >/dev/null 2>&1 || true && cargo fmt --all --check"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-cn-admin-axum-20260210-134616.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-cn-admin-axum-20260210-134737.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-community-node-tests-cn-admin-axum-20260210-135547.log`）

## Community Nodes / `cn-relay` 認証必須モードの consent/subscription 強制テスト

- [x] `cn-relay` 統合テスト `auth_required_enforces_consent_and_subscription` を追加
  - AUTH 成功 + 未同意 -> `consent-required`
  - 同意済み未購読 -> `restricted: subscription required`
  - 同意済み購読済み -> 受理（`OK` true）
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_cn_relay_auth_consent_subscription_integration.md` として作成

## 検証（`cn-relay` consent/subscription 強制）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/work -w /work/kukuri-community-node rust:1.88-bookworm bash -lc "export DEBIAN_FRONTEND=noninteractive; apt-get update >/dev/null && apt-get install -y --no-install-recommends build-essential pkg-config libssl-dev >/dev/null; export PATH=/usr/local/cargo/bin:$PATH; cargo test --locked -p cn-relay auth_required_enforces_consent_and_subscription -- --nocapture"`（成功: 1 passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-cn-relay-consent-20260210-150451.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-cn-relay-consent-20260210-150606.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-community-node-tests-cn-relay-consent-20260210-151410.log`）

## GitHub Actions `Build Test (Windows)` 失敗修正（`Cargo.lock` 未追跡）

- [x] `gh run view 21865755636 --log-failed` で失敗原因を特定
  - `build-test-windows` の `cargo check --locked -p cn-cli --all-features` が lock 不整合で失敗
- [x] `kukuri-community-node/Cargo.lock` を追跡対象へ修正
  - `.gitignore` に `!kukuri-community-node/Cargo.lock` を追加
  - `cargo update -p home --precise 0.5.11` で Rust 1.86 互換の lock を生成
- [x] ローカル再現と解消確認
  - `cargo +1.86.0 check --locked -p cn-cli --all-features`（成功）
- [x] 必須 `gh act` 3ジョブ実行（本セッション）
  - `format-check` 成功（`tmp/logs/gh-act-format-check-20260210-233102.log`）
  - `native-test-linux` 成功（`tmp/logs/gh-act-native-test-linux-20260210-231941.log`）
  - `community-node-tests` は `cn-relay` の `integration_tests::ingest_outbox_ws_gossip_integration` が `gossip timeout` で失敗（`tmp/logs/gh-act-community-node-tests-20260210-232711.log` / `tmp/logs/gh-act-community-node-tests-retry-20260210-233342.log`）

## Community Nodes / `cn-user-api` Billing/quota 402 契約テスト追加

- [x] `cn-user-api` 契約テストを拡充し、Billing/quota の 402 を検証
  - `search` / `trending` / `reports` / `topic-subscription` で上限超過時の 402 を追加
  - エラーコード `QUOTA_EXCEEDED` と `details`（`metric`/`current`/`limit`）を検証
  - 日次 quota では `details.reset_at` を検証
  - `x-request-id` 再送時の冪等挙動（同一 request_id で再送しても usage_event が増えない）を検証
- [x] `billing::consume_quota` を補完し、`request_id` 再送で既に `rejected` の場合も `details.reset_at` を返すように修正
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_cn_user_api_quota_402_contract_tests.md` として作成

## 検証（`cn-user-api` Billing/quota 402）

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker run --rm --network host -e DATABASE_URL=postgres://cn:cn_password@localhost:15432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "/usr/local/cargo/bin/cargo test --package cn-user-api -- --nocapture"`（成功: 32 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "/usr/local/cargo/bin/cargo fmt --all -- --check"`（成功）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "/usr/local/cargo/bin/cargo clippy --package cn-user-api --all-features -- -D warnings"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-cn-user-api-quota-20260211-013431.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-cn-user-api-quota-20260211-013545.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-community-node-tests-cn-user-api-quota-20260211-014209.log`）

## Community Nodes / `cn-relay` WS バックフィル順序・`limit`・`EOSE` 整合

- [x] `cn-relay` の WS バックフィル初期取得順序を `created_at` 降順（同値は `event.id` 辞書順）へ修正
  - `fetch_events` の SQL を `ORDER BY e.created_at DESC, e.event_id ASC` へ更新
  - 複数フィルタ時も初期取得全体を同一順序で送信するため、送信前に集約ソートを追加
- [x] 統合テスト `ws_backfill_orders_desc_applies_limit_and_transitions_to_realtime_after_eose` を追加
  - `limit` 適用時の順序（`newest -> tie(id辞書順)`）を固定
  - `EOSE` 到達後にリアルタイム配信へ遷移することを固定
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_cn_relay_ws_backfill_order_limit_eose.md` として作成

## 検証（`cn-relay` WS バックフィル順序・`limit`・`EOSE` 整合）

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-relay -- --nocapture"`（成功: 11 passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（初回は rustfmt 差分で失敗、`cargo fmt --all` 後の再実行で成功）
  - 失敗ログ: `tmp/logs/gh-act-format-check-cn-relay-backfill-20260211-061929.log`
  - 再実行成功ログ: `tmp/logs/gh-act-format-check-cn-relay-backfill-retry-20260211-062056.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-cn-relay-backfill-20260211-062217.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-community-node-tests-cn-relay-backfill-20260211-062834.log`）
