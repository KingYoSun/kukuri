# 2026年02月10日 作業完了タスク

最終更新日: 2026年02月10日

## Community Nodes / Admin API パス設計の不整合解消（`/v1/admin/*` 統一 + 互換エイリアス）

- [x] `cn-admin-api` の正規パスを維持したまま、互換エイリアスを追加
  - `POST /v1/attestations` -> `POST /v1/admin/trust/jobs`
  - `POST /v1/labels` -> `POST /v1/admin/moderation/labels`
  - `/v1/policies*` -> `/v1/admin/policies*`
- [x] `cn-admin-api` 契約テスト `legacy_admin_path_aliases_contract_success` を追加し、旧パス経由でも同一ハンドラで動作することを検証
- [x] `services_trust.md` / `services_moderation.md` / `policy_consent_management.md` を `/v1/admin/*` に統一し、互換エイリアス（非推奨）を明記
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_admin_api_path_alignment.md` として作成

## 検証

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（成功: 22 passed）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --lib legacy_admin_path_aliases_contract_success -- --nocapture"`（成功: 1 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt && cargo fmt --all --check"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-admin-path-alias-20260210-090859.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-admin-path-alias-20260210-091015.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（再実行で成功。ログ: `tmp/logs/gh-act-community-node-tests-admin-path-alias-retry-20260210-092217.log`）

## 備考

- `community-node-tests` 初回は既知の flaky (`cn-relay` の `integration_tests::ingest_outbox_ws_gossip_integration` timeout) で失敗し、再実行で成功。
  - 失敗ログ: `tmp/logs/gh-act-community-node-tests-admin-path-alias-20260210-091824.log`

## Community Nodes / Admin Console Dashboard Runbook 指標対応

- [x] Admin Console `Dashboard` を Runbook 要件に追従
  - `outbox backlog` 指標表示
  - `reject` 急増指標表示
  - DB 逼迫指標表示
- [x] `cn-admin-api` に `GET /v1/admin/dashboard` を追加し、Runbook 指標を集約して返す実装を追加
- [x] `cn-admin-api` OpenAPI / 契約テストを更新し、dashboard path と schema の互換性を固定
- [x] Admin Console `DashboardPage` に Runbook alert 表示と `Refresh` 同時再取得を追加
- [x] `DashboardPage.test.tsx` へ UI テストを追加（指標表示・alert 表示・再取得）
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-10_admin_dashboard_runbook_signals.md` として作成

## 検証（Dashboard Runbook 指標対応）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --tests -- --nocapture"`（成功: 24 passed）
- [x] `docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt && cargo fmt --all --check"`（成功）
- [x] `docker run --rm -e CI=true -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node/apps/admin-console node:20-bookworm bash -lc "set -euo pipefail; corepack enable; pnpm install --frozen-lockfile; pnpm vitest run src/pages/DashboardPage.test.tsx"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-format-check-admin-dashboard-20260210-100840.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（成功。ログ: `tmp/logs/gh-act-native-test-linux-admin-dashboard-20260210-100956.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（初回失敗、再実行で成功）
  - 初回失敗ログ: `tmp/logs/gh-act-community-node-tests-admin-dashboard-20260210-101805.log`
  - 再実行成功ログ: `tmp/logs/gh-act-community-node-tests-admin-dashboard-retry-20260210-102155.log`
