## 作業名: Tauriコマンド導線チェックリストの整備
- [x] UI から到達していなかった `create_account` / `login_with_*` / `get_topic` / `get_joined_topics` / `batch_*` / `set_default_p2p_topic` / `sync_posts` を Rust から撤去し、`lib.rs` の `invoke_handler` 登録と Handler/DTO を整理。  
- [x] `scripts/check-tauri-commands.mjs` と `pnpm run check:tauri-commands` を追加し、`#[tauri::command]` とフロントエンド `invoke` の一致を自動検証できるようにした。`phase5_user_flow_summary.md` / `phase5_ci_path_audit.md` / `refactoring_plan_2025-08-08_v3.md` にチェックリストと運用ルールを追記。  
- [x] `clear_all_accounts_for_test` を唯一のデバッグ専用コマンドとして残し、DevTools/QA ユースのみ＋ログ採取（`tmp/logs/dev_account_reset_<timestamp>.log`）の境界を `phase5_user_flow_summary.md` へ明文化。  
- [x] `tasks/status/in_progress.md`（L16）を更新し、タスク進行ログと完了条件達成を記録。  

### 成果物
- `scripts/check-tauri-commands.mjs`
- `kukuri-tauri/src-tauri/src/presentation/commands/{auth,event,post,topic,user}_commands.rs`
- `kukuri-tauri/src-tauri/src/presentation/dto/{event,post}_dto.rs`
- `kukuri-tauri/src-tauri/src/presentation/handlers/{event,post,topic}_handler.rs`
- `kukuri-tauri/src-tauri/src/lib.rs`
- `docs/01_project/activeContext/artefacts/phase5_user_flow_summary.md`
- `docs/01_project/activeContext/artefacts/phase5_ci_path_audit.md`
- `docs/01_project/refactoring_plan_2025-08-08_v3.md`
- `docs/01_project/activeContext/tasks/status/in_progress.md`

### 検証
- `node scripts/check-tauri-commands.mjs`
- `powershell.exe -ExecutionPolicy Bypass -File scripts/test-docker.ps1 rust > tmp/logs/rust_tests_20251114.log`

## 作業名: 未使用APIエンドポイント撤去とドキュメント整合
- [x] `add_relay` / `join_topic_by_name` / `delete_events` / `get_nostr_pubkey` を Tauri コマンドとフロントエンド API から撤去し、Rust/TypeScript のユニットテストを更新。  
- [x] `phase5_user_flow_inventory.md` / `phase5_user_flow_summary.md` / `phase5_feature_usage_map.md` に未使用 API 0 件の結果と 2025年11月14日の撤去記録を追記。  
- [x] `refactoring_plan_2025-08-08_v3.md:436-446` と `tasks/status/in_progress.md` の成功指標・タスク記述を更新し、未導線 API チェックをクローズ。  
- [x] `docs/01_project/activeContext/artefacts/phase5_ci_path_audit.md` で API 棚卸し完了ログを追加し、デバッグ専用コマンドのみが残る旨を明文化。

### 謌先棡迚ｩ

- `docs/01_project/activeContext/artefacts/phase5_user_flow_inventory.md`
- `docs/01_project/activeContext/artefacts/phase5_user_flow_summary.md`
- `docs/01_project/activeContext/artefacts/phase5_feature_usage_map.md`
- `docs/01_project/refactoring_plan_2025-08-08_v3.md`
- `docs/01_project/activeContext/artefacts/phase5_ci_path_audit.md`
- `docs/01_project/activeContext/tasks/status/in_progress.md`

### 検証

- `corepack pnpm vitest run src/tests/unit/lib/api/nostr.test.ts src/tests/unit/lib/api/p2p.test.ts` (kukuri-tauri)  
- `cargo test` (kukuri-cli)  
- `cargo test` (kukuri-tauri) → `STATUS_ENTRYPOINT_NOT_FOUND` で失敗。依存 DLL 不足による既知の Windows 制約として記録。
# 2025年11月14日 完了タスク

最終更新日: 2025年11月14日

## 機能使用状況マップ: アクティブ機能の洗い出し

- [x] `phase5_user_flow_inventory.md` / `phase5_user_flow_summary.md` を突き合わせ、UI 導線ごとに呼び出し元コンポーネント・ストア・Tauri コマンドを整理。
- [x] `docs/01_project/activeContext/artefacts/phase5_feature_usage_map.md` を作成し、1.1〜1.7 のテーブルで認証/メイン UI/トピック/検索/設定/P2P/プロフィール・DM を網羅。
- [x] `docs/01_project/refactoring_plan_2025-08-08_v3.md` の 2.5.2 チェックリストを更新し、アクティブ機能項目を `[x]` 済に変更。`tasks/status/in_progress.md` から当該タスクを削除。

### 成果物

- `docs/01_project/activeContext/artefacts/phase5_feature_usage_map.md`

## 機能使用状況マップ: 未使用機能（削除候補）の整理

- [x] `rg` で `nostrApi.*` / `p2pApi.*` / `SecureStorageApi` / `TopicMesh` / `EncryptionService` の未使用関数を検索し、`phase5_user_flow_inventory.md:168-196` の backlog と突合。
- [x] `docs/01_project/activeContext/artefacts/phase5_feature_usage_map.md` に「2. 未使用機能（削除候補）」セクションを追加し、各機能のソース位置・未使用理由・削除/保留判断・次アクションを表形式で記載。
- [x] `docs/01_project/refactoring_plan_2025-08-08_v3.md` の 2.5.2 チェックリストで未使用機能項目を `[x]` に更新し、`tasks/status/in_progress.md` から当該タスクを削除。

### 成果物

- `docs/01_project/activeContext/artefacts/phase5_feature_usage_map.md`
- `docs/01_project/refactoring_plan_2025-08-08_v3.md`

## 機能使用状況マップ: 部分的に使用される機能の可視化

- [x] `docs/01_project/activeContext/artefacts/phase5_feature_usage_map.md` に「3. 部分的に使用されている機能」を追加し、トピック作成導線 / Sidebar トレンド&フォローカテゴリー / 鍵管理 / プライバシー設定 / DEV 専用パネルの使用・未使用文脈と推奨アクションを整理。
- [x] `docs/01_project/refactoring_plan_2025-08-08_v3.md` 2.5.2 の「部分的に使用されている機能」チェックを `[x]` に更新し、参照先として新セクションを明記。
- [x] `tasks/status/in_progress.md` から当該タスクを削除し、残タスクの番号を繰り上げ。

### 成果物

- `docs/01_project/activeContext/artefacts/phase5_feature_usage_map.md`
- `docs/01_project/refactoring_plan_2025-08-08_v3.md`
- `docs/01_project/activeContext/tasks/status/in_progress.md`

## リファクタリング計画: すべてのRustテストをグリーンに戻す（Phase0.2 再検証）
- [x] `./scripts/test-docker.ps1 rust` を実行し、`tmp/logs/rust_docker_20251114.log` に `kukuri-tauri/src-tauri` 配下の lib / integration / contract / performance を含む 195 件が全て成功した Docker ログを保存。Windows 固有の `STATUS_ENTRYPOINT_NOT_FOUND` を回避する標準手順として再確認。  
- [x] `cd kukuri-cli && cargo test` を同日に実行し、CLI 側 8 件もグリーンであることを確認。  
- [x] 成果を `docs/01_project/refactoring_plan_2025-08-08_v3.md`（0.2 節および成功指標チェック）、`docs/01_project/activeContext/artefacts/phase5_ci_path_audit.md`、`tasks/status/in_progress.md` に反映してタスクをクローズ。  
### エビデンス
- `tmp/logs/rust_docker_20251114.log`
- `kukuri-cli` 直下での `cargo test` 実行ログ（標準出力）

## リファクタリング計画: コード重複率30%削減の達成

- [x] `npx jscpd 4.0.5` を TypeScript（`kukuri-tauri/src`）対象で実行し、362ファイル 53,610 行中 4.16%（2,231 行）の重複を確認。テストコードに 85% が偏在し、`postStore` / `topicStore` / `ReplyForm` などの実コード重複は 338 行に収まることを整理。  
- [x] 同日に Rust (`kukuri-tauri/src-tauri/src` + `kukuri-cli/src`) を計測し、251 ファイル 34,447 行中 4.51%（1,555 行）。重複は `users.rs` / `user_service.rs` / `presentation/commands/*` 等に集中し、cli 側は 22 行のみで目標ラインを十分下回っていることを確認。  
- [x] 結果を `docs/01_project/activeContext/artefacts/code_duplication_report_2025-11-14.md` に記録し、共通化候補・推奨アクションを抽出。`tasks/status/in_progress.md` から当該タスクを削除し、リファクタリング計画の成功指標を達成扱いとした。  

### 成果物

- `docs/01_project/activeContext/artefacts/code_duplication_report_2025-11-14.md`

## 作業名: 孤立コンポーネント 0 件達成
- [x] `SyncStatusIndicator` へ `ConflictResolutionDialog` を常時統合し、孤立していた同期競合 UI をポップオーバー導線から開けるように再配線。`ConflictResolutionDialog` を `showConflictDialog` が真のときのみ描画し、State 重複を排除。
- [x] `kukuri-tauri/src/components/sync/conflictUtils.ts` を新設し、Doc/Blob メタデータ抽出・表示を `SyncStatusIndicator` / `ConflictResolutionDialog` 間で共有。Doc/Blob 比較タブやマージプレビューを `ConflictResolutionDialog` に実装し、手動解決フローを一本化。
- [x] `SyncStatusIndicator` のテストを刷新し、競合バナー表示にフォーカス。`ConflictResolutionDialog` の単体テストを追加してローカル/リモート適用と Doc/Blob タブ表示を検証。
- [x] `docs/01_project/activeContext/tasks/status/in_progress.md` から当該タスクを削除し、本ファイルへ記録。

### 成果物
- `kukuri-tauri/src/components/SyncStatusIndicator.tsx`
- `kukuri-tauri/src/components/sync/ConflictResolutionDialog.tsx`
- `kukuri-tauri/src/components/sync/conflictUtils.ts`
- `kukuri-tauri/src/tests/unit/components/SyncStatusIndicator.test.tsx`
- `kukuri-tauri/src/tests/unit/components/sync/ConflictResolutionDialog.test.tsx`
- `docs/01_project/activeContext/tasks/status/in_progress.md`

### 検証
- `./scripts/test-docker.ps1 ts -NoBuild`
  - 実行成功 (`EXIT:0`) だが `Header.test.tsx` が `SyncStatusIndicator` を直接描画するため `act(...)` 警告が 2 件出力。必要に応じて `Header` テスト側でのモック化を要検討。

## リファクタリング計画: dead_code の 80% 以上削減

- [x] `rg "#\[allow(dead_code)\]" -g "*.rs"` の計測値（24 箇所）を起点に、Rust 全体で未使用コード・テスト専用ユーティリティを棚卸し。`tests/common/offline_support.rs` を新設し、性能テスト専用のシード処理 (`offline_seed.rs`) を分離することで `#[allow(dead_code)]` なしでもビルドできる構成に変更。
- [x] `AppState` の未使用暗号サービス依存を撤去し、`phase5_feature_usage_map.md` に完了記録を追記。`topic_mesh` は `anyhow::Result` を返すよう改修し、旧 `P2PError` モジュールとテストを削除してエラー型の重複を解消。
- [x] `state.rs` / `event_manager_gateway.rs` / `manager_handle.rs` / `manager/core.rs` / `manager/publishing.rs` / `nostr_client_manager.rs` / `metrics.rs` / `p2p::metrics` などの `#[allow(dead_code)]` を除去し、必要に応じて `cfg(test)` 化。`docs/01_project/activeContext/tasks/status/in_progress.md` へ削減ログを追加し、成果を `phase5_feature_usage_map.md` に反映。

### 成果物

- `kukuri-tauri/src-tauri/tests/common/offline_support.rs`
- `kukuri-tauri/src-tauri/tests/common/performance/offline_seed.rs`
- `kukuri-tauri/src-tauri/src/domain/p2p/{topic_mesh.rs,message.rs}`
- `kukuri-tauri/src-tauri/src/infrastructure/event/{manager_handle.rs,manager/core.rs,manager/publishing.rs,event_manager_gateway.rs,metrics.rs,nostr_client_manager.rs}`
- `kukuri-tauri/src-tauri/src/infrastructure/p2p/{metrics.rs,event_distributor/state.rs}`
- `kukuri-tauri/src-tauri/src/state.rs`
- `docs/01_project/activeContext/artefacts/phase5_feature_usage_map.md`
- `docs/01_project/activeContext/tasks/status/in_progress.md`
