# 2026年02月16日 完了タスク

最終更新日: 2026年02月16日

## Issue #27 検索PG移行計画の初期監査

- [x] `docs/01_project/activeContext/search_pg_migration/` の PR-01..PR-07 計画を現行実装へ突合し、`implemented / missing / risky` を整理。
- [x] 監査結果を `docs/01_project/activeContext/search_pg_migration/issue27_initial_audit_2026-02-16.md` に記録。
- [x] 検索PG移行の未着手タスクを `docs/01_project/activeContext/tasks/priority/search_pg_migration_roadmap.md` として新規起票。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_search_pg_migration_audit.md` を追加。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。

## Issue #27 PR-01 拡張導入とランタイムフラグ基盤

- [x] `kukuri-community-node/docker/postgres-age/Dockerfile` に PGroonga 導入を追加。
- [x] migration `20260216020000_m6_search_runtime_flags.sql` を追加し、`pg_trgm` / `pgroonga` / `age` / `cn_search.runtime_flags` を初期化。
- [x] `cn-core::search_runtime_flags` を追加し、`cn-user-api` / `cn-index` の検索ランタイムフラグ読取を共通化。
- [x] 正本を `cn_search.runtime_flags` に確定（`service_configs` は既存用途のみ維持）。

## Issue #27 / PR #28 Community Node Tests fix loop（cn-admin-api 契約テスト直列化）

- [x] PR #28 CI失敗ログ（Run `22048263032` / Job `63700968967`）を解析し、`subscription_request_approve_rejects_when_node_topic_limit_reached` の不安定失敗原因を特定。
- [x] `kukuri-community-node/crates/cn-admin-api/src/contract_tests.rs` に `relay_subscription_approval_test_lock` を追加し、`service='relay'` を共有する承認系契約テスト 5件を直列化。
- [x] `transactional_admin_mutations_rollback_when_audit_log_write_fails` / `..._commit_fails` / `subscription_requests_and_node_subscriptions_contract_success` / `subscription_request_approve_rejects_when_node_topic_limit_reached` / `...already_exceeded` の競合を解消。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr28_community_node_tests_fix_loop.md` を追加。

## 検証

- [x] `docker compose -f docker-compose.test.yml build community-node-postgres test-runner`（PGroonga 導入済み Postgres イメージの再現性確認）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（再実行で pass。`cn-admin-api` の対象契約テストを含め全クレート通過）
- [x] `docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... 'for i in $(seq 1 8); do cargo test -p cn-admin-api --lib -- --test-threads=8; done'`（8連続 pass。PR #28 失敗点の再発なし）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）

## Issue #27 PR-02 投稿検索ドキュメント（PGroonga）

- [x] migration `20260216030000_m7_post_search_documents.sql` を追加し、`cn_search.post_search_documents` と PGroonga index を導入。
- [x] `cn-index` outbox consumer に `search_write_mode`（`meili_only/dual/pg_only`）を追加し、Meili 維持の dual-write（upsert/delete/expiry）を実装。
- [x] `cn-user-api` `/v1/search` に PG read backend を追加し、`search_read_backend` ランタイムフラグで Meili/PG 切替を実装。
- [x] `cn-core::search_normalizer`（NFKC/小文字化/記号正規化/`normalizer_version`）を追加し、`cn-index`/`cn-user-api` で共通利用。
- [x] 回帰テストを追加（`cn-core` 正規化ユニット、`cn-index` dual-write 統合、`cn-user-api` PG読取契約）。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr02_post_search_pgroonga.md` を追加。

## 検証

- [x] `cd kukuri-community-node && cargo fmt`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... "cargo test -p cn-core search_normalizer -- --nocapture; cargo test -p cn-index outbox_dual_write_updates_meili_and_post_search_documents -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_switch_normalization_and_version_filter -- --nocapture"`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... "cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests`（fail: `cn-admin-api` 契約テスト `trust_contract_success_and_shape` の既知系不安定失敗。ログ: `tmp/logs/gh-act-community-node-tests-issue27-pr02.log`）

## Issue #27 / PR #29 fix loop（post_search_documents multi-topic 上書き防止）

- [x] migration `20260216040000_m8_post_search_documents_topic_key.sql` を追加し、`cn_search.post_search_documents` の主キーを `(post_id, topic_id)` へ変更。
- [x] `cn-index` の PG upsert を `ON CONFLICT (post_id, topic_id)` へ修正し、delete/expiry/stale-mark を `topic_id` 条件付き更新へ変更。
- [x] `cn-index` 統合テスト `outbox_dual_write_preserves_post_search_documents_per_topic` を追加し、同一 event が複数 topic に属するケースで 2 行保持を回帰テスト化。
- [x] `cn-user-api` 契約テスト `search_contract_pg_backend_preserves_multi_topic_rows_for_same_post_id` を追加し、`/v1/search?topic=...` が topic ごとに正しい行を返すことを検証。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr29_post_search_topic_key_fix_loop.md` を追加。

## 検証

- [x] `cd kukuri-community-node && cargo fmt`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml down -v`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... "cargo clean -p cn-core; cargo test -p cn-index outbox_dual_write_updates_meili_and_post_search_documents -- --nocapture; cargo test -p cn-index outbox_dual_write_preserves_post_search_documents_per_topic -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_switch_normalization_and_version_filter -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_preserves_multi_topic_rows_for_same_post_id -- --nocapture"`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... "cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr29-fix-loop.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr29-fix-loop.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr29-fix-loop.log`（pass）

## Issue #27 / PR #29 fix loop second pass（CI run 22050188054）

- [x] CI 失敗ジョブを再解析し、Native Test の `Invite signature is invalid` と Community Node Tests の `search_contract_success_shape_compatible` 失敗原因を特定。
- [x] `kukuri-tauri/src-tauri/src/infrastructure/crypto/default_signature_service.rs` で、署名後の `created_at` を署名済みイベント時刻へ同期し、検証時の時刻不整合を解消。
- [x] `kukuri-community-node/crates/cn-user-api/src/subscriptions.rs` で検索契約テストの runtime flag 競合を直列化（`Mutex`）し、Meili 前提テストのフラグ初期化を明示。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr29_second_pass_ci_fix_loop.md` を追加。

## 検証

- [x] `cd kukuri-tauri/src-tauri && cargo test request_join_with_invite_broadcasts_to_issuer_topic -- --nocapture`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-user-api search_contract_success_shape_compatible -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_switch_normalization_and_version_filter -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_preserves_multi_topic_rows_for_same_post_id -- --nocapture"`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `XDG_CACHE_HOME=/tmp/act-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr29-second-pass.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/act-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr29-second-pass.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/act-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr29-second-pass.log`（fail: `subscriptions::api_contract_tests::auth_consent_quota_metrics_regression_counters_increment` が `left: 428, right: 402`。今回修正対象外の既知不安定系としてログ保全）

## Issue #27 PR-03 コミュニティ候補生成（pg_trgm + prefix）

- [x] migration `20260216050000_m9_community_search_terms.sql` を追加し、`cn_search.community_search_terms` と `gin_trgm_ops` / `text_pattern_ops` index、既存購読データ由来の初期バックフィルを実装。
- [x] `cn-core::community_search_terms` を追加し、`topic_id -> community_id` 変換と候補語（name/alias）生成ロジックを共通化。
- [x] `cn-index` outbox upsert で `community_search_terms` へ同期する write path を追加し、migration 適用前でも `42P01/3F000` を握って互換動作を維持。
- [x] `cn-user-api` に `/v1/communities/suggest` を追加し、`suggest_read_backend=pg|legacy` 切替、入力長別（1-2文字/prefix優先、3文字以上/trgm活用）候補生成、pg空時 legacy fallback を実装。
- [x] `cn-index` / `cn-user-api` / OpenAPI 契約テストを更新し、exact/prefix/trgm と legacy 経路を固定化。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr03_community_candidates_pg_trgm.md` を追加。

## 検証

- [x] `cd kukuri-community-node && cargo fmt`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-core community_search_terms; cargo test -p cn-index outbox_upsert_updates_community_search_terms; cargo test -p cn-user-api community_suggest_pg_backend_supports_exact_prefix_and_trgm; cargo test -p cn-user-api community_suggest_legacy_backend_uses_topic_sources; cargo test -p cn-user-api openapi_contract_contains_user_paths"`（pass, ログ: `tmp/logs/issue27-pr03-targeted-tests.log`）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass, ログ: `tmp/logs/issue27-pr03-community-node-full.log`）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass, ログ: `tmp/logs/issue27-pr03-tauri-cargo-test.log`）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr03.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr03.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr03.log`（fail: `auth_consent_quota_metrics_regression_counters_increment` が `left: 428, right: 402`）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr03-rerun.log`（pass）

## Issue #27 / PR #30 fix loop（community_search_terms alias backfill の hashed-tail ノイズ除去）

- [x] PR #30 review（`discussion_r2810818018`）で指摘された `kukuri:<64hex>` alias ノイズ原因を再現し、migration/backfill と runtime 生成ロジックの不整合を確認。
- [x] `kukuri-community-node/migrations/20260216050000_m9_community_search_terms.sql` の alias backfill 条件に `LOWER(TRIM(topic_id)) !~ '^kukuri:[0-9a-f]{64}$'` を追加し、`kukuri:<64hex>` を初期バックフィル対象から除外。
- [x] `kukuri-community-node/crates/cn-user-api/src/subscriptions.rs` に backfill 相当 SQL を検証する回帰テスト `community_search_alias_backfill_skips_kukuri_hashed_tail_topics` を追加し、hashed tail は alias 0件・通常 topic は alias 生成ありを固定化。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr30_alias_backfill_hashed_tail_fix_loop.md` を追加。

## 検証

- [x] `cd kukuri-community-node && cargo fmt`（pass）
- [x] `cd /home/kingyosun/kukuri && docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-core community_search_terms -- --nocapture; cargo test -p cn-user-api community_search_alias_backfill_skips_kukuri_hashed_tail_topics -- --nocapture; cargo test -p cn-user-api community_suggest_pg_backend_supports_exact_prefix_and_trgm -- --nocapture; cargo test -p cn-user-api community_suggest_legacy_backend_uses_topic_sources -- --nocapture" | tee tmp/logs/issue27-pr30-fix-loop-targeted-tests.log`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli" | tee tmp/logs/issue27-pr30-fix-loop-community-node-full.log`（pass）
- [x] `cd /home/kingyosun/kukuri/kukuri-tauri/src-tauri && cargo test | tee /home/kingyosun/kukuri/tmp/logs/issue27-pr30-fix-loop-tauri-cargo-test.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr30-fix-loop.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr30-fix-loop.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr30-fix-loop.log`（pass）
