# 2026年02月16日 完了タスク

最終更新日: 2026年02月16日

## Issue #40 マルチレイヤーライセンス監査（audit-first）

- [x] Issue #40 要件に基づき、ライセンス宣言を 5 レイヤー（ルート LICENSE、サブディレクトリ LICENSE/COPYING、Rust `Cargo.toml`、Node `package.json`、README/docs の明示宣言）で監査。
- [x] 監査結果として、リポジトリ MIT 方針との不一致マップを作成し、主要差分（`kukuri-community-node/Cargo.toml` の `Apache-2.0`）を特定。
- [x] 最小修正計画（1タスク=1PR）を定義し、対象ファイルを明示した進捗レポート `docs/01_project/progressReports/2026-02-16_issue40_multilayer_license_audit.md` を作成。
- [x] Issue #40 へ監査結果と次実装タスク（PR単位）をコメント投稿。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。

## Issue #40 PR-1（M-01）community-node workspace license を MIT へ整合

- [x] `kukuri-community-node/Cargo.toml` の `[workspace.package].license` を `Apache-2.0` から `MIT` へ変更。
- [x] 監査で定義した M-01 のみを実施し、M-02/M-03 は本PRのスコープ外として据え置き。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue40_pr1_community_node_workspace_license_mit.md` を追加。

## 検証

- [x] `cd /home/kingyosun/kukuri/kukuri-community-node && cargo fmt --all --check`（pass）
- [x] `cd /home/kingyosun/kukuri && git diff --check`（pass）
- [x] `cd /home/kingyosun/kukuri && NPM_CONFIG_PREFIX=/tmp/npm-global XDG_CACHE_HOME=/tmp/xdg-cache DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check 2>&1 | tee tmp/logs/gh-act-format-check-issue40-pr1.log`（pass）
- [x] `cd /home/kingyosun/kukuri && NPM_CONFIG_PREFIX=/tmp/npm-global XDG_CACHE_HOME=/tmp/xdg-cache DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux 2>&1 | tee tmp/logs/gh-act-native-test-linux-issue40-pr1.log`（pass）
- [x] `cd /home/kingyosun/kukuri && NPM_CONFIG_PREFIX=/tmp/npm-global XDG_CACHE_HOME=/tmp/xdg-cache DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests 2>&1 | tee tmp/logs/gh-act-community-node-tests-issue40-pr1.log`（pass）

## Issue #40 / PR #42 fix loop（OpenAPI Artifacts Check generated drift）

- [x] CI失敗ジョブ（Run `22064412365` / Job `63752435217`）ログを確認し、`Verify generated artifacts are up-to-date` の差分が `admin-api.json` / `user-api.json` の `info.license.name`（`Apache-2.0` -> `MIT`）のみであることを特定。
- [x] CIと同一手順（`openapi export` 2本 + `pnpm generate:api`）でアーティファクトを再生成し、PR #42 のM-01（ライセンス整合）に対応する最小差分のみを反映。
- [x] `kukuri-community-node/apps/admin-console/openapi/admin-api.json` と `kukuri-community-node/apps/admin-console/openapi/user-api.json` を更新し、OpenAPI Artifacts Check のドリフトを解消。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue40_pr42_openapi_artifacts_fix_loop.md` を追加。

## 検証

- [x] `cd /home/kingyosun/kukuri && gh run view 22064412365 --job 63752435217 --log`（pass: 失敗差分を特定）
- [x] `cd /home/kingyosun/kukuri/kukuri-community-node/apps/admin-console && pnpm install --frozen-lockfile`（pass）
- [x] `cd /home/kingyosun/kukuri/kukuri-community-node && cargo run --locked -p cn-cli -- openapi export --service user-api --output apps/admin-console/openapi/user-api.json --pretty`（pass）
- [x] `cd /home/kingyosun/kukuri/kukuri-community-node && cargo run --locked -p cn-cli -- openapi export --service admin-api --output apps/admin-console/openapi/admin-api.json --pretty`（pass）
- [x] `cd /home/kingyosun/kukuri/kukuri-community-node/apps/admin-console && pnpm generate:api`（pass）
- [x] `cd /home/kingyosun/kukuri && git diff -- kukuri-community-node/apps/admin-console/openapi/admin-api.json kukuri-community-node/apps/admin-console/openapi/user-api.json kukuri-community-node/apps/admin-console/src/generated/admin-api.ts`（pass: JSON 2件のみ差分）
- [x] `cd /home/kingyosun/kukuri && NPM_CONFIG_PREFIX=/tmp/npm-global XDG_CACHE_HOME=/tmp/xdg-cache DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check 2>&1 | tee tmp/logs/gh-act-format-check-issue40-pr42-openapi-fix-loop.log`（pass）
- [x] `cd /home/kingyosun/kukuri && NPM_CONFIG_PREFIX=/tmp/npm-global XDG_CACHE_HOME=/tmp/xdg-cache DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux 2>&1 | tee tmp/logs/gh-act-native-test-linux-issue40-pr42-openapi-fix-loop.log`（pass）
- [x] `cd /home/kingyosun/kukuri && NPM_CONFIG_PREFIX=/tmp/npm-global XDG_CACHE_HOME=/tmp/xdg-cache DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests 2>&1 | tee tmp/logs/gh-act-community-node-tests-issue40-pr42-openapi-fix-loop.log`（pass）

## Main branch Community Node Tests fix loop（Run `22060340981`）

- [x] GitHub Actions Run `22060340981` / Job `63738742754` の失敗ログを解析し、`cn-user-api` 契約テスト `auth_consent_quota_metrics_regression_counters_increment` の `428` vs `402` 競合を根因として特定。
- [x] `kukuri-community-node/crates/cn-user-api/src/subscriptions.rs` で、該当テストの2回目 `topic-subscription-requests` を `post_json_with_consent_retry` に置換し、consent競合時の再試行を追加。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_main_branch_community_node_tests_run22060340981_fix_loop.md` を追加。

## 検証

- [x] `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check --action-cache-path /tmp/act-cache --cache-server-path /tmp/actcache`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux --action-cache-path /tmp/act-cache --cache-server-path /tmp/actcache`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests --action-cache-path /tmp/act-cache --cache-server-path /tmp/actcache`（pass）

## Issue #27 検索PG移行計画の初期監査

- [x] `docs/01_project/activeContext/search_pg_migration/` の PR-01..PR-07 計画を現行実装へ突合し、`implemented / missing / risky` を整理。
- [x] 監査結果を `docs/01_project/activeContext/search_pg_migration/issue27_initial_audit_2026-02-16.md` に記録。
- [x] 検索PG移行の未着手タスクを `docs/01_project/activeContext/tasks/priority/search_pg_migration_roadmap.md` として新規起票。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_search_pg_migration_audit.md` を追加。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。

## Issue #27 PR-01 拡張導入とランタイムフラグ基盤

- [x] `kukuri-community-node/docker/postgres-age/Dockerfile` に PGroonga 導入を追加。
- [x] migration `20260216020000_m6_search_runtime_flags.sql` を追加し、`pg_trgm` / `pgroonga` / `age` / `cn_search.runtime_flags` を初期化。
- [x] `cn-core::search_runtime_flags` を追加し、`cn-user-api` / `cn-index` の検索ランタイムフラグ読取を共通化。
- [x] 正本を `cn_search.runtime_flags` に確定（`service_configs` は既存用途のみ維持）。

## Issue #27 / PR #28 Community Node Tests fix loop（cn-admin-api 契約テスト直列化）

- [x] PR #28 CI失敗ログ（Run `22048263032` / Job `63700968967`）を解析し、`subscription_request_approve_rejects_when_node_topic_limit_reached` の不安定失敗原因を特定。
- [x] `kukuri-community-node/crates/cn-admin-api/src/contract_tests.rs` に `relay_subscription_approval_test_lock` を追加し、`service='relay'` を共有する承認系契約テスト 5件を直列化。
- [x] `transactional_admin_mutations_rollback_when_audit_log_write_fails` / `..._commit_fails` / `subscription_requests_and_node_subscriptions_contract_success` / `subscription_request_approve_rejects_when_node_topic_limit_reached` / `...already_exceeded` の競合を解消。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr28_community_node_tests_fix_loop.md` を追加。

## 検証

- [x] `docker compose -f docker-compose.test.yml build community-node-postgres test-runner`（PGroonga 導入済み Postgres イメージの再現性確認）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（再実行で pass。`cn-admin-api` の対象契約テストを含め全クレート通過）
- [x] `docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... 'for i in $(seq 1 8); do cargo test -p cn-admin-api --lib -- --test-threads=8; done'`（8連続 pass。PR #28 失敗点の再発なし）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）

## Issue #27 PR-02 投稿検索ドキュメント（PGroonga）

- [x] migration `20260216030000_m7_post_search_documents.sql` を追加し、`cn_search.post_search_documents` と PGroonga index を導入。
- [x] `cn-index` outbox consumer に `search_write_mode`（`meili_only/dual/pg_only`）を追加し、Meili 維持の dual-write（upsert/delete/expiry）を実装。
- [x] `cn-user-api` `/v1/search` に PG read backend を追加し、`search_read_backend` ランタイムフラグで Meili/PG 切替を実装。
- [x] `cn-core::search_normalizer`（NFKC/小文字化/記号正規化/`normalizer_version`）を追加し、`cn-index`/`cn-user-api` で共通利用。
- [x] 回帰テストを追加（`cn-core` 正規化ユニット、`cn-index` dual-write 統合、`cn-user-api` PG読取契約）。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr02_post_search_pgroonga.md` を追加。

## 検証

- [x] `cd kukuri-community-node && cargo fmt`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... "cargo test -p cn-core search_normalizer -- --nocapture; cargo test -p cn-index outbox_dual_write_updates_meili_and_post_search_documents -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_switch_normalization_and_version_filter -- --nocapture"`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... "cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests`（fail: `cn-admin-api` 契約テスト `trust_contract_success_and_shape` の既知系不安定失敗。ログ: `tmp/logs/gh-act-community-node-tests-issue27-pr02.log`）

## Issue #27 / PR #29 fix loop（post_search_documents multi-topic 上書き防止）

- [x] migration `20260216040000_m8_post_search_documents_topic_key.sql` を追加し、`cn_search.post_search_documents` の主キーを `(post_id, topic_id)` へ変更。
- [x] `cn-index` の PG upsert を `ON CONFLICT (post_id, topic_id)` へ修正し、delete/expiry/stale-mark を `topic_id` 条件付き更新へ変更。
- [x] `cn-index` 統合テスト `outbox_dual_write_preserves_post_search_documents_per_topic` を追加し、同一 event が複数 topic に属するケースで 2 行保持を回帰テスト化。
- [x] `cn-user-api` 契約テスト `search_contract_pg_backend_preserves_multi_topic_rows_for_same_post_id` を追加し、`/v1/search?topic=...` が topic ごとに正しい行を返すことを検証。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr29_post_search_topic_key_fix_loop.md` を追加。

## 検証

- [x] `cd kukuri-community-node && cargo fmt`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml down -v`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... "cargo clean -p cn-core; cargo test -p cn-index outbox_dual_write_updates_meili_and_post_search_documents -- --nocapture; cargo test -p cn-index outbox_dual_write_preserves_post_search_documents_per_topic -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_switch_normalization_and_version_filter -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_preserves_multi_topic_rows_for_same_post_id -- --nocapture"`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... "cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr29-fix-loop.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr29-fix-loop.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr29-fix-loop.log`（pass）

## Issue #27 / PR #29 fix loop second pass（CI run 22050188054）

- [x] CI 失敗ジョブを再解析し、Native Test の `Invite signature is invalid` と Community Node Tests の `search_contract_success_shape_compatible` 失敗原因を特定。
- [x] `kukuri-tauri/src-tauri/src/infrastructure/crypto/default_signature_service.rs` で、署名後の `created_at` を署名済みイベント時刻へ同期し、検証時の時刻不整合を解消。
- [x] `kukuri-community-node/crates/cn-user-api/src/subscriptions.rs` で検索契約テストの runtime flag 競合を直列化（`Mutex`）し、Meili 前提テストのフラグ初期化を明示。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr29_second_pass_ci_fix_loop.md` を追加。

## 検証

- [x] `cd kukuri-tauri/src-tauri && cargo test request_join_with_invite_broadcasts_to_issuer_topic -- --nocapture`（pass）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-user-api search_contract_success_shape_compatible -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_switch_normalization_and_version_filter -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_preserves_multi_topic_rows_for_same_post_id -- --nocapture"`（pass）
- [x] `DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `XDG_CACHE_HOME=/tmp/act-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr29-second-pass.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/act-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr29-second-pass.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/act-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr29-second-pass.log`（fail: `subscriptions::api_contract_tests::auth_consent_quota_metrics_regression_counters_increment` が `left: 428, right: 402`。今回修正対象外の既知不安定系としてログ保全）

## Issue #27 PR-03 コミュニティ候補生成（pg_trgm + prefix）

- [x] migration `20260216050000_m9_community_search_terms.sql` を追加し、`cn_search.community_search_terms` と `gin_trgm_ops` / `text_pattern_ops` index、既存購読データ由来の初期バックフィルを実装。
- [x] `cn-core::community_search_terms` を追加し、`topic_id -> community_id` 変換と候補語（name/alias）生成ロジックを共通化。
- [x] `cn-index` outbox upsert で `community_search_terms` へ同期する write path を追加し、migration 適用前でも `42P01/3F000` を握って互換動作を維持。
- [x] `cn-user-api` に `/v1/communities/suggest` を追加し、`suggest_read_backend=pg|legacy` 切替、入力長別（1-2文字/prefix優先、3文字以上/trgm活用）候補生成、pg空時 legacy fallback を実装。
- [x] `cn-index` / `cn-user-api` / OpenAPI 契約テストを更新し、exact/prefix/trgm と legacy 経路を固定化。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr03_community_candidates_pg_trgm.md` を追加。

## 検証

- [x] `cd kukuri-community-node && cargo fmt`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-core community_search_terms; cargo test -p cn-index outbox_upsert_updates_community_search_terms; cargo test -p cn-user-api community_suggest_pg_backend_supports_exact_prefix_and_trgm; cargo test -p cn-user-api community_suggest_legacy_backend_uses_topic_sources; cargo test -p cn-user-api openapi_contract_contains_user_paths"`（pass, ログ: `tmp/logs/issue27-pr03-targeted-tests.log`）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass, ログ: `tmp/logs/issue27-pr03-community-node-full.log`）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass, ログ: `tmp/logs/issue27-pr03-tauri-cargo-test.log`）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr03.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr03.log`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr03.log`（fail: `auth_consent_quota_metrics_regression_counters_increment` が `left: 428, right: 402`）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr03-rerun.log`（pass）

## Issue #27 / PR #30 fix loop（community_search_terms alias backfill の hashed-tail ノイズ除去）

- [x] PR #30 review（`discussion_r2810818018`）で指摘された `kukuri:<64hex>` alias ノイズ原因を再現し、migration/backfill と runtime 生成ロジックの不整合を確認。
- [x] `kukuri-community-node/migrations/20260216050000_m9_community_search_terms.sql` の alias backfill 条件に `LOWER(TRIM(topic_id)) !~ '^kukuri:[0-9a-f]{64}$'` を追加し、`kukuri:<64hex>` を初期バックフィル対象から除外。
- [x] `kukuri-community-node/crates/cn-user-api/src/subscriptions.rs` に backfill 相当 SQL を検証する回帰テスト `community_search_alias_backfill_skips_kukuri_hashed_tail_topics` を追加し、hashed tail は alias 0件・通常 topic は alias 生成ありを固定化。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr30_alias_backfill_hashed_tail_fix_loop.md` を追加。

## 検証

- [x] `cd kukuri-community-node && cargo fmt`（pass）
- [x] `cd /home/kingyosun/kukuri && docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-core community_search_terms -- --nocapture; cargo test -p cn-user-api community_search_alias_backfill_skips_kukuri_hashed_tail_topics -- --nocapture; cargo test -p cn-user-api community_suggest_pg_backend_supports_exact_prefix_and_trgm -- --nocapture; cargo test -p cn-user-api community_suggest_legacy_backend_uses_topic_sources -- --nocapture" | tee tmp/logs/issue27-pr30-fix-loop-targeted-tests.log`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli" | tee tmp/logs/issue27-pr30-fix-loop-community-node-full.log`（pass）
- [x] `cd /home/kingyosun/kukuri/kukuri-tauri/src-tauri && cargo test | tee /home/kingyosun/kukuri/tmp/logs/issue27-pr30-fix-loop-tauri-cargo-test.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr30-fix-loop.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr30-fix-loop.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr30-fix-loop.log`（pass）

## Issue #27 / PR #30 fix loop second pass（OpenAPI generated artifacts drift）

- [x] CI失敗ジョブ（Run `22052290440` / Job `63712785423`）ログを確認し、`Verify generated artifacts are up-to-date` で `kukuri-community-node/apps/admin-console/openapi/user-api.json` に `/v1/communities/suggest` が不足している差分を特定。
- [x] CIと同一コマンド（`cargo run -p cn-cli -- openapi export ...` / `pnpm generate:api`）で生成物を再作成し、差分が `user-api.json` のみであることを確認。
- [x] 生成物ドリフト修正として `kukuri-community-node/apps/admin-console/openapi/user-api.json` を更新。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr30_second_pass_openapi_artifacts_fix_loop.md` を追加。

## 検証

- [x] `cd /home/kingyosun/kukuri && gh run view 22052290440 --job 63712785423 --log`（pass: 差分箇所特定）
- [x] `cd /home/kingyosun/kukuri/kukuri-community-node/apps/admin-console && pnpm install --frozen-lockfile`（pass）
- [x] `cd /home/kingyosun/kukuri/kukuri-community-node && cargo run --locked -p cn-cli -- openapi export --service user-api --output apps/admin-console/openapi/user-api.json --pretty && cargo run --locked -p cn-cli -- openapi export --service admin-api --output apps/admin-console/openapi/admin-api.json --pretty`（pass）
- [x] `cd /home/kingyosun/kukuri/kukuri-community-node/apps/admin-console && pnpm generate:api`（pass）
- [x] `cd /home/kingyosun/kukuri && git diff --stat`（pass: `user-api.json` のみ変更）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr30-second-pass-openapi.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr30-second-pass-openapi.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr30-second-pass-openapi.log`（pass）

## Issue #27 PR-04 AGE グラフ同期

- [x] migration `20260216060000_m10_age_graph_sync.sql` を追加し、`cn_search.graph_sync_offsets` / `cn_search.user_community_affinity` と score index を導入。
- [x] `cn-index` に suggest 用 AGE グラフ（`kukuri_cn_suggest`）の初期化・ブートストラップ・差分同期（`index-age-suggest-v1` checkpoint）を実装。
- [x] outbox `upsert/delete` の後段で `MEMBER_OF` / `FOLLOWS_COMMUNITY` / `VIEWED_COMMUNITY` / `FOLLOWS_USER` を同期し、kind=3 の再同期冪等性を固定化。
- [x] `cn_search.user_community_affinity` の定期再計算ワーカー（`graph_affinity.recompute_interval_seconds`）を追加。
- [x] `cn-index` 統合テストを追加し、グラフエッジ同期・affinity 再計算・kind3 delete 冪等性を回帰テスト化。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr04_age_graph_sync.md` を追加。

## 検証

- [x] `cd /home/kingyosun/kukuri && docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-index outbox_graph_sync_updates_age_edges_and_affinity -- --nocapture; cargo test -p cn-index outbox_graph_sync_kind3_delete_is_idempotent -- --nocapture; cargo test -p cn-index outbox_upsert_updates_community_search_terms -- --nocapture"`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `cd /home/kingyosun/kukuri/kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr04.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr04.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr04.log`（pass）

## Issue #27 / PR #31 fix loop（`VIEWED_COMMUNITY` delete再計算）

- [x] `cn-index` の `sync_suggest_graph_for_outbox_row` で `delete` 分岐および非アクティブ `upsert` 分岐から `VIEWED_COMMUNITY` を再計算するよう修正。
- [x] `refresh_viewed_community_edge_from_current` / `delete_viewed_community_edge` を追加し、現行イベントが存在しない場合に stale `VIEWED_COMMUNITY` エッジを削除する挙動を実装。
- [x] `cn-index` 統合テスト `outbox_graph_sync_kind3_delete_is_idempotent` に、`VIEWED_COMMUNITY` エッジの作成・削除アサーションを追加して回帰を固定化。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr31_viewed_community_delete_fix_loop.md` を追加。

## 検証

- [x] `cd /home/kingyosun/kukuri && docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-index outbox_graph_sync_updates_age_edges_and_affinity -- --nocapture; cargo test -p cn-index outbox_graph_sync_kind3_delete_is_idempotent -- --nocapture"`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr31-fix-loop.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr31-fix-loop.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr31-fix-loop.log`（pass）

## Issue #27 PR-05 2段階サジェスト（候補生成 + 再ランキング）

- [x] migration `20260216070000_m11_suggest_rerank_runtime_flags.sql` を追加し、`suggest_rerank_mode=shadow` と `suggest_relation_weights` の初期値を `cn_search.runtime_flags` に投入。
- [x] `cn-core::search_runtime_flags` に `suggest_rerank_mode` / `suggest_relation_weights` を追加し、runtime flag ローダーと seed 検証テストを更新。
- [x] `cn-user-api` `/v1/communities/suggest` を Stage-A（候補生成）+ Stage-B（relation rerank）へ拡張し、`suggest_rerank_mode=shadow|enabled` の切替と shadow サンプリング比較を実装。
- [x] Stage-B SQL で block/mute/visibility の最終フィルタを適用し、`user_community_affinity` を結合した weighted score（name/relation/popularity/recency）で再ランキング。
- [x] observability として `suggest_stage_a_latency_ms` / `suggest_stage_b_latency_ms` / `suggest_block_filter_drop_count` を `cn_core::metrics` に追加し、API 経路から記録するよう接続。
- [x] `cn-user-api` 契約テストを追加・更新し、enabled rerank 順位/ミュート除外/shadow モード順序保持/既存 pg+legacy 互換を回帰固定。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr05_two_stage_suggest_rerank.md` を追加。

## 検証

- [x] `cd /home/kingyosun/kukuri && docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `cd /home/kingyosun/kukuri && docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `cd /home/kingyosun/kukuri && docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-core search_runtime_flags -- --nocapture; cargo test -p cn-user-api community_suggest_pg_backend_supports_exact_prefix_and_trgm -- --nocapture; cargo test -p cn-user-api community_suggest_pg_rerank_enabled_prioritizes_affinity_and_visibility -- --nocapture; cargo test -p cn-user-api community_suggest_pg_rerank_filters_muted_communities -- --nocapture; cargo test -p cn-user-api community_suggest_pg_shadow_mode_preserves_stage_a_order_and_reports_shadow -- --nocapture; cargo test -p cn-user-api community_suggest_legacy_backend_uses_topic_sources -- --nocapture; cargo test -p cn-user-api community_search_alias_backfill_skips_kukuri_hashed_tail_topics -- --nocapture"`（pass）
- [x] `cd /home/kingyosun/kukuri && docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass。初回1回のみ `cn-admin-api::trust_contract_success_and_shape` が不安定失敗したため単体再実行後に再度 full を実行し pass）
- [x] `cd /home/kingyosun/kukuri/kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr05.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr05.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr05.log`（pass）

## Issue #27 PR-06 dual-write + backfill + shadow-read

- [x] migration `20260216080000_m12_search_backfill_shadow.sql` を追加し、`cn_search.backfill_jobs` / `cn_search.backfill_checkpoints` / `cn_search.shadow_read_logs` と検索用 index を導入。
- [x] `cn-index` で dual-write 片系失敗を `DualWriteFailureMarker` とメトリクスで追跡し、outbox 再処理成功時に retry カウンタを加算する再送フローを追加。
- [x] `cn-index` に backfill worker（claim/run/checkpoint/progress/ETA）を追加し、`post_search_documents` への再構築を checkpoint 再開可能で実装。
- [x] `cn-user-api` `/v1/search` に sampled shadow-read 比較（secondary backend 実行、overlap@10 / latency delta 計測、`cn_search.shadow_read_logs` 保存）を追加。
- [x] `cn-core::metrics` に PR-06 用 observability（`backfill_processed_rows` / `backfill_eta_seconds` / `shadow_overlap_at_10` / `shadow_latency_delta_ms` / `search_dual_write_errors_total` / `search_dual_write_retries_total`）を追加。
- [x] `cn-index` / `cn-user-api` の統合・契約テストを拡張し、dual-write 再送・backfill checkpoint 再開・shadow-read ログ保存を回帰固定。
- [x] `community-node-tests` 初回失敗（`backfill_job_resumes_from_checkpoint_and_completes_post_search_documents` が `processed_rows` 期待値不一致）に対し、同テストの `topic_id` を高ソートキー化して他テストデータ混入を遮断し、再実行で解消。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr06_dual_write_backfill_shadow.md` を追加。

## 検証

- [x] `cd /home/kingyosun/kukuri/kukuri-community-node && cargo fmt`（pass）
- [x] `cd /home/kingyosun/kukuri && docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-index outbox_dual_write_updates_meili_and_post_search_documents -- --nocapture; cargo test -p cn-index outbox_dual_write_retries_after_pg_side_failure_and_recovers -- --nocapture; cargo test -p cn-index backfill_job_resumes_from_checkpoint_and_completes_post_search_documents -- --nocapture; cargo test -p cn-user-api search_contract_success_shape_compatible -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_switch_normalization_and_version_filter -- --nocapture; cargo test -p cn-user-api search_contract_pg_backend_preserves_multi_topic_rows_for_same_post_id -- --nocapture; cargo test -p cn-user-api search_shadow_read_logs_overlap_and_latency_when_sampled -- --nocapture"`（pass）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `cd /home/kingyosun/kukuri/kukuri-tauri/src-tauri && cargo test`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check | tee tmp/logs/gh-act-format-check-issue27-pr06.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux | tee tmp/logs/gh-act-native-test-linux-issue27-pr06.log`（pass）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr06.log`（fail: `backfill_job_resumes_from_checkpoint_and_completes_post_search_documents` の `processed_rows` 期待値不一致）
- [x] `cd /home/kingyosun/kukuri && docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（pass: fix loop 再検証環境）
- [x] `cd /home/kingyosun/kukuri && DOCKER_CONFIG=/tmp/docker-config docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-index backfill_job_resumes_from_checkpoint_and_completes_post_search_documents -- --nocapture"`（pass: fix loop 単体確認）
- [x] `cd /home/kingyosun/kukuri && XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests | tee tmp/logs/gh-act-community-node-tests-issue27-pr06-rerun.log`（pass）

## Issue #27 / PR #33 fix loop（stale `running` backfill reclaim）

- [x] review 指摘（`discussion_r2811523305`）に対応し、`claim_backfill_job` が `pending/failed` に加えて stale `running` を回収できるよう修正。
- [x] backfill claim 時に `started_at = NOW()` を lease トークンとして再発行し、`BackfillJob` に `lease_started_at` を保持するよう更新。
- [x] `update_backfill_job_progress` / `mark_backfill_job_succeeded` / `mark_backfill_job_failed` に `started_at` フェンシング条件を追加し、旧 lease owner の更新を遮断。
- [x] 回帰テスト `claim_backfill_job_reclaims_stale_running_job` / `backfill_job_fences_old_lease_after_takeover` を追加し、stale reclaim と safe takeover を固定化。
- [x] `backfill_job_resumes_from_checkpoint_and_completes_post_search_documents` の checkpoint 期待値を順序前進検証へ変更し、full suite での順序揺らぎに対して安定化。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr33_stale_running_backfill_reclaim_fix_loop.md` を追加。

## 検証

- [x] `cd /home/kingyosun/kukuri/kukuri-community-node && cargo fmt`（pass）
- [x] `cd /home/kingyosun/kukuri && NPM_CONFIG_PREFIX=/tmp/npm-global XDG_CACHE_HOME=/tmp/.cache ACT_CACHE_DIR=/tmp/act-cache DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check 2>&1 | tee tmp/logs/gh-act-format-check-issue27-pr33-fix-loop.log`（pass）
- [x] `cd /home/kingyosun/kukuri && NPM_CONFIG_PREFIX=/tmp/npm-global XDG_CACHE_HOME=/tmp/.cache ACT_CACHE_DIR=/tmp/act-cache DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux 2>&1 | tee tmp/logs/gh-act-native-test-linux-issue27-pr33-fix-loop.log`（pass）
- [x] `cd /home/kingyosun/kukuri && NPM_CONFIG_PREFIX=/tmp/npm-global XDG_CACHE_HOME=/tmp/.cache ACT_CACHE_DIR=/tmp/act-cache DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests 2>&1 | tee tmp/logs/gh-act-community-node-tests-issue27-pr33-fix-loop.log`（fail: `cn-user-api` の既知不安定系 `subscriptions::api_contract_tests::auth_consent_quota_metrics_regression_counters_increment` が `left: 428, right: 402`。本修正の `cn-index` backfill 16 tests は pass）

## Issue #27 PR-07 cutover runbook / finalization

- [x] `docs/01_project/activeContext/search_pg_migration/PR-07_cutover_runbook.md` を更新し、`search_read_backend` / `suggest_read_backend` のカナリア切替（5/25/50/100%）、品質/性能ゲート閾値、5分以内ロールバック手順、一次切り分け、再インデックス、監査ログ確認、既知障害テンプレートを Runbook 化。
- [x] PG検索向け監視項目（search/suggest latency、index lag、zero-result、filter drop、shadow 指標）と Dashboard 監視観点を明文化。
- [x] Meili 依存の compose/test/env 段階撤去条件と手順を Runbook に追記。
- [x] `docs/03_implementation/community_nodes/ops_runbook.md` に検索 PG cutover 監視セクションを追加し、運用 Runbook と実装メトリクス名の対応を固定。
- [x] `docs/01_project/activeContext/tasks/priority/search_pg_migration_roadmap.md` の PR-07 項目と共通ゲート項目を完了状態へ更新。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr07_cutover_runbook_finalization.md` を追加。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。
- [x] `git diff --check`（pass: whitespace/error なし）。

## Issue #43 in_progress 運用衛生化と AGENTS 更新

- [x] `docs/01_project/activeContext/tasks/status/in_progress.md` から、完了済み見出し `2026年02月16日 Issue #27 検索PG移行計画の初期監査（完了）` 配下を削除。
- [x] `AGENTS.md` に `in_progress.md` へ完了状態を残さない明示ルールと、完了時の移管順序を追記。
- [x] `AGENTS.md` の作業完了チェックリストに、完了状態残留チェックと移管先記録チェックを追記。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue43_in_progress_hygiene_and_agents_update.md` を追加。

## 検証

- [x] `date "+%Y年%m月%d日"`（pass: `2026年02月16日`）。
- [x] `rg -n "状態: 完了|（完了）" docs/01_project/activeContext/tasks/status/in_progress.md`（pass: 一致なし）。
- [x] `git diff --check`（pass: whitespace/error なし）。
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job format-check --action-cache-path /tmp/act-cache --cache-server-path /tmp/actcache`（pass, `tmp/logs/gh-act-format-check-issue43.log`）。
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job native-test-linux --action-cache-path /tmp/act-cache --cache-server-path /tmp/actcache`（pass, `tmp/logs/gh-act-native-test-linux-issue43.log`）。
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global DOCKER_CONFIG=/tmp/docker-config gh act --workflows .github/workflows/test.yml --job community-node-tests --action-cache-path /tmp/act-cache --cache-server-path /tmp/actcache`（pass, `tmp/logs/gh-act-community-node-tests-issue43.log`）。

## Issue #27 最終再監査フォローアップ（ops_runbook shadow canary sync）

- [x] `docs/03_implementation/community_nodes/ops_runbook.md` の PG cutover 監視節を更新し、5%/25%/50% は `shadow_sample_rate` カナリア、100% 段階のみ `search_read_backend` / `suggest_read_backend` を `pg` へ切替する順序を明記。
- [x] `docs/01_project/activeContext/tasks/status/in_progress.md` から Issue #27 最終再監査フォローアップの作業中エントリを削除し、残タスク 0 件へ更新。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_followup_ops_runbook_shadow_canary_sync.md` を追加。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。
- [x] `git diff --check`（pass: whitespace/error なし）。
- [x] `rg -n "shadow_sample_rate|5%/25%/50% canary|100% cutover|search_read_backend='pg'" docs/03_implementation/community_nodes/ops_runbook.md`（pass）。

## Issue #27 最終再監査フォローアップ（services_index cutover sync）

- [x] `docs/03_implementation/community_nodes/services_index.md` を Meili-only 記述から、`search_write_mode` / dual-write 片系失敗再送 / backfill checkpoint / shadow-read 連携 / cutover 順序を含む運用モデルへ更新。
- [x] 同ドキュメントに責務境界（shadow-read 実行主体は `cn-user-api`）と、`cn-index` `GET /healthz` の Meili readiness 依存を注記。
- [x] `docs/01_project/activeContext/tasks/status/in_progress.md` の Issue #27 フォローアップ残タスクを 1件へ更新（residual task #3 完了反映）。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_followup_services_index_cutover_sync.md` を追加。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。
- [x] `git diff --check`（pass: whitespace/error なし）。

## Issue #27 最終再監査フォローアップ（user_api suggest/runtime flag docs sync）

- [x] `docs/03_implementation/community_nodes/user_api.md` の API 一覧に `GET /v1/communities/suggest` を追記し、`q` 正規化・`limit` clamp・`legacy_fallback` 条件を実装記述へ同期。
- [x] 同ドキュメントに search/suggest runtime flag 運用メモを追加し、`search_read_backend` / `search_write_mode` / `suggest_read_backend` / `suggest_rerank_mode` / `suggest_relation_weights` / `shadow_sample_rate` の値・fallback・対象サービスを明記。
- [x] `docs/01_project/activeContext/tasks/status/in_progress.md` の Issue #27 フォローアップ残タスクを 2件へ更新（residual task #2 完了反映）。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_followup_user_api_suggest_runtime_flags.md` を追加。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。
- [x] `git diff --check`（pass: whitespace/error なし）。

## Issue #27 最終再監査フォローアップ（PR-02 key/conflict docs sync）

- [x] `docs/01_project/activeContext/search_pg_migration/PR-02_post_search_pgroonga.md` の DDL を `(post_id, topic_id)` 複合主キーへ更新。
- [x] 同ドキュメントの backfill 手順を `ON CONFLICT (post_id, topic_id)` へ更新し、`m7 -> m8` の migration 履歴注記を追加。
- [x] `docs/01_project/activeContext/tasks/status/in_progress.md` の Issue #27 最終再監査フォローアップ残タスクを 3件へ更新（residual task #1 完了反映）。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_followup_pr02_key_conflict_doc_sync.md` を追加。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。
- [x] `git diff --check`（pass: whitespace/error なし）。
- [x] `rg -n "post_id TEXT PRIMARY KEY|ON CONFLICT \\(post_id\\)" docs/01_project/activeContext/search_pg_migration/PR-02_post_search_pgroonga.md`（pass: 一致なし）。
- [x] `rg -n "PRIMARY KEY \\(post_id, topic_id\\)|ON CONFLICT \\(post_id, topic_id\\)|20260216040000_m8_post_search_documents_topic_key.sql" docs/01_project/activeContext/search_pg_migration/PR-02_post_search_pgroonga.md`（pass）。

## Issue #27 / PR #34 fix loop（cutover runbook review comments）

- [x] review 指摘 `discussion_r2811782984` に対応し、`PR-07_cutover_runbook.md` の 5%/25%/50% 手順を binary な read backend 切替から `shadow_sample_rate` 段階へ修正。100% 段階のみ `search_read_backend` / `suggest_read_backend` を `pg` へ切替する手順に更新。
- [x] review 指摘 `discussion_r2811782990` に対応し、zero-result 監視 SQL の時刻列を `recorded_at` から `created_at` へ修正。
- [x] review 指摘 `discussion_r2811782994` に対応し、Index lag / outbox health の consumer ラベルを `index-search-v1` から実装値 `index-v1` へ修正（`PR-07_cutover_runbook.md` と `ops_runbook.md`）。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr34_cutover_runbook_fix_loop.md` を追加。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。
- [x] `git diff --check`（pass: whitespace/error なし）。
- [x] `rg -n "recorded_at|index-search-v1" docs/01_project/activeContext/search_pg_migration/PR-07_cutover_runbook.md docs/03_implementation/community_nodes/ops_runbook.md`（pass: 対象ファイルで一致なし）。

## Issue #27 最終再監査（PR-01..PR-07 マージ後）

- [x] `references/community-nodes-strict-audit-checklist.md` の有無を再確認し、未存在のため Issue #5 fallback gate（`https://github.com/KingYoSun/kukuri/issues/5#issuecomment-3900483686`）で監査を実施。
- [x] 監査要求3点（runtime flags / cutover docs、PG search docs / suggest path / backfill-shadow、migrations / runbook）を実装・ドキュメント・OpenAPIの三層で突合。
- [x] 最終再監査レポート `docs/01_project/progressReports/2026-02-16_issue27_final_reaudit.md` を追加。
- [x] 追加フォローアップ 4件（ドキュメント整合）を抽出し、`docs/01_project/activeContext/tasks/status/in_progress.md` に反映。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。
- [x] `git diff --check`（pass: whitespace/error なし）。

## Issue #27 最終再監査（post-followups / pass2）

- [x] `references/community-nodes-strict-audit-checklist.md` の有無を再確認し、未存在のため Issue #5 fallback gate（`https://github.com/KingYoSun/kukuri/issues/5#issuecomment-3900483686`）を再適用。
- [x] residual follow-up #1-#4 マージ後の strict 再監査として、PR-02..PR-07 文書と m6〜m12 migration / `cn-index` / `cn-user-api` / `cn-core` 実装を突合。
- [x] `docs/03_implementation/community_nodes/user_api.md` / `services_index.md` / `ops_runbook.md` の運用記述を runtime flag・cutover 実装へ再突合し、残差分 0 を確認。
- [x] 最終再監査レポート `docs/01_project/progressReports/2026-02-16_issue27_final_reaudit_pass2.md` を追加。
- [x] 判定を **PASS（追加タスクなし）** とし、Issue #27 クローズ可能を確定。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。
- [x] `find . -name 'community-nodes-strict-audit-checklist.md'`（結果なし: strict checklist 未存在）。
- [x] `gh api repos/KingYoSun/kukuri/issues/comments/3900483686 | jq '{html_url, created_at, updated_at, user: .user.login, body}'`（pass: fallback gate コメント確認）。
- [x] `rg -n "search_write_mode|backfill_jobs|shadow_sample_rate|search_read_backend=pg|healthz" docs/03_implementation/community_nodes/services_index.md`（pass）。
- [x] `rg -n "/v1/communities/suggest|search_read_backend|suggest_read_backend|suggest_rerank_mode|suggest_relation_weights|shadow_sample_rate" docs/03_implementation/community_nodes/user_api.md`（pass）。
- [x] `git diff --check`（pass: whitespace/error なし）。

## Issue #43 / PR #44 fix loop（in_progress 10.Ops/CI ガード削除）

- [x] Manager 指示（PR comment）に従い、`docs/01_project/activeContext/tasks/status/in_progress.md` から完了済みの `10. **Ops/CI ガード**` 節を削除。
- [x] 完了記録を本ファイルへ追記し、`in_progress.md` を active-only の状態へ維持。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue43_pr44_ops_ci_guard_fix_loop.md` を追加。

## 検証

- [x] `date "+%Y年%m月%d日"`（pass: `2026年02月16日`）。
- [x] `rg -n "^  10\\. \\*\\*Ops/CI ガード\\*\\*" docs/01_project/activeContext/tasks/status/in_progress.md`（pass: 一致なし）。
- [x] `git diff --check`（pass: whitespace/error なし）。

## Issue #45 初期監査（i18n ja/en/zh-CN）

- [x] Issue #45 の監査観点（未定義キー、locale drift、時刻ロケール整合）に沿って、PR #41 head（`pr-41-audit`）を対象に i18n 差分監査を実施。
- [x] mismatch を特定（未定義キー 4 件、locale drift 2 件、時刻ロケール不一致箇所 9 ファイル）。
- [x] 1タスク=1PR の最小実行計画（PR-1〜PR-3）を定義し、進捗レポート `docs/01_project/progressReports/2026-02-16_issue45_initial_i18n_audit.md` を追加。
- [x] Issue #45 へ監査結果と次実装PRスコープをコメント投稿。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。
- [x] `git diff --check`（pass: whitespace/error なし）。
