# 2026年02月16日 完了タスク

最終更新日: 2026年02月16日

## Issue #27 検索PG移行計画の初期監査

- [x] `docs/01_project/activeContext/search_pg_migration/` の PR-01..PR-07 計画を現行実装へ突合し、`implemented / missing / risky` を整理。
- [x] 監査結果を `docs/01_project/activeContext/search_pg_migration/issue27_initial_audit_2026-02-16.md` に記録。
- [x] 検索PG移行の未着手タスクを `docs/01_project/activeContext/tasks/priority/search_pg_migration_roadmap.md` として新規起票。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_search_pg_migration_audit.md` を追加。

## 検証

- [x] docs-only 更新のため、テスト/ビルド/`gh act` は実施不要（`AGENTS.md` の「`./docs` 配下のみ更新では不要」ルールに従う）。

## Issue #27 PR-01 拡張導入とランタイムフラグ基盤

- [x] `kukuri-community-node/docker/postgres-age/Dockerfile` に PGroonga 導入を追加。
- [x] migration `20260216020000_m6_search_runtime_flags.sql` を追加し、`pg_trgm` / `pgroonga` / `age` / `cn_search.runtime_flags` を初期化。
- [x] `cn-core::search_runtime_flags` を追加し、`cn-user-api` / `cn-index` の検索ランタイムフラグ読取を共通化。
- [x] 正本を `cn_search.runtime_flags` に確定（`service_configs` は既存用途のみ維持）。

## Issue #27 / PR #28 Community Node Tests fix loop（cn-admin-api 契約テスト直列化）

- [x] PR #28 CI失敗ログ（Run `22048263032` / Job `63700968967`）を解析し、`subscription_request_approve_rejects_when_node_topic_limit_reached` の不安定失敗原因を特定。
- [x] `kukuri-community-node/crates/cn-admin-api/src/contract_tests.rs` に `relay_subscription_approval_test_lock` を追加し、`service='relay'` を共有する承認系契約テスト 5件を直列化。
- [x] `transactional_admin_mutations_rollback_when_audit_log_write_fails` / `..._commit_fails` / `subscription_requests_and_node_subscriptions_contract_success` / `subscription_request_approve_rejects_when_node_topic_limit_reached` / `...already_exceeded` の競合を解消。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-16_issue27_pr28_community_node_tests_fix_loop.md` を追加。

## 検証

- [x] `docker compose -f docker-compose.test.yml build community-node-postgres test-runner`（PGroonga 導入済み Postgres イメージの再現性確認）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `XDG_CACHE_HOME=/tmp/xdg-cache NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（再実行で pass。`cn-admin-api` の対象契約テストを含め全クレート通過）
- [x] `docker run --rm --network kukuri_community-node-network ... kukuri-test-runner ... 'for i in $(seq 1 8); do cargo test -p cn-admin-api --lib -- --test-threads=8; done'`（8連続 pass。PR #28 失敗点の再発なし）
- [x] `cd kukuri-tauri/src-tauri && cargo test`（pass）
