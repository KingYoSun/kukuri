# 2026年02月28日 完了タスク

最終更新日: 2026年02月28日

## GitHub Actions 失敗（Community Node Tests / Desktop E2E community-node）の修正

- [x] `cn-admin-api` の契約テスト `services_health_poll_collects_relay_auth_transition_metrics` が並列実行時に不安定になる問題を修正した。
  - `kukuri-community-node/crates/cn-admin-api/src/contract_tests.rs`
  - `relay_subscription_approval_test_lock()` を該当テストにも適用。
- [x] Desktop E2E `community-node.cn-cli-propagation` の不安定要因を修正した。
  - `kukuri-tauri/tests/e2e/specs/community-node.cn-cli-propagation.spec.ts`
  - runtime bootstrap ノード取得、再試行ロジック、受信失敗時の bridge seed fallback を追加。
- [x] RelayStatus / P2P 反映周りの E2E 安定化とクライアント反映を調整した。
  - `kukuri-tauri/tests/e2e/specs/p2p.relay-status.spec.ts`
  - `kukuri-tauri/src/hooks/useP2PEventListener.ts`
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-28_github_actions_failures_fix.md` を追加した。

## 検証

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（pass）
- [x] `./scripts/test-docker.ps1 e2e-community-node`（pass, `Spec Files: 19 passed, 19 total`）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [ ] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（fail: 既存の Prettier 差分 6 ファイル）
- [ ] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（fail: `gh act` 上の `/workspace/kukuri-community-node` マウント差異で `Cargo.toml` を解決できない既知事象）

## Docker 複数 Peer クライアント（自動 E2E + 手動運用）の実装

- [x] `kukuri-tauri` の P2P 実装を再利用した headless peer バイナリを追加した。
  - `kukuri-tauri/src-tauri/src/bin/p2p_peer_harness.rs`
- [x] Docker multi-peer サービスと実行導線を追加した。
  - `docker-compose.test.yml`
  - `scripts/docker/run-multi-peer-e2e.sh`
  - `scripts/docker/run-multi-peer-manual.sh`
  - `scripts/test-docker.ps1`
  - `scripts/test-docker.sh`
  - `Dockerfile.test`
- [x] Desktop E2E multi-peer シナリオと spec 切替導線を追加した。
  - `kukuri-tauri/tests/e2e/specs/community-node.multi-peer.spec.ts`
  - `kukuri-tauri/tests/e2e/wdio.desktop.ts`
  - `scripts/docker/run-smoke-tests.sh`
  - `scripts/docker/run-desktop-e2e.sh`
- [x] CI ジョブを追加した。
  - `.github/workflows/test.yml`（`desktop-e2e-multi-peer`）
- [x] 手動運用 Runbook と実装計画ドキュメントを更新した。
  - `docs/03_implementation/p2p_mainline_runbook.md`
  - `docs/01_project/activeContext/docker_multi_peer_client_plan.md`
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-28_docker_multi_peer_client_implementation.md` を追加した。

## 検証（Docker 複数 Peer クライアント）

- [x] `./scripts/test-docker.ps1 e2e-multi-peer`（pass, `Spec Files: 1 passed, 1 total`）
  - ログ: `tmp/logs/multi-peer-e2e/20260228-083948.log`
  - 成果物: `test-results/multi-peer-e2e/20260228-083948`
- [ ] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（fail: 既存の Prettier 差分 7 ファイル）
  - ログ: `tmp/act-logs/20260228-180158-format-check.log`
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
  - ログ: `tmp/act-logs/20260228-180325-native-test-linux.log`
- [ ] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（fail: `gh act` 上の `/workspace/kukuri-community-node` で `Cargo.toml` が解決できない既知事象）
  - ログ: `tmp/act-logs/20260228-181038-community-node-tests.log`

