# 2025年11月13日 完了タスク

最終更新日: 2025年11月13日

## GitHub Actions ワークフロー修復

- [x] `useProfileAvatarSync` / `composerStore` / `topicStore` の型ずれを解消し、`PendingTopicStatus::from_value` へ改名。`ProfileSetup`・`ProfileEditDialog`・`useTopics` のユニットテストを新仕様に合わせて更新し、`pnpm format:check` → `pnpm lint` → `pnpm type-check` → `pnpm test` を通過させて TypeScript パイプラインを復旧。
- [x] `docs/01_project/activeContext/tasks/status/in_progress.md` に 2025年11月13日の対応内容（gh act ログ・PowerShell Docker テストログ）を追記し、タスクの進捗を共有。

### 実行コマンド

- `pnpm format:check`
- `pnpm lint`
- `pnpm type-check`
- `pnpm test`
- `gh act push -j format-check -W .github/workflows/test.yml --container-options '--user 0:0'`
- `gh act push -j native-test-linux -W .github/workflows/test.yml --container-options '--user 0:0'`

## Rust / Docker テスト検証

- [x] Windows ネイティブの `cargo test` が DLL 依存で失敗するため、`./scripts/test-docker.ps1 rust` を実行して kukuri-tauri/src-tauri と kukuri-cli の `cargo test` / `cargo clippy` / マルチノード P2P テストを Docker 上で完走。ログは `tmp/rust-docker.log` に保存。
- [x] `cargo test --workspace --all-features`・`cargo clippy --workspace --all-features -- -D warnings` を `kukuri-tauri/src-tauri` と `kukuri-cli` の両方で実行し、ローカルの警告ゼロを確認。`gh act push -j docker-test ...` は Windows の単一ファイルマウント制約で失敗するため、代替として上記 PowerShell スクリプト結果を共有。

### 実行コマンド

- `cd kukuri-tauri/src-tauri && cargo test --workspace --all-features`
- `cd kukuri-tauri/src-tauri && cargo clippy --workspace --all-features -- -D warnings`
- `cd kukuri-cli && cargo test --workspace --all-features`
- `cd kukuri-cli && cargo clippy --workspace --all-features -- -D warnings`
- `./scripts/test-docker.ps1 rust`
- `gh act push -j docker-test -W .github/workflows/test.yml --container-options '--user 0:0'`

## trending-feed シナリオ安定化 / Dependency テンプレ更新

- [x] `scripts/docker/run-vitest-target.sh` を追加して pnpm/corepack フォールバックと `pnpm install --frozen-lockfile --ignore-workspace` リカバリーを共通化し、PowerShell 版 `scripts/test-docker.ps1` からは per-target 実行を同スクリプト経由に切り替えた。併せて `Build-TestImage` が `test-runner` と `ts-test` の両サービスをビルドし、`Test-DockerImageExists` も `kukuri-ts-test` イメージまで監視するように調整。
- [x] `./scripts/test-docker.ps1 ts -Scenario trending-feed` を再実行して `tmp/logs/trending-feed/20251113-221436.log` / `test-results/trending-feed/20251113-221436-*.json`（Nightly artefact）を確認し、`phase5_dependency_inventory_template.md` と `tasks/status/in_progress.md` の該当項目をクローズ。

### 実行コマンド

- `./scripts/test-docker.ps1 build`
- `./scripts/test-docker.ps1 ts -Scenario trending-feed`

## Stage4: 投稿削除フロー／post-delete-cache シナリオ

- [x] `src-tauri/tests/integration/post_delete_flow.rs` を追加し、`delete_post` → `sync_queue` → `list_following_feed` / `get_posts_by_topic` の整合性と `EventService::delete_events` 呼び出しを Rust 側で検証。`useDeletePost.manualRetryDelete` と `SyncStatusIndicator` の削除再送 UI を仕上げ、`PostCard.deleteOffline.test.tsx` / `useDeletePost.test.tsx` を拡張。
- [x] ローカルで `pnpm vitest run …` を実行して `tmp/logs/post_delete_cache_20251113-085756.log` を採取し、Docker では `SCENARIO=post-delete-cache docker compose -f docker-compose.test.yml run --rm test-runner` を実行して `tmp/logs/post-delete-cache_docker_20251113-002140.log` と `test-results/post-delete-cache/20251113-002140.json` を生成。Runbook Chapter5 / `phase5_ci_path_audit.md` / `phase5_user_flow_inventory.md` / `phase5_user_flow_summary.md` を同日付で更新。

### 実行コマンド

- `cd kukuri-tauri && pnpm vitest run src/tests/unit/hooks/useDeletePost.test.tsx src/tests/unit/components/posts/PostCard.test.tsx src/tests/unit/components/posts/PostCard.deleteOffline.test.tsx | Tee-Object -FilePath ..\tmp\logs\post_delete_cache_20251113-085756.log`

## EventGateway / P2PService 再構成

- [x] `application/services/p2p_service/bootstrap.rs` で `P2PStack.p2p_service` を `Arc<dyn P2PServiceTrait>` に変更し、`state.rs` の AppState と `TopicService` / `presentation::handlers::p2p_handler.rs` がダウンキャスト無しで trait を受け取るよう再配線した。EventGateway も `LegacyEventManagerGateway` を介した `Arc<dyn EventGateway>` 注入に統一。
- [x] `phase5_dependency_inventory_template.md`（MVP モジュール表）、`docs/01_project/roadmap.md`（P2P & Discovery 行）、`docs/03_implementation/p2p_mainline_runbook.md` 3.2 に完了内容と検証ログ (`tmp/logs/cargo-test-kukuri-tauri_di_20251113.log`, `tmp/logs/test-docker-rust_di_20251113.log`, `tmp/logs/cargo-test-kukuri-cli_di_20251113.log`) を追記し、`tasks/status/in_progress.md` の当該タスクをクローズした。
- [x] Windows ネイティブの `cargo test --workspace --all-features` は `kukuri_lib` 実行時に `STATUS_ENTRYPOINT_NOT_FOUND` で失敗したため、`./scripts/test-docker.ps1 rust` で kukuri-tauri/src-tauri + kukuri-cli の Rust テスト＆Clippy を Docker 経由で再実行。CLI 単体の `cargo test --workspace --all-features` はローカルで成功しており、すべてのログを `tmp/logs/` 配下に保存した。

### 実行コマンド

- `cd kukuri-tauri/src-tauri && cargo test --workspace --all-features 2>&1 | Tee-Object -FilePath ..\..\tmp\logs\cargo-test-kukuri-tauri_di_20251113.log`
- `./scripts/test-docker.ps1 rust 2>&1 | Tee-Object -FilePath tmp\logs\test-docker-rust_di_20251113.log`
- `cd kukuri-cli && cargo test --workspace --all-features 2>&1 | Tee-Object -FilePath ..\tmp\logs\cargo-test-kukuri-cli_di_20251113.log`
- `docker compose -f docker-compose.test.yml build test-runner`
- `SCENARIO=post-delete-cache docker compose -f docker-compose.test.yml run --rm test-runner`

## DirectMessageInbox backlog 解消

- [x] DirectMessageInbox に会話検索/候補補完・Enter ショートカット・TanStack Virtualizer の測定付き仮想スクロール・多端末既読バッジを実装し、`useDirectMessageStore.markConversationAsRead(conversationNpub, lastReadAt?)` と `useDirectMessageBootstrap` が SQLite の `lastReadAt` を同期できるようにした。`phase5_user_flow_summary.md` 2章と `phase5_user_flow_inventory.md` 5.6.1 を稼働状態へ更新。
- [x] `tests/contract/direct_messages.rs` を追加し、会話サマリの既読タイムスタンプと未読集計を Docker (`./scripts/test-docker.ps1 rust`) で毎回検証できるようにした。Vitest（`tmp/logs/direct_message_inbox_20251113-140827.log`）と Docker Rust（`tmp/logs/rust_docker_20251113-141846.log`）の結果を記録。

### 実行コマンド

- `cd kukuri-tauri && corepack pnpm vitest run src/tests/unit/components/directMessages/DirectMessageInbox.test.tsx src/tests/unit/components/directMessages/DirectMessageDialog.test.tsx | Tee-Object -FilePath ..\tmp\logs\direct_message_inbox_20251113-140827.log`
- `cd kukuri-tauri/src-tauri && cargo test` （Windows では `STATUS_ENTRYPOINT_NOT_FOUND` のため失敗。`./scripts/test-docker.ps1 rust` に切り替えてログ取得）
- `./scripts/test-docker.ps1 rust *> tmp/logs/rust_docker_20251113-141846.log`
- `cd kukuri-cli && cargo test`

## Stage4 ドキュメント同期 / タスククローズ

- [x] `roadmap.md`, `design_doc.md`, `tauri_app_implementation_plan.md` を Stage4 ログ（`tmp/logs/profile_avatar_sync_stage4_<timestamp>.log`, `tmp/logs/trending_metrics_job_stage4_<timestamp>.log`, `tmp/logs/sync_status_indicator_stage4_<timestamp>.log`, `tmp/logs/topic_create_host_20251112-231141.log`, `tmp/logs/post_delete_cache_20251113-085756.log` など）と Nightly artefact（`profile-avatar-sync-logs`, `topic-create`, `post-delete-cache`, `user-search-pagination`, `trending-feed/prometheus`）で更新し、残タスクを DM 既読共有 + `/search` レートリミット UI へ再フォーカス。
- [x] `phase5_user_flow_summary.md` / `phase5_user_flow_inventory.md` / `phase5_ci_path_audit.md` / `phase5_dependency_inventory_template.md` / `refactoring_plan_2025-08-08_v3.md` を Stage4 完了条件・Runbook 連携・テスト ID と同期。`phase5_user_flow_inventory.md` の Stage4 未着手表現を排除し、`nightly.profile-avatar-sync` / `nightly.topic-create` / `nightly.post-delete-cache` / `nightly.user-search-pagination` の artefact パスを明記。
- [x] `tasks/status/in_progress.md` の「MVP残タスク棚卸し / ドキュメント刷新」エントリをクローズし、`tasks/completed/2025-11-13.md` での完了記録に誘導。

## UI導線棚卸し / サマリードキュメント整備

- [x] UI から辿れる主要導線を 2025年11月01日〜05日に再点検し、Welcome/Home/Sidebar/Search/Topics/Settings/DirectMessage などの各画面フローと到達可否、欠落導線、改善メモを `docs/01_project/activeContext/artefacts/phase5_user_flow_inventory.md` に体系化。段階ごとの課題（プライバシー設定・プロフィール編集・DM 履歴・トレンド/フォロー導線など）を Sec.1〜5 に追加し、Nightly ログやテスト結果（`tmp/logs/vitest_trending_topics_20251110020449.log` など）を紐付けた。
- [x] 意思決定者向けのサマリーとして `docs/01_project/activeContext/artefacts/phase5_user_flow_summary.md` を新規作成し、導線状態（稼働中/改善中/未実装）の区分、MVP Exit チェックリスト、共通検証手順、各画面の表形式サマリーを整理。`phase5_ci_path_audit.md`・`tauri_app_implementation_plan.md`・`refactoring_plan_2025-08-08_v3.md` へ同ドキュメントへの参照と最新導線ステータスを連携。
- [x] `tasks/status/in_progress.md` の「ユーザー導線ドキュメント整備」行で進捗ログ（日時、更新内容、テスト/ログファイルパス）を集約し、完了判定後は本 completed エントリへ移管。今後は `phase5_user_flow_summary.md` / `phase5_user_flow_inventory.md` を最新版ソースオブトゥルースとして参照する運用に切り替えた。

### 参照ドキュメント

- `docs/01_project/activeContext/artefacts/phase5_user_flow_summary.md`
- `docs/01_project/activeContext/artefacts/phase5_user_flow_inventory.md`
- `docs/01_project/activeContext/artefacts/phase5_ci_path_audit.md`
- `docs/01_project/activeContext/tauri_app_implementation_plan.md`
- `docs/01_project/refactoring_plan_2025-08-08_v3.md`

## GitHub Actions ワークフロー失敗調査ログ

- [x] 2025年11月13日: `gh run view 19333274556` / `19322123073` で検出した `Format Check`・`Native Test (Linux)` の失敗を再現し、`DirectMessageDialog.test.tsx` / `profile.$userId.test.tsx` の Prettier 差分、`trendingFixture.ts` の未使用変数、`tests/contract/direct_messages.rs` / `tests/contract.rs` の `cargo fmt` 差分、`DirectMessageInbox.test.tsx` のフォーマットを修正。`corepack pnpm format:check|lint|test`、`pnpm type-check`、`cargo test --workspace --all-features`（Docker 代替含む）、`gh act -W .github/workflows/test.yml -j format-check|native-test-linux|docker-test` を実行し、`kukuri-tauri/tmp/logs/format_check_20251113-230505.log`, `pnpm_lint_20251113-230521.log`, `pnpm_test_20251113-230530.log`, `kukuri-tauri/tmp/logs/test_docker_rust_20251113-232319.log`, `kukuri-cli/tmp/logs/cargo_test_kukuri_cli_20251113-232450.log`, `kukuri-tauri/tmp/logs/gh_act_format_check_20251113-231020.log`, `kukuri-tauri/tmp/logs/gh_act_native_test_20251113-232538.log`, `tmp/logs/gh_act_format_20251113_fix.log`, `tmp/logs/gh_act_native_20251113_fix.log`, `tmp/logs/gh_act_docker_20251113_fix.log`, `tmp/logs/gh_act_format_20251113-162500.log` に証跡を保存。
- [x] 2025年11月12日: `gh run view 19286497950` / `19269742316` の `Format Check` と `Native Test (Linux)` / `Docker Test Suite` 失敗を切り分け、`DirectMessageInbox.tsx` ほかの Prettier 差分修正、`cache_status.rs` / `sqlite_store.rs` の `clippy::too_many_arguments` を構造体リテラル化で解消。`pnpm format:check`、`cargo clippy --workspace --all-features`、`cargo test --workspace --all-features`（両リポジトリ）を実施し、`tmp/logs/gh_act_format_20251112-141807.log`, `tmp/logs/gh_act_native.log`, `tmp/logs/gh_act_docker.log` に結果を記録。
- [x] 2025年11月11日: `gh run view 19251065845` で `RelayStatus.tsx` の Prettier 差分と `kukuri-cli/src/main.rs` の `clippy::needless_borrow` を検出し、`pnpm prettier --write`, `pnpm format:check|lint|type-check|test`, `cargo test|clippy`, `./scripts/test-docker.ps1 rust -NoBuild`, `gh act -W .github/workflows/test.yml -j format-check|native-test-linux` を実行して `tmp/logs/gh_act_format_20251110_fix8.log` などへ保存。
- [x] 2025年11月10日: `SyncStatusIndicator` / `useSyncManager` / `offlineSyncWorker` の Prettier 差分と `UpdateSyncStatusRequest` の未定義フィールド、`offline::cache_metadata` の TTL 待機を修正し、`pnpm vitest run src/tests/unit/components/SyncStatusIndicator.test.tsx`, `cargo test --workspace --all-features`、`docker compose -f docker-compose.test.yml run --rm test-runner /app/run-tests.sh` を取得。`tmp/logs/gh_act_format_20251110_fix8.log` や `tmp/logs/gh_act_native_20251110_fix7.log` などへ緑化ログを保存。

## Clippy 警告ゼロ体制の復帰

- [x] `domain/entities/event/validation/nip19.rs` と `infrastructure/p2p/dht_integration.rs` の `format!` 呼び出しを埋め込み式へ置換し、`AppError::DeserializationError` 付近のログ表現を統一。
- [x] `cargo clippy --all-features -- -D warnings` を `kukuri-tauri/src-tauri`・`kukuri-cli` 両方で実行して警告ゼロを再確認し、`phase5_ci_path_audit.md` に証跡を追記。
- [x] `refactoring_plan_2025-08-08_v3.md` の成功指標欄へ対策内容と再発防止タスクを記録。

## delete_post 導線と Tauri API 棚卸し

- [x] `phase5_user_flow_inventory.md` Sec.5.6 と `phase5_user_flow_summary.md` の優先度表を更新し、`delete_post` コマンド利用時の UX・楽観更新・オフライン再送方針を整理。`pnpm vitest run src/tests/unit/components/posts/PostCard.test.tsx src/tests/unit/stores/postStore.test.ts` を再取得し、`phase5_ci_path_audit.md` と `tauri_app_implementation_plan.md` にログを反映。
- [x] フロントエンドの `invoke` 呼び出しをスクリプトで棚卸しし、`TauriApi` / `SecureStorageApi` / `p2pApi` / `nostr` ユーティリティの利用箇所・未使用コマンド (`add_relay`, `subscribe_to_user`, `join_topic_by_name` 等)・統合テスト専用コマンドを `phase5_user_flow_inventory.md` Sec.3.1〜3.3 に集約。`offlineApi` と `syncEngine` の `invoke`、`invokeCommand` のラッパー整理内容も反映。

## refactoring_plan / Phase5 ドキュメント同期

- [x] `refactoring_plan_2025-08-08_v3.md` のユーザー導線指標チェックボックスを 2025年11月01日〜09日の更新内容（プロフィール導線、フォロー体験、DM/SyncStatus ギャップ、Nightly テスト計画）に合わせて順次更新し、`phase5_user_flow_summary.md` / `phase5_user_flow_inventory.md` / `phase5_ci_path_audit.md` との整合を確保。
- [x] `phase5_ci_path_audit.md` と `docs/01_project/activeContext/tauri_app_implementation_plan.md` を毎日同期し、Relay/P2P ステータスカード、ProfileAvatarSync、DM 未読バッジ、Summary Panel、SyncStatusIndicator/useSyncManager、`test:unit` 行の追加テストなどを追記。関連ログ（`tmp/logs/vitest_direct_message_20251112-124608.log`, `tmp/logs/user_search_pagination_20251112-125208.log`, `tmp/logs/topic_create_20251112-125226.log`, `tmp/logs/post_delete_cache_20251112-125301.log` など）をリンク。
- [x] `docs/03_implementation/trending_metrics_job.md`, `docs/03_implementation/docker_test_environment.md`, `docs/03_implementation/p2p_mainline_runbook.md`, `docs/01_project/roadmap.md`, `docs/01_project/design_doc.md`, `phase5_dependency_inventory_template.md`, `phase5_event_gateway_design.md` を更新し、Nightly artefact（`trending-metrics-logs`, `user-search-pagination-logs`, `post-delete-cache`, `topic-create`, `profile-avatar-sync-logs` 等）と `tmp/logs/*` の紐付け、`scripts/test-docker.{sh,ps1}` の `--scenario` 追加、`Build-TestImage` / `Test-DockerImageExists` の拡張を記録。
- [x] `phase5_user_flow_summary.md` グローバル要素・Quick View・1.6「ダイレクトメッセージ」節を 2025年11月08日版へ更新し、ヘッダー/Sidebar/Trending/Follower Summary Panel の DM 連携、未読バッジ、CTA、Nightly テスト ID を明文化。
- [x] `useOfflineStore.refreshCacheMetadata`, `useSyncManager.persistSyncStatuses`, `useSyncManager.enqueueSyncRequest` 実装に合わせて Inventory 3.2/3.3/5.11 と Summary Quick View を改訂し、`pnpm vitest run src/tests/unit/stores/offlineStore.test.ts src/tests/unit/hooks/useSyncManager.test.tsx src/tests/unit/components/SyncStatusIndicator.test.tsx`、`./scripts/test-docker.ps1 rust`、`cargo test` の結果を `phase5_ci_path_audit.md` に反映。

## EventGateway・トレンド監視・MVP Exit

- [x] `phase5_event_gateway_design.md` に従って EventGateway mapper と P2PService Stack を抽象化し、`kukuri-cli bootstrap --export-path` で生成した CLI ブートストラップリストを RelayStatus から適用できる PoC を構築。`p2pApi.getBootstrapConfig`・`apply_cli_bootstrap_nodes`・`refreshRelaySnapshot` を統合し、`application/services/p2p_service/tests.rs` のユニットテストや `tmp/logs/relay_status_cli_bootstrap_20251112-094500.log` を Runbook/Inventory/Dependency テンプレへ連携。
- [x] `scripts/test-docker.{sh,ps1} ts --scenario trending-feed` に `prometheus-trending` サービス起動と `curl http://127.0.0.1:9898/metrics` 採取を追加し、`tmp/logs/trending_metrics_job_stage4_20251111-191137.log` と Nightly artefact `trending-metrics-logs` を整備。`phase5_user_flow_summary.md`, `phase5_user_flow_inventory.md`, `phase5_ci_path_audit.md`, `docs/03_implementation/trending_metrics_job.md`, `docs/01_project/roadmap.md` へ 24h 集計と監視手順を反映。
- [x] `nightly.yml` に `user-search-pagination`, `topic-create`, `post-delete-cache`, `profile-avatar-sync`, `trending-feed`, `sync-status-indicator` 等のジョブを追加し、`scripts/test-docker.{sh,ps1}` とのパラメータ整合を確認。これにより MVP Exit ブロッカー（DM 既読共有、検索レートリミット、Offline Topic/Post 操作、トレンドメトリクス）が `phase5_user_flow_summary.md` 11-16 行どおり解消された。

## プロフィールアバター UI 連携

- [x] `ProfileForm`, `ProfileSetup`, `ProfileEditDialog` から `upload_profile_avatar` / `fetch_profile_avatar` を呼び出す導線を実装し、Tauri プラグインモックと Vitest エイリアスを追加してアップロード/フェッチ/エラー処理テストを整備。`pnpm vitest run` と `cargo test`（Docker 代替含む）で検証。
- [x] `resolveUserAvatarSrc` ユーティリティを導入し、ReplyForm/QuoteForm/PostCard/AccountSwitcher/UserSearchResults が共通のフォールバックを利用するよう更新。`authStore` 初期化時に `fetch_profile_avatar` を呼び出して `currentUser.avatar` を同期し、AccountSwitcher と composer 群へ即時反映する仕組みを追加。
