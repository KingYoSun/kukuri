# 2025年11月13日 完了タスク

最終更新日: 2025年11月13日

## GitHub Actions ワークフロー修復

- [x] `useProfileAvatarSync` / `composerStore` / `topicStore` の型ずれを解消し、`PendingTopicStatus::from_value` へ改名。`ProfileSetup`・`ProfileEditDialog`・`useTopics` のユニットテストを新仕様に合わせて更新し、`pnpm format:check` → `pnpm lint` → `pnpm type-check` → `pnpm test` を通過させて TypeScript パイプラインを復旧。
- [x] `docs/01_project/activeContext/tasks/status/in_progress.md` に 2025年11月13日の対応内容（gh act ログ・PowerShell Docker テストログ）を追記し、タスクの進捗を共有。

### 実行コマンド

- `pnpm format:check`
- `pnpm lint`
- `pnpm type-check`
- `pnpm test`
- `gh act push -j format-check -W .github/workflows/test.yml --container-options '--user 0:0'`
- `gh act push -j native-test-linux -W .github/workflows/test.yml --container-options '--user 0:0'`

## Rust / Docker テスト検証

- [x] Windows ネイティブの `cargo test` が DLL 依存で失敗するため、`./scripts/test-docker.ps1 rust` を実行して kukuri-tauri/src-tauri と kukuri-cli の `cargo test` / `cargo clippy` / マルチノード P2P テストを Docker 上で完走。ログは `tmp/rust-docker.log` に保存。
- [x] `cargo test --workspace --all-features`・`cargo clippy --workspace --all-features -- -D warnings` を `kukuri-tauri/src-tauri` と `kukuri-cli` の両方で実行し、ローカルの警告ゼロを確認。`gh act push -j docker-test ...` は Windows の単一ファイルマウント制約で失敗するため、代替として上記 PowerShell スクリプト結果を共有。

### 実行コマンド

- `cd kukuri-tauri/src-tauri && cargo test --workspace --all-features`
- `cd kukuri-tauri/src-tauri && cargo clippy --workspace --all-features -- -D warnings`
- `cd kukuri-cli && cargo test --workspace --all-features`
- `cd kukuri-cli && cargo clippy --workspace --all-features -- -D warnings`
- `./scripts/test-docker.ps1 rust`
- `gh act push -j docker-test -W .github/workflows/test.yml --container-options '--user 0:0'`

## Stage4: 投稿削除フロー／post-delete-cache シナリオ

- [x] `src-tauri/tests/integration/post_delete_flow.rs` を追加し、`delete_post` → `sync_queue` → `list_following_feed` / `get_posts_by_topic` の整合性と `EventService::delete_events` 呼び出しを Rust 側で検証。`useDeletePost.manualRetryDelete` と `SyncStatusIndicator` の削除再送 UI を仕上げ、`PostCard.deleteOffline.test.tsx` / `useDeletePost.test.tsx` を拡張。
- [x] ローカルで `pnpm vitest run …` を実行して `tmp/logs/post_delete_cache_20251113-085756.log` を採取し、Docker では `SCENARIO=post-delete-cache docker compose -f docker-compose.test.yml run --rm test-runner` を実行して `tmp/logs/post-delete-cache_docker_20251113-002140.log` と `test-results/post-delete-cache/20251113-002140.json` を生成。Runbook Chapter5 / `phase5_ci_path_audit.md` / `phase5_user_flow_inventory.md` / `phase5_user_flow_summary.md` を同日付で更新。

### 実行コマンド

- `cd kukuri-tauri && pnpm vitest run src/tests/unit/hooks/useDeletePost.test.tsx src/tests/unit/components/posts/PostCard.test.tsx src/tests/unit/components/posts/PostCard.deleteOffline.test.tsx | Tee-Object -FilePath ..\tmp\logs\post_delete_cache_20251113-085756.log`

## EventGateway / P2PService 再構成

- [x] `application/services/p2p_service/bootstrap.rs` で `P2PStack.p2p_service` を `Arc<dyn P2PServiceTrait>` に変更し、`state.rs` の AppState と `TopicService` / `presentation::handlers::p2p_handler.rs` がダウンキャスト無しで trait を受け取るよう再配線した。EventGateway も `LegacyEventManagerGateway` を介した `Arc<dyn EventGateway>` 注入に統一。
- [x] `phase5_dependency_inventory_template.md`（MVP モジュール表）、`docs/01_project/roadmap.md`（P2P & Discovery 行）、`docs/03_implementation/p2p_mainline_runbook.md` 3.2 に完了内容と検証ログ (`tmp/logs/cargo-test-kukuri-tauri_di_20251113.log`, `tmp/logs/test-docker-rust_di_20251113.log`, `tmp/logs/cargo-test-kukuri-cli_di_20251113.log`) を追記し、`tasks/status/in_progress.md` の当該タスクをクローズした。
- [x] Windows ネイティブの `cargo test --workspace --all-features` は `kukuri_lib` 実行時に `STATUS_ENTRYPOINT_NOT_FOUND` で失敗したため、`./scripts/test-docker.ps1 rust` で kukuri-tauri/src-tauri + kukuri-cli の Rust テスト＆Clippy を Docker 経由で再実行。CLI 単体の `cargo test --workspace --all-features` はローカルで成功しており、すべてのログを `tmp/logs/` 配下に保存した。

### 実行コマンド

- `cd kukuri-tauri/src-tauri && cargo test --workspace --all-features 2>&1 | Tee-Object -FilePath ..\..\tmp\logs\cargo-test-kukuri-tauri_di_20251113.log`
- `./scripts/test-docker.ps1 rust 2>&1 | Tee-Object -FilePath tmp\logs\test-docker-rust_di_20251113.log`
- `cd kukuri-cli && cargo test --workspace --all-features 2>&1 | Tee-Object -FilePath ..\tmp\logs\cargo-test-kukuri-cli_di_20251113.log`
- `docker compose -f docker-compose.test.yml build test-runner`
- `SCENARIO=post-delete-cache docker compose -f docker-compose.test.yml run --rm test-runner`

## DirectMessageInbox backlog 解消

- [x] DirectMessageInbox に会話検索/候補補完・Enter ショートカット・TanStack Virtualizer の測定付き仮想スクロール・多端末既読バッジを実装し、`useDirectMessageStore.markConversationAsRead(conversationNpub, lastReadAt?)` と `useDirectMessageBootstrap` が SQLite の `lastReadAt` を同期できるようにした。`phase5_user_flow_summary.md` 2章と `phase5_user_flow_inventory.md` 5.6.1 を稼働状態へ更新。
- [x] `tests/contract/direct_messages.rs` を追加し、会話サマリの既読タイムスタンプと未読集計を Docker (`./scripts/test-docker.ps1 rust`) で毎回検証できるようにした。Vitest（`tmp/logs/direct_message_inbox_20251113-140827.log`）と Docker Rust（`tmp/logs/rust_docker_20251113-141846.log`）の結果を記録。

### 実行コマンド

- `cd kukuri-tauri && corepack pnpm vitest run src/tests/unit/components/directMessages/DirectMessageInbox.test.tsx src/tests/unit/components/directMessages/DirectMessageDialog.test.tsx | Tee-Object -FilePath ..\tmp\logs\direct_message_inbox_20251113-140827.log`
- `cd kukuri-tauri/src-tauri && cargo test` （Windows では `STATUS_ENTRYPOINT_NOT_FOUND` のため失敗。`./scripts/test-docker.ps1 rust` に切り替えてログ取得）
- `./scripts/test-docker.ps1 rust *> tmp/logs/rust_docker_20251113-141846.log`
- `cd kukuri-cli && cargo test`
