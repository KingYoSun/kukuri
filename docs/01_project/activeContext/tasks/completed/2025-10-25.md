# 2025年10月25日 完了タスク

## Phase 5 Workstream A - WSA-02 Offline Persistence Stage 1/2
- `domain/entities/offline/commands.rs` を追加し、`OfflineActionDraft` / `OfflineActionFilter` / `SyncQueueItemDraft` / `OptimisticUpdateDraft` / `SyncStatusUpdate` をドメイン値オブジェクトとして定義。ポート・サービス層から Legacy 型依存を除去した。
- `application::ports::offline_store` をドメイン型シグネチャへ刷新し、`LegacyOfflineManagerAdapter` と `SqliteOfflinePersistence` を `infrastructure/offline/mappers.rs` 経由で移行。`OfflineService` は新しいドラフト／フィルタ型を用いて呼び出せるよう再構成した。
- `presentation/handlers/offline_handler.rs` を更新し、UI DTO との相互変換ヘルパを実装。PowerShell 経由のネイティブ `cargo test` が `STATUS_ENTRYPOINT_NOT_FOUND` で失敗する既知事象のため、`./scripts/test-docker.ps1 rust` を実行して回帰確認した。

## Phase 5 OfflineService Adapter Stage 1 - OFF-S1-03
- `OfflineServiceTrait` をドメイン値オブジェクトで扱う API に改修し、テストを `SaveOfflineActionParams` / `OfflineActionsQuery` ベースへ変更。楽観的更新・同期キュー・キャッシュ更新など全フローの戻り値をドメイン型で検証するようにした。
- Docker Rust テスト (`./scripts/test-docker.ps1 rust`) を実施し、Phase 5 Workstream A でのサービス再配線が既存統合テストをパスすることを確認。Windows ネイティブ `cargo test` は引き続き Docker 実行で代替可能であることをレポート。

## Phase 5 OfflineService Adapter Stage 3 - Legacy 解体
- `modules/offline`（manager/models/reindex/tests）および `infrastructure/offline/legacy_adapter.rs` を撤去し、`infrastructure/offline/{rows,mappers,sqlite_store,reindex_job}.rs` へロジックを集約。`SqliteOfflinePersistence` に同期キュー・キャッシュ・楽観的更新・同期状態 API を実装し、`OfflineReindexJob` を新 Persistence 経由で再構築した。
- `state.rs` の DI を `Arc<SqliteOfflinePersistence>` 共有に刷新し、OfflineService と OfflineReindexJob の双方がポート経由で動作する構成を確認。Rust ユニットテストを `sqlite_store.rs` / `reindex_job.rs` 内へ移設し、`cargo fmt` 実行後に `cargo test` を試行（`cc` リンクエラーで失敗するため結果を記録）。
