# 2025蟷ｴ10譛・5譌･ 螳御ｺ・ち繧ｹ繧ｯ

## Phase 5 Workstream A - WSA-02 Offline Persistence Stage 1/2
- `domain/entities/offline/commands.rs` 繧定ｿｽ蜉縺励～OfflineActionDraft` / `OfflineActionFilter` / `SyncQueueItemDraft` / `OptimisticUpdateDraft` / `SyncStatusUpdate` 繧偵ラ繝｡繧､繝ｳ蛟､繧ｪ繝悶ず繧ｧ繧ｯ繝医→縺励※螳夂ｾｩ縲ゅ・繝ｼ繝医・繧ｵ繝ｼ繝薙せ螻､縺九ｉ Legacy 蝙倶ｾ晏ｭ倥ｒ髯､蜴ｻ縺励◆縲・- `application::ports::offline_store` 繧偵ラ繝｡繧､繝ｳ蝙九す繧ｰ繝阪メ繝｣縺ｸ蛻ｷ譁ｰ縺励～LegacyOfflineManagerAdapter` 縺ｨ `SqliteOfflinePersistence` 繧・`infrastructure/offline/mappers.rs` 邨檎罰縺ｧ遘ｻ陦後ＡOfflineService` 縺ｯ譁ｰ縺励＞繝峨Λ繝輔ヨ・上ヵ繧｣繝ｫ繧ｿ蝙九ｒ逕ｨ縺・※蜻ｼ縺ｳ蜃ｺ縺帙ｋ繧医≧蜀肴ｧ区・縺励◆縲・- `presentation/handlers/offline_handler.rs` 繧呈峩譁ｰ縺励ゞI DTO 縺ｨ縺ｮ逶ｸ莠貞､画鋤繝倥Ν繝代ｒ螳溯｣・１owerShell 邨檎罰縺ｮ繝阪う繝・ぅ繝・`cargo test` 縺・`STATUS_ENTRYPOINT_NOT_FOUND` 縺ｧ螟ｱ謨励☆繧区里遏･莠玖ｱ｡縺ｮ縺溘ａ縲～./scripts/test-docker.ps1 rust` 繧貞ｮ溯｡後＠縺ｦ蝗槫ｸｰ遒ｺ隱阪＠縺溘・
## Phase 5 OfflineService Adapter Stage 1 - OFF-S1-03
- `OfflineServiceTrait` 繧偵ラ繝｡繧､繝ｳ蛟､繧ｪ繝悶ず繧ｧ繧ｯ繝医〒謇ｱ縺・API 縺ｫ謾ｹ菫ｮ縺励√ユ繧ｹ繝医ｒ `SaveOfflineActionParams` / `OfflineActionsQuery` 繝吶・繧ｹ縺ｸ螟画峩縲よ･ｽ隕ｳ逧・峩譁ｰ繝ｻ蜷梧悄繧ｭ繝･繝ｼ繝ｻ繧ｭ繝｣繝・す繝･譖ｴ譁ｰ縺ｪ縺ｩ蜈ｨ繝輔Ο繝ｼ縺ｮ謌ｻ繧雁､繧偵ラ繝｡繧､繝ｳ蝙九〒讀懆ｨｼ縺吶ｋ繧医≧縺ｫ縺励◆縲・- Docker Rust 繝・せ繝・(`./scripts/test-docker.ps1 rust`) 繧貞ｮ滓命縺励￣hase 5 Workstream A 縺ｧ縺ｮ繧ｵ繝ｼ繝薙せ蜀埼・邱壹′譌｢蟄倡ｵｱ蜷医ユ繧ｹ繝医ｒ繝代せ縺吶ｋ縺薙→繧堤｢ｺ隱阪８indows 繝阪う繝・ぅ繝・`cargo test` 縺ｯ蠑輔″邯壹″ Docker 螳溯｡後〒莉｣譖ｿ蜿ｯ閭ｽ縺ｧ縺ゅｋ縺薙→繧偵Ξ繝昴・繝医・
## Phase 5 OfflineService Adapter Stage 3 - Legacy 隗｣菴・- `modules/offline`・・anager/models/reindex/tests・峨♀繧医・ `infrastructure/offline/legacy_adapter.rs` 繧呈彫蜴ｻ縺励～infrastructure/offline/{rows,mappers,sqlite_store,reindex_job}.rs` 縺ｸ繝ｭ繧ｸ繝・け繧帝寔邏・ＡSqliteOfflinePersistence` 縺ｫ蜷梧悄繧ｭ繝･繝ｼ繝ｻ繧ｭ繝｣繝・す繝･繝ｻ讌ｽ隕ｳ逧・峩譁ｰ繝ｻ蜷梧悄迥ｶ諷・API 繧貞ｮ溯｣・＠縲～OfflineReindexJob` 繧呈眠 Persistence 邨檎罰縺ｧ蜀肴ｧ狗ｯ峨＠縺溘・- `state.rs` 縺ｮ DI 繧・`Arc<SqliteOfflinePersistence>` 蜈ｱ譛峨↓蛻ｷ譁ｰ縺励＾fflineService 縺ｨ OfflineReindexJob 縺ｮ蜿梧婿縺後・繝ｼ繝育ｵ檎罰縺ｧ蜍穂ｽ懊☆繧区ｧ区・繧堤｢ｺ隱阪３ust 繝ｦ繝九ャ繝医ユ繧ｹ繝医ｒ `sqlite_store.rs` / `reindex_job.rs` 蜀・∈遘ｻ險ｭ縺励～cargo fmt` 螳溯｡悟ｾ後↓ `cargo test` 繧定ｩｦ陦鯉ｼ・cc` 繝ｪ繝ｳ繧ｯ繧ｨ繝ｩ繝ｼ縺ｧ螟ｱ謨励☆繧九◆繧∫ｵ先棡繧定ｨ倬鹸・峨・
## Phase 5 OfflineService Adapter Stage 2 - OFF-S2-03
- OfflineService の統合テストを pplication/services/offline_service.rs から 	ests/integration/offline/mod.rs へ移設。SQLite スキーマ初期化ヘルパーと SqliteOfflinePersistence の DI を維持しつつ、Cargo から cargo test --test offline_integration が参照できるように整理。Runbook/タスクを更新し Phase 5 Stage2-3 の完了判定を記録。

## Phase 5 EventGateway Sprint 2 - EG-S2-04
- 2025年10月25日: `tests/integration/test_event_gateway.rs` を追加し、Gateway → Legacy EventManager → SQLite 永続化フローを実データベース付きで検証。P2P（Mainline DHT）経路で取得した DomainEvent が `events` / `event_topics` テーブルへ保存されることを確認し、`phase5_event_gateway_design.md` / `tasks/status/in_progress.md` の Sprint 2 要件（結合テスト整備）をクローズした。

## Phase 5 EventGateway Stage 3 - EG-S3-01
- 2025年10月25日: `infrastructure::event::manager_handle::EventManagerHandle` を導入し、`AppState` / `EventManagerSubscriptionInvoker` / `LegacyEventManagerGateway` から `modules::event` への直接依存を解消。`LegacyEventManagerHandle` を介して DI を統一した。
- 2025年10月25日: `tests/integration/test_event_service_gateway.rs` を新設し、Publish/TopicPost/Reaction/Metadata/Delete の送信パスが Gateway 実装経由で `EventManagerHandle` へ正しく委譲されることを検証。`RecordingEventManager` スタブで呼び出し内容を捕捉し、結合テストのギャップを解消。
- 2025年10月25日: `tests/integration/test_p2p_mainline.rs` にカスタム `DiscoveryOptions` override シナリオを追加し、Mainline DHT フローの構成検証を自動化。Runbook (`docs/03_implementation/p2p_mainline_runbook.md`) を同日更新し、新テストの位置付けと実行手順を追記。

## Phase 5 SubscriptionStateMachine Repository 化 - SSR
- 2025年10月25日: `domain/value_objects/subscription.rs` を新設し、購読対象・状態・レコードをドメイン値オブジェクトとして定義。バックオフ計算 (`since_timestamp`) と遷移メソッド（`mark_requested` / `mark_subscribed` / `mark_failure`）を同モジュールへ集約した。
- 2025年10月25日: `application/ports/subscription_state_repository.rs` を追加し、`SubscriptionStateRepository` ポートを定義。`infrastructure/database/subscription_state_repository.rs` で `SqliteSubscriptionStateRepository` を実装し、既存 SQL を Repository 経由の永続化処理へ移行。
- 2025年10月25日: `SubscriptionStateMachine` を Repository 注入式へ書き換え、`state.rs` で `SqliteSubscriptionStateRepository` を DI。`tests/common/mocks` / `tests/unit` / `tests/integration` の SubscriptionStore モック/インポートを更新し、再購読フローのユニットテストを Repository ベースで継続できるよう調整。
- 2025年10月25日: `phase5_dependency_inventory_template.md` と `tauri_app_implementation_plan.md` に SSR 完了状況を追記し、`tasks/status/in_progress.md` から当該タスクを除去。


## Phase 5 Legacy KeyManager 移行
- 2025年10月25日: `application::ports::key_manager` を新設し、`KeyPair` 定義と `current_keypair` API を追加。`DefaultKeyManager` をポート実装として再配備し、ユニットテストを拡充した。
- 2025年10月25日: `AppState` と Tauri コマンド（post/topic）を `Arc<dyn KeyManager>` の DI に切り替え、SecureStorage/Handler/サービス経由で同一インスタンスを共有できるようにした。
- 2025年10月25日: Legacy `modules::auth::key_manager` を削除し、`modules::event::manager` / Gateway テストを新ポート経由に更新して Phase 5 Stage3 の完了条件を満たした。

## Phase 5 Legacy SecureStorage デバッグユーティリティ整理
- 2025年10月25日: `infrastructure::storage::secure_storage::DefaultSecureStorage::clear_all_accounts_for_test` を追加し、Tauri `clear_all_accounts_for_test` コマンドが Legacy `modules::secure_storage` に依存しないよう再配線。`SecureStorage`/`SecureAccountStore` の公開 API を維持しつつ debug 専用ユーティリティを Infrastructure 層へ集約した。
- 2025年10月25日: `modules/secure_storage` ディレクトリ（`mod.rs` / `tests.rs`）と `modules/mod.rs` の再エクスポートを削除し、`docs/01_project/deprecated/refactoring_plan_2025-08-08_v3.md` / `phase5_dependency_inventory_template.md` に完了状況を追記。Legacy 行は Archived 扱いへ更新した。
- テスト: `cargo fmt`、`cargo test`（Windows では `STATUS_ENTRYPOINT_NOT_FOUND` で停止。ただし結果を記録済み）、`./scripts/test-docker.ps1 rust`、`pnpm test`、`(cd kukuri-cli && cargo test)` を実行し、Docker 経由で Rust テストが通過することを確認。
