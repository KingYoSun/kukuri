# 2026年02月14日 完了タスク

最終更新日: 2026年02月14日

## Community Nodes / `cn-relay` REQ `since/until` 時間範囲制約の実装

- [x] `cn-relay` `filters.rs` に REQ 時間範囲制約（`since > until` / 過大lookback / 過大window）を実装
- [x] 拒否理由を固定（`invalid since/until range` / `lookback too large` / `time window too large`）
- [x] `filters.rs` に unit test を追加し、拒否理由互換を固定
- [x] `integration_tests.rs` に WebSocket REQ の統合テストを追加し、`NOTICE` 理由の互換を固定
- [x] `community_nodes_roadmap.md` の該当未実装項目を `[x]` に更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-14_cn_relay_req_time_range_constraints.md` を作成

## 検証

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v ${PWD}:/workspace -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli"`（成功）
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job format-check`
  - 初回失敗（`rustfmt` 差分）: `tmp/logs/gh-act-format-check-cn-relay-time-range-20260214.log`
  - 再実行成功: `tmp/logs/gh-act-format-check-cn-relay-time-range-20260214-final.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job native-test-linux`
  - 成功ログ: `tmp/logs/gh-act-native-test-linux-cn-relay-time-range-20260214-final.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job community-node-tests`
  - 成功ログ: `tmp/logs/gh-act-community-node-tests-cn-relay-time-range-20260214-final.log`

補足: `gh act` 実行時に PowerShell 側で `NativeCommandError` が出力されるが、各ログ末尾の `Job succeeded` で成功を確認済み。

## Community Nodes / `cn-moderation` outbox consumer セマンティクス統合テスト追加

- [x] `cn-moderation` に統合テスト `outbox_consumer_semantics_cover_catch_up_notify_commit_and_replay_idempotency` を追加し、`outbox_notify_semantics.md` の consumer 要件（起動時 catch-up / NOTIFY 起床 / offset commit / replay）を一連で固定
- [x] `load_last_seq` / `commit_last_seq` / `fetch_outbox_batch` / `enqueue_job` の実経路を通し、offset の前進・巻き戻し（replay）・再コミットが回帰しないことを検証
- [x] replay（at-least-once 再処理）時に `cn_moderation.jobs(event_id, topic_id)` の一意制約で重複ジョブが増えないことを確認し、冪等性をテストで固定
- [x] `community_nodes_roadmap.md` の該当未実装項目を `[x]` に更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-14_cn_moderation_outbox_consumer_semantics_integration_test.md` を作成

## 検証（`cn-moderation` outbox consumer）

- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v ${PWD}:/workspace -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "source /usr/local/cargo/env && cargo test -p cn-moderation outbox_consumer_semantics_cover_catch_up_notify_commit_and_replay_idempotency -- --nocapture --test-threads=1"`（成功）
- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -e MEILI_MASTER_KEY=change-me -v ${PWD}:/workspace -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "source /usr/local/cargo/env && cargo test --workspace --all-features && cargo build --release -p cn-cli"`（成功）
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - ログ: `tmp/logs/gh-act-format-check-cn-moderation-outbox-20260214-final2.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - ログ: `tmp/logs/gh-act-native-test-linux-cn-moderation-outbox-20260214-final.log`
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - ログ: `tmp/logs/gh-act-community-node-tests-cn-moderation-outbox-20260214-final.log`

補足: `gh act` 実行時に PowerShell 側で `NativeCommandError` が表示されるが、各ログ末尾の `Job succeeded` をもって成功判定とした。

## Community Nodes / `cn-bootstrap` hint受信→HTTP再取得フローの実装完了

- [x] `cn-user-api` に `cn_bootstrap_hint` 受信ループ（`PgListener`）を追加し、最新 hint を保持する `BootstrapHintStore` を実装
- [x] `GET /v1/bootstrap/hints/latest?since=` を追加し、hint 未更新時 `204` / 更新時 `200`（`seq` + `hint` payload）を返す契約を実装
- [x] `kukuri-tauri` `CommunityNodeHandler` に hint 取得ロジックを追加し、hint 受信時に `/v1/bootstrap/nodes` と `/v1/bootstrap/topics/{topic_id}/services` キャッシュを stale 化して即時再取得する経路を実装
- [x] `community_node_handler` unit test を追加し、hint 受信後の `list_bootstrap_services` 再取得（event id 更新）を固定
- [x] `cn-user-api` 契約テストを追加し、`/v1/bootstrap/hints/latest` の `200/204` 互換を固定
- [x] `tests/e2e/specs/community-node.bootstrap.spec.ts` を拡張し、hint 受信後に `/v1/bootstrap/topics/{topic_id}/services` キャッシュが更新される E2E を追加
- [x] `community_nodes_roadmap.md` の該当未実装項目を `[x]` に更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-14_cn_bootstrap_hint_receive_refetch_e2e.md` を作成

## 検証（bootstrap hint受信→再取得）

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `./scripts/test-docker.ps1 e2e-community-node`（成功、`Spec Files: 17 passed, 17 total`）
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job format-check`
  - 初回失敗（`rustfmt` 差分）後に修正し再実行成功
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
- [x] `$env:NPM_CONFIG_PREFIX='/tmp/npm-global'; gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
