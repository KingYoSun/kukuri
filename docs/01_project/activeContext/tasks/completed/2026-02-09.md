# 2026年02月09日 作業完了タスク

最終更新日: 2026年02月09日

## Community Nodes / `cn-user-api`・`cn-admin-api` `/healthz` `/metrics` 契約テスト追加

- [x] `cn-admin-api` に `/healthz` 契約テスト（ready / dependency unavailable）を追加し、status code と `status` フィールドを固定
- [x] `cn-admin-api` に `/metrics` 契約テストを追加し、Prometheus content-type（`text/plain; version=0.0.4`）を固定
- [x] `cn-user-api` に `/healthz` 契約テスト（Meilisearch mock: ready / unavailable）を追加し、status code と `status` フィールドを固定
- [x] `cn-user-api` に `/metrics` 契約テストを追加し、Prometheus content-type（`text/plain; version=0.0.4`）を固定
- [x] `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-09_cn_user_admin_health_metrics_contract_tests.md` として作成

## 検証

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml down -v`（成功、検証前に DB/Meilisearch ボリュームを初期化）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-user-api -p cn-admin-api --tests -- --nocapture"`（成功: `cn-admin-api` 21 tests passed, `cn-user-api` 27 tests passed）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --lib healthz_contract_ -- --nocapture && cargo test -p cn-admin-api --lib metrics_contract_prometheus_content_type_shape_compatible -- --nocapture"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-user-api --lib healthz_contract_ -- --nocapture && cargo test -p cn-user-api --lib metrics_contract_prometheus_content_type_shape_compatible -- --nocapture"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260209-014704.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260209-014817.log`）

## 備考

- 初回検証時に DB 状態の影響で `cn-user-api` 契約テストが不安定化したため、`docker compose ... down -v` で環境を初期化して再実行し、全件成功を確認。

## Community Nodes / `cn-user-api` bootstrap 条件付き GET + キャッシュ契約テスト追加

- [x] `cn-user-api` の bootstrap 配布（`/v1/bootstrap/topics/{topic_id}/services`）に対して、`If-None-Match` / `If-Modified-Since` の条件付き GET が `304 Not Modified` を返す契約テストを追加
- [x] 同レスポンスの `ETag` / `Last-Modified` / `Cache-Control` / `next_refresh_at` を検証する契約テストを追加
- [x] `If-Modified-Since` 判定が秒未満精度で不安定にならないよう、`cn-user-api/src/bootstrap.rs` の比較を秒精度で揃える修正を反映
- [x] `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-09_cn_user_api_bootstrap_conditional_get_contract_tests.md` として作成

## 検証（本タスク）

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-user-api --lib bootstrap_services_conditional_get_and_cache_headers_contract_compatible -- --nocapture"`（成功: 1 passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260209-061212.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260209-061326.log`）

## Community Nodes / `cn-index` 統合テスト追加（outbox・期限切れ削除・reindex_jobs 遷移）

- [x] `cn-index` に統合テストモジュールを追加し、outbox `upsert/delete` の Meilisearch 反映を検証
- [x] 期限切れイベントの sweep（`expire_events_once`）で Meilisearch 削除 + `cn_index.expired_events` 記録を検証
- [x] `reindex_jobs` の `pending -> running -> succeeded` 遷移と再索引後の Meilisearch 反映を検証
- [x] `reindex_jobs` の `pending -> running -> failed` 遷移と `error_message` 記録を検証
- [x] `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-09_cn_index_integration_tests.md` として作成

## 検証（本タスク）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-index -- --nocapture"`（成功: 5 passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260209-151318.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260209-151318.log`）

## Community Nodes / `cn-trust` 統合テスト追加（report/interactions -> score -> attestation -> jobs/schedules）

- [x] `cn-trust` に統合テストモジュール `integration_tests.rs` を追加し、`report` と `interaction` の outbox 取込を起点に trust 集計フローを検証
- [x] `report_scores` / `communication_scores` の算出結果と、`attestations.event_json.kind = 39010`・claim タグ（`moderation.risk` / `reputation`）を検証
- [x] `ensure_job_schedules` -> `load_due_schedules` -> `enqueue_scheduled_job` -> `claim_job` -> `process_job` -> `finalize_job` の一連フローを検証し、`cn_trust.jobs` の `pending -> running -> succeeded` と `next_run_at` 更新を確認
- [x] AGE 実行互換の不整合（`cypher` 呼び出し・`MERGE ... ON CREATE SET`・`ag_graph` 判定型）を `cn-trust` 側で修正し、統合テストで再発防止
- [x] `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-09_cn_trust_integration_tests.md` として作成

## 検証（本タスク）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && rustup component add rustfmt && cargo fmt --all"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-trust -- --nocapture"`（成功: 4 passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260209-171633.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260209-171750.log`）
## Community Nodes / `cn-bootstrap` 39001 クリーンアップ補完

- [x] `cn_admin.topic_services` が 0 件のときに `cn_bootstrap.events(kind=39001)` の stale レコードが残る挙動を修正（active tag 0 件時は kind=39001 を全削除）。
- [x] `cn-bootstrap` に `LISTEN cn_admin_config`（`PgListener`）を追加し、`bootstrap` 設定更新通知で即時に `refresh_bootstrap_events` を実行するように変更。
- [x] `cn-bootstrap` のユニットテストを追加（通知 payload 判定、39001 クリーンアップ分岐）。
- [x] `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md` の該当項目を完了化。
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-09_cn_bootstrap_39001_cleanup.md` に記録。

## 検証

- [x] `cargo test -p cn-bootstrap`（5 passed）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests --env NPM_CONFIG_PREFIX=/tmp/npm-global`（ログ: `tmp/logs/gh-act-community-node-39001-fix-20260209-211926.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check --env NPM_CONFIG_PREFIX=/tmp/npm-global`（ログ: `tmp/logs/gh-act-format-check-39001-fix-20260209-212253.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux --env NPM_CONFIG_PREFIX=/tmp/npm-global`（ログ: `tmp/logs/gh-act-native-test-linux-39001-fix-20260209-212408.log`）
