# 2026年02月09日 作業完了タスク

最終更新日: 2026年02月09日

## Community Nodes / `cn-user-api`・`cn-admin-api` `/healthz` `/metrics` 契約テスト追加

- [x] `cn-admin-api` に `/healthz` 契約テスト（ready / dependency unavailable）を追加し、status code と `status` フィールドを固定
- [x] `cn-admin-api` に `/metrics` 契約テストを追加し、Prometheus content-type（`text/plain; version=0.0.4`）を固定
- [x] `cn-user-api` に `/healthz` 契約テスト（Meilisearch mock: ready / unavailable）を追加し、status code と `status` フィールドを固定
- [x] `cn-user-api` に `/metrics` 契約テストを追加し、Prometheus content-type（`text/plain; version=0.0.4`）を固定
- [x] `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-09_cn_user_admin_health_metrics_contract_tests.md` として作成

## 検証

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml down -v`（成功、検証前に DB/Meilisearch ボリュームを初期化）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-user-api -p cn-admin-api --tests -- --nocapture"`（成功: `cn-admin-api` 21 tests passed, `cn-user-api` 27 tests passed）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-admin-api --lib healthz_contract_ -- --nocapture && cargo test -p cn-admin-api --lib metrics_contract_prometheus_content_type_shape_compatible -- --nocapture"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-user-api --lib healthz_contract_ -- --nocapture && cargo test -p cn-user-api --lib metrics_contract_prometheus_content_type_shape_compatible -- --nocapture"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260209-014704.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260209-014817.log`）

## 備考

- 初回検証時に DB 状態の影響で `cn-user-api` 契約テストが不安定化したため、`docker compose ... down -v` で環境を初期化して再実行し、全件成功を確認。

## Community Nodes / `cn-user-api` bootstrap 条件付き GET + キャッシュ契約テスト追加

- [x] `cn-user-api` の bootstrap 配布（`/v1/bootstrap/topics/{topic_id}/services`）に対して、`If-None-Match` / `If-Modified-Since` の条件付き GET が `304 Not Modified` を返す契約テストを追加
- [x] 同レスポンスの `ETag` / `Last-Modified` / `Cache-Control` / `next_refresh_at` を検証する契約テストを追加
- [x] `If-Modified-Since` 判定が秒未満精度で不安定にならないよう、`cn-user-api/src/bootstrap.rs` の比較を秒精度で揃える修正を反映
- [x] `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-09_cn_user_api_bootstrap_conditional_get_contract_tests.md` として作成

## 検証（本タスク）

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -e MEILI_URL=http://community-node-meilisearch:7700 -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-user-api --lib bootstrap_services_conditional_get_and_cache_headers_contract_compatible -- --nocapture"`（成功: 1 passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260209-061212.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260209-061326.log`）
