# 2025年11月12日 完了タスク

最終更新日: 2025年11月12日

## Nightly Docker シナリオ（ts-test-entrypoint）実行権限修正

- [x] `gh run list --workflow nightly.yml` / `gh run view 19269754542 --job 55094644156` で Nightly `profile-avatar-sync` / `trending-feed` ジョブが `scripts/docker/ts-test-entrypoint.sh` 実行時に `permission denied` で失敗していることを確認し、`gh api repos/KingYoSun/kukuri/actions/jobs/55094644156/logs` から OCI runtime エラーを取得。
- [x] `git update-index --chmod=+x scripts/docker/ts-test-entrypoint.sh` を適用し、Linux runner で `ts-test` サービスの entrypoint に実行権限が付与されるよう修正。
- [x] `gh act -W .github/workflows/nightly.yml -j profile-avatar-sync -P ubuntu-latest=catthehacker/ubuntu:act-latest` で Docker シナリオをローカル再現し、コンテナ起動〜Vitest 実行まで完了すること（`act` では artefact ステップのみログ検出できず失敗する制限がある）を確認。
- [x] `cd kukuri-tauri/src-tauri && cargo test` および `cd kukuri-cli && cargo test` で Rust 側回帰が無いことを検証。

### 実行コマンド

- `gh run list --workflow nightly.yml --limit 5`
- `gh run view 19269754542 --job 55094644156`
- `gh api repos/KingYoSun/kukuri/actions/jobs/55094644156/logs > tmp/gha-logs/profile-avatar-sync.log`
- `gh api repos/KingYoSun/kukuri/actions/jobs/55094644159/logs > tmp/gha-logs/trending-feed.log`
- `gh act -W .github/workflows/nightly.yml -j profile-avatar-sync -P ubuntu-latest=catthehacker/ubuntu:act-latest`
- `cd kukuri-tauri/src-tauri && cargo test`
- `cd kukuri-cli && cargo test`

## Mainline DHT Runbook / ブートストラップ動的更新 PoC

- [x] `docs/03_implementation/p2p_mainline_runbook.md` Chapter10 に CLI ブートストラップリストの既定保存先表と Ops/Nightly 連携節（10.4）を追加し、`apply_cli_bootstrap_nodes` PoC のログ要件（`tmp/logs/relay_status_cli_bootstrap_<timestamp>.log`）と `phase5_ci_path_audit.md` の参照位置を明文化。
- [x] `tmp/logs/relay_status_cli_bootstrap_20251112-094500.log` を採取し、`phase5_ci_path_audit.md`・`phase5_user_flow_summary.md`・`phase5_user_flow_inventory.md`・`phase5_dependency_inventory_template.md` と `docs/01_project/roadmap.md`（MVPトラック／KPI／Week2補足）へ PoC 完了の証跡を反映。`design_doc.md` / `refactoring_plan_2025-08-08_v3.md` の Phase5 ステータスも Runbook 完了ベースへ更新。
- [x] `pnpm install`（PowerShell, CI=true）で `node_modules/.bin/vitest` を再構築した上で `pnpm exec vitest run src/tests/unit/components/RelayStatus.test.tsx` を実行し、UI から Runbook のリンク／CLI 適用ボタンが回帰していないことを確認。Rust 側は `cargo test`（`kukuri-tauri/src-tauri`, `kukuri-cli`）を完走させ PoC に伴うコード部分の回帰が無いことを確認。
- [x] RelayStatus に `refreshRelaySnapshot` を追加し、バックオフ更新・`再試行`・CLI 適用後の再取得が全て `updateRelayStatus` + `p2pApi.getBootstrapConfig` を同時に叩く経路へ統一。`phase5_event_gateway_design.md` / `phase5_dependency_inventory_template.md` / `phase5_user_flow_summary.md` / Runbook Chapter10 に新フローとログ（`tmp/logs/relay_status_cli_bootstrap_20251112-094500.log`）を追記し、`pnpm vitest run src/tests/unit/components/RelayStatus.test.tsx` + `cargo test`（`kukuri-tauri/src-tauri`, `kukuri-cli`）+ `./scripts/test-docker.ps1 rust -NoBuild` で UI/Rust 双方の回帰を確認（Windows ネイティブ `cargo test` は既知の `STATUS_ENTRYPOINT_NOT_FOUND` のため Docker 経由で完走）。

### 実行コマンド

- `cd kukuri-tauri/src-tauri && cargo test`
- `cd kukuri-cli && cargo test`
- `cd kukuri-tauri && powershell -Command "pnpm install"`
- `cd kukuri-tauri && powershell -Command "pnpm exec vitest run src/tests/unit/components/RelayStatus.test.tsx"`
- `cd kukuri-tauri && pnpm vitest run src/tests/unit/components/RelayStatus.test.tsx`
- `./scripts/test-docker.ps1 rust -NoBuild`

## Profile avatar Stage4（Service Worker + cache_metadata）クローズ

- [x] `profileAvatarSyncSW.ts` に最大3回のリトライ＋指数バックオフを実装し、BroadcastChannel の `success=false` を検知して自動再投入。`useProfileAvatarSync` では job metadata（`jobId/source/requestedAt/retryCount`）を `syncNow` に渡し、Service Worker 実行分は `offlineApi.addToSyncQueue`（action_type=`profile_avatar_sync`）へ記録できるようにした。Vitest に `src/tests/unit/workers/profileAvatarSyncWorker.test.ts` を追加し、`scripts/test-docker.{sh,ps1}` の `ts --scenario profile-avatar-sync` に `--service-worker` フラグと Stage4 ログ（`tmp/logs/profile_avatar_sync_stage4_<timestamp>.log`）採取を追加。
- [x] `profile_avatar_sync` コマンドへ `source` / `requested_at` / `retry_count` / `job_id` を追加し、同期結果を `cache_metadata`（`doc::profile_avatar::<npub>`）へ TTL 30 分で保存。Service Worker job の `sync_queue` ロギング／`phase5_ci_path_audit.md` / Runbook Chapter4 / `phase5_user_flow_inventory.md` / `phase5_dependency_inventory_template.md` / `roadmap.md` を Stage4 仕様に更新。

### 実行コマンド

- `npx pnpm vitest run src/tests/unit/hooks/useProfileAvatarSync.test.tsx src/tests/unit/workers/profileAvatarSyncWorker.test.ts`
- `cd kukuri-tauri/src-tauri && cargo test`
- `cd kukuri-cli && cargo test`

## UX/体験導線ギャップ解消（DM既読同期 / Dockerシナリオ / Nightly artefact）

- [x] `useDirectMessageBootstrap` に 30 秒間隔の `list_direct_message_conversations` 再取得・`visibilitychange` フォーカス復帰・Inbox/Dialog オープン時の即時同期を実装し、多端末既読共有を安定化。`DirectMessageInbox` の候補検索成功時に `errorHandler.info('DirectMessageInbox.search_completed', …)` を記録し、`npx pnpm vitest run … | tee tmp/logs/vitest_direct_message_20251112-124608.log` を取得。
- [x] `scripts/test-docker.{sh,ps1}` に `topic-create` / `post-delete-cache` / `user-search-pagination` シナリオを追加し、各シナリオで `test-results/<scenario>/*.json` と `tmp/logs/<scenario>_<timestamp>.log` を生成。`nightly.yml` に新規ジョブ（`topic-create` / `post-delete-cache` / `user-search-pagination`）と `trending-metrics-logs` artefact を追加し、`phase5_ci_path_audit.md` / `phase5_user_flow_summary.md` / `phase5_user_flow_inventory.md` を同期。
- [x] `npx pnpm vitest run src/tests/unit/hooks/useDeletePost.test.tsx src/tests/unit/components/posts/PostCard.test.tsx`, `npx pnpm vitest run src/tests/unit/components/topics/TopicSelector.test.tsx src/tests/unit/components/posts/PostComposer.test.tsx src/tests/unit/components/layout/Sidebar.test.tsx`, `npx pnpm vitest run src/tests/unit/hooks/useUserSearchQuery.test.tsx src/tests/unit/components/search/UserSearchResults.test.tsx` を実行してログ（`tmp/logs/post_delete_cache_20251112-125301.log` / `topic_create_20251112-125226.log` / `user_search_pagination_20251112-125208.log`）を更新。
- [x] `scripts/test-docker.sh ts --scenario trending-feed` 実行時に `prometheus-trending` が起動できなくても `tmp/logs/trending_metrics_job_stage4_<timestamp>.log` を残すよう `collect_trending_metrics_snapshot` を更新し、Nightly artefact `trending-metrics-logs` を追加。

### 実行コマンド

- `cd kukuri-tauri && npx pnpm vitest run src/tests/unit/components/directMessages/DirectMessageDialog.test.tsx src/tests/unit/components/directMessages/DirectMessageInbox.test.tsx src/tests/unit/components/layout/Header.test.tsx src/tests/unit/components/trending/TrendingSummaryPanel.test.tsx src/tests/unit/components/following/FollowingSummaryPanel.test.tsx | tee ../tmp/logs/vitest_direct_message.log`
- `cd kukuri-tauri && npx pnpm vitest run src/tests/unit/hooks/useUserSearchQuery.test.tsx src/tests/unit/components/search/UserSearchResults.test.tsx | tee ../tmp/logs/user_search_pagination.log`
- `cd kukuri-tauri && npx pnpm vitest run src/tests/unit/components/topics/TopicSelector.test.tsx src/tests/unit/components/posts/PostComposer.test.tsx src/tests/unit/components/layout/Sidebar.test.tsx | tee ../tmp/logs/topic_create.log`
- `cd kukuri-tauri && npx pnpm vitest run src/tests/unit/hooks/useDeletePost.test.tsx src/tests/unit/components/posts/PostCard.test.tsx | tee ../tmp/logs/post_delete_cache.log`
- `cd kukuri-tauri/src-tauri && cargo test`
- `cd kukuri-cli && cargo test`

## データ/同期 & メトリクス Runbook/CI（trending_metrics_job Stage4）

- [x] `docker-compose.test.yml` の `rust-test` / `rust-coverage` / `lint-check` サービスに `KUKURI_METRICS_PROMETHEUS_PORT` と `KUKURI_METRICS_EMIT_HISTOGRAM` を追加し、Docker ベースの Rust テストや `p2p_metrics_export` 実行時も Prometheus 監視設定を揃えられるようにした。
- [x] `scripts/test-docker.{sh,ps1}` の `trending-feed` シナリオで採取した `tmp/logs/trending_metrics_job_stage4_<timestamp>.log` を `test-results/trending-feed/prometheus/` に複製し、`nightly.yml` が `trending-metrics-prometheus` artefact として公開できるようにした。Bash/PowerShell 双方で `prometheus-trending` ログのコピー処理を実装。
- [x] `nightly.yml` へ Prometheus スナップショット artefact のアップロード手順を追加し、`phase5_ci_path_audit.md` / `phase5_user_flow_summary.md` / `docs/03_implementation/trending_metrics_job.md` / `docs/03_implementation/p2p_mainline_runbook.md` に Runbook/CI 更新内容を追記。`tasks/status/in_progress.md` から当該タスクを削除して本ファイルへ移行。

### 実行コマンド

- （ドキュメントおよびスクリプト更新のみのため追加コマンド実行なし。CI 側で Docker シナリオを検証予定）

## Ops / CI Onboarding & Nightly artefact 同期

- [x] `docs/01_project/setup_guide.md` に「Ops / CI Onboarding: corepack + pnpm 初期化」節を追加し、Windows（`cmd.exe /c "corepack enable pnpm"`）/macOS/Linux いずれでも Corepack 経由で `pnpm install --frozen-lockfile` を行う手順とログ取得フローを明文化。最終更新日を 2025年11月12日に更新。
- [x] `nightly.yml` の `unit-tests` ジョブを Corepack ベースに切り替え、`pnpm` をグローバルインストールせず `corepack enable pnpm` → `pnpm --version` → `pnpm install/test:unit` を実行する構成へ変更。合わせて `sync-status-indicator` ジョブ（`./scripts/test-docker.sh ts --scenario offline-sync`）を追加し、`tmp/logs/sync_status_indicator_stage4_*.log` を `sync-status-indicator-logs` artefact で収集。
- [x] `docs/03_implementation/p2p_mainline_runbook.md` 6.4 に Nightly シナリオと artefact パスの一覧表（`nightly.trending-feed`, `nightly.profile-avatar-sync`, `nightly.sync-status-indicator`, `nightly.user-search-pagination`, `nightly.post-delete-cache`）を追加し、ダウンロード先 artefact 名（`*-logs`, `*-reports`, `trending-metrics-*`）と `tmp/logs/<scenario>_<timestamp>.log` を紐付け。
- [x] `phase5_ci_path_audit.md` に上記 Test ID と `tmp/logs/*.log` を追記し、`Nightly 'profile-avatar-sync'`, `Nightly 'trending-feed'`, `Nightly 'user-search-pagination'`, `SyncStatusIndicator/useSyncManager`, `投稿削除キャッシュ整合性テスト` の各行へ artefact 名とログ形式を記録。最終更新日を 2025年11月12日に更新。
- [x] `phase5_user_flow_summary.md` の Ops/CI ハイライトと MVP Exit Checklist 行を刷新し、Onboarding/artefact ギャップが解消されたこと、`nightly.<job>` ID を Runbook/CI/Inventory へ反映したことを明示。MVP Exit Checklist の版数を 2025年11月12日版に更新。
- [x] `tasks/status/in_progress.md` から当該タスクを削除し、本完了ファイルへ移動。

### 実行コマンド

- （ドキュメント/ワークフロー定義の更新のみのため追加コマンド実行なし）
