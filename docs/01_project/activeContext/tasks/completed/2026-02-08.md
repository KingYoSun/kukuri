# 2026年02月08日 作業完了タスク

最終更新日: 2026年02月08日

## Community Nodes / Admin Console UI テスト拡充（Dashboard / Services / Subscriptions / Policies / Trust / Audit）

- [x] `kukuri-community-node/apps/admin-console/src/pages` に以下の UI テストを追加し、主要操作と表示崩れ防止の検証を実装
  - `DashboardPage.test.tsx`
  - `ServicesPage.test.tsx`
  - `SubscriptionsPage.test.tsx`
  - `PoliciesPage.test.tsx`
  - `TrustPage.test.tsx`
  - `AuditPage.test.tsx`
- [x] 主要操作（Refresh / Save / Approve / Reject / Toggle / Plan create/edit / Publish / Make current / Enqueue / Schedule save / Run now / Filter）の API 呼び出しをテストで検証
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-08_admin_console_ui_test_expansion.md` として作成

## 検証

- [x] `docker run --rm -e CI=true -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node/apps/admin-console node:20-bookworm bash -lc "corepack enable; pnpm install --frozen-lockfile; pnpm vitest run src/pages/DashboardPage.test.tsx src/pages/ServicesPage.test.tsx src/pages/SubscriptionsPage.test.tsx src/pages/PoliciesPage.test.tsx src/pages/TrustPage.test.tsx src/pages/AuditPage.test.tsx"`（成功: 6 passed）
- [x] `./scripts/test-docker.ps1 ts`（成功: 92 files / 822 tests passed, 6 skipped）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260208-041927.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260208-042040.log`）

## 備考

- `gh act` 実行時に `some refs were not updated` と `pnpm approve-builds` 警告が表示されるが、いずれも既知でジョブ本体は成功。

## Community Nodes / Admin Console shadcn/ui 整合対応

- [x] `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md` の未実装項目「管理画面の技術要件（shadcn/ui）」を完了に更新
- [x] `kukuri-community-node/apps/admin-console/package.json` に shadcn/ui 構成の依存（`@radix-ui/react-slot` / `class-variance-authority` / `clsx` / `tailwind-merge`）を追加
- [x] `kukuri-community-node/apps/admin-console/src/components/ui/` に共通 UI（`Button` / `Card` / `Badge` / `Input` / `Textarea` / `Select` / `Label` / `Notice`）を追加し、`src/lib/utils.ts` の `cn` ユーティリティを実装
- [x] `App` / `LoginPage` / `DashboardPage` / `ServicesPage` / `StatusBadge` を共通 UI 化
- [x] `docs/03_implementation/community_nodes/admin_console.md` / `summary.md` / `apps/admin-console/README.md` に採用済み構成を反映
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-08_admin_console_shadcn_adoption.md` として作成

## 検証（Admin Console shadcn/ui）

- [x] `./scripts/test-docker.ps1 ts`（成功: 92 files / 822 tests passed, 6 skipped）
- [x] `docker compose -f docker-compose.test.yml run --rm ts-test bash -lc "cd /app/kukuri-community-node/apps/admin-console && pnpm install --frozen-lockfile && pnpm test"`（成功: 10 files / 10 tests passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）

## 備考（Admin Console shadcn/ui）

- `gh act` 実行中に `some refs were not updated` が表示されるが、ジョブは成功扱い。
- `format-check` / `native-test-linux` のいずれも `pnpm approve-builds` 警告は出るが既知で、失敗要因ではない。

## Community Nodes / cn-relay 統合テスト拡充（認証切替・rate limit 境界）

- [x] `kukuri-community-node/crates/cn-relay/src/integration_tests.rs` に統合テストを追加し、以下を検証
- [x] 認証 OFF→ON 切替（`enforce_at`）後に `AUTH` challenge が発行され、`ws_auth_timeout_seconds` 経過で `NOTICE(auth-required: timeout)` になること
- [x] rate limit 境界での期待挙動（接続: HTTP 429 reject / REQ: `CLOSED rate-limited` / EVENT: `OK false rate-limited`）を確認
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-08_cn_relay_integration_test_expansion.md` として作成

## 検証（本タスク）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -v "${PWD}:/app" -w /app/kukuri-community-node -e DATABASE_URL="postgres://cn:cn_password@community-node-postgres:5432/cn" rust:1.88-bookworm bash -lc "/usr/local/cargo/bin/cargo test -p cn-relay -- --nocapture"`（成功: `cn-relay` 9 tests passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260208-092501.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260208-092617.log`）

## 備考（本タスク）

- `gh act` 実行時に `some refs were not updated` と `pnpm approve-builds` 警告が表示されるが、いずれも既知でジョブ本体は成功。

## Community Nodes / cn-relay gossip timeout 安定化

- [x] `gh run view 21796109648 --log-failed` で `Community Node Tests` の失敗原因（`integration_tests::ingest_outbox_ws_gossip_integration` の `gossip timeout`）を特定
- [x] `kukuri-community-node/crates/cn-relay/src/integration_tests.rs` の `setup_gossip` で `receiver_a.joined()` / `receiver_b.joined()` を `timeout + expect` で厳密待機するよう修正
- [x] `wait_for_gossip_event` の timeout panic に `expected_id` / `last_received_id` を含め、再発時の診断性を改善
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-08_cn_relay_gossip_timeout_stabilization.md` として作成

## 検証（gossip timeout 安定化）

- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功、2回連続で完走）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260208-200124.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260208-200241.log`）

## 備考（gossip timeout 安定化）

- `gh act` の標準エラーに出る `some refs were not updated` と `pnpm approve-builds` 警告は既知で、いずれもジョブ失敗要因ではない。

## Community Nodes / `GET /healthz` 依存関係 ready 判定拡張

- [x] `cn-user-api` / `cn-admin-api` / `cn-index` / `cn-moderation` / `cn-trust` / `cn-bootstrap` の `/healthz` を DB 単体判定から依存関係込みの ready 判定へ拡張
- [x] `cn-core` に共通ヘルス補助 (`parse_health_targets` / `ensure_health_targets_ready` / `ensure_endpoint_reachable`) を追加し、各サービスで再利用
- [x] `cn-user-api` / `cn-index` は Meilisearch 疎通 (`MeiliClient::check_ready`) を ready 条件へ追加
- [x] `cn-moderation` は LLM 設定（`openai`/`local`）に応じた外部依存疎通チェックを ready 条件へ追加
- [x] `cn-admin-api` の health target fallback に `trust` を追加し、内部依存サービス疎通を ready 条件へ反映
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新
- [x] 進捗レポートを `docs/01_project/progressReports/2026-02-08_community_nodes_healthz_dependency_ready.md` として作成

## 検証（healthz 拡張）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo run -p cn-cli -- migrate"`（成功）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm bash -lc "source /usr/local/cargo/env && cargo test -p cn-user-api -p cn-admin-api -p cn-index -p cn-moderation -p cn-trust -p cn-bootstrap --tests -- --nocapture"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功。ログ: `tmp/logs/gh-act-format-check-20260208-214815.log`）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260208-214815.log`）

## 備考（healthz 拡張）

- `gh act` 実行時に標準エラーで `some refs were not updated` が表示されるが、`format-check` / `native-test-linux` ともに成功。
