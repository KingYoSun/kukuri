# 2026年02月06日 作業完了タスク

最終更新日: 2026年02月06日

## Community Nodes / Access Control (friend_plus)
- [x] AccessControlService に FoF(2-hop) 判定を追加し、friend_plus join.request を検証
- [x] join.request(friend_plus) → 承認 → key.envelope → 暗号投稿復号の統合テストを追加
- [x] friend_plus FoF 判定の unit テストを追加
- [x] community_nodes_roadmap の friend_plus 未実装項目を完了扱いに更新

## Community Nodes / Access Control (P2P-only relay/DB 整合)

- [x] cn-relay ingest の `scope!=public` で DB membership/epoch 検証を撤去し、`epoch` タグの最小検証に統一
- [x] cn-relay WS 配信の private scope 判定を `epoch` タグ検証のみに整理
- [x] Access Control 設計ドキュメントに P2P-only の relay/DB 方針を追記

## Community Nodes / Access Control (KIP 検証補完)

- [x] `cn-kip-types` で `join.request(kind=39022)` の `scope=friend_plus` を許可
- [x] `cn-kip-types` で `invite.capability(kind=39021)` の content schema 検証を追加し、schema 定数名を統一
- [x] `kukuri-tauri` の `AccessControlService` で schema 定数を導入し、`key.envelope` schema を `kukuri-key-envelope-v1` に統一（`kukuri-keyenv-v1` 受理を廃止）
- [x] `AccessControlService` のテストを追加（friend_plus join.request 受理、invite 不正 schema 拒否、legacy key.envelope schema 拒否）
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新

## 検証
- [x] ./scripts/test-docker.ps1 rust
- [x] ./scripts/test-docker.ps1 coverage（tarpaulin: coverage 40.94%）
- [x] gh act --workflows .github/workflows/test.yml --job format-check（1回目: rustfmt 差分で失敗、2回目: 成功）
- [x] gh act --workflows .github/workflows/test.yml --job native-test-linux（act/useRouter 警告、ENABLE_P2P_INTEGRATION 未設定による skip あり）
- [x] docker run --rm --network kukuri-community-node_cn -e DATABASE_URL=postgres://cn:cn_password@postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.86-bookworm bash -c "cargo test --locked -p cn-relay"
- [x] docker run --rm -v C:\Users\kgm11\kukuri\kukuri-cli:/app -w /app rust:1.86-bookworm cargo test --locked
- [x] gh act --workflows .github/workflows/test.yml --job format-check（ログ: tmp/logs/gh-act-format-check-20260206-122344.log / 警告: some refs were not updated / pnpm approve-builds）
- [x] gh act --workflows .github/workflows/test.yml --job native-test-linux（ログ: tmp/logs/gh-act-native-test-linux-20260206-122517.log / 警告: some refs were not updated / pnpm approve-builds / useRouter 警告）
- [x] ./scripts/test-docker.ps1 rust -NoBuild
- [x] docker run --rm -v C:\Users\kgm11\kukuri:/workspace -w /workspace/kukuri-community-node rust:1.88-bookworm bash -c "cargo test --locked -p cn-kip-types -- --nocapture"
- [x] gh act --workflows .github/workflows/test.yml --job format-check（1回目: rustfmt 差分で失敗、2回目: 成功。ログ: `tmp/logs/gh-act-format-check-20260206-141235.log`, `tmp/logs/gh-act-format-check-20260206-141530.log`）
- [x] gh act --workflows .github/workflows/test.yml --job native-test-linux（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260206-141646.log`）
