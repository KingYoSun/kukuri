# 2026年02月06日 作業完了タスク

最終更新日: 2026年02月07日

## Community Nodes / Access Control (friend_plus)
- [x] AccessControlService に FoF(2-hop) 判定を追加し、friend_plus join.request を検証
- [x] join.request(friend_plus) → 承認 → key.envelope → 暗号投稿復号の統合テストを追加
- [x] friend_plus FoF 判定の unit テストを追加
- [x] community_nodes_roadmap の friend_plus 未実装項目を完了扱いに更新

## Community Nodes / Access Control (P2P-only relay/DB 整合)

- [x] cn-relay ingest の `scope!=public` で DB membership/epoch 検証を撤去し、`epoch` タグの最小検証に統一
- [x] cn-relay WS 配信の private scope 判定を `epoch` タグ検証のみに整理
- [x] Access Control 設計ドキュメントに P2P-only の relay/DB 方針を追記

## Community Nodes / Access Control (KIP 検証補完)

- [x] `cn-kip-types` で `join.request(kind=39022)` の `scope=friend_plus` を許可
- [x] `cn-kip-types` で `invite.capability(kind=39021)` の content schema 検証を追加し、schema 定数名を統一
- [x] `kukuri-tauri` の `AccessControlService` で schema 定数を導入し、`key.envelope` schema を `kukuri-key-envelope-v1` に統一（`kukuri-keyenv-v1` 受理を廃止）
- [x] `AccessControlService` のテストを追加（friend_plus join.request 受理、invite 不正 schema 拒否、legacy key.envelope schema 拒否）
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了に更新

## Community Nodes / Deletion Request（派生データ削除・再計算）

- [x] `cn-user-api` の `perform_deletion` をトランザクション化し、relay/moderation/trust/AGE の派生データ削除を統合
- [x] 削除対象の topic / 影響 subject を抽出し、`cn_index.reindex_jobs` と `cn_trust.jobs` の再計算ジョブ投入を実装
- [x] `perform_deletion_removes_derived_data_and_enqueues_jobs` テストを追加し、削除要求の反映を検証
- [x] `community_nodes_roadmap.md` の「削除要求」未実装項目を完了に更新

## Community Nodes / OpenAPI（User/Admin spec + Admin Console 契約）

- [x] `cn-user-api` / `cn-admin-api` に `utoipa` ベースの OpenAPI 生成を追加し、`/v1/openapi.json` を実データ返却へ移行
- [x] User/Admin API の OpenAPI 契約テストを追加し、主要 path/schemas の存在を検証
- [x] `cn-cli` に `openapi export` サブコマンドを追加し、spec を JSON 出力できるようにした
- [x] Admin Console に OpenAPI 由来の型/クライアント生成（`openapi-typescript` + `openapi-fetch`）を導入し、既存 API 呼び出しを置換
- [x] `community_nodes_roadmap.md` の OpenAPI 未実装項目を完了に更新

## Community Nodes / Moderation LLM（OpenAI/Local provider + LLM ラベリング統合/E2E）

- [x] `cn-moderation` に LLM provider（`disabled` / `openai` / `local`）を実装し、OpenAI/Local 応答を内部ラベルへ正規化
- [x] moderation worker に LLM ラベリング挿入（`kind=39006`）、重複防止、外部送信無効時スキップを実装
- [x] `cn-cli` の E2E seed を拡張し、`source=llm:local` のラベル付き投稿を投入できるようにした
- [x] `kukuri-tauri/tests/e2e/specs/community-node.llm-label.spec.ts` を追加し、LLM ラベルバッジ表示を検証
- [x] `community_nodes_roadmap.md` の「Moderation LLM: OpenAI/Local provider を実装（または無効化の明示）し、LLM ラベリングの統合/E2E テストを追加する」を完了に更新

## 検証
- [x] ./scripts/test-docker.ps1 rust
- [x] ./scripts/test-docker.ps1 coverage（tarpaulin: coverage 40.94%）
- [x] gh act --workflows .github/workflows/test.yml --job format-check（1回目: rustfmt 差分で失敗、2回目: 成功）
- [x] gh act --workflows .github/workflows/test.yml --job native-test-linux（act/useRouter 警告、ENABLE_P2P_INTEGRATION 未設定による skip あり）
- [x] docker run --rm --network kukuri-community-node_cn -e DATABASE_URL=postgres://cn:cn_password@postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.86-bookworm bash -c "cargo test --locked -p cn-relay"
- [x] docker run --rm -v C:\Users\kgm11\kukuri\kukuri-community-node:/app -w /app rust:1.86-bookworm cargo test --locked
- [x] gh act --workflows .github/workflows/test.yml --job format-check（ログ: tmp/logs/gh-act-format-check-20260206-122344.log / 警告: some refs were not updated / pnpm approve-builds）
- [x] gh act --workflows .github/workflows/test.yml --job native-test-linux（ログ: tmp/logs/gh-act-native-test-linux-20260206-122517.log / 警告: some refs were not updated / pnpm approve-builds / useRouter 警告）
- [x] ./scripts/test-docker.ps1 rust -NoBuild
- [x] docker run --rm -v C:\Users\kgm11\kukuri:/workspace -w /workspace/kukuri-community-node rust:1.88-bookworm bash -c "cargo test --locked -p cn-kip-types -- --nocapture"
- [x] gh act --workflows .github/workflows/test.yml --job format-check（1回目: rustfmt 差分で失敗、2回目: 成功。ログ: `tmp/logs/gh-act-format-check-20260206-141235.log`, `tmp/logs/gh-act-format-check-20260206-141530.log`）
- [x] gh act --workflows .github/workflows/test.yml --job native-test-linux（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260206-141646.log`）
- [x] docker compose -f docker-compose.test.yml up -d community-node-postgres community-node-meilisearch
- [x] docker compose -f docker-compose.test.yml build test-runner
- [x] docker run --rm --network kukuri_community-node-network -v ${PWD}:/app -w /app/kukuri-community-node kukuri-test-runner bash -lc "/usr/local/cargo/bin/rustup toolchain install 1.90.0 --profile minimal && /usr/local/cargo/bin/rustup component add --toolchain 1.90.0-x86_64-unknown-linux-gnu rustfmt && /usr/local/cargo/bin/cargo +1.90.0 fmt --all"
- [x] docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v ${PWD}:/app -w /app/kukuri-community-node kukuri-test-runner bash -lc "/usr/local/cargo/bin/rustup toolchain install 1.90.0 --profile minimal && /usr/local/cargo/bin/cargo +1.90.0 run -p cn-cli -- migrate && /usr/local/cargo/bin/cargo +1.90.0 test -p cn-user-api --tests -- --nocapture"
- [x] gh act --workflows .github/workflows/test.yml --job format-check（成功。ログ: `tmp/logs/gh-act-format-check-20260206-161920.log` / 警告: some refs were not updated / pnpm approve-builds）
- [x] gh act --workflows .github/workflows/test.yml --job native-test-linux（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260206-162037.log` / 警告: some refs were not updated / pnpm approve-builds / useRouter 警告）
- [x] ./scripts/test-docker.ps1 rust（成功）
- [x] ./scripts/test-docker.ps1 ts（成功）
- [x] docker run --rm -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm sh -lc "/usr/local/cargo/bin/cargo test -p cn-admin-api openapi_contract_contains_admin_paths -- --nocapture && /usr/local/cargo/bin/cargo test -p cn-user-api openapi_contract_contains_user_paths -- --nocapture && /usr/local/cargo/bin/cargo test -p cn-cli -- --nocapture"（成功）
- [x] gh act --workflows .github/workflows/test.yml --job format-check（成功。ログ: `tmp/logs/gh-act-format-check-20260206-183630.log` / 警告: some refs were not updated / pnpm approve-builds）
- [x] gh act --workflows .github/workflows/test.yml --job native-test-linux（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260206-182834.log` / 警告: some refs were not updated / pnpm approve-builds / useRouter 警告）
- [x] docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v C:\Users\kgm11\kukuri:/app -w /app/kukuri-community-node rust:1.88-bookworm sh -lc "export PATH=/usr/local/cargo/bin:$PATH; cargo test --locked -p cn-moderation -- --nocapture && cargo test --locked -p cn-cli -- --nocapture"（成功）
- [x] ./scripts/test-docker.ps1 e2e-community-node（成功。`tmp/logs/community-node-e2e/20260206-175039.log` で `community-node.llm-label.spec.ts` を含む 16/16 spec passed を確認）
- [x] gh act --workflows .github/workflows/test.yml --job format-check（成功。ログ: `tmp/logs/gh-act-format-check-20260207-031135.log` / 警告: some refs were not updated / pnpm approve-builds）
- [x] gh act --workflows .github/workflows/test.yml --job native-test-linux（成功。ログ: `tmp/logs/gh-act-native-test-linux-20260207-031302.log` / 警告: some refs were not updated / useRouter 警告）
