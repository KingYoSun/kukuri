# 2026年02月27日 完了タスク

最終更新日: 2026年02月27日

## Community Node bootstrap source が `n0デフォルト` から切り替わらない問題の修正

- [x] `cn-relay` に `/v1/p2p/info` を追加し、実行中の `node_id` と `bootstrap_nodes`（`node_id@host:port`）を取得可能にした。
- [x] `cn-user-api` の `/v1/bootstrap/nodes` レスポンスへ `bootstrap_nodes` を追加し、descriptor に `endpoints.p2p` が無い場合でも runtime bootstrap 候補を返せるようにした。
- [x] Tauri `CommunityNodeHandler` で `bootstrap_nodes` フィールドを取り込み、descriptor の `p2p` 欠落時フォールバックで user bootstrap を保存するようにした。
- [x] Tauri / Community Node 双方に回帰テストを追加した。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-27_community_node_bootstrap_runtime_fallback.md` を追加した。

## Admin UI の Relay / Bootstrap 接続数が 0 のままになる問題の修正

- [x] `cn-admin-api` の node-subscriptions 応答で、topic 側接続情報が空かつ `ref_count > 0` のトピックに限定して relay runtime (`service_health.details_json`) から `connected_node_count` / `connected_user_count` を補完するようにした。
- [x] `cn-admin-api` 契約テストを追加し、runtime fallback（`ws_connections` と `bootstrap_nodes`）が node-subscriptions 応答へ反映されることを検証した。
- [x] Admin Console `BootstrapPage` の Connected users 集計元を topic 接続情報ベースへ変更し、必要時に relay runtime へフォールバックするようにした。
- [x] Admin Console `RelayPage` で runtime-only 接続（count あり / pubkey なし）を明示表示するようにした。
- [x] `BootstrapPage.test.tsx` / `RelayPage.test.tsx` を更新し、runtime 補完時の表示を回帰テスト化した。

## Admin UI の Connected Users が 0 のまま残る問題の修正

- [x] `cn-user-api` に `ensure_default_public_topic_subscription` を追加し、public topic の `topic_subscriptions` を idempotent に `active` 補完するようにした。
- [x] `auth_verify` 成功時に上記補完を実行し、初回のみ `cn_admin.node_subscriptions.ref_count` を +1 するようにした。
- [x] 既存トークン利用時にも補完が走るよう、`require_auth` 経路にも同補完を追加した。
- [x] `auth::tests::ensure_default_public_topic_subscription_is_idempotent` を追加し、重複加算防止と状態反映を検証した。

## 検証

- [x] `./scripts/test-docker.ps1 rust`（pass）
- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v \"$(git rev-parse --show-toplevel):/workspace\" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc \"set -euo pipefail; source /usr/local/cargo/env; cargo test --workspace --all-features; cargo build --release -p cn-cli\"`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v \"$(git rev-parse --show-toplevel):/workspace\" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc \"set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-admin-api --all-features\"`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v \"$(git rev-parse --show-toplevel):/workspace\" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc \"set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-user-api --all-features\"`（pass）
- [x] `docker run --rm -e CI=true -v \"$(git rev-parse --show-toplevel):/workspace\" -w /workspace/kukuri-community-node/apps/admin-console kukuri-test-runner bash -lc \"set -euo pipefail; corepack enable pnpm >/dev/null 2>&1 || true; pnpm vitest run src/pages/BootstrapPage.test.tsx src/pages/RelayPage.test.tsx\"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [ ] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（fail: 既存の TypeScript 整形差分 142 件で失敗）
- [ ] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（fail: `docker run` の作業ディレクトリ `/workspace/kukuri-community-node` で `Cargo.toml` を解決できず失敗）
