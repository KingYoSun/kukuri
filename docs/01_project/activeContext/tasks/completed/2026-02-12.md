# 2026年02月12日 完了タスク

最終更新日: 2026年02月12日

## Community Nodes / `cn-cli` Node Key + Access Control 統合テスト

- [x] `cn-cli` の `node-key generate/rotate/show` 統合テストを追加し、監査ログ記録とCLI出力互換を検証
- [x] `cn-cli` の `access-control rotate/revoke` 統合テストを追加し、監査ログ・DB反映・CLI出力互換を検証
- [x] `cn-cli` 実装に `access_control.rotate` / `access_control.revoke` の監査ログ記録を追加
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了へ更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_cn_cli_access_control_node_key_integration_tests.md` を作成

## 検証

- [x] `./scripts/test-docker.ps1 rust -NoBuild`（成功）
  - `tmp/logs/test-docker-rust-cn-cli-access-control-20260211-235253.log`
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`
  - 初回失敗（`rustfmt` 差分）: `tmp/logs/gh-act-format-check-cn-cli-access-control-20260211-235325.log`
  - `cargo fmt --all` 後の再実行成功: `tmp/logs/gh-act-format-check-cn-cli-access-control-20260211-235448.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - `tmp/logs/gh-act-native-test-linux-cn-cli-access-control-20260211-235608.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - `tmp/logs/gh-act-community-node-tests-cn-cli-access-control-20260212-000304.log`

## Community Nodes / Access Control 再配布結果の記録・参照（success/failed/pending + reason）

- [x] `cn-core` に再配布結果記録を追加し、epoch rotate/revoke で `pending -> success|failed` と `reason` を保存できるようにした
- [x] `cn-admin-api` に再配布結果 API（`GET /v1/admin/access-control/distribution-results`）を追加し、rotate/revoke レスポンスへ `distribution_results` を追加した
- [x] Admin Console（Access Control）に再配布結果の可視化（集計 + failed/pending 一覧 + 検索）を追加した
- [x] DB マイグレーション `kukuri-community-node/migrations/20260211000000_access_control_distribution_results.sql` を追加した
- [x] `community_nodes_roadmap.md` の該当未実装項目2件を完了（`[x]`）へ更新した
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_access_control_distribution_results.md` を作成した

## 検証（Access Control 再配布結果）

- [x] `./scripts/test-docker.ps1 rust -NoBuild`（ログ上成功）
  - `tmp/logs/test-docker-rust-access-control-distribution-20260212-035553.log`
- [x] `./scripts/test-docker.ps1 ts -NoBuild`（ログ上成功）
  - `tmp/logs/test-docker-ts-access-control-distribution-20260212-035613.log`
- [x] `docker run --rm -v ${PWD}:/workspace -w /workspace/kukuri-community-node/apps/admin-console -e CI=true node:20-bookworm bash -lc "corepack enable && pnpm install --frozen-lockfile && pnpm test -- src/pages/AccessControlPage.test.tsx"`（成功）
  - `tmp/logs/docker-admin-console-access-control-page-20260212-040903.log`
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - `tmp/logs/gh-act-format-check-access-control-distribution-20260212-035709.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - `tmp/logs/gh-act-native-test-linux-access-control-distribution-20260212-035828.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - `tmp/logs/gh-act-community-node-tests-access-control-distribution-20260212-040450.log`

## GitHub Actions 実行時間短縮（全方針一括対応）受け入れ条件確認

- [x] `test.yml` の直近5実行平均が 40 分未満であることを確認
  - 対象 run: `21917213675`(8.32分, success), `21910691648`(36.32分, success), `21909688930`(27.40分, cancelled), `21907509258`(34.18分, success), `21906408713`(33.60分, cancelled)
  - 平均: `27.96` 分（`concurrency` によるキャンセルを含む）
- [x] docs-only 変更で重いジョブが起動しないことを確認
  - 実 run（push/docs-only）: `21917213675` で `Docker Test Suite` / `Desktop E2E (Community Node, Docker)` / `Push Heavy Checks` が `skipped`
  - `pull_request` dry-run: `gh act pull_request --workflows .github/workflows/test.yml --job docker-test --dryrun --verbose`
    - ログ: `tmp/logs/gh-act-dryrun-pull-request-docker-test-20260212.log`（`Skipping job 'Docker Test Suite'`）
  - `pull_request` dry-run: `gh act pull_request --workflows .github/workflows/test.yml --job desktop-e2e --dryrun --verbose`
    - ログ: `tmp/logs/gh-act-dryrun-pull-request-desktop-e2e-20260212.log`（`Skipping job 'Desktop E2E (Community Node, Docker)'`）
- [x] required checks の運用方針がドキュメント化済み
  - `docs/03_implementation/ci_required_checks_policy.md`

## Community Nodes / `recovery-drill` の月次CI統合（`nightly.yml`）

- [x] `.github/workflows/nightly.yml` に `community-node-recovery-drill` ジョブを追加
- [x] UTC 日付ガードを実装し、`workflow_dispatch` または UTC 毎月1日のみ `recovery-drill` を実行するようにした
- [x] `./scripts/test-docker.ps1 recovery-drill` 実行後、`test-results/community-node-recovery/latest-summary.json` を `jq` で検証するステップを追加
- [x] `tmp/logs/community-node-recovery` と `test-results/community-node-recovery` を Nightly artefact として収集するようにした
- [x] `docs/03_implementation/community_nodes/ops_runbook.md` に定期CI連携を追記し、`community_nodes_roadmap.md` の該当未実装項目を完了へ更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_community_node_recovery_drill_monthly_ci.md` を作成

## 検証（`recovery-drill` 月次CI統合）

- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - `tmp/logs/gh-act-format-check-recovery-ci-20260212-055400.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - `tmp/logs/gh-act-native-test-linux-recovery-ci-20260212-055522.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - `tmp/logs/gh-act-community-node-tests-recovery-ci-20260212-060145.log`
- [x] `gh act workflow_dispatch --workflows .github/workflows/nightly.yml --job community-node-recovery-drill`（`act` コンテナ内に `pwsh` が無いため失敗。GitHub Hosted Runner では `pwsh` 利用可）
  - `tmp/logs/gh-act-nightly-community-node-recovery-drill-20260212-060600.log`

## Community Nodes / Runbook 共通必須 HTTP メトリクス契約固定

- [x] `cn-bootstrap` / `cn-user-api` / `cn-admin-api` / `cn-index` / `cn-moderation` / `cn-trust` / `cn-relay` の `/metrics` 契約テストへ `http_requests_total` と `http_request_duration_seconds_bucket` の検証を追加
- [x] 各サービスで `service,route,method,status` ラベルを固定検証し、Runbook 共通必須メトリクスの後方互換を保証
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了（`[x]`）へ更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_common_http_metrics_contract_tests.md` を作成

## 検証（Runbook 共通 HTTP メトリクス契約固定）

- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功、既知の `useRouter` 警告のみ）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）

## Community Nodes / Access Control SoT 境界の文書整合

- [x] `docs/03_implementation/community_nodes/access_control_design.md` を更新し、P2P-only の正判定 SoT と node 側運用補助データ SoT（`cn_user`）の境界を明文化
- [x] 現行実装（membership/invite 管理 API + Admin Console）との整合を反映し、「正判定には非関与、運用補助として関与」の表現に統一
- [x] `docs/01_project/activeContext/tasks/priority/community_nodes_roadmap.md` の該当未実装項目を完了（`[x]`）へ更新

## 検証（Access Control SoT 境界の文書整合）

- [x] ドキュメント更新のみ（`docs/` 配下のみ）につき、`AGENTS.md` ルールによりテスト/`gh act` 実行は対象外

## Community Nodes / `cn-admin-api` 監査ログ必須化（`log_audit(...).await.ok()` 廃止）

- [x] `cn-admin-api` に `log_admin_audit` ヘルパーを追加し、監査ログ書き込み失敗を `AUDIT_LOG_ERROR (500)` として返すように統一
- [x] `services` / `policies` / `subscriptions` / `moderation` / `trust` / `access_control` / `dsar` / `reindex` / `auth` の管理操作で `log_audit(...).await.ok()` を廃止
- [x] `cn-admin-api` 契約テスト `admin_mutations_fail_when_audit_log_write_fails` を追加し、上記カテゴリの更新系 API が監査ログ失敗時に `500 + AUDIT_LOG_ERROR` を返すことを確認
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了（`[x]`）へ更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_cn_admin_api_audit_log_required.md` を作成

## 検証（`cn-admin-api` 監査ログ必須化）

- [x] `cargo fmt --all`（`kukuri-community-node`）
- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml run --rm -v <repo>/kukuri-community-node:/app/kukuri-community-node rust-test /bin/sh -c "cd /app/kukuri-community-node && cargo test -p cn-admin-api -- --nocapture --test-threads=1"`（成功）
  - 備考: 初回実行は DB 未起動で `PoolTimedOut`、次回は `AGE` 拡張なし DB で migration 失敗。`kukuri-community-node-postgres` イメージの一時 DB を `localhost:5432` で起動後に成功。
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功、既知の `useRouter` 警告のみ）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）

## Community Nodes / `cn-admin-api` 更新系の commit 失敗伝播 + ロールバック保証

- [x] `cn-admin-api` の管理更新系で `tx.commit().await.ok()` を廃止し、`services` / `policies` / `subscriptions` の更新ハンドラで commit 失敗を `DB_ERROR (500)` として返すよう修正
- [x] 管理更新系の変更 + 監査ログを同一トランザクションに統一するため `log_admin_audit_tx` を追加し、監査ログ書き込み失敗時にロールバックされるよう統一
- [x] `cn-admin-api` 契約テストに `transactional_admin_mutations_rollback_when_audit_log_write_fails` と `transactional_admin_mutations_rollback_when_commit_fails` を追加し、`service_config.update` / `policy.make_current` / `subscription_request.approve` / `plan.create` / `plan.update` で `5xx` と副作用なしを検証
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了（`[x]`）へ更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_cn_admin_api_commit_rollback_guarantees.md` を作成

## 検証（`cn-admin-api` commit 失敗伝播 + ロールバック保証）

- [x] `cargo fmt --all`（`kukuri-community-node`）
- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功、既知の `useRouter` 警告のみ）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）

## Community Nodes / `service_configs` 秘匿キー保存防止（`cn-admin-api` + Admin Console）

- [x] `cn-admin-api` の `PUT /v1/admin/services/{service}/config` に secret-like key 検出を追加し、`OPENAI_API_KEY` などを含む設定を `400 + SECRET_CONFIG_FORBIDDEN` で reject するようにした
- [x] `cn-admin-api` 契約テストを追加し、secret-like key を含む `config_json` が拒否され、`cn_admin.service_configs` と `audit_logs` に副作用が残らないことを固定した
- [x] Admin Console `Services` の保存処理に同等の検証を追加し、秘匿キーを含む JSON は API 呼び出し前に UI エラーでブロックするようにした
- [x] Admin Console UI テストを追加し、`OPENAI_API_KEY` 含有時にエラー表示され `updateServiceConfig` が呼ばれないことを固定した
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了（`[x]`）へ更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_cn_admin_api_service_config_secret_guard.md` を作成

## 検証（`service_configs` 秘匿キー保存防止）

- [x] `./scripts/test-docker.ps1 ts`（成功）
- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker compose -f docker-compose.test.yml run --rm -v ${PWD}:/workspace -w /workspace/kukuri-community-node/apps/admin-console -e CI=true node:20-bookworm bash -lc "corepack enable && pnpm install --frozen-lockfile && pnpm vitest run src/pages/ServicesPage.test.tsx"`（成功）
- [x] `docker compose -f docker-compose.test.yml run --rm -v ${PWD}:/workspace -w /workspace/kukuri-community-node rust-test /bin/sh -c "cd /workspace/kukuri-community-node && /usr/local/cargo/bin/cargo test --locked -p cn-admin-api -- --nocapture"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）

## Community Nodes / Admin Console 認証遷移フォーム + relay施行状態可視化

- [x] Admin Console `Services` で relay/bootstrap の `auth_mode` / `enforce_at` / `grace_seconds` / `ws_auth_timeout_seconds` を生 JSON ではなく専用フォームで編集できるようにした
- [x] relay の施行状態表示（phase, `enforce_at`, `disconnect_unauthenticated_at`, enforce/切断まで残時間）を追加した
- [x] relay runtime signals（未AUTH接続残数・`auth` reject 累積・timeout/deadline 切断累積）を表示できるようにした
- [x] `cn-relay` / `cn-core` に未AUTH接続ゲージと auth 施行切断カウンタを追加し、AUTH timeout/deadline と auth-required 拒否をメトリクスへ反映した
- [x] `cn-admin-api` の `services::poll_health_once` で relay `/metrics` を収集し、`details_json.auth_transition` へ反映するようにした（契約テスト追加）
- [x] Admin Console `ServicesPage` の Vitest + Testing Library 回帰テストを更新し、専用フォーム保存・施行状態表示・不正入力拒否・JSON編集維持を固定した
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了（`[x]`）へ更新した
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_admin_console_auth_transition_rollout.md` を作成した

## 検証（Admin Console 認証遷移フォーム + relay施行状態可視化）

- [x] `./scripts/test-docker.ps1 ts`（成功）
- [x] `./scripts/test-docker.ps1 rust`（成功）
- [x] `docker run --rm -v ${PWD}:/workspace -w /workspace/kukuri-community-node/apps/admin-console -e CI=true node:20-bookworm bash -lc "corepack enable && pnpm install --frozen-lockfile && pnpm vitest run src/pages/ServicesPage.test.tsx"`（成功）
- [x] `docker compose -f docker-compose.test.yml run --rm -e DATABASE_URL=postgres://cn:cn_password@localhost:5432/cn -v ${PWD}:/workspace -w /workspace/kukuri-community-node rust-test /bin/sh -c "cd /workspace/kukuri-community-node && cargo test --workspace --all-features -- --nocapture"`（初回失敗→再実行成功）
  - 初回失敗: `cn-relay` 統合テストで既存DB残骸により `events_pkey` 重複
  - 対応: `kukuri-community-node-postgres-local` を `--tmpfs /var/lib/postgresql/data` で再起動
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（最終成功）
  - 初回失敗ログ: `tmp/logs/gh-act-format-check-auth-transition-20260212.log`（`cargo fmt` 差分）
  - 成功ログ: `tmp/logs/gh-act-format-check-auth-transition-20260212-final.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - 成功ログ: `tmp/logs/gh-act-native-test-linux-auth-transition-20260212-final.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（最終成功）
  - 初回失敗ログ: `tmp/logs/gh-act-community-node-tests-auth-transition-20260212.log`（`clippy::too_many_arguments`）
  - 成功ログ: `tmp/logs/gh-act-community-node-tests-auth-transition-20260212-rerun.log`

## Community Nodes / moderation human review・再判定・無効化フロー整備（`cn-admin-api` + Admin Console）

- [x] `cn_moderation.labels` にレビュー状態管理カラム（`review_status` / `review_reason` / `reviewed_by` / `reviewed_at`）を追加し、`active` のみ一意制約を維持する migration を追加
- [x] `cn-admin-api` に `POST /v1/admin/moderation/labels/{label_id}/review` と `POST /v1/admin/moderation/labels/{label_id}/rejudge` を実装し、監査ログ（append-only）をトランザクション必須化
- [x] `cn-admin-api` OpenAPI/契約テストを更新し、review/rejudge の成功系・監査失敗系を固定
- [x] `cn-user-api` の labels 取得を `review_status='active'` のみに制限し、無効ラベル非表示を契約テストで固定
- [x] Admin Console Moderation ページに review status 表示・フィルタ・Enable/Disable/Rejudge 操作を追加し、UI テストを追加
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了（`[x]`）へ更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_cn_admin_api_moderation_label_review_rejudge.md` を作成

## 検証（moderation human review・再判定・無効化フロー整備）

- [x] `./scripts/test-docker.ps1 rust -NoBuild`（成功）
- [x] `docker compose -f docker-compose.test.yml run --rm test-runner bash -lc "source /usr/local/cargo/env && cd /app/kukuri-community-node && cargo test --workspace --all-features && cargo build --release -p cn-cli"`（成功）
- [x] `docker run --rm -v ${PWD}:/workspace -w /workspace/kukuri-community-node/apps/admin-console -e CI=true node:20-bookworm bash -lc "corepack enable && pnpm install --frozen-lockfile && pnpm vitest run src/pages/ModerationPage.test.tsx"`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（初回失敗→修正後成功）
  - 初回失敗: Docker ポート `15432` 競合（`kukuri-test-postgres` が占有）
  - 再実行時失敗: `cn-admin-api` 契約テストで `E0382`（`app` move 後再利用）
  - 対応: 競合コンテナ停止 + `contract_tests.rs` の `app.clone()` 修正後に再実行成功

## Community Nodes / `cn-user-api` trust クォータ契約テスト追加

- [x] `cn-user-api` に `/v1/trust/report-based` の `402 QUOTA_EXCEEDED` + `X-Request-Id` 冪等契約テストを追加
- [x] `cn-user-api` に `/v1/trust/communication-density` の `402 QUOTA_EXCEEDED` + `X-Request-Id` 冪等契約テストを追加
- [x] 同一 `request_id` 再送時の `reset_at` 不変と `cn_user.usage_events` 重複計上なし（1件）を固定
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了（`[x]`）へ更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_cn_user_api_trust_quota_contract_tests.md` を作成

## 検証（`cn-user-api` trust クォータ契約テスト）

- [x] `./scripts/test-docker.ps1 rust -NoBuild`（成功）
- [x] `docker compose -f docker-compose.test.yml run --rm -e DATABASE_URL=postgres://cn:cn_password@localhost:5432/cn -e MEILI_URL=http://localhost:7700 test-runner bash -lc "source /usr/local/cargo/env && cd /app/kukuri-community-node && cargo test --workspace --all-features && cargo build --release -p cn-cli"`（成功）
- [x] `docker run --rm --network host -v ${PWD}:/workspace -v kukuri-cargo-registry:/usr/local/cargo/registry -v kukuri-cargo-git:/usr/local/cargo/git -v kukuri-cargo-target:/workspace/kukuri-community-node/target -w /workspace/kukuri-community-node -e DATABASE_URL=postgres://cn:cn_password@localhost:5432/cn -e MEILI_URL=http://localhost:7700 kukuri-test-runner bash -lc "source /usr/local/cargo/env && cargo test -p cn-user-api -- --nocapture"`（成功、37 tests passed）
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - `tmp/logs/gh-act-format-check-trust-quota-20260212-203149.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功、既知の `useRouter` 警告のみ）
  - `tmp/logs/gh-act-native-test-linux-trust-quota-20260212-203311.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - `tmp/logs/gh-act-community-node-tests-trust-quota-20260212-204003.log`

## Community Nodes / Admin Console 認証導線 UI テスト追加（`LoginPage` / `App`）

- [x] `App` のセッションブートストラップ（`api.me` / `/v1/admin/auth/me`）回帰テストを追加
- [x] `App` のログアウト後にログイン画面へ戻る遷移テストを追加
- [x] `LoginPage` のログイン成功/失敗 UI テストを追加
- [x] `community_nodes_roadmap.md` の該当未実装項目を完了（`[x]`）へ更新
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-12_admin_console_auth_flow_ui_tests.md` を作成

## 検証（Admin Console 認証導線 UI テスト追加）

- [x] `./scripts/test-docker.ps1 ts`（成功）
- [x] `docker compose -f docker-compose.test.yml run --rm ts-test bash -lc "cd /app/kukuri-community-node/apps/admin-console && corepack pnpm install --frozen-lockfile && pnpm test"`（成功）
  - `tmp/logs/docker-admin-console-auth-flow-ui-tests-20260212-210707.log`
- [x] `gh act --workflows .github/workflows/test.yml --job format-check`（成功）
  - `tmp/logs/gh-act-format-check-admin-console-auth-ui-tests-20260212-205443.log`
- [x] `gh act --workflows .github/workflows/test.yml --job native-test-linux`（成功）
  - `tmp/logs/gh-act-native-test-linux-admin-console-auth-ui-tests-20260212-205604.log`
- [x] `gh act --workflows .github/workflows/test.yml --job community-node-tests`（成功）
  - `tmp/logs/gh-act-community-node-tests-admin-console-auth-ui-tests-20260212-210302.log`
