# 2026年02月24日 完了タスク

最終更新日: 2026年02月24日

## Issue #152: Community Node Admin UI の Bootstrap サイドバー情報追加

- [x] `kukuri-community-node/apps/admin-console/src/App.tsx` にサイドバー `Bootstrap` カードを追加し、接続先 `node_id@host:port` 一覧を表示するようにした。
- [x] `nodeSubscriptions` と `subscriptions` を組み合わせ、接続ユーザー一覧と接続ユーザー数を表示するようにした（`subscriptions` は最新状態の `active` を採用）。
- [x] 接続先正規化ロジックを `src/lib/bootstrap.ts` へ共通化し、`SubscriptionsPage` と `App` で再利用するようにした。
- [x] `App.test.tsx` に Bootstrap カード表示要件（接続先・接続ユーザー一覧・接続ユーザー数）のテストを追加した。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-24_issue152_admin_ui_bootstrap_sidebar.md` を追加した。

## 検証（Issue #152）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cd /workspace/kukuri-community-node/apps/admin-console; pnpm install --frozen-lockfile; pnpm test -- src/App.test.tsx src/pages/SubscriptionsPage.test.tsx"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #153: Community Node Admin UI に Relay サイドバーを追加し、トピック購読管理を移設

- [x] `kukuri-community-node/apps/admin-console/src/App.tsx` のサイドバーに `Relay` 項目を追加した。
- [x] `kukuri-community-node/apps/admin-console/src/router.tsx` に `/relay` ルートを追加した。
- [x] `kukuri-community-node/apps/admin-console/src/pages/SubscriptionsPage.tsx` からトピック購読管理 UI を除去し、購読申請・プラン・利用状況管理に責務を整理した。
- [x] `kukuri-community-node/apps/admin-console/src/pages/RelayPage.tsx` を新規作成し、トピック購読 CRUD と ingest policy 管理を実装した。
- [x] `kukuri-community-node/crates/cn-admin-api/src/subscriptions.rs` に topic ごとの `connected_users` / `connected_user_count` 集計を追加し、node subscription レスポンスへ反映した。
- [x] `kukuri-community-node/crates/cn-admin-api/src/contract_tests.rs` を更新し、接続ユーザー数・一覧の契約テストを追加した。
- [x] `kukuri-community-node/apps/admin-console/src/pages/RelayPage.test.tsx` を新規作成し、CRUD と接続ユーザー表示のテストを追加した。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-24_issue153_relay_sidebar_topic_subscriptions.md` を追加した。

## 検証（Issue #153）

- [x] `docker compose -f docker-compose.test.yml up -d community-node-postgres`（pass）
- [x] `docker compose -f docker-compose.test.yml build test-runner`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo run --locked -p cn-cli -- openapi export --service user-api --output apps/admin-console/openapi/user-api.json --pretty; cargo run --locked -p cn-cli -- openapi export --service admin-api --output apps/admin-console/openapi/admin-api.json --pretty"`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node/apps/admin-console kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; pnpm install --frozen-lockfile; pnpm generate:api; pnpm typecheck; pnpm test -- src/App.test.tsx src/pages/RelayPage.test.tsx src/pages/SubscriptionsPage.test.tsx"`（pass）
- [x] `docker run --rm --network kukuri_community-node-network -e DATABASE_URL=postgres://cn:cn_password@community-node-postgres:5432/cn -v "$(git rev-parse --show-toplevel):/workspace" -w /workspace/kukuri-community-node kukuri-test-runner bash -lc "set -euo pipefail; source /usr/local/cargo/env; cargo test -p cn-admin-api subscription_requests_and_node_subscriptions_contract_success -- --nocapture; cargo test --workspace --all-features; cargo build --release -p cn-cli; cargo fmt --all --check"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）

## Issue #154: Tauri client のユーザー設定オフライン永続化とオンライン復帰同期

- [x] `kukuri-tauri/src/stores/privacySettingsStore.ts` を拡張し、`ownerNpub`/`hasPendingSync`/`lastSyncedAt`/`lastSyncError`/`updatedAt` を永続化対象として追加した。
- [x] `applyLocalChange` / `markSyncSuccess` / `markSyncFailure` を追加し、ローカル保存と同期状態遷移を store で扱えるようにした。
- [x] 同一ユーザーで未同期変更がある場合、`hydrateFromUser` がローカル値を優先するようにした。
- [x] `kukuri-tauri/src/lib/settings/privacySettingsSync.ts` を新規追加し、Tauri 側更新と Nostr メタデータ更新を集約した。
- [x] `kukuri-tauri/src/routes/settings.tsx` でオフライン時ローカル保存、オンライン時即時同期、`online` イベントでの未同期再送を実装した。
- [x] `kukuri-tauri/src/locales/{ja,en,zh-CN}.json` に未同期表示とオフライン保存トースト文言を追加した。
- [x] `kukuri-tauri/src/tests/unit/stores/privacySettingsStore.test.ts` と `kukuri-tauri/src/tests/unit/routes/settings.test.tsx` を更新し、オフライン保存・再同期動作を検証した。
- [x] 進捗レポート `docs/01_project/progressReports/2026-02-24_issue154_offline_privacy_settings_sync.md` を追加した。

## 検証（Issue #154）

- [x] `docker compose -f docker-compose.test.yml build ts-test`（pass）
- [x] `docker compose -f docker-compose.test.yml run --rm ts-test bash -lc "cd /app/kukuri-tauri && pnpm vitest run src/tests/unit/routes/settings.test.tsx src/tests/unit/stores/privacySettingsStore.test.ts"`（pass）
- [x] `docker compose -f docker-compose.test.yml run --rm ts-test bash -lc "cd /app/kukuri-tauri && pnpm lint && pnpm format:check"`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job format-check`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job native-test-linux`（pass）
- [x] `NPM_CONFIG_PREFIX=/tmp/npm-global gh act --workflows .github/workflows/test.yml --job community-node-tests`（pass）
