# 2025年10月27日 完了タスク

## Phase 5 EventTopicStore ポート導入（EVT-TOPIC-01）
- `application/ports/event_topic_store.rs` を新設し、イベントとトピックの対応管理をアプリ層ポートに抽象化。`RepositoryEventTopicStore` で `EventRepository` ベースの実装を追加し、`AppState` からは `Arc<dyn EventTopicStore>` を注入するように変更。
- `EventManager`（`modules/event/manager/*`）は `EventTopicStore` のみを参照する構成に刷新し、`LegacyEventManagerHandle` / `LegacyEventManagerGateway` / `state.rs` の DI から直接的な Repository 依存を排除。テスト用ハンドラやモックも新ポートに追随させた。
- 検証: `cargo fmt`／`cargo test`（kukuri-tauri/src-tauri は Windows 既知の `STATUS_ENTRYPOINT_NOT_FOUND` で停止するため `./scripts/test-docker.ps1 rust` で代替実行）／`cargo test`（kukuri-cli）。

## Phase 5 P2PStack trait 化とテスト抽象化（P2P-STACK-01）
- `P2PStack` の公開フィールドを `Arc<dyn NetworkService>` / `Arc<dyn GossipService>` に切り替え、Iroh 具象型の露出を builder 内へ封じ込め。GossipService に `local_peer_hint` を追加し、Iroh 実装およびモック・テストユーティリティを更新してヒント取得を trait 経由で扱えるようにした。
- Mainline スモークテスト（`tests/p2p_mainline_smoke.rs`）を trait ベースの helper へ書き換え、`wait_for_bootstrap_peer` / `wait_for_topic_membership` などで dyn trait を直接扱うよう修正。`docs/01_project/activeContext/tasks/status/in_progress.md` と `phase5_dependency_inventory_template.md` を 2025年10月27日更新として反映。
- 検証: `cargo fmt`／`cargo test`（kukuri-tauri/src-tauri は `./scripts/test-docker.ps1 rust` で完走、Windows ネイティブ実行は既知エラー）／`cargo test`（kukuri-cli）。

## Phase 5 P2Pイベントバス再編（P2P-BUS-02）
- DistributionStrategy を `domain::p2p` 配下へ移設し、`DistributionMetrics` トレイトを新設。`DefaultEventDistributor` / `P2PEventDistributor` / `NostrEventDistributor` は共通メトリクス実装を受け取り、配信成功/失敗を `infrastructure::p2p::metrics` へ送信する構成に改修した。
- P2P イベントバスを `broadcast::Sender<P2PEvent>` ベースに統一し、`IrohNetworkService` から `P2PEvent::NetworkConnected/Disconnected` を送出。`NetworkService` トレイトから `subscribe_connection_events` を削除して `AppState`／OfflineJob／EventService の再接続フローをイベントバス経由に整理、`IrohGossipService` や `tests/p2p_gossip_smoke.rs` も broadcast へ対応させた。
- `docs/01_project/activeContext/tasks/status/in_progress.md` と `phase5_dependency_inventory_template.md` の EventDistributor / IrohNetworkService / IrohGossipService 行を 2025年10月27日完了として更新し、テスト支援ドキュメントの受信待ちヘルパーも broadcast 実装へ追随させた。
- 検証: `cargo fmt`／`cargo clippy -- -D warnings`／`cargo test`（kukuri-tauri/src-tauri、Windows 既知の `STATUS_ENTRYPOINT_NOT_FOUND` を回避するため長時間ジョブを許容）。
