# 2025年10月27日 完了タスク

## Phase 5 EventTopicStore ポート導入（EVT-TOPIC-01）
- `application/ports/event_topic_store.rs` を新設し、イベントとトピックの対応管理をアプリ層ポートに抽象化。`RepositoryEventTopicStore` で `EventRepository` ベースの実装を追加し、`AppState` からは `Arc<dyn EventTopicStore>` を注入するように変更。
- `EventManager`（`modules/event/manager/*`）は `EventTopicStore` のみを参照する構成に刷新し、`LegacyEventManagerHandle` / `LegacyEventManagerGateway` / `state.rs` の DI から直接的な Repository 依存を排除。テスト用ハンドラやモックも新ポートに追随させた。
- 検証: `cargo fmt`／`cargo test`（kukuri-tauri/src-tauri は Windows 既知の `STATUS_ENTRYPOINT_NOT_FOUND` で停止するため `./scripts/test-docker.ps1 rust` で代替実行）／`cargo test`（kukuri-cli）。

## Phase 5 P2PStack trait 化とテスト抽象化（P2P-STACK-01）
- `P2PStack` の公開フィールドを `Arc<dyn NetworkService>` / `Arc<dyn GossipService>` に切り替え、Iroh 具象型の露出を builder 内へ封じ込め。GossipService に `local_peer_hint` を追加し、Iroh 実装およびモック・テストユーティリティを更新してヒント取得を trait 経由で扱えるようにした。
- Mainline スモークテスト（`tests/p2p_mainline_smoke.rs`）を trait ベースの helper へ書き換え、`wait_for_bootstrap_peer` / `wait_for_topic_membership` などで dyn trait を直接扱うよう修正。`docs/01_project/activeContext/tasks/status/in_progress.md` と `phase5_dependency_inventory_template.md` を 2025年10月27日更新として反映。
- 検証: `cargo fmt`／`cargo test`（kukuri-tauri/src-tauri は `./scripts/test-docker.ps1 rust` で完走、Windows ネイティブ実行は既知エラー）／`cargo test`（kukuri-cli）。

## Phase 5 P2Pイベントバス再編（P2P-BUS-02）
- DistributionStrategy を `domain::p2p` 配下へ移設し、`DistributionMetrics` トレイトを新設。`DefaultEventDistributor` / `P2PEventDistributor` / `NostrEventDistributor` は共通メトリクス実装を受け取り、配信成功/失敗を `infrastructure::p2p::metrics` へ送信する構成に改修した。
- P2P イベントバスを `broadcast::Sender<P2PEvent>` ベースに統一し、`IrohNetworkService` から `P2PEvent::NetworkConnected/Disconnected` を送出。`NetworkService` トレイトから `subscribe_connection_events` を削除して `AppState`／OfflineJob／EventService の再接続フローをイベントバス経由に整理、`IrohGossipService` や `tests/p2p_gossip_smoke.rs` も broadcast へ対応させた。
- `docs/01_project/activeContext/tasks/status/in_progress.md` と `phase5_dependency_inventory_template.md` の EventDistributor / IrohNetworkService / IrohGossipService 行を 2025年10月27日完了として更新し、テスト支援ドキュメントの受信待ちヘルパーも broadcast 実装へ追随させた。
- 検証: `cargo fmt`／`cargo clippy -- -D warnings`／`cargo test`（kukuri-tauri/src-tauri、Windows 既知の `STATUS_ENTRYPOINT_NOT_FOUND` を回避するため長時間ジョブを許容）。

## Phase 5 EventGateway 残課題消化（EG-S4-01）
- `LegacyEventManagerGateway` から `infrastructure::p2p::metrics` への計測フックを追加し、Publish/TopicPost/Reaction/Metadata/Delete/Repost すべての API で P2P 成功率を収集。EventGateway メトリクスと P2P メトリクスを併記できるよう Runbook 追記準備を実施。
- `modules/event/manager/tests` を撤廃し、`application/shared/tests/event/manager_tests.rs` へユニットテストを移設。DefaultTopics/Gossip broadcast/KeyManager 初期化など既存ケースを crate 共通モックで再現し、Phase 5 のレイヤ分離方針に沿った検証パスに更新。
- Presentation DTO に `Nip65RelayDto` を新設し、`ProfileMetadata` に Relay List を保持する `RelayEndpoint` を追加。Mapper で NIP-65 Relay 配列を JSON ↔ Domain に相互変換し、Validation/Mapper 双方向の単体テストを追加。
- 検証: `cargo fmt`（kukuri-tauri/src-tauri）／`cargo test`（kukuri-tauri/src-tauri、約6分で完走）／`cargo test`（kukuri-cli）。

## Phase 5 Repository ポート抽象化（PH5-REPO-PORT）
- `application::ports::repositories.rs` を新設し、Post/Topic/User/Event/Bookmark Repository の各トレイトを application 層へ移動。`domain::repositories` は役割を終えたため削除し、参照元は全て新ポートに差し替えた。
- `PostService` / `TopicService` / `UserService` / `EventService` などアプリケーションサービスと関連ユニットテストの import を刷新し、モックや DI も `Arc<dyn RepositoryPort>` ベースへ整理。`state.rs` では `AppState` が application ポート経由で Repository を要求する構成に改めた。
- `SqliteRepository` 配下の各モジュール（posts/topics/users/events/bookmarks）と `RepositoryEventTopicStore` を新ポートへ追従させ、`infrastructure::database::repository` はアグリゲータ `Repository` のみに簡素化。これにより Infrastructure 層は application ポートを実装する形になり、Phase 5 で求めるレイヤ分離が完了。
- 検証: `cargo fmt`／`cargo test`（kukuri-tauri/src-tauri、10分タイムアウトで完走）。

## Phase 5 Key/Storage 再編（KEY-STORE-02）
- `KeyMaterialStore` ポートを `application::ports::key_manager` に追加し、KeyPair の保存/削除/現在値更新を専門トレイトへ切り出し。`DefaultKeyManager` は InMemory 実装を標準で抱えつつ、このトレイトへ委譲する設計に刷新した。
- SecureStorage へ `KeyMaterialLedger` / `KeyMaterialRecord` 値オブジェクトを導入し、keyring に保存する鍵メタデータを Domain スキーマで管理。アカウント追加・切替・削除と KeyManager の保存経路が同じ台帳を更新するよう同期処理を実装した。
- `AppState` では `DefaultSecureStorage` を `Arc<dyn KeyMaterialStore>` としても注入し、KeyManager/SecureAccountStore/KeyMaterialStore を同一インスタンスから共有。ドキュメント（`phase5_dependency_inventory_template.md` / `tasks/status/in_progress.md`）を 2025年10月27日完了で更新。
- 検証: `cargo fmt`／`./scripts/test-docker.sh rust`（kukuri-tauri/src-tauri の全テスト）／`cargo test`（kukuri-cli）。

## Phase 5 Gossip Metrics Exporter（P2P-METRICS-01）
- P2P メトリクスのスナップショットを JSON へ書き出す `p2p_metrics_export` バイナリを追加し、`ops::p2p::metrics` を外部バイナリから参照できるように公開。`scripts/metrics/export-p2p.{sh,ps1}` から `--output`/`--pretty` で呼び出しやすくした。
- Runbook（セクション 6.2）と `phase5_ci_path_audit.md` を更新し、CI/ローカルのいずれでも `docs/01_project/activeContext/artefacts/metrics/` へ JSON を保存する手順を明文化。`tasks/status/in_progress.md` の Gossip Metrics 残タスクを完了扱いに変更。
- 検証: `./scripts/test-docker.sh rust`（バイナリを含む全テスト）、CLI 自体は JSON を stdout/ファイルへ吐き出せることを手動確認。

## Phase 5 EncryptionManager 廃止（ENC-LEGACY-01）
- Legacy `modules::crypto::{mod.rs,encryption.rs}` を削除し、`modules::mod.rs` から再エクスポートを撤去。`DefaultEncryptionService` が唯一の暗号化実装として残る構成に整理。
- `phase5_dependency_inventory_template.md` と `tasks/status/in_progress.md` の Stage2/Stage3 を完了済みに更新し、Runbook/計画ドキュメントで Legacy モジュール参照が残っていないことを確認。
- 検証: `./scripts/test-docker.sh rust`（kukuri-tauri/src-tauri）で regression なし、`cargo test`（kukuri-cli）も成功。
