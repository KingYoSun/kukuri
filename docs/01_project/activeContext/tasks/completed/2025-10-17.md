# 2025年10月17日 完了タスク

## Mainline DHT メトリクス可視化
- `kukuri-tauri/src-tauri/src/infrastructure/p2p/metrics.rs` に Mainline DHT の接続・ルーティング・再接続カウンタを追加し、`snapshot_full` で Gossip と合わせて取得できるようにした。
- `kukuri-tauri/src-tauri/src/presentation/commands/p2p_commands.rs` / `presentation/dto/p2p.rs` を更新し、`get_p2p_metrics` で Mainline DHT の接続数・ルーティング成功率・再接続統計を返すレスポンスを導入。
- フロントエンドの `src/lib/api/p2p.ts` と `src/components/P2PDebugPanel.tsx` を更新し、Mainline DHT メトリクスを UI で可視化。`P2PDebugPanel` から自動/手動更新で接続状況を確認可能にした。
- Rust テストは Windows ネイティブ `cargo test` が `STATUS_ENTRYPOINT_NOT_FOUND` で失敗する既知事象のため `./scripts/test-docker.ps1 rust` で実施。TypeScript テストは `pnpm test` を完走。

## P2P ステータス API のメトリクス要約対応
- `kukuri-tauri/src-tauri/src/application/services/p2p_service.rs` で Gossip メトリクスのスナップショットをまとめ、`metrics_summary` として返却。
- DTO (`presentation/dto/p2p.rs`) とハンドラ (`presentation/handlers/p2p_handler.rs`) を更新し、フロント側が要約値を受け取れるよう整備。
- `p2pStore` / `useP2P` / `P2PStatus` などフロントサイドの状態管理を変更し、メトリクスのリフレッシュボタンから `refreshStatus` を再利用。

## NIP-10 契約テスト共通化
- `testdata/nip10_contract_cases.json` を追加し、Rust (`tests/nip10_contract_tests.rs`) と TypeScript (`src/lib/__tests__/nip10.contract.test.ts`) で共通ケースを実行。
- `contract_testing::validate_nip10_tags` を導入し、アプリ本体のエンティティ検証ロジックをそのままテストで利用。

## 開発支援スクリプトの拡張
- `scripts/test-docker.ps1` に `metrics` / `contracts` サブコマンドを追加し、対象テストのみを Docker 経由で実行可能にした。

## 既知の課題 / フォローアップ
- `cargo test` は Windows 環境の DLL 依存により依然として `STATUS_ENTRYPOINT_NOT_FOUND` で失敗。個別の `cargo test --test nip10_contract_tests` は完走済み。
- `pnpm test` は JSX のローカライズ文字列を調整中。P2P UI 周りのスナップショットが安定した段階で再実行する。

## NIP-10 契約ケース拡張と Docker スモークテスト縮小タスク整理
- `kukuri-tauri/testdata/nip10_contract_cases.json` を bech32（note/nevent/npub/nprofile）およびリレー数上限を含む12ケースまで拡張し、Rust (`docker run --rm -w /app/kukuri-tauri/src-tauri kukuri-rust-test cargo test --test nip10_contract_tests`) と TypeScript (`docker run --rm -w /app/kukuri-tauri kukuri-ts-test pnpm vitest run src/lib/__tests__/nip10.contract.test.ts`) の契約テストで整合性を確認。
- Docker スモークテスト構成の軽量化タスクを `docs/01_project/activeContext/tasks/context/docker_smoke_tests.md` に集約し、Compose 分割・ベースイメージ最適化・スクリプト更新のフォローアップを明文化。

## Iroh DHT/Discovery 仕上げの完了
- `bootstrap_nodes.json` のスキーマを確定させ、CLI と Tauri 双方で同一バリデーションとローダーを共有しつつ `user_bootstrap_nodes.json` との優先順位を整理。
- 設定画面に `BootstrapConfigPanel` を実装し、n0 を既定としつつ任意ノードを `node_id@host:port` 形式で登録できる UI を提供。
- `dht_bootstrap.rs::leave_topic` で Sender ドロップによる退出と再参加制御を行い、quit の意味を明確化。
- `dht_bootstrap.rs::broadcast` で Sender 利用によるブロードキャスト処理を追加し、API 連動の送信動作を整備。
- `shared/config.rs` の `NetworkConfig` に `enable_{dht,dns,local}` を追加し、`IrohNetworkService` ビルダーへ反映。
- 受信イベントに NIP-01/10/19 準拠のバリデーションを導入し、P2P 経路での投稿・閲覧・返信・引用の結合テスト（Rust/TS）を通過。
- GitHub Actions に `smoke-tests.yml`（`test-runner` 実行）を追加し、P2P シナリオの CI カバレッジを拡張。
- `get_p2p_metrics` とフロントの P2PDebugPanel を拡張し、メトリクスの自動更新（10秒）と手動更新で状態を可視化。

## 短期フォロー項目の解消
- NIP-19 TLV の検証を拡張し、複数リレー URL・長さ制限・UTF-8 妥当性を厳格化。
- `get_p2p_status` にメトリクス要約を含め、`metricsSummary` をフロントの `p2pStore` / `useP2P` で扱えるよう統一。
- Rust/TS 双方の契約テストに NIP-10 の境界ケースを追加し、`testdata/nip10_contract_cases.json` を共通参照。
- `scripts/test-docker.ps1` に `metrics` / `contracts` オプションを追加し、Docker 経由で個別テストを即時実行可能にした。
- `modules/p2p/tests/iroh_integration_tests.rs` を NodeAddr ヒント対応とし、`connect_peers` の戻り値から初期ピア再設定を行うよう調整。
- DHT ブートストラップコンテナ経由で `discovery_dht()` のみを使う受信確認テストへ切り替え、安定化のためのタイムアウトとリトライ戦略を整理。
- TypeScript 契約テストと Docker スモークテストの縮小計画を `docs/01_project/activeContext/tasks/context/docker_smoke_tests.md` にまとめ、後続タスクの整理を完了。

## Mainline DHT 向け DI 初期化シーケンスの再構成
- `kukuri-tauri/src-tauri/src/state/application_container.rs` を新設し、AppConfig 取得・`app_data_dir` 生成・P2P スタック構築を一元化。Base64 で永続化する iroh シークレットキーを管理し、ノード ID を再利用できるようにした。
- `AppState::new`（`state.rs`）からコンテナ経由で `build_p2p_stack` を呼び出すよう変更し、`P2PService` 初期化時に永続化された鍵とブートストラップ設定を注入。
- `IrohNetworkService::new` 完了時に `NetworkConfig.bootstrap_peers` を即時接続する `apply_bootstrap_peers_from_config` を追加し、Mainline DHT ハンドシェイクの初期同報を自動化。
- 変更後の導線を Docker 経由の `./scripts/test-docker.ps1 rust` と `kukuri-cli` の `cargo test` で検証し、Windows ネイティブ `cargo test` が失敗する既知事象も並行して共有。

## Mainline DHT ハンドシェイク統合テスト
- `kukuri-tauri/src-tauri/src/modules/p2p/tests/mainline_dht_tests.rs` を追加し、Mainline DHT ハンドシェイクとルーティングの正常系を P2P スタック経由で検証。
- `scripts/docker/run-smoke-tests.sh` を更新し、Mainline DHT テストと既存の DHT/Gossip テストを並行実行してスモーク確認できるようにした。
