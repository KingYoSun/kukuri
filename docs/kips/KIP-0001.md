# KIP-0001 (Draft): Community Node / Attestation Trust / Access Control

作成日: 2026年01月26日  
Status: Draft (v0.1)  
Scope: kukuri ネットワークにおけるコミュニティノード（収益化Super Node）の責務分割、Trust 提案（署名付きアテステーション）、公開度（public/friend+/friend/invite）の鍵配布フローを定義する。

## 0. Goals / Non-Goals

### Goals
- コミュニティノードが **役割（bootstrap/relay/index/moderation/trust）** を部分的に提供できる。
- クライアントが **複数ノードを選択・併用・乗り換え**できる（中央集権化を避ける）。
- Trust は **署名付き提案（attestation）** として配布し、スコア押し付けを避ける。
- 公開度を段階化し、**public → friend+ → friend → invite** の導線を実現する。

### Non-Goals
- 課金・決済の具体仕様（別KIP）。
- 完全なスパム耐性の保証（段階的に導入）。
- 過去暗号文の完全剥奪（追放は“未来の閲覧”を止めることが主）。

## 1. Terms

- **User Key**: ユーザーの署名鍵（Nostr互換）。
- **Node Key**: コミュニティノードの署名鍵（ノード人格）。
- **Topic ID**: kukuri トピック識別子（例: `kukuri:<64hex>` / `kukuri:global`）。
- **Role**: `bootstrap | relay | index | moderation | trust`。
- **Scope**: `public | friend_plus | friend | invite`。
- **Epoch**: 鍵世代番号（追放/漏洩時に増える）。
- **Key Steward**: 鍵配布/ローテを担う主体（v1 は招待発行者/トピック作成者など。クライアントが信頼する発行者を選ぶ）。

## 2. Event Kind Allocation

本 KIP は以下の kind を使用する。

- `39000` **kukuri.node.descriptor** (replaceable 推奨)
- `39001` **kukuri.node.topic_service** (replaceable 推奨)
- `39005` **kukuri.report** (append-only)
- `39006` **kukuri.label** (append-only)
- `39010` **kukuri.attestation** (append-only)
- `39011` **kukuri.trust.anchor** (replaceable 推奨)
- `39020` **kukuri.key.envelope** (append-only)
- `39021` **kukuri.invite.capability** (append-only)
- `39022` **kukuri.join.request** (append-only)

共通 tags（必須）:
- `["k","kukuri"]`
- `["ver","1"]`

## 3. Community Node Capability Advertisement

### 3.1 kukuri.node.descriptor (kind=39000)

ノードが能力・規約・連絡先・エンドポイント・料金を宣言する。

推奨 tags:
- `["d","descriptor"]`
- `["role","bootstrap"]` 等（複数可）
- `["jurisdiction","JP"]` 等
- `["policy","<url>"]`
- `["exp","<unix_ts>"]`

content（JSON 例）:

```json
{
  "schema":"kukuri-node-desc-v1",
  "name":"Example Node",
  "roles":["bootstrap","index","moderation","trust"],
  "endpoints":{"http":"https://node.example","ws":"wss://node.example/ws"},
  "pricing":{"index":"subscription","trust":"per-request"},
  "policy_url":"https://node.example/policy",
  "jurisdiction":"JP",
  "contact":"ops@example"
}
```

### 3.2 kukuri.node.topic_service (kind=39001)

ノードが特定 topic に対して提供する役割を宣言する。

必須 tags:
- `["d","topic_service:<topic_id>:<role>:<scope>"]`
- `["t","<topic_id>"]`
- `["role","index|moderation|trust|relay|bootstrap"]`
- `["scope","public|friend_plus|friend|invite"]`
- `["exp","<unix_ts>"]`

content（JSON 例）:

```json
{
  "schema":"kukuri-topic-service-v1",
  "topic":"<topic_id>",
  "role":"index",
  "scope":"public"
}
```

## 4. Moderation = Reports + Labels

### 4.1 kukuri.report (kind=39005)

誰でも通報できる入力。自動適用しない。

tags（例）:
- `["target","event:<id>"]` / `["target","pubkey:<hex>"]`
- `["reason","spam|illegal|harassment|impersonation|nsfw"]`

### 4.2 kukuri.label (kind=39006)

ノードが署名して出す「判断/提案」。

tags（例）:
- `["target","event:<id>"]` / `["target","pubkey:<hex>"]`
- `["label","spam|illegal|harassment|impersonation|nsfw|safe"]`
- `["confidence","0.0-1.0"]`（任意）
- `["policy_url","<policy_url>"]`
- `["policy_ref","<policy_ref>"]`
- `["exp","<unix_ts>"]`

クライアントは採用する label 発行者（ノード）を選択可能。

## 5. Trust = Signed Attestations

### 5.1 kukuri.attestation (kind=39010)

署名主体（attester）が subject について claim を発行する。

tags（例）:
- `["sub","pubkey","<hex>"]` / `["sub","node","<hex>"]` / `["sub","event","<id>"]`
- `["claim","reputation|identity.link|moderation.risk|capability|social.distance"]`
- `["t","<topic_id>"]`（任意）
- `["exp","<unix_ts>"]`

content（JSON 例）:

```json
{
  "schema":"kukuri-attest-v1",
  "subject":"pubkey:<hex>",
  "claim":"reputation",
  "value":{"score":0.82,"level":"good"},
  "evidence":["event:<id>","url:https://..."],
  "context":{"topic":"<topic_id>"},
  "expires":1767225600
}
```

### 5.2 kukuri.trust.anchor (kind=39011)

ユーザーが「どの attester をどの範囲で信頼するか」を宣言する。

tags（例）:
- `["attester","<pubkey_hex>"]`
- `["claim","reputation"]`（任意）
- `["t","<topic_id>"]`（任意）
- `["weight","0.0-1.0"]`

## 6. Access Control (Public → Friend+ → Friend → Invite)

v1 は **P2P-only** を前提とし、招待/加入/鍵配布はクライアント間で完結する（ノード必須ではない）。Access Control の運用範囲は 39020/39021/39022 と epoch/加入判定に限定し、Node HTTP API には載せない。

### 6.1 kukuri.key.envelope (kind=39020)

受信者ごとに `K(topic_id, scope, epoch)` を渡す。

tags（必須）:
- `["p","<recipient_pubkey_hex>"]`
- `["t","<topic_id>"]`
- `["scope","friend_plus|friend|invite"]`
- `["epoch","<int>"]`
- `["d","keyenv:<topic_id>:<scope>:<epoch>:<recipient_pubkey_hex>"]`

content:
- NIP-44 v2（0x02）で recipient 宛に暗号化した JSON を payload とする。
- 暗号化前の例:

```json
{
  "schema":"kukuri-key-envelope-v1",
  "topic":"<topic_id>",
  "scope":"friend_plus",
  "epoch":7,
  "key_b64":"....",
  "issued_at":...,
  "expires":...
}
```

### 6.2 kukuri.invite.capability (kind=39021)

招待トークン（capability）を配布し、join 後に key.envelope を渡す。
capability は **発行者（issuer）= ユーザー鍵** が署名し、原則 out-of-band/直接共有する（P2P DM/QR/コピー等）。

tags（必須）:
- `["t","<topic_id>"]`
- `["scope","invite"]`
- `["d","invite:<nonce>"]`

content（JSON 例）:

```json
{
  "schema":"kukuri-invite-v1",
  "topic":"<topic_id>",
  "scope":"invite",
  "expires":...,
  "max_uses":1,
  "nonce":"...",
  "issuer":"pubkey:<hex>"
}
```

補足（P2P-only の割り切り）:
- `max_uses` は **best-effort**（分散下で厳密な回数制御はしない）。
- 濫用リスクは **短い期限/再配布の最小化/鍵ローテ** で軽減する。

### 6.3 kukuri.join.request (kind=39022)

join 申請イベント。招待capabilityを提示し、参加希望を通知する。

tags（必須）:
- `["t","<topic_id>"]`
- `["scope","invite|friend"]`
- `["d","join:<topic_id>:<nonce>:<requester_pubkey_hex>"]`

tags（任意）:
- `["e","<invite_event_id>"]`（invite 利用時）
- `["p","<issuer_pubkey_hex>"]`（招待発行者/鍵配布先の目安）

content（JSON 例）:

```json
{
  "schema":"kukuri-join-request-v1",
  "topic":"<topic_id>",
  "scope":"invite",
  "invite_event_json":{ ... },
  "requester":"pubkey:<hex>",
  "requested_at":...
}
```

補足:
- join.request は **P2Pで直接送付**（招待者や既存メンバーへのDM）または **topic へのブロードキャスト**を選べる。
- 受理側は invite の署名/期限/スコープを検証し、問題なければ key.envelope を requestor に送る。

## 7. Client Rules (Minimal)

- ノードは **提案者**。label/attestation の採用はユーザー設定に依存。
- 重要データ（鍵・capability・個人関係）は暗号化・最小開示を前提にする。
- 期限（exp）を積極的に使い、固定スコア化・永続 BAN を避ける。
- Access Control の membership は **ローカル判断が正**（P2P-onlyのため、単一の台帳は持たない）。

## 8. Versioning

- `["ver","1"]` を共通 tag として使用する。
- schema 名に `-v1` を付与し、破壊的変更時は v2 へ更新する。
